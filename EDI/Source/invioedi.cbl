      *{TOTEM}PRG-COMMENT
      * invioedi.Cbl
      * invioedi.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          invioedi.
       AUTHOR.              ANDREA EVENTI.
       DATE-WRITTEN.        martedì 30 dicembre 2014 14:11:27.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:invioedi, INIT:invioedi, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "paramedi.sl".
           COPY "tedi.sl".
           COPY "redi.sl".
           COPY "exp-edi.sl".
           COPY "anautf.sl".
           COPY "lineseq.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "paramedi.fd".
           COPY "tedi.fd".
           COPY "redi.fd".
           COPY "exp-edi.fd".
           COPY "anautf.fd".
           COPY "lineseq.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "fonts.def".
               COPY "crtvars.def".
               COPY "opensave.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "F:\lubex\geslux\Copylib\standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Enter-Pushed VALUE 13.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
          88 Screen-Time-Out VALUE 99.
      * Properties & User defined Working Stoarge
       77 Screen1-Handle
                  USAGE IS HANDLE OF WINDOW.
           COPY  "COMMON-EXCEL.DEF".
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 anno PIC  9(4).
       77 mese PIC  9(2).
       77 Screen2-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 Form1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 TITOLO           PIC  X(50)
                  VALUE IS "Geslux - Invio dati telematici".
       77 Form1-Tb-1-Handlea
                  USAGE IS HANDLE OF WINDOW.
       77 toolbar-bmp      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 E-ESCI           PIC  9
                  VALUE IS 1.
       77 bottone-ok-bmp   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 bottone-cancel-bmp           PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 Verdana12-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 Verdana10-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 STATUS-paramedi  PIC  X(2).
           88 Valid-STATUS-paramedi VALUE IS "00" THRU "09". 
       77 STATUS-tedi      PIC  X(2).
           88 Valid-STATUS-tedi VALUE IS "00" THRU "09". 
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 1002.
       77 col-stato-ordine PIC  9(6)
                  VALUE IS 1.
       77 Verdana10B-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 tit-stato-ordine PIC  X(20)
                  VALUE IS "Ingresso".
       77 STRIP-GRID-GCLIENTI-BMP      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 STATUS-redi      PIC  X(2).
           88 Valid-STATUS-redi VALUE IS "00" THRU "09". 
       77 form3-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 Verdana12BI-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 path-exp-edi     PIC  X(256).
       77 STATUS-exp-edi   PIC  X(2).
           88 Valid-STATUS-exp-edi VALUE IS "00" THRU "09". 
       77 STATUS-anautf    PIC  X(2).
           88 Valid-STATUS-anautf VALUE IS "00" THRU "09". 
       77 scr-fine-SF-HANDLE
                  USAGE IS HANDLE OF WINDOW.
       77 mov-da           PIC  z(8).
       77 mov-a            PIC  z(8).
       77 tot-mov          PIC  z(17)9.
       77 tot-ent          PIC  z.zzz.zzz.zz9.
       77 tot-edi          PIC  z(10).
       77 Verdana12B-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 num-bitmap       PIC  9.
       77 old-kg           PIC  9(9)v99.
       77 bottone-elimina-bmp          PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 sel-tutto-bmp    PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 DESEL-TUTTO-BMP  PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 OPENSAVE-STATUS  PIC  s99.
       01 rec-grid-b.
           05 col-nulla        PIC  x.
           05 col-anno-tmo     PIC  9(4).
           05 col-num-tmo      PIC  z(8).
           05 col-data-mov     PIC  99/99/9999.
           05 col-ragsoc       PIC  X(40).
           05 col-cpa          PIC  X(4).
           05 col-nc           PIC  z(08).
           05 col-taric        PIC  z(02).
           05 col-dac          PIC  x(4).
           05 col-kg           PIC  zz.zzz.zz9,999.
           05 col-stoccaggio   PIC  x.
           05 col-ddt          PIC  x(21).
           05 col-data-ddt     PIC  99/99/9999.
           05 col-nazione      PIC  X(2).
           05 col-pos-fiscale  PIC  X(3).
           05 col-cau          PIC  X(3).
           05 col-consumo      PIC  zz.zzz.zz9,99.
           05 col-stato        PIC  XX.
           05 col-invio        PIC  x.
       77 filtro-nc        PIC  9(8).
       77 old-filtro-nc    PIC  9(8).
       77 filtro-nc-x      PIC  x(8).
       77 filtro-nc-z      PIC  z(8).
       77 redi-nc-x        PIC  x(8).
       01 FILLER           PIC  9.
           88 rec-ok VALUE IS 1    WHEN SET TO FALSE  0. 
       77 tot-importi      PIC  9(12)v999.
       77 tot-carico       PIC  9(12)v999.
       77 tot-scarico      PIC  9(12)v999.
       77 tot-importi-ed   PIC  z.zzz.zzz.zz9,99.
       77 lab-carico-buf   PIC  z.zzz.zzz.zz9,999.
       77 lab-scarico-buf  PIC  z.zzz.zzz.zz9,999.
       77 EXCEL-BMP        PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 wstampa          PIC  X(256).
       77 STATUS-lineseq   PIC  X(2).
           88 Valid-STATUS-lineseq VALUE IS "00" THRU "09". 

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 STATUS-Screen2-FLAG-REFRESH PIC  9.
          88 Screen2-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-Screen2-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Screen2-tedi-RESTOREBUF  PIC X(631).
       77 TMP-Screen2-KEYIS  PIC 9(3) VALUE 1.
       77 Screen2-MULKEY-TMPBUF   PIC X(631).
       77 STATUS-form3-FLAG-REFRESH PIC  9.
          88 form3-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 STATUS-scr-fine-FLAG-REFRESH PIC  9.
          88 scr-fine-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-DataSet1-paramedi-BUF     PIC X(454).
       77 TMP-DataSet1-tedi-BUF     PIC X(631).
       77 TMP-DataSet1-redi-BUF     PIC X(836).
       77 TMP-DataSet1-exp-edi-BUF     PIC X(387).
       77 TMP-DataSet1-anautf-BUF     PIC X(638).
       77 TMP-DataSet1-lineseq-BUF     PIC X(900).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-paramedi-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-paramedi-LOCK  VALUE "Y".
       77 DataSet1-paramedi-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-paramedi-KEY-Asc  VALUE "A".
          88 DataSet1-paramedi-KEY-Desc VALUE "D".
       77 DataSet1-tedi-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tedi-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-tedi-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-tedi-KEY1-Asc  VALUE "A".
          88 DataSet1-tedi-KEY1-Desc VALUE "D".
       77 DataSet1-redi-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-redi-LOCK  VALUE "Y".
       77 DataSet1-redi-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-redi-KEY-Asc  VALUE "A".
          88 DataSet1-redi-KEY-Desc VALUE "D".
       77 DataSet1-exp-edi-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-exp-edi-LOCK  VALUE "Y".
       77 DataSet1-exp-edi-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-exp-edi-KEY-Asc  VALUE "A".
          88 DataSet1-exp-edi-KEY-Desc VALUE "D".
       77 DataSet1-anautf-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-anautf-LOCK  VALUE "Y".
       77 DataSet1-anautf-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-anautf-KEY-Asc  VALUE "A".
          88 DataSet1-anautf-KEY-Desc VALUE "D".
       77 DataSet1-lineseq-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-lineseq-LOCK  VALUE "Y".
       77 DataSet1-lineseq-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-lineseq-KEY-Asc  VALUE "A".
          88 DataSet1-lineseq-KEY-Desc VALUE "D".

       77 redi-redi-k-tipo-mov-SPLITBUF  PIC X(27).
       77 redi-redi-k-dt-mov-SPLITBUF  PIC X(28).

           COPY  "LINK-GESLOCK.DEF".

       01                       pic 9.
           88 procedi           value 1 false zero.

       78  78-colore-ingresso   value 481.
       78  78-colore-uscita     value 400.

       78  78-tit-ingresso      value "MOVIMENTO DI CARICO".
       78  78-tit-uscita        value "MOVIMENTO DI SCARICO".

       77  como-tipo-mov     pic x.
           88 como-carico    VALUE IS "C". 
           88 como-scarico   VALUE IS "S". 


       77  elemento-bmp   PIC  S9(9) USAGE IS COMP-4   VALUE IS ZERO.
       77  conferma-handle  PIC  S9(9) USAGE IS COMP-4   VALUE IS ZERO.
       77  font-evidenzia-griglia  USAGE IS HANDLE OF FONT.


      * 78  78-col-anno          value 2.
      * 78  78-col-registro      value 3.
      * 78  78-col-progressivo   value 4.
       78  78-col-anno-tmo      value 2.
       78  78-col-num-tmo       value 3.
       78  78-col-data-mov      value 4.
       78  78-col-ragsoc        value 5. 
       78  78-col-cpa           value 6. 
       78  78-col-nc            value 7.
       78  78-col-taric         value 8.
       78  78-col-dac           value 9.
       78  78-col-kg            value 10.
       78  78-col-stoccaggio    value 11.
       78  78-col-ddt           value 12.
       78  78-col-data-ddt      value 13.
       78  78-col-nazione       value 14.
       78  78-col-pos-fiscale   value 15.
       78  78-col-cau           value 16.
       78  78-col-consumo       value 17.
       78  78-col-stato         value 18.
       78  78-col-invio         value 19.

       77  cont-exp             pic 9(18).

       01  FILE-INFO.
           02  FILE-SIZE    PIC X(8) COMP-X.
           02  FILE-DATE    PIC 9(8) COMP-X.
           02  FILE-TIME    PIC 9(8) COMP-X.  

       77  blocco                  pic x.

       77  como-redi-imp-consumo   PIC  9(9)V9(2).

       77  save-riga               pic 9(5).
      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
       78  78-ID-ef-mese VALUE 5001.
       78  78-ID-gb-rec-b VALUE 5001.
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE
           COPY  "COMMON-LINKAGE.DEF".
      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           .

      * ENTRY FIELD
       05
           ef-anno, 
           Entry-Field, 
           COL 14,00, 
           LINE 2,00,
           LINES 1,33 ,
           SIZE 5,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 1001,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           VALUE anno,
           AFTER PROCEDURE ef-anno-AfterProcedure, 
           BEFORE PROCEDURE ef-anno-BeforeProcedure, 
           .

      * ENTRY FIELD
       05
           ef-mese, 
           Entry-Field, 
           COL 14,00, 
           LINE 4,00,
           LINES 1,33 ,
           SIZE 5,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-mese,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           MAX-TEXT 2,
           VALUE mese,
           AFTER PROCEDURE ef-num-AfterProcedure, 
           BEFORE PROCEDURE ef-num-BeforeProcedure, 
           .

      * LABEL
       05
           Screen1-Custom1-1, 
           Label, 
           COL 1,70, 
           LINE 5,33,
           LINES 1,39 ,
           SIZE 1,60 ,
           FONT IS Small-Font,
           ID IS 5,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * LABEL
       05
           Screen1-La-1, 
           Label, 
           COL 2,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,00 ,
           ID IS 1003,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Anno",
           .

      * LABEL
       05
           Screen1-La-2, 
           Label, 
           COL 2,00, 
           LINE 4,00,
           LINES 1,31 ,
           SIZE 12,00 ,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Mese",
           .

      * FRAME
       05
           Screen1-Fr-1, 
           Frame, 
           COL 1,00, 
           LINE 5,50,
           LINES 2,78 ,
           SIZE 18,60 ,
           LOWERED,
           ID IS 1,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           .

      * PUSH BUTTON
       05
           PB-ESEGUI, 
           Push-Button, 
           COL 3,40, 
           LINE 6,17,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-OK-BMP,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED 1,
           EXCEPTION-VALUE 1001,
           FLAT,
           ID IS 500,
           SELF-ACT,
           TERMINATION-VALUE 13,
           TITLE "E&segue il programma selezionato",
           AFTER PROCEDURE PB-ESEGUI-AfterProcedure, 
           BEFORE PROCEDURE PB-ESEGUI-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           pb-cancel, 
           Push-Button, 
           COL 11,30, 
           LINE 6,17,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-CANCEL-BMP,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED 1,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 501,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "&Esce dall'applicativo",
           AFTER PROCEDURE Form1-Pb-2-AfterProcedure, 
           BEFORE PROCEDURE Form1-Pb-2-BeforeProcedure, 
           .

      * LABEL
       05
           Screen1-blockpgm-1, 
           Label, 
           COL 10,90, 
           LINE 1,33,
           LINES 0,44 ,
           SIZE 4,00 ,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "BlockPgm",
           VISIBLE v-custom,
           .

      * FORM
       01 
           Screen2, 
           .

      * PUSH BUTTON
       05
           PB-ESEGUIa, 
           Push-Button, 
           COL 54,50, 
           LINE 2,00,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-OK-BMP,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED 1,
           EXCEPTION-VALUE 1000,
           FLAT,
           ID IS 500,
           SELF-ACT,
           TERMINATION-VALUE 13,
           TITLE "E&segue il programma selezionato",
           AFTER PROCEDURE PB-ESEGUIa-AfterProcedure, 
           BEFORE PROCEDURE PB-ESEGUIa-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           Form1-Pb-2a, 
           Push-Button, 
           COL 64,25, 
           LINE 2,00,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-CANCEL-BMP,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED 1,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 501,
           NO-AUTO-DEFAULT,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "&Esce dall'applicativo",
           AFTER PROCEDURE Form1-Pb-2a-AfterProcedure, 
           BEFORE PROCEDURE Form1-Pb-2a-BeforeProcedure, 
           .

      * GRID
       05
           gb-rec-b, 
           Grid, 
           COL 1,50, 
           LINE 7,00,
           LINES 34,50 ,
           SIZE 157,13 ,
           ADJUSTABLE-COLUMNS,
           BOXED,
           CENTERED-HEADINGS,
           DATA-COLUMNS (1, 2, 6, 14, 24, 64, 68, 76, 78, 82, 96, 97, 
           118, 128, 130, 133, 136, 149, 151),
           ALIGNMENT ("U", "R", "R", "C", "L", "U", "R", "R", "L", "R", 
           "C", "R", "C", "C", "C", "C", "R", "C", "C"),
           SEPARATION (5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
           5, 5, 5),
           DATA-TYPES ("x", "z(4)", "9(8)", "9(8)", "x(40)", "x(4)", "9(
      -    "8)", "9(2)", "x(4)", "9(8),999", "x", "x(21)", "9(8)", "x(2)
      -    "", "X(3)", "x(3)", "9(8)v99", "XX", "x"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           FONT IS Small-Font,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           ID IS 78-ID-gb-rec-b,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           ROW-HEADINGS,
           TILED-HEADINGS,
           VISIBLE 1,
           VPADDING 40,
           VSCROLL,
           EVENT PROCEDURE Screen2-Gd-1-Event-Proc,
           .

      * BAR
       05
           Screen2-Br-1a, 
           Bar,
           COL 38,00, 
           LINE 5,70,
           SIZE 121,00 ,
           ID IS 19,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * LABEL
       05
           Form1-La-1abbba, 
           Label, 
           COL 2,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 36,00 ,
           COLOR IS 80,
           ID IS 560,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TITLE "MOVIMENTAZIONE PRODOTTI ENERGETICI",
           .

      * LABEL
       05
           Form1-La-11, 
           Label, 
           COL 3,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,00 ,
           COLOR IS 5,
           FONT IS Verdana12B-Occidentale,
           ID IS 22,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Mese",
           .

      * LABEL
       05
           Form1-La-11a, 
           Label, 
           COL 11,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 3,13 ,
           COLOR IS 5,
           FONT IS Verdana12B-Occidentale,
           ID IS 23,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE mese,
           .

      * LABEL
       05
           Form1-La-11aa, 
           Label, 
           COL 30,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,13 ,
           COLOR IS 5,
           FONT IS Verdana12B-Occidentale,
           ID IS 24,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE anno,
           .

      * LABEL
       05
           Form1-La-11b, 
           Label, 
           COL 22,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,00 ,
           COLOR IS 5,
           FONT IS Verdana12B-Occidentale,
           ID IS 25,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Anno",
           .

      * LABEL
       05
           lbl-stato, 
           Label, 
           COL 2,50, 
           LINE 42,31,
           LINES 1,19 ,
           SIZE 30,00 ,
           COLOR IS col-stato-ordine,
           FONT IS Verdana10B-Occidentale,
           ID IS 5,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TITLE tit-stato-ordine,
           .

      * PUSH BUTTON
       05
           pb-grid-elimina, 
           Push-Button, 
           COL 74,88, 
           LINE 2,00,
           LINES 2,31 ,
           SIZE 10,13 ,
           BITMAP-HANDLE BOTTONE-ELIMINA-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1005,
           FLAT,
           FONT IS Small-Font,
           ID IS 1001,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           SELF-ACT,
           TITLE "&Elimina la riga selezionata",
           .

      * PUSH BUTTON
       05
           pb-grid-sel-tutto, 
           Push-Button, 
           COL 85,50, 
           LINE 2,00,
           LINES 2,31 ,
           SIZE 10,13 ,
           BITMAP-HANDLE SEL-TUTTO-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1001,
           FLAT,
           FONT IS Small-Font,
           ID IS 1002,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           SELF-ACT,
           AFTER PROCEDURE pb-grid-sel-tutto-AfterProcedure, 
           BEFORE PROCEDURE pb-grid-sel-tutto-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           pb-grid-desel-tutto, 
           Push-Button, 
           COL 95,50, 
           LINE 2,00,
           LINES 2,31 ,
           SIZE 10,13 ,
           BITMAP-HANDLE DESEL-TUTTO-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1002,
           FLAT,
           FONT IS Small-Font,
           ID IS 1003,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           SELF-ACT,
           AFTER PROCEDURE pb-grid-desel-tutto-AfterProcedure, 
           BEFORE PROCEDURE pb-grid-desel-tutto-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           pb-excell, 
           Push-Button, 
           COL 109,00, 
           LINE 1,88,
           LINES 2,19 ,
           SIZE 4,50 ,
           BITMAP-HANDLE EXCEL-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 2000,
           FLAT,
           FONT IS Small-Font,
           ID IS 15,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           SELF-ACT,
           TITLE "Esporta dati in CSV",
           AFTER PROCEDURE pb-excell-AfterProcedure, 
           BEFORE PROCEDURE pb-excell-BeforeProcedure, 
           .

      * BAR
       05
           Screen2-Br-1aa, 
           Bar,
           COL 54,00, 
           LINE 1,50,
           SIZE 52,00 ,
           ID IS 1004,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * BAR
       05
           Screen2-Br-1aaa, 
           Bar,
           COL 54,00, 
           LINE 4,50,
           SIZE 52,00 ,
           ID IS 1005,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * BAR
       05
           Screen2-Br-1aaaa, 
           Bar,
           COL 54,00, 
           LINE 1,50,
           LINES 3,00 ,
           ID IS 1006,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * BAR
       05
           Screen2-Br-1aaaaa, 
           Bar,
           COL 74,38, 
           LINE 1,50,
           LINES 3,00 ,
           ID IS 1007,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * BAR
       05
           Screen2-Br-1aaaaaa, 
           Bar,
           COL 85,00, 
           LINE 1,50,
           LINES 3,00 ,
           ID IS 1008,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * BAR
       05
           Screen2-Br-1aaaaaaa, 
           Bar,
           COL 105,75, 
           LINE 1,50,
           LINES 3,00 ,
           ID IS 1009,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (1),
           SHADING (-1),
           WIDTH 1,
           VISIBLE 1,
           .

      * ENTRY FIELD
       05
           ef-filtro-nc, 
           Entry-Field, 
           COL 86,00, 
           LINE 42,31,
           LINES 1,19 ,
           SIZE 10,00 ,
           BOXED,
           COLOR IS 513,
           FONT IS Small-Font,
           ID IS 1,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           PIC z(8),
           MAX-TEXT 8,
           NUMERIC,
           VALUE filtro-nc,
           AFTER PROCEDURE Screen2-Ef-1-AfterProcedure, 
           BEFORE PROCEDURE Screen2-Ef-1-BeforeProcedure, 
           .

      * LABEL
       05
           lbl-statoa, 
           Label, 
           COL 64,00, 
           LINE 42,31,
           LINES 1,19 ,
           SIZE 21,00 ,
           COLOR IS col-stato-ordine,
           FONT IS Verdana10B-Occidentale,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           TRANSPARENT,
           TITLE "Filtro su nomenclatura",
           .

      * LABEL
       05
           lbl-tot-importi, 
           Label, 
           COL 140,88, 
           LINE 1,38,
           LINES 1,00 ,
           SIZE 15,00 ,
           COLOR IS 5,
           FONT IS Verdana10B-Occidentale,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           TRANSPARENT,
           TITLE tot-importi-ed,
           .

      * LABEL
       05
           Form1-La-11c, 
           Label, 
           COL 123,13, 
           LINE 1,38,
           LINES 1,00 ,
           SIZE 17,00 ,
           COLOR IS 5,
           FONT IS Verdana10B-Occidentale,
           ID IS 4,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Totale Imposte:",
           .

      * LABEL
       05
           Form1-La-11ca, 
           Label, 
           COL 123,13, 
           LINE 3,13,
           LINES 1,00 ,
           SIZE 17,00 ,
           COLOR IS 481,
           FONT IS Verdana10B-Occidentale,
           ID IS 6,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Totale Kg carico:",
           .

      * LABEL
       05
           Form1-La-11caa, 
           Label, 
           COL 123,13, 
           LINE 4,38,
           LINES 1,00 ,
           SIZE 17,00 ,
           COLOR IS 400,
           FONT IS Verdana10B-Occidentale,
           ID IS 7,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Totale Kg scarico:",
           .

      * LABEL
       05
           lab-carico, 
           Label, 
           COL 140,88, 
           LINE 3,13,
           LINES 1,00 ,
           SIZE 15,00 ,
           COLOR IS 481,
           FONT IS Verdana10B-Occidentale,
           ID IS 8,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           TITLE lab-carico-buf,
           .

      * LABEL
       05
           lab-scarico, 
           Label, 
           COL 140,88, 
           LINE 4,38,
           LINES 1,00 ,
           SIZE 15,00 ,
           COLOR IS 400,
           FONT IS Verdana10B-Occidentale,
           ID IS 9,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           TITLE lab-scarico-buf,
           .

      * BAR
       05
           Screen2-Br-1, 
           Bar,
           COL 122,25, 
           LINE 1,13,
           LINES 4,56 ,
           ID IS 10,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           WIDTH 1,
           .

      * BAR
       05
           Screen2-Br-2, 
           Bar,
           COL 122,38, 
           LINE 2,69,
           SIZE 34,00 ,
           ID IS 11,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           WIDTH 1,
           .

      * BAR
       05
           Screen2-Br-2a, 
           Bar,
           COL 122,38, 
           LINE 1,13,
           SIZE 34,00 ,
           ID IS 12,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           WIDTH 1,
           .

      * BAR
       05
           Screen2-Br-1b, 
           Bar,
           COL 156,50, 
           LINE 1,13,
           LINES 4,63 ,
           ID IS 13,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           WIDTH 1,
           .

      * FORM
       01 
           form3, 
           .

      * LABEL
       05
           form3-La-1, 
           Label, 
           COL 1,57, 
           LINE 2,00,
           LINES 2,00 ,
           SIZE 51,86 ,
           FONT IS Verdana12BI-Occidentale,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "Esportazione dati in corso...",
           .

      * FORM
       01 
           scr-fine, 
           HELP-ID 1,
           .

      * FRAME
       05
           Screen1-Fr-1a, 
           Frame, 
           COL 2,10, 
           LINE 1,30,
           LINES 12,00 CELLS,
           SIZE 32,80 CELLS,
           RAISED,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           VERY-HEAVY,
           .

      * LABEL
       05
           scr-fine-La-4, 
           Label, 
           COL 5,20, 
           LINE 3,00,
           LINES 2,00 CELLS,
           SIZE 26,50 CELLS,
           ID IS 11,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "Movimenti UTF trattati",
           .

      * BAR
       05
           scr-fine-Br-1a, 
           Bar,
           COL 2,60, 
           LINE 3,80,
           SIZE 2,20 CELLS,
           ID IS 14,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (8, 8),
           SHADING (-1, 1),
           WIDTH 2,
           .

      * LABEL
       05
           scr-fine-La-4a, 
           Label, 
           COL 5,20, 
           LINE 6,30,
           LINES 2,00 CELLS,
           SIZE 26,50 CELLS,
           ID IS 6,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "Totale Record Esportati",
           .

      * LABEL
       05
           lbl-tot-fat, 
           Label, 
           COL 13,50, 
           LINE 9,30,
           LINES 2,00 CELLS,
           SIZE 10,00 CELLS,
           COLOR IS 5,
           ID IS 12,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE tot-mov,
           .

      * BAR
       05
           scr-fine-Br-1aa, 
           Bar,
           COL 32,20, 
           LINE 3,80,
           SIZE 2,20 CELLS,
           ID IS 13,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (8, 8),
           SHADING (-1, 1),
           WIDTH 2,
           .

      * PUSH BUTTON
       05
           pb-sia, 
           Push-Button, 
           COL 14,40, 
           LINE 13,90,
           LINES 29,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-OK-BMP,
           BITMAP-NUMBER 2,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 10,
           ESCAPE-BUTTON,
           .

      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE  DIVISION USING LK-BLOCKPGM, USER-CODI, LIVELLO-ABIL.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:invioedi, INIT:invioedi, BeforeDeclarative>
       TEDI-ERR SECTION.
           use after error procedure on TEDI.
           evaluate status-TEDI
           when "35"
                display message "File [TEDI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [TEDI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[TEDI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           when "93"
                initialize geslock-messaggio
                string   "File già in uso!"
                  x"0d0a""Impossibile procedere!" delimited size
                      into geslock-messaggio
                end-string
                move 0 to geslock-v-riprova
                move 0 to geslock-v-ignora
                move 1 to geslock-v-termina
                move   "TEDI"    to geslock-nome-file
                call   "geslock" using geslock-linkage
                cancel "geslock"
                set errori to true
                display message "Operazione interrotta!"
                        title titolo
                        icon 2
           when "99"
                set RecLocked to true
           end-evaluate.
      
      ***---
       PARAMEDI-ERR SECTION.
           use after error procedure on PARAMEDI.
           set tutto-ok  to true.
           evaluate status-PARAMEDI
           when "35"
                display message "File [PARAMEDI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [PARAMEDI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[PARAMEDI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
      
       EXP-EDI-ERR SECTION.
           use after error procedure on EXP-EDI.
           evaluate status-EXP-EDI
           when "35"
      *          display message "File [EXP-EDI] not found!"
      *                     title titolo
      *                      icon 3
                set errori to true
           when "39"
      *          display message "File [EXP-EDI] Mismatch size!"
      *                     title titolo
      *                      icon 3
                set errori to true
           when "98"
      *          display message "[EXP-EDI] Indexed file corrupt!"
      *                     title titolo
      *                      icon 3
                set errori to true
           when "93"
           when "99"
                set RecLocked to true
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM bprepb-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:invioedi, INIT:invioedi, BeforeDestroyResource>
      * <TOTEM:END>
           DESTROY Verdana12-Occidentale
           DESTROY Verdana12B-Occidentale
           DESTROY Verdana10B-Occidentale
           DESTROY Verdana10-Occidentale
           DESTROY Verdana12BI-Occidentale
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-OK-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-CANCEL-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-ELIMINA-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, SEL-TUTTO-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, DESEL-TUTTO-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, EXCEL-BMP
      *    After-Program
           PERFORM accetordforn-Ev-After-Program
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
           PERFORM invioedi-Ev-After-Init
           .
    
       INIT-FONT.
      * Verdana12-Occidentale
           INITIALIZE WFONT-DATA Verdana12-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12-Occidentale, WFONT-DATA

      * Verdana12B-Occidentale
           INITIALIZE WFONT-DATA Verdana12B-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO TRUE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12B-Occidentale, WFONT-DATA
      * Verdana10B-Occidentale
           INITIALIZE WFONT-DATA Verdana10B-Occidentale
           MOVE 10 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO TRUE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana10B-Occidentale, WFONT-DATA
      * Verdana10-Occidentale
           INITIALIZE WFONT-DATA Verdana10-Occidentale
           MOVE 10 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana10-Occidentale, WFONT-DATA
      * Verdana12BI-Occidentale
           INITIALIZE WFONT-DATA Verdana12BI-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO TRUE
           SET WFONT-ITALIC TO TRUE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12BI-Occidentale, WFONT-DATA
           .

       INIT-BMP.
      * PB-ESEGUI
           COPY RESOURCE "BOTTONE-OK.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-OK.BMP", 
                   GIVING BOTTONE-OK-BMP.
      * pb-cancel
           COPY RESOURCE "BOTTONE-CANCEL.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-CANCEL.BMP", 
                   GIVING BOTTONE-CANCEL-BMP.
      * pb-grid-elimina
           COPY RESOURCE "BOTTONE-ELIMINA.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-ELIMINA.BMP", 
                   GIVING BOTTONE-ELIMINA-BMP.
      * pb-grid-sel-tutto
           COPY RESOURCE "SEL-TUTTO.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "SEL-TUTTO.BMP", 
                   GIVING SEL-TUTTO-BMP.
      * pb-grid-desel-tutto
           COPY RESOURCE "DESEL-TUTTO.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "DESEL-TUTTO.BMP", 
                   GIVING DESEL-TUTTO-BMP.
      * pb-excell
           COPY RESOURCE "EXCEL.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "EXCEL.BMP", 
                   GIVING EXCEL-BMP.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-paramedi
      *    tedi OPEN MODE IS FALSE
      *    PERFORM OPEN-tedi
           PERFORM OPEN-redi
      *    exp-edi OPEN MODE IS FALSE
      *    PERFORM OPEN-exp-edi
           PERFORM OPEN-anautf
      *    lineseq OPEN MODE IS FALSE
      *    PERFORM OPEN-lineseq
      *    After Open
           .

       OPEN-paramedi.
      * <TOTEM:EPT. INIT:invioedi, FD:paramedi, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT paramedi
           IF NOT Valid-STATUS-paramedi
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:paramedi, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tedi.
      * <TOTEM:EPT. INIT:invioedi, FD:tedi, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O tedi
           IF STATUS-tedi = "35"
              OPEN OUTPUT tedi
                IF Valid-STATUS-tedi
                   CLOSE tedi
                   OPEN I-O tedi
                END-IF
           END-IF
           IF NOT Valid-STATUS-tedi
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:tedi, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-redi.
      * <TOTEM:EPT. INIT:invioedi, FD:redi, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O redi
           IF STATUS-redi = "35"
              OPEN OUTPUT redi
                IF Valid-STATUS-redi
                   CLOSE redi
                   OPEN I-O redi
                END-IF
           END-IF
           IF NOT Valid-STATUS-redi
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:redi, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-exp-edi.
      * <TOTEM:EPT. INIT:invioedi, FD:exp-edi, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT exp-edi
           IF NOT Valid-STATUS-exp-edi
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:exp-edi, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-anautf.
      * <TOTEM:EPT. INIT:invioedi, FD:anautf, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT anautf
           IF NOT Valid-STATUS-anautf
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:anautf, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-lineseq.
      * <TOTEM:EPT. INIT:invioedi, FD:lineseq, BeforeOpen>
      * <TOTEM:END>
           OPEN  OUTPUT lineseq
           IF NOT Valid-STATUS-lineseq
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:invioedi, FD:lineseq, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-paramedi
      *    tedi CLOSE MODE IS FALSE
      *    PERFORM CLOSE-tedi
           PERFORM CLOSE-redi
      *    exp-edi CLOSE MODE IS FALSE
      *    PERFORM CLOSE-exp-edi
           PERFORM CLOSE-anautf
      *    lineseq CLOSE MODE IS FALSE
      *    PERFORM CLOSE-lineseq
      *    After Close
           .

       CLOSE-paramedi.
      * <TOTEM:EPT. INIT:invioedi, FD:paramedi, BeforeClose>
      * <TOTEM:END>
           CLOSE paramedi
           .

       CLOSE-tedi.
      * <TOTEM:EPT. INIT:invioedi, FD:tedi, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-redi.
      * <TOTEM:EPT. INIT:invioedi, FD:redi, BeforeClose>
      * <TOTEM:END>
           CLOSE redi
           .

       CLOSE-exp-edi.
      * <TOTEM:EPT. INIT:invioedi, FD:exp-edi, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-anautf.
      * <TOTEM:EPT. INIT:invioedi, FD:anautf, BeforeClose>
      * <TOTEM:END>
           CLOSE anautf
           .

       CLOSE-lineseq.
      * <TOTEM:EPT. INIT:invioedi, FD:lineseq, BeforeClose>
      * <TOTEM:END>
           .

       DataSet1-paramedi-INITSTART.
           IF DataSet1-paramedi-KEY-Asc
              MOVE Low-Value TO pae-chiave OF paramedi
           ELSE
              MOVE High-Value TO pae-chiave OF paramedi
           END-IF
           .

       DataSet1-paramedi-INITEND.
           IF DataSet1-paramedi-KEY-Asc
              MOVE High-Value TO pae-chiave OF paramedi
           ELSE
              MOVE Low-Value TO pae-chiave OF paramedi
           END-IF
           .

      * paramedi
       DataSet1-paramedi-START.
           IF DataSet1-paramedi-KEY-Asc
              START paramedi KEY >= pae-chiave OF paramedi
           ELSE
              START paramedi KEY <= pae-chiave OF paramedi
           END-IF
           .

       DataSet1-paramedi-START-NOTGREATER.
           IF DataSet1-paramedi-KEY-Asc
              START paramedi KEY <= pae-chiave OF paramedi
           ELSE
              START paramedi KEY >= pae-chiave OF paramedi
           END-IF
           .

       DataSet1-paramedi-START-GREATER.
           IF DataSet1-paramedi-KEY-Asc
              START paramedi KEY > pae-chiave OF paramedi
           ELSE
              START paramedi KEY < pae-chiave OF paramedi
           END-IF
           .

       DataSet1-paramedi-START-LESS.
           IF DataSet1-paramedi-KEY-Asc
              START paramedi KEY < pae-chiave OF paramedi
           ELSE
              START paramedi KEY > pae-chiave OF paramedi
           END-IF
           .

       DataSet1-paramedi-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-paramedi-LOCK
              READ paramedi WITH LOCK 
              KEY pae-chiave OF paramedi
           ELSE
              READ paramedi WITH NO LOCK 
              KEY pae-chiave OF paramedi
           END-IF
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT 
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-paramedi-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-paramedi-KEY-Asc
              IF DataSet1-paramedi-LOCK
                 READ paramedi NEXT WITH LOCK
              ELSE
                 READ paramedi NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-paramedi-LOCK
                 READ paramedi PREVIOUS WITH LOCK
              ELSE
                 READ paramedi PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-paramedi-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-paramedi-KEY-Asc
              IF DataSet1-paramedi-LOCK
                 READ paramedi PREVIOUS WITH LOCK
              ELSE
                 READ paramedi PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-paramedi-LOCK
                 READ paramedi NEXT WITH LOCK
              ELSE
                 READ paramedi NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-paramedi-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-paramedi-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-paramedi-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-paramedi TO TOTEM-ERR-STAT
           MOVE "paramedi" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:paramedi, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tedi-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 MOVE Low-Value TO tedi-chiave
              ELSE
                 MOVE High-Value TO tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tedi-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 MOVE High-Value TO tedi-chiave
              ELSE
                 MOVE Low-Value TO tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tedi-KEY1-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tedi-KEY1-ORDER
           END-EVALUATE
           .

      * tedi
       DataSet1-tedi-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 START tedi KEY >= tedi-chiave
              ELSE
                 START tedi KEY <= tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tedi-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 START tedi KEY <= tedi-chiave
              ELSE
                 START tedi KEY >= tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tedi-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 START tedi KEY > tedi-chiave
              ELSE
                 START tedi KEY < tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tedi-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 START tedi KEY < tedi-chiave
              ELSE
                 START tedi KEY > tedi-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tedi-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-LOCK
                 READ tedi WITH LOCK 
                 KEY tedi-chiave
              ELSE
                 READ tedi WITH NO LOCK 
                 KEY tedi-chiave
              END-IF
           END-EVALUATE
           MOVE STATUS-tedi TO TOTEM-ERR-STAT 
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tedi-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 IF DataSet1-tedi-LOCK
                    READ tedi NEXT WITH LOCK
                 ELSE
                    READ tedi NEXT WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tedi-LOCK
                    READ tedi PREVIOUS WITH LOCK
                 ELSE
                    READ tedi PREVIOUS WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-tedi TO TOTEM-ERR-STAT
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tedi-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tedi-KEY1-Asc
                 IF DataSet1-tedi-LOCK
                    READ tedi PREVIOUS WITH LOCK
                 ELSE
                    READ tedi PREVIOUS WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tedi-LOCK
                    READ tedi NEXT WITH LOCK
                 ELSE
                    READ tedi NEXT WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-tedi TO TOTEM-ERR-STAT
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tedi-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeWrite>
      * <TOTEM:END>
           WRITE tedi-rec OF tedi.
           MOVE STATUS-tedi TO TOTEM-ERR-STAT
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tedi-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeRewrite>
      * <TOTEM:END>
           REWRITE tedi-rec OF tedi.
           MOVE STATUS-tedi TO TOTEM-ERR-STAT
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tedi-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, BeforeDelete>
      * <TOTEM:END>
           DELETE tedi.
           MOVE STATUS-tedi TO TOTEM-ERR-STAT
           MOVE "tedi" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tedi, AfterDelete>
      * <TOTEM:END>
           .

       redi-redi-k-tipo-mov-MERGE-SPLITBUF.
           INITIALIZE redi-redi-k-tipo-mov-SPLITBUF
           MOVE redi-tedi-chiave OF redi(1:6) TO 
           redi-redi-k-tipo-mov-SPLITBUF(1:6)
           MOVE redi-tipo-movim OF redi(1:1) TO 
           redi-redi-k-tipo-mov-SPLITBUF(7:1)
           MOVE redi-chiave-mov OF redi(1:19) TO 
           redi-redi-k-tipo-mov-SPLITBUF(8:19)
           .

       redi-redi-k-dt-mov-MERGE-SPLITBUF.
           INITIALIZE redi-redi-k-dt-mov-SPLITBUF
           MOVE redi-tedi-chiave OF redi(1:6) TO 
           redi-redi-k-dt-mov-SPLITBUF(1:6)
           MOVE redi-tipo-movim OF redi(1:1) TO 
           redi-redi-k-dt-mov-SPLITBUF(7:1)
           MOVE redi-data-movimento OF redi(1:8) TO 
           redi-redi-k-dt-mov-SPLITBUF(8:8)
           MOVE redi-tmo-chiave OF redi(1:12) TO 
           redi-redi-k-dt-mov-SPLITBUF(16:12)
           .

       DataSet1-redi-INITSTART.
           IF DataSet1-redi-KEY-Asc
              MOVE Low-Value TO redi-chiave OF redi
           ELSE
              MOVE High-Value TO redi-chiave OF redi
           END-IF
           .

       DataSet1-redi-INITEND.
           IF DataSet1-redi-KEY-Asc
              MOVE High-Value TO redi-chiave OF redi
           ELSE
              MOVE Low-Value TO redi-chiave OF redi
           END-IF
           .

      * redi
       DataSet1-redi-START.
           IF DataSet1-redi-KEY-Asc
              START redi KEY >= redi-chiave OF redi
           ELSE
              START redi KEY <= redi-chiave OF redi
           END-IF
           .

       DataSet1-redi-START-NOTGREATER.
           IF DataSet1-redi-KEY-Asc
              START redi KEY <= redi-chiave OF redi
           ELSE
              START redi KEY >= redi-chiave OF redi
           END-IF
           .

       DataSet1-redi-START-GREATER.
           IF DataSet1-redi-KEY-Asc
              START redi KEY > redi-chiave OF redi
           ELSE
              START redi KEY < redi-chiave OF redi
           END-IF
           .

       DataSet1-redi-START-LESS.
           IF DataSet1-redi-KEY-Asc
              START redi KEY < redi-chiave OF redi
           ELSE
              START redi KEY > redi-chiave OF redi
           END-IF
           .

       DataSet1-redi-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-redi-LOCK
              READ redi WITH LOCK 
              KEY redi-chiave OF redi
           ELSE
              READ redi WITH NO LOCK 
              KEY redi-chiave OF redi
           END-IF
           PERFORM redi-redi-k-tipo-mov-MERGE-SPLITBUF
           PERFORM redi-redi-k-dt-mov-MERGE-SPLITBUF
           MOVE STATUS-redi TO TOTEM-ERR-STAT 
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-redi-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-redi-KEY-Asc
              IF DataSet1-redi-LOCK
                 READ redi NEXT WITH LOCK
              ELSE
                 READ redi NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-redi-LOCK
                 READ redi PREVIOUS WITH LOCK
              ELSE
                 READ redi PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM redi-redi-k-tipo-mov-MERGE-SPLITBUF
           PERFORM redi-redi-k-dt-mov-MERGE-SPLITBUF
           MOVE STATUS-redi TO TOTEM-ERR-STAT
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-redi-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-redi-KEY-Asc
              IF DataSet1-redi-LOCK
                 READ redi PREVIOUS WITH LOCK
              ELSE
                 READ redi PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-redi-LOCK
                 READ redi NEXT WITH LOCK
              ELSE
                 READ redi NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM redi-redi-k-tipo-mov-MERGE-SPLITBUF
           PERFORM redi-redi-k-dt-mov-MERGE-SPLITBUF
           MOVE STATUS-redi TO TOTEM-ERR-STAT
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-redi-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeWrite>
      * <TOTEM:END>
           WRITE redi-rec OF redi.
           MOVE STATUS-redi TO TOTEM-ERR-STAT
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-redi-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeRewrite>
      * <TOTEM:END>
           REWRITE redi-rec OF redi.
           MOVE STATUS-redi TO TOTEM-ERR-STAT
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-redi-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:redi, BeforeDelete>
      * <TOTEM:END>
           DELETE redi.
           MOVE STATUS-redi TO TOTEM-ERR-STAT
           MOVE "redi" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:redi, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-INITSTART.
           .

       DataSet1-exp-edi-INITEND.
           .

       DataSet1-exp-edi-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-exp-edi-LOCK
              READ exp-edi WITH LOCK 
           ELSE
              READ exp-edi WITH NO LOCK 
           END-IF
           MOVE STATUS-exp-edi TO TOTEM-ERR-STAT 
           MOVE "exp-edi" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-exp-edi-KEY-Asc
              IF DataSet1-exp-edi-LOCK
                 READ exp-edi NEXT WITH LOCK
              ELSE
                 READ exp-edi NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-exp-edi TO TOTEM-ERR-STAT
           MOVE "exp-edi" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-exp-edi TO TOTEM-ERR-STAT
           MOVE "exp-edi" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-exp-edi TO TOTEM-ERR-STAT
           MOVE "exp-edi" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-exp-edi-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-exp-edi TO TOTEM-ERR-STAT
           MOVE "exp-edi" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:exp-edi, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-anautf-INITSTART.
           IF DataSet1-anautf-KEY-Asc
              MOVE Low-Value TO utf-chiave
           ELSE
              MOVE High-Value TO utf-chiave
           END-IF
           .

       DataSet1-anautf-INITEND.
           IF DataSet1-anautf-KEY-Asc
              MOVE High-Value TO utf-chiave
           ELSE
              MOVE Low-Value TO utf-chiave
           END-IF
           .

      * anautf
       DataSet1-anautf-START.
           IF DataSet1-anautf-KEY-Asc
              START anautf KEY >= utf-chiave
           ELSE
              START anautf KEY <= utf-chiave
           END-IF
           .

       DataSet1-anautf-START-NOTGREATER.
           IF DataSet1-anautf-KEY-Asc
              START anautf KEY <= utf-chiave
           ELSE
              START anautf KEY >= utf-chiave
           END-IF
           .

       DataSet1-anautf-START-GREATER.
           IF DataSet1-anautf-KEY-Asc
              START anautf KEY > utf-chiave
           ELSE
              START anautf KEY < utf-chiave
           END-IF
           .

       DataSet1-anautf-START-LESS.
           IF DataSet1-anautf-KEY-Asc
              START anautf KEY < utf-chiave
           ELSE
              START anautf KEY > utf-chiave
           END-IF
           .

       DataSet1-anautf-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-anautf-LOCK
              READ anautf WITH LOCK 
              KEY utf-chiave
           ELSE
              READ anautf WITH NO LOCK 
              KEY utf-chiave
           END-IF
           MOVE STATUS-anautf TO TOTEM-ERR-STAT 
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-anautf-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-anautf-KEY-Asc
              IF DataSet1-anautf-LOCK
                 READ anautf NEXT WITH LOCK
              ELSE
                 READ anautf NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-anautf-LOCK
                 READ anautf PREVIOUS WITH LOCK
              ELSE
                 READ anautf PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-anautf TO TOTEM-ERR-STAT
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-anautf-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-anautf-KEY-Asc
              IF DataSet1-anautf-LOCK
                 READ anautf PREVIOUS WITH LOCK
              ELSE
                 READ anautf PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-anautf-LOCK
                 READ anautf NEXT WITH LOCK
              ELSE
                 READ anautf NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-anautf TO TOTEM-ERR-STAT
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-anautf-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-anautf TO TOTEM-ERR-STAT
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-anautf-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-anautf TO TOTEM-ERR-STAT
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-anautf-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-anautf TO TOTEM-ERR-STAT
           MOVE "anautf" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:anautf, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-lineseq-INITSTART.
           .

       DataSet1-lineseq-INITEND.
           .

       DataSet1-lineseq-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadRecord>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadNext>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeWrite>
      * <TOTEM:END>
           WRITE line-riga OF lineseq.
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-INIT-RECORD.
           INITIALIZE pae-rec OF paramedi
           INITIALIZE tedi-rec OF tedi
           INITIALIZE redi-rec OF redi
           INITIALIZE rec-exe OF exp-edi
           INITIALIZE utf-rec OF anautf
           INITIALIZE line-riga OF lineseq
           .


      * GRID
       gb-rec-b-Content.
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 2, Y = 1,
                CELL-DATA = "Anno",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 3, Y = 1,
                CELL-DATA = "Num. Mov.",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 4, Y = 1,
                CELL-DATA = "Dt. Mov.",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 5, Y = 1,
                CELL-DATA = "Ragione Sociale",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 6, Y = 1,
                CELL-DATA = "CPA",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 7, Y = 1,
                CELL-DATA = "NC",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 8, Y = 1,
                CELL-DATA = "TARIC",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 9, Y = 1,
                CELL-DATA = "DAC",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 10, Y = 1,
                CELL-DATA = "Qta Kg",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 11, Y = 1,
                CELL-DATA = "Stoccaggio",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 12, Y = 1,
                CELL-DATA = "DDT",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 13, Y = 1,
                CELL-DATA = "del",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 14, Y = 1,
                CELL-DATA = "Naz.",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 15, Y = 1,
                CELL-DATA = "Pos. Fiscale",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 16, Y = 1,
                CELL-DATA = "Causale",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 17, Y = 1,
                CELL-DATA = "Imp.Consumo",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 18, Y = 1,
                CELL-DATA = "Stato",
      * CELLS' SETTING
              MODIFY gb-rec-b, X = 19, Y = 1,
                CELL-DATA = "Invio",
           .

      * FD's Initialize Paragraph
       DataSet1-paramedi-INITREC.
           INITIALIZE pae-rec OF paramedi
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tedi-INITREC.
           INITIALIZE tedi-rec OF tedi
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-redi-INITREC.
           INITIALIZE redi-rec OF redi
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-exp-edi-INITREC.
           INITIALIZE rec-exe OF exp-edi
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-anautf-INITREC.
           INITIALIZE utf-rec OF anautf
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-lineseq-INITREC.
           INITIALIZE line-riga OF lineseq
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 2 ALSO 0
                  PERFORM Screen2-Buf-To-Fld
           END-EVALUATE
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 7,28,
              SIZE 18,60,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Verdana12-Occidentale,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS Form1-Handle,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY Form1 UPON Form1-Handle
      * DISPLAY-COLUMNS settings
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Form1-Handle
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = 1001
                 PERFORM PB-ESEGUI-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1 UPON Form1-Handle
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
           accept como-data from century-date
           move como-data(1:4)  to anno
           move como-data(5:2)  to mese

           .
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.
           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           .             

       Form1-Restore-Status.
           .

       Screen2-Open-Routine.
           PERFORM Screen2-Scrn
           PERFORM Screen2-Proc
           .

       Screen2-Scrn.
           PERFORM Screen2-Create-Win
           PERFORM Screen2-Init-Value
           PERFORM Screen2-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM Screen2-DISPLAY
           .

       Screen2-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 43,00,
              SIZE 158,00,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Verdana10-Occidentale,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE TITOLO,
              WITH SYSTEM MENU,
              USER-GRAY,
           VISIBLE 0,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen2-Event-Proc,
              HANDLE IS Screen2-Handle,
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY Screen2 UPON Screen2-Handle
      * DISPLAY-COLUMNS settings
              MODIFY gb-rec-b, DISPLAY-COLUMNS (1, 4, 12, 22, 34, 81, 
           87, 97, 104, 112, 122, 132, 144, 156, 161, 173, 181, 195, 
           202)
           .

       Screen2-PROC.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeAccept>
           inquire ef-anno, value in anno.
           move anno to tedi-anno.
           inquire ef-mese,  value in mese.
           move mese to tedi-mese.
           perform READ-RECORD-LOCK
           if errori
              move 27  to key-status
           else
              perform SCREEN2-BEFOREACCEPT
           end-if

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Screen2
                 ON EXCEPTION
                    PERFORM Screen2-Evaluate-Func
                 MOVE 2 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Screen2-Handle
           INITIALIZE Key-Status
           .

       Screen2-Evaluate-Func.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Screen2-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Screen2-Exit
                 END-IF
              WHEN Key-Status = 1000
                 PERFORM PB-ESEGUIa-LinkTo
              WHEN Key-Status = 1005
                 PERFORM pb-grid-elimina-LinkTo
              WHEN Key-Status = 1001
                 PERFORM pb-grid-sel-tutto-LinkTo
              WHEN Key-Status = 1002
                 PERFORM pb-grid-desel-tutto-LinkTo
              WHEN Key-Status = 2000
                 PERFORM pb-excell-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Screen2-CLEAR.
           PERFORM Screen2-INIT-VALUE
           PERFORM Screen2-DISPLAY
           .

       Screen2-DISPLAY.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Screen2 UPON Screen2-Handle
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterDisplay>
      *<<** Customized_Default, SP-G, Screen1-blockpgm-1, Disable **>>

           .
      * <TOTEM:END>
           .

       Screen2-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Screen2-Init-Data.
           MOVE 2 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM gb-rec-b-Content
           .

       Screen2-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Screen2-DataSet1-Update-Key
           .

       Screen2-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tedi-KEY1-ORDER
           END-EVALUATE
           PERFORM Screen2-DataSet1-Update-Key
           .

       Screen2-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tedi-KEY1-ORDER
           END-EVALUATE
           PERFORM Screen2-DataSet1-Update-Key
           .

       Screen2-DataSet1-Update-Key.
           MOVE tedi-rec OF tedi TO
                     Screen2-MULKEY-TMPBUF
           PERFORM Screen2-CLEAR
           PERFORM Screen2-INIT-DATA
           MOVE Screen2-MULKEY-TMPBUF TO
                     tedi-rec OF tedi
           PERFORM DataSet1-tedi-Read
           PERFORM Screen2-DUPLICATE-MOVEKEY
           PERFORM Screen2-DUMMY-CURR
           PERFORM Screen2-IUD-Display
           .

       Screen2-DUPLICATE-MOVEKEY.
           .

       Screen2-First.
           PERFORM Screen2-DUMMY-FIRST
           PERFORM DataSet1-tedi-INITSTART
           PERFORM DataSet1-tedi-START
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-tedi-Read-Next
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterFirst>
      * <TOTEM:END>
           PERFORM Screen2-DUPLICATE-MOVEKEY.
           PERFORM Screen2-IUD-Display
           .

       Screen2-Previous.
              PERFORM Screen2-Buf-To-Fld
              PERFORM DataSet1-tedi-START-LESS
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-tedi-Read-Prev
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterPrevious>
      * <TOTEM:END>
           PERFORM Screen2-DUPLICATE-MOVEKEY
           PERFORM Screen2-DUMMY-PREVIOUS
           PERFORM Screen2-IUD-Display
           .

       Screen2-Next.
              PERFORM Screen2-Buf-To-Fld
              PERFORM DataSet1-tedi-START-GREATER
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-tedi-Read-Next
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterNext>
      * <TOTEM:END>
           PERFORM Screen2-DUPLICATE-MOVEKEY
           PERFORM Screen2-DUMMY-NEXT
           PERFORM Screen2-IUD-Display
           .
      
       Screen2-Last.
           PERFORM Screen2-DUMMY-LAST
           PERFORM DataSet1-tedi-INITEND
           PERFORM DataSet1-tedi-START-NOTGREATER
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-tedi-Read-Prev
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterLast>
      * <TOTEM:END>
           PERFORM Screen2-DUPLICATE-MOVEKEY.
           PERFORM Screen2-IUD-Display
           .

       Screen2-Curr.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Screen2-Buf-To-Fld
           PERFORM DataSet1-tedi-Read
           PERFORM Screen2-DUPLICATE-MOVEKEY
           PERFORM Screen2-DUMMY-CURR
           PERFORM Screen2-IUD-Display
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterCurrent>
      * <TOTEM:END>
           .

       Screen2-IUD-Display.
           IF Valid-STATUS-tedi
              PERFORM Screen2-ALLGRID-RESET
              PERFORM Screen2-Fld-To-Buf
              PERFORM Screen2-NAVI-FOR-MASTERGRID
              PERFORM Screen2-DISPLAY
           ELSE
              IF Screen2-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Screen2-Extended-File-Status
              END-IF
           END-IF
           .

       Screen2-Add.
           PERFORM Screen2-Buf-To-Fld
           PERFORM Screen2-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Screen2-DUMMY-ADD
           PERFORM DataSet1-tedi-INITREC
           PERFORM Screen2-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tedi-Rec-Write
           IF Valid-STATUS-tedi
              PERFORM Screen2-RESUMMARY-INS
              PERFORM Screen2-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Screen2-IUD-Display
           END-IF
           PERFORM Screen2-ERR-CHECKING
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterAdd>
      * <TOTEM:END>
           .
     
       Screen2-Update.
           PERFORM Screen2-Buf-To-Fld
           PERFORM DataSet1-tedi-START              
           IF NOT Valid-STATUS-tedi
              PERFORM Screen2-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-tedi-Read
           PERFORM Screen2-Buf-To-Fld
           PERFORM Screen2-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Screen2-DUMMY-UPDATE
           PERFORM Screen2-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tedi-Rec-Rewrite
           IF Valid-STATUS-tedi
              PERFORM Screen2-RESUMMARY-DEL
              PERFORM Screen2-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Screen2-IUD-Display
           END-IF
           PERFORM Screen2-ERR-CHECKING
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterUpdate>
      * <TOTEM:END>
           .

       Screen2-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeDelete>
      * <TOTEM:END>
           PERFORM Screen2-DUMMY-DELETE
      * delete
           PERFORM Screen2-Buf-To-Fld
           PERFORM DataSet1-tedi-Rec-Delete
           IF Valid-STATUS-tedi
              PERFORM Screen2-CLEAR
              PERFORM Screen2-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to STATUS-tedi
           END-IF
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterDelete>
      * <TOTEM:END>
           PERFORM Screen2-ERR-CHECKING
           .

       Screen2-NAVI-FOR-MASTERGRID.
           .

       Screen2-ERR-CHECKING.
           IF Valid-STATUS-tedi
              PERFORM Screen2-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Screen2-Extended-File-Status
           END-IF
           .

       Screen2-RESUMMARY-INS.
           .

       Screen2-RESUMMARY-DEL.
           .


       Screen2-DUMMY-FIRST.
           .

       Screen2-DUMMY-PREVIOUS.
           .

       Screen2-DUMMY-NEXT.
           .

       Screen2-DUMMY-LAST.
           .

       Screen2-DUMMY-CURR.
           .

       Screen2-DUMMY-ADD.
           .

       Screen2-DUMMY-UPDATE.
           .

       Screen2-DUMMY-UPDATE-INIT.
           .

       Screen2-DUMMY-DELETE.
           .

       Screen2-DUMMY-DELETE-INIT.
           .

       Screen2-Init-Value.
      * FORM : Screen2
           PERFORM DataSet1-INIT-RECORD
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, SetDefault>
      * <TOTEM:END>
           PERFORM Screen2-FLD-TO-BUF
           .


       Screen2-ALLGRID-RESET.
           .

      * for Form's Validation
       Screen2-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       Screen2-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterBufToFld>
      * <TOTEM:END>
           .

       Screen2-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Screen2, FORM:Screen2, AfterFldToBuf>
      * <TOTEM:END>
           .

       Screen2-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Screen2-BUF-TO-FLD.
           move 0 to scelta.
           .
       Screen2-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Screen2-SHOW-MSG-ROUTINE
           .

       Screen2-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Screen2-DISPLAY-MESSAGE
           .

       Screen2-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Screen2-Save-Status.
           MOVE DataSet1-tedi-KEY1-ORDER TO TMP-Screen2-KEY1-ORDER
           MOVE DataSet1-KEYIS TO TMP-Screen2-KEYIS
           MOVE tedi-rec OF tedi TO 
              TMP-Screen2-tedi-RESTOREBUF
           .             

       Screen2-Restore-Status.
           MOVE TMP-Screen2-KEY1-ORDER TO DataSet1-tedi-KEY1-ORDER
           MOVE TMP-Screen2-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Screen2-tedi-RESTOREBUF TO
              tedi-rec OF tedi
           PERFORM DataSet1-tedi-START
           IF Valid-STATUS-tedi
              PERFORM DataSet1-tedi-Read-Next
           ELSE
              PERFORM DataSet1-tedi-INITREC
           END-IF
           PERFORM UNTIL NOT Valid-STATUS-tedi OR
              (Valid-STATUS-tedi AND
                 tedi-rec OF tedi = 
                   TMP-Screen2-tedi-RESTOREBUF)
              PERFORM DataSet1-tedi-Read-Next
           END-PERFORM
           .

       form3-Open-Routine.
           PERFORM form3-Scrn
           PERFORM form3-Proc
           .

       form3-Scrn.
           PERFORM form3-Create-Win
           PERFORM form3-Init-Value
           PERFORM form3-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM form3-DISPLAY
           .

       form3-Create-Win.
           Display Floating GRAPHICAL WINDOW
              LINES 3,00,
              SIZE 53,14,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE form3-Event-Proc,
              HANDLE IS form3-Handle,
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY form3 UPON form3-Handle
      * DISPLAY-COLUMNS settings
           .

       form3-PROC.
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeAccept>
           perform EXP-DATI
           perform FORM3-EXIT

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT OMITTED LINE 1 COL 1
                 ON EXCEPTION
                    PERFORM form3-Evaluate-Func
                 MOVE 3 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY form3-Handle
           INITIALIZE Key-Status
           .

       form3-Evaluate-Func.
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM form3-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM form3-Exit
                 END-IF
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       form3-CLEAR.
           PERFORM form3-INIT-VALUE
           PERFORM form3-DISPLAY
           .

       form3-DISPLAY.
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY form3 UPON form3-Handle
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterDisplay>
      *<<** Customized_Default, SP-G, Screen1-blockpgm-1, Disable **>>

           .
      * <TOTEM:END>
           .

       form3-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       form3-Init-Data.
           MOVE 3 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
           .

       form3-Init-Value.
      * <TOTEM:EPT. FORM:form3, FORM:form3, SetDefault>
      * <TOTEM:END>
           PERFORM form3-FLD-TO-BUF
           .


       form3-ALLGRID-RESET.
           .

      * for Form's Validation
       form3-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       form3-Buf-To-Fld.
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterBufToFld>
      * <TOTEM:END>
           .

       form3-Fld-To-Buf.
      * <TOTEM:EPT. FORM:form3, FORM:form3, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:form3, FORM:form3, AfterFldToBuf>
      * <TOTEM:END>
           .

       form3-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform form3-BUF-TO-FLD.
           move 0 to scelta.
           .
       form3-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM form3-SHOW-MSG-ROUTINE
           .

       form3-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM form3-DISPLAY-MESSAGE
           .

       form3-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       form3-Save-Status.
           .             

       form3-Restore-Status.
           .

       scr-fine-Open-Routine.
           PERFORM scr-fine-Scrn
           PERFORM scr-fine-Proc
           .

       scr-fine-Scrn.
           PERFORM scr-fine-Create-Win
           PERFORM scr-fine-Init-Value
           PERFORM scr-fine-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM scr-fine-DISPLAY
           .

       scr-fine-Create-Win.
           Display Floating GRAPHICAL WINDOW
              LINES 17,10,
              SIZE 35,00,
              CELL HEIGHT 10,
              CELL WIDTH 10,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              ERASE,
              CONTROL FONT Verdana12-Occidentale,
              LABEL-OFFSET 0,
              LINK TO THREAD,
              MODELESS,
              RESIZABLE,
              NO SCROLL,
              TITLE-BAR,
              TITLE "Operazione conclusa - Riepilogo",
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              HANDLE IS scr-fine-SF-HANDLE,
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY scr-fine UPON scr-fine-SF-HANDLE
      * DISPLAY-COLUMNS settings
           .

       scr-fine-PROC.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeAccept>
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT scr-fine
                 ON EXCEPTION
                    PERFORM scr-fine-Evaluate-Func
                 MOVE 4 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY scr-fine-SF-HANDLE
           INITIALIZE Key-Status
           .

       scr-fine-Evaluate-Func.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM scr-fine-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM scr-fine-Exit
                 END-IF
              WHEN Key-Status = 27
                 PERFORM pb-si-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       scr-fine-CLEAR.
           PERFORM scr-fine-INIT-VALUE
           PERFORM scr-fine-DISPLAY
           .

       scr-fine-DISPLAY.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY scr-fine UPON scr-fine-SF-HANDLE
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       scr-fine-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       scr-fine-Init-Data.
           MOVE 4 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
           .

       scr-fine-Init-Value.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, SetDefault>
      * <TOTEM:END>
           PERFORM scr-fine-FLD-TO-BUF
           .


       scr-fine-ALLGRID-RESET.
           .

      * for Form's Validation
       scr-fine-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       scr-fine-Buf-To-Fld.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterBufToFld>
      * <TOTEM:END>
           .

       scr-fine-Fld-To-Buf.
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:scr-fine, FORM:scr-fine, AfterFldToBuf>
      * <TOTEM:END>
           .

       scr-fine-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform scr-fine-BUF-TO-FLD.
           move 0 to scelta.
           .
       scr-fine-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM scr-fine-SHOW-MSG-ROUTINE
           .

       scr-fine-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM scr-fine-DISPLAY-MESSAGE
           .

       scr-fine-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       scr-fine-Save-Status.
           .             

       scr-fine-Restore-Status.
           .



       Screen1-Event-Proc.
           .

       Screen2-Event-Proc.
           .

       Screen2-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM gb-rec-b-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5001 ALSO
                    Screen2-Handle 
              PERFORM Screen2-Gd-1-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

       form3-Event-Proc.
           .

      * USER DEFINE PARAGRAPH
       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "utydata.cpy".
           copy "color-custom.cpy".
           copy "invioedi-procedure.cpy".
           copy "common-excel.cpy" 
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       bprepb-Ev-Before-Program.
      * <TOTEM:PARA. bprepb-Ev-Before-Program>
      *     accept blocco from environment "EDI-BLOCCATO"
      *     if blocco = "1"
      *        SET LK-BL-CANCELLAZIONE TO TRUE
      *        CALL "BLOCKPGM"  USING LK-BLOCKPGM
      *        goback
      *     end-if
           move LK-BL-PROG-ID    TO COMO-PROG-ID.

           INITIALIZE WFONT-DATA, font-evidenzia-griglia
           MOVE 10                TO WFONT-SIZE
           MOVE "Arial"           TO WFONT-NAME
           SET WFONT-BOLD         TO true
           SET WFONT-ITALIC       TO true
           SET WFONT-UNDERLINE    TO FALSE
           SET WFONT-STRIKEOUT    TO FALSE
           SET WFONT-FIXED-PITCH  TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     font-evidenzia-griglia, WFONT-DATA

           copy resource "..\..\RESOURCE\elemento.bmp".
           call "W$BITMAP" using wbitmap-load, "elemento.bmp"
                          giving elemento-bmp 
           copy resource "..\..\RESOURCE\conferma.bmp".
           call "W$BITMAP" using wbitmap-load, "conferma.bmp"
                          giving conferma-handle 
           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-Begin-Entry>
           evaluate colonna
      *     when 78-col-anno          
      *     when 78-col-registro      
      *     when 78-col-progressivo   
           when 78-col-anno-tmo
           when 78-col-num-tmo
           when 78-col-data-mov
           when 78-col-ragsoc        
           when 78-col-cpa
           when 78-col-nc
           when 78-col-taric
           when 78-col-dac
           when 78-col-nazione
           when 78-col-stato
           when 78-col-cau
           when 78-col-pos-fiscale
                set event-action to event-action-fail
           when 78-col-kg
                perform CONTROLLA-MOD
                if procedi
                   set environment "KEYSTROKE" to "DATA=44 46"
                   move redi-qta-kg to old-kg
                else
                   set event-action to event-action-fail      
                end-if
           when 78-col-consumo
                perform CONTROLLA-MOD
                if procedi
                   set environment "KEYSTROKE" to "DATA=44 46"
                   move redi-imp-consumo to como-redi-imp-consumo
                else
                   set event-action to event-action-fail      
                end-if
           when 78-col-stoccaggio
      *     when 78-col-pos-fiscale
           when 78-col-ddt
           when 78-col-data-ddt
                perform CONTROLLA-MOD
                if procedi
                   continue
                else
                   set event-action to event-action-fail      
                end-if
           when 78-col-invio
                perform CAMBIA-BITMAP
                set event-action to event-action-fail
           end-evaluate

           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-End-Drag.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-End-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       Screen2-Gd-1-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. Screen2-Gd-1-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       ef-anno-BeforeProcedure.
      * <TOTEM:PARA. ef-anno-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-anno-AfterProcedure.
      * <TOTEM:PARA. ef-anno-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       ef-num-BeforeProcedure.
      * <TOTEM:PARA. ef-num-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-num-AfterProcedure.
      * <TOTEM:PARA. ef-num-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           inquire ef-mese, VALUE mese
           if mese > 12 or mese = zero
              set errori to true
              display message "Mese NON valido"
                        title tit-err
                         icon 2
              move 78-id-ef-mese   to control-id
              move 4   to accept-control
           end-if 
              
           .
      * <TOTEM:END>
       PB-ESEGUIa-LinkTo.
      * <TOTEM:PARA. PB-ESEGUIa-LinkTo>
           display message "S'intende procedere con l'esportazione"
                    x"0d0a""dei dati UTF verso l'esterno?"
                     title titolo
                      type mb-yes-no
                      icon 2
                   default mb-no
                    giving scelta
      
           if scelta = mb-yes           

              initialize FILE-INFO
              CALL "C$FILEINFO" USING pae-path-file-invio, FILE-INFO, 
                    GIVING STATUS-CODE
              
              if file-size not = zero
                 display message 
                         "E' presente un'esportazione precedente"
                  X"0d0a""in attesa di essere elaborata."
                  X"0d0a""Tutti i dati presenti andranno persi e."
                  X"0d0a""sostituiti con quelli a video."
                  x"0d0a""S'intende procedere comunque?"
                          title titolo
                           type mb-yes-no
                           icon 2
                        default mb-no
                         giving scelta
              
              end-if
           end-if
           if scelta = mb-yes           
              perform FORM3-OPEN-ROUTINE
              move 27 to key-status
           end-if 
           .
      * <TOTEM:END>
       PB-ESEGUIa-BeforeProcedure.
      * <TOTEM:PARA. PB-ESEGUIa-BeforeProcedure>
           modify PB-ESEGUIa, bitmap-number 2
           .
      * <TOTEM:END>
       PB-ESEGUIa-AfterProcedure.
      * <TOTEM:PARA. PB-ESEGUIa-AfterProcedure>
           modify PB-ESEGUIa, bitmap-number 1
           .
      * <TOTEM:END>
       Form1-Pb-2a-BeforeProcedure.
      * <TOTEM:PARA. Form1-Pb-2a-BeforeProcedure>
           modify Form1-Pb-2a, bitmap-number 2
           .
      * <TOTEM:END>
       Form1-Pb-2a-AfterProcedure.
      * <TOTEM:PARA. Form1-Pb-2a-AfterProcedure>
           modify Form1-Pb-2a, bitmap-number 1
           .
      * <TOTEM:END>
       PB-ESEGUI-BeforeProcedure.
      * <TOTEM:PARA. PB-ESEGUI-BeforeProcedure>
           modify PB-ESEGUI, bitmap-number 2 
           .
      * <TOTEM:END>
       PB-ESEGUI-AfterProcedure.
      * <TOTEM:PARA. PB-ESEGUI-AfterProcedure>
           modify PB-ESEGUI, bitmap-number 1 
           .
      * <TOTEM:END>
       PB-ESEGUI-LinkTo.
      * <TOTEM:PARA. PB-ESEGUI-LinkTo>
           set tutto-ok to true.
           inquire ef-anno, value in anno.
           move anno to tedi-anno.
           inquire ef-mese,  value in mese.
           move mese to tedi-mese.
           read tedi no lock
              invalid 
                 set errori to true
                 display message "Dati EDI non caricati"
                           title tit-err
                            icon 2
           end-read.
      
           perform CANCELLA-COLORE.
           if tutto-ok
              modify Form1-Handle, visible false
              perform SCREEN2-OPEN-ROUTINE     
              unlock tedi all records
              modify Form1-Handle, visible true
              move 1001 to control-id
           else                      
              move 1002 to control-id
           end-if.  
                                     
           move    4 to accept-control.
           
           modify pb-esegui, bitmap-number = 1.
           modify pb-cancel, bitmap-number = 1 
           .
      * <TOTEM:END>
       Form1-Pb-2-BeforeProcedure.
      * <TOTEM:PARA. Form1-Pb-2-BeforeProcedure>
           modify pb-cancel, bitmap-number 2 
           .
      * <TOTEM:END>
       Form1-Pb-2-AfterProcedure.
      * <TOTEM:PARA. Form1-Pb-2-AfterProcedure>
           modify pb-cancel, bitmap-number 1 
           .
      * <TOTEM:END>
       accetordforn-Ev-After-Program.
      * <TOTEM:PARA. accetordforn-Ev-After-Program>
           SET LK-BL-CANCELLAZIONE TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           call "W$BITMAP" using wbitmap-destroy, elemento-bmp 

           close tedi
           .
      * <TOTEM:END>
       pb-grid-elimina-LinkTo.
      * <TOTEM:PARA. pb-grid-elimina-LinkTo>
           inquire gb-rec-b(riga, 2) hidden-data = redi-chiave.


           perform CONTROLLA-CANC
           if procedi
              read redi no lock
                 invalid
                    move zero   to redi-imp-consumo
              end-read
              subtract redi-imp-consumo  from tot-importi
              move tot-importi to tot-importi-ed
              modify lbl-tot-importi, TITLE tot-importi-ed

              delete redi record
                 invalid 
                    continue
              end-delete

              modify gb-rec-b, RECORD-TO-DELETE riga

              perform X-Y
              move riga   to event-data-2
              move zero   to riga
              perform SPOSTAMENTO
              modify gb-rec-b, CURSOR-Y  riga
           end-if 
           .
      * <TOTEM:END>
       gb-rec-b-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. gb-rec-b-Ev-Msg-Finish-Entry>
           set tutto-ok to true.
           perform X-Y.
           perform VALORE-RIGA.

           evaluate colonna
      *     when 78-col-anno          
      *     when 78-col-registro      
      *     when 78-col-progressivo   
           when 78-col-anno-tmo
           when 78-col-num-tmo
           when 78-col-ragsoc        
           when 78-col-cpa
           when 78-col-nc
           when 78-col-taric
           when 78-col-dac
           when 78-col-nazione
           when 78-col-stato
                continue

           when 78-col-kg
                perform CONTROLLO-RIGA
                modify  gb-rec-b(riga, 78-col-kg), cell-data col-kg
                inquire gb-rec-b(riga, 1), hidden-data como-tipo-mov
                if como-carico
                   compute tot-carico = tot-carico - 
                                        old-kg +
                                        redi-qta-kg
                   move tot-carico to lab-carico-buf
                   display lab-carico
                else
                   compute tot-scarico = tot-scarico - 
                                         old-kg +
                                         redi-qta-kg
                   move tot-scarico to lab-scarico-buf
                   display lab-scarico
                end-if

           when 78-col-consumo
                perform CONTROLLO-RIGA
                modify gb-rec-b(riga, 78-col-consumo), 
                                                  cell-data col-consumo
                compute tot-importi = tot-importi           - 
                                      como-redi-imp-consumo +
                                      redi-imp-consumo
                move tot-importi to tot-importi-ed
                modify lbl-tot-importi, TITLE tot-importi-ed
           when 78-col-data-ddt
                perform CONTROLLO-RIGA
                modify gb-rec-b(riga, 78-col-data-ddt), 
                                                  cell-data col-data-ddt
           when 78-col-stoccaggio
           when 78-col-pos-fiscale
           when 78-col-ddt
                perform CONTROLLO-RIGA
           end-evaluate.

           if errori
              move 78-ID-gb-rec-b  to store-id
              set event-action     to event-action-fail
           else
              set environment "KEYSTROKE" to "DATA=44 44"
              set environment "KEYSTROKE" to "DATA=46 46"
              perform SALVA-RIGA

              evaluate colonna
              when 78-col-kg
              when 78-col-consumo
              when 78-col-data-ddt
              when 78-col-ddt
                   perform MSG-SINCRO      
              end-evaluate
           end-if 
           .
      * <TOTEM:END>
       pb-si-LinkTo.
      * <TOTEM:PARA. pb-si-LinkTo>
           .
      * <TOTEM:END>
       invioedi-Ev-After-Init.
      * <TOTEM:PARA. invioedi-Ev-After-Init>
           open i-o tedi
           if status-tedi not = zero
              perform EXIT-STOP-ROUTINE
              SET LK-BL-CANCELLAZIONE TO TRUE
              MOVE COMO-PROG-ID       TO LK-BL-PROG-ID
              CALL "BLOCKPGM"  USING LK-BLOCKPGM
              goback
           end-if 
           .
      * <TOTEM:END>
       pb-grid-sel-tutto-BeforeProcedure.
      * <TOTEM:PARA. pb-grid-sel-tutto-BeforeProcedure>
           modify pb-grid-sel-tutto, BITMAP-NUMBER 2
           .
      * <TOTEM:END>
       pb-grid-sel-tutto-AfterProcedure.
      * <TOTEM:PARA. pb-grid-sel-tutto-AfterProcedure>
           modify pb-grid-sel-tutto, BITMAP-NUMBER 1
           .
      * <TOTEM:END>
       pb-grid-desel-tutto-BeforeProcedure.
      * <TOTEM:PARA. pb-grid-desel-tutto-BeforeProcedure>
           modify pb-grid-desel-tutto, BITMAP-NUMBER 2
           .
      * <TOTEM:END>
       pb-grid-desel-tutto-AfterProcedure.
      * <TOTEM:PARA. pb-grid-desel-tutto-AfterProcedure>
           modify pb-grid-desel-tutto, BITMAP-NUMBER 1
           .
      * <TOTEM:END>
       pb-grid-sel-tutto-LinkTo.
      * <TOTEM:PARA. pb-grid-sel-tutto-LinkTo>
           inquire gb-rec-b last-row tot-righe

           perform varying riga from 2 by 1 until riga > tot-righe
              move 1   to num-bitmap
              modify gb-rec-b(riga, 78-col-invio) 
                                            hidden-data = num-bitmap
              modify gb-rec-b(riga, 78-col-invio) 
                                            bitmap = conferma-handle
                                            bitmap-width = 19
                                            bitmap-number = num-bitmap
           end-perform


           .
      * <TOTEM:END>
       pb-grid-desel-tutto-LinkTo.
      * <TOTEM:PARA. pb-grid-desel-tutto-LinkTo>
           inquire gb-rec-b last-row tot-righe

           perform varying riga from 2 by 1 until riga > tot-righe
              move 2   to num-bitmap
              modify gb-rec-b(riga, 78-col-invio) 
                                            hidden-data = num-bitmap
              modify gb-rec-b(riga, 78-col-invio) 
                                            bitmap = conferma-handle
                                            bitmap-width = 19
                                            bitmap-number = num-bitmap
           end-perform


           .
      * <TOTEM:END>
       Screen2-Ef-1-BeforeProcedure.
      * <TOTEM:PARA. Screen2-Ef-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           move filtro-nc to old-filtro-nc
           .
      * <TOTEM:END>
       Screen2-Ef-1-AfterProcedure.
      * <TOTEM:PARA. Screen2-Ef-1-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           if filtro-nc not = old-filtro-nc
              perform LOAD-REDI
           end-if 
           .
      * <TOTEM:END>
       pb-excell-BeforeProcedure.
      * <TOTEM:PARA. pb-excell-BeforeProcedure>
           modify pb-excell, BITMAP-NUMBER 2           
           .
      * <TOTEM:END>
       pb-excell-AfterProcedure.
      * <TOTEM:PARA. pb-excell-AfterProcedure>
           modify pb-excell, BITMAP-NUMBER 1
           .
      * <TOTEM:END>
       pb-excell-LinkTo.
      * <TOTEM:PARA. pb-excell-LinkTo>
           initialize opensave-data.
           accept opnsav-default-dir from environment "PATH_ST".
                                    
           move "CSV files (*.csv)" to opnsav-filters.
           move "Salva file"        to opnsav-title.
           call "C$OPENSAVEBOX"  using 3, opensave-data
                                giving opensave-status.

           if opensave-status = 1
              perform SALVA-EXCELL
           end-if.
           modify pb-excell, bitmap-number 1 
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

