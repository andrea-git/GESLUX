      *{TOTEM}PRG-COMMENT
      * lab-gpromo.Cbl
      * lab-gpromo.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          lab-gpromo.
       AUTHOR.              andre.
       DATE-WRITTEN.        martedì 16 maggio 2023 18:36:23.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:lab-gpromo, INIT:lab-gpromo, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "destini.sl".
           COPY "articoli.sl".
           COPY "rpromo.sl".
           COPY "tgrupgdo.sl".
           COPY "tpromo.sl".
           COPY "tpromo.sl"
                REPLACING ==tpromo== BY ==tpromo1==,
                          ==STATUS-tpromo== BY ==STATUS-tpromo1==
                .
           COPY "listini.sl".
           COPY "locali.sl".
           COPY "timposte.sl".
           COPY "timballi.sl".
           COPY "timbalqta.sl".
           COPY "lineseq.sl".
           COPY "blister.sl".
           COPY "clienti.sl".
           COPY "tsetinvio.sl".
           COPY "tscorte.sl".
           COPY "tmarche.sl".
           COPY "lineseq-mail.sl".
           COPY "fileseq.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "destini.fd".
           COPY "articoli.fd".
           COPY "rpromo.fd".
           COPY "tgrupgdo.fd".
           COPY "tpromo.fd".
           COPY "tpromo.fd"
                REPLACING ==tpromo== BY ==tpromo1==,
                          ==STATUS-tpromo== BY ==STATUS-tpromo1==
                .
           COPY "listini.fd".
           COPY "locali.fd".
           COPY "timposte.fd".
           COPY "timballi.fd".
           COPY "timbalqta.fd".
           COPY "lineseq.fd".
           COPY "blister.fd".
           COPY "clienti.fd".
           COPY "tsetinvio.fd".
           COPY "tscorte.fd".
           COPY "tmarche.fd".
           COPY "lineseq-mail.fd".
           COPY "fileseq.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "fonts.def".
               COPY "crtvars.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Enter-Pushed VALUE 13.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
          88 Screen-Time-Out VALUE 99.
      * Properties & User defined Working Stoarge
       78 titolo VALUE IS "Geslux - Gestione Promo". 
           COPY  "LINK-ST-PROMO.DEF".
           COPY  "IMPOSTE.DEF".
           COPY  "EXTERNALS.DEF".
           COPY  "MAIL.DEF".
           COPY  "LINK-READUTENTE.DEF".
       77 como-user        PIC  x(20).
       01 tab-righe-old.
           05 el-riga
                      OCCURS 1000 TIMES
                      INDEXED  idx-old.
               10 el-art           PIC  9(6).
               10 el-data-creazione            PIC  9(8).
               10 el-ora-creazione PIC  9(8).
               10 el-utente-creazione          PIC  x(20).
       77 font-evidenzia-griglia
                  USAGE IS HANDLE OF FONT.
       77 imballi-ed       PIC  zz.zz9.
       77 link-tpr-codice  PIC  9(15)
                  VALUE IS 0.
       77 RigheIniziali    PIC  9(5)
                  VALUE IS 0.
       77 RigaVarDestino   PIC  9(3).
       77 como-entry       PIC  x.
       78 start-fittizia VALUE IS 999999. 
       01 progmag.
           05 prg-peso-utf     PIC  9(6)v999.
           05 prg-peso-non-utf PIC  9(6)v999.
       77 CallingPgm       PIC  x(20).
       01 FILLER           PIC  9
                  VALUE IS 0.
           88 blister VALUE IS 1    WHEN SET TO FALSE  0. 
       01 tipo-volantino   PIC  x.
           88 nazionale VALUE IS "N". 
           88 local VALUE IS "L". 
       01 FILLER           PIC  9
                  VALUE IS 0.
           88 StoSalvando VALUE IS 1    WHEN SET TO FALSE  0. 
       01 FILLER           PIC  9
                  VALUE IS 0.
           88 VariazioneDestini VALUE IS 1    WHEN SET TO FALSE  0. 
       01 FILLER           PIC  9
                  VALUE IS 0.
           88 inserito-extra VALUE IS 1    WHEN SET TO FALSE  0. 
       77 save-gdo         PIC  x(5).
       77 separatore       PIC  x.
       77 NumChars         PIC  9(5).
       77 colore           PIC  9(3).
       77 RigaCambiata     PIC  9(5)
                  VALUE IS 0.
       77 ColonnaCambiata  PIC  9(5)
                  VALUE IS 0.
       77 old-col-ven      PIC  z.zzz.zz9,99.
       77 old-col-acq      PIC  z.zzz.zz9,99.
       77 old-col-qta      PIC  zzz.zzz.zz9.
       77 tot-imposte      PIC  9(6)v99.
       77 prezzo-netto     PIC  9(6)v99.
       77 sconto           PIC  9(6)v99.
       77 como-numero      PIC  9(12)v99.
       77 old-gdo-codice   PIC  x(5).
       77 Form1-Tb-1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 mail-adresses    PIC  x(400).
       77 dpo-ini          PIC  99/99/9999.
       77 dpo-fine         PIC  99/99/9999.
       77 store-gdo        PIC  x(5).
       77 store-ini        PIC  9(8).
       77 store-fine       PIC  9(8).
       77 store-codice     PIC  9(15).
       01 FILLER           PIC  9.
           88 PromoUrgente VALUE IS 1    WHEN SET TO FALSE  0. 
       77 adress-1         PIC  x(100).
       77 adress-2         PIC  x(100).
       77 adress-3         PIC  x(100).
       77 adress-4         PIC  x(100).
       77 data-oggi        PIC  9(8).
       77 CountChar        PIC  9(3).
       77 toolbar-bmp      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 w-fehler         PIC  9.
       77 wrk-result-text  PIC  x(60)
                  VALUE IS spaces.
       77 wrk-rt-len       PIC  9(2)
                  VALUE IS 0.
       77 E-ESCI           PIC  9
                  VALUE IS 1.
       77 E-NUOVO          PIC  9
                  VALUE IS 1.
       77 E-CANCELLA       PIC  9
                  VALUE IS 1.
       77 E-SALVA          PIC  9
                  VALUE IS 1.
       77 E-ANTEPRIMA      PIC  9
                  VALUE IS 1.
       77 E-MODIFICA       PIC  9
                  VALUE IS 1.
       77 E-STAMPA         PIC  9
                  VALUE IS 1.
       77 E-CERCA          PIC  9
                  VALUE IS 0.
       77 E-SELEZIONA      PIC  9
                  VALUE IS 1.
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 Default-Font
                  USAGE IS HANDLE OF FONT DEFAULT-FONT.
       77 Screen1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 Screen1-Pg-2-Visible         PIC  9
                  VALUE IS 0.
       77 Form1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       78 78-ID-pb-dest VALUE IS 1234. 
       77 form1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 como-data-to     PIC  9(8).
       77 store-articolo   PIC  9(6).
       77 save-cliente     PIC  9(5).
       77 save-destino     PIC  9(5).
       77 como-ven         PIC  9(12)v99.
       77 como-acq         PIC  9(12)v99.
       77 como-qta         PIC  9(12).
       77 link-codice      PIC  9(15).
       77 link-articolo    PIC  9(6).
       01 save-key.
           05 save-codice      PIC  9(15).
       77 codice-ed        PIC  Z(4)9.
       77 ID-AUTO          PIC  9(6)
                  VALUE IS 0.
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 0,00.
       77 STATUS-articoli  PIC  X(2).
           88 Valid-STATUS-articoli VALUE IS "00" THRU "09". 
       77 STATUS-clienti   PIC  X(2).
           88 Valid-STATUS-clienti VALUE IS "00" THRU "09". 
       77 STATUS-destini   PIC  X(2).
           88 Valid-STATUS-destini VALUE IS "00" THRU "09". 
       77 STATUS-rpromo    PIC  X(2).
           88 Valid-STATUS-rpromo VALUE IS "00" THRU "09". 
       77 STATUS-tpromo    PIC  X(2).
           88 Valid-STATUS-tpromo VALUE IS "00" THRU "09". 
       77 STATUS-tgrupgdo  PIC  X(2).
           88 Valid-STATUS-tgrupgdo VALUE IS "00" THRU "09". 
       77 STATUS-locali    PIC  X(2).
           88 Valid-STATUS-locali VALUE IS "00" THRU "09". 
       77 lab-gdo-buf      PIC  X(50).
       77 HiddenSel        PIC  9.
           88 YesSel VALUE IS 1. 
           88 NoSel VALUE IS 0. 
       01 rec-grid.
           05 col-art          PIC  z(6).
           05 col-des          PIC  x(80).
           05 col-ven          PIC  z.zzz.zz9,99
                      BLANK WHEN ZERO.
           05 col-acq          PIC  z.zzz.zz9,99
                      BLANK WHEN ZERO.
           05 col-qta          PIC  zzz.zzz.zz9
                      BLANK WHEN ZERO.
       77 lab-tipo-buf     PIC  x(15).
       01 gd-art-rec.
           05 c-art            PIC  z(6).
           05 c-des            PIC  x(50).
           05 c-prz            PIC  zzz.zz9,99.
           05 c-qta            PIC  zzz.zz9.
       77 lab-citta-buf    PIC  x(50).
       77 lab-via-buf      PIC  x(50).
       01 OLD-tpr-rec.
           05 OLD-tpr-chiave.
               10 OLD-tpr-codice   PIC  9(15).
           05 OLD-tpr-dati.
               10 OLD-tpr-chiave-ricerca.
                   15 OLD-tpr-gdo      PIC  x(5).
                   15 OLD-tpr-ini-dpo  PIC  9(8).
                   15 OLD-tpr-fine-dpo PIC  9(8).
               10 OLD-tpr-tipo     PIC  x.
                   88 OLD-tpr-nazionale VALUE IS "N". 
                   88 OLD-tpr-locale VALUE IS "L". 
               10 OLD-tpr-descrizione          PIC  x(50).
               10 OLD-tpr-ini-volantino        PIC  9(8).
               10 OLD-tpr-fine-volantino       PIC  9(8).
               10 OLD-tpr-sett-uscita          PIC  9(3).
               10 OLD-tpr-comuni.
                   15 OLD-tpr-data-creazione       PIC  9(8).
                   15 OLD-tpr-ora-creazione        PIC  9(8).
                   15 OLD-tpr-utente-creazione     PIC  x(10).
                   15 OLD-tpr-data-modifica        PIC  9(8).
                   15 OLD-tpr-ora-modifica         PIC  9(8).
                   15 OLD-tpr-utente-modifica      PIC  x(10).
               10 OLD-tpr-vuoti.
                   15 OLD-tpr-num-vuoto-1          PIC  9(15).
                   15 OLD-tpr-num-vuoto-2          PIC  9(15).
                   15 OLD-tpr-num-vuoto-3          PIC  9(15).
                   15 OLD-tpr-note     PIC  x(35).
                   15 OLD-tpr-alfa-vuoto           PIC  x(25).
       01 OLD-rpr-rec.
           05 OLD-rpr-chiave.
               10 OLD-rpr-codice   PIC  9(15).
               10 OLD-rpr-articolo PIC  9(6).
      *(( XFD NAME = rpr-gdo_1 ))
           05 OLD-rpr-dati.
               10 OLD-rpr-prz-ven  PIC  9(9)v99.
      *(( XFD NAME = rpr-gdo_2 ))
               10 OLD-rpr-prz-acq  PIC  9(9)v99.
      *(( XFD NAME = rpr-gdo_3 ))
               10 OLD-rpr-qta      PIC  9(9).
               10 OLD-rpr-comuni.
                   15 OLD-rpr-data-creazione       PIC  9(8).
                   15 OLD-rpr-ora-creazione        PIC  9(8).
                   15 OLD-rpr-utente-creazione     PIC  x(10).
                   15 OLD-rpr-data-modifica        PIC  9(8).
                   15 OLD-rpr-ora-modifica         PIC  9(8).
                   15 OLD-rpr-utente-modifica      PIC  x(10).
               10 OLD-rpr-vuoti.
                   15 OLD-rpr-num-vuoto-1          PIC  9(15).
                   15 OLD-rpr-num-vuoto-2          PIC  9(15).
                   15 OLD-rpr-num-vuoto-3          PIC  9(15).
                   15 OLD-rpr-alfa-vuoto-1         PIC  x(20).
                   15 OLD-rpr-alfa-vuoto-2         PIC  x(20).
                   15 OLD-rpr-alfa-vuoto-3         PIC  x(20).
       77 Verdana12-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 Screen1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 BOTTONE-OK-BMP   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 BOTTONE-CANCEL-BMP           PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 ef-des-buf       PIC  X(50).
       77 ef-sconto-buf    PIC  99v99.
       77 wstampa          PIC  X(256).
       77 rename-status    PIC  9(9)
                  USAGE IS COMP-4.
       77 SettimanaUscita  PIC  zz9.
       77 num-articoli     PIC  9(6).
       77 STATUS-lineseq   PIC  X(2).
           88 Valid-STATUS-lineseq VALUE IS "00" THRU "09". 
       77 status-usr-tel   PIC  X(2).
           88 Valid-status-usr-tel VALUE IS "00" THRU "09". 
       77 STATUS-tpromo1   PIC  X(2).
           88 VALID-STATUS-tpromo1 VALUE IS "00" THRU "09". 
       77 genera-bmp       PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 STATUS-listini   PIC  X(2).
           88 Valid-STATUS-listini VALUE IS "00" THRU "09". 
       77 STATUS-timposte  PIC  X(2).
           88 Valid-STATUS-timposte VALUE IS "00" THRU "09". 
       01 HiddenDati.
           05 hid-cliente      PIC  9(5).
           05 hid-destino      PIC  9(5).
       01 rec-grid-dest.
           05 col-ragsoc       PIC  X(40).
           05 col-destino      PIC  X(40).
           05 col-loca         PIC  X(40).
           05 col-ind          PIC  X(40).
           05 col-cap          PIC  9(5).
           05 col-prov         PIC  xx.
       77 MS-Sans-Serif9-Occidentale
                  USAGE IS HANDLE OF FONT.
       01 r-csv.
           05 r-art            PIC  x(50).
           05 r-prz-v          PIC  x(100).
           05 r-prz-a          PIC  x(50).
           05 r-qta            PIC  x(50).
       77 STATUS-timballi  PIC  X(2).
           88 Valid-STATUS-timballi VALUE IS "00" THRU "09". 
       77 STATUS-timbalqta PIC  X(2).
           88 Valid-STATUS-timbalqta VALUE IS "00" THRU "09". 
       77 STATUS-blister   PIC  X(2).
           88 Valid-STATUS-blister VALUE IS "00" THRU "09". 
       77 chk-mail-buf     PIC  9
                  VALUE IS 0.
       77 STATUS-tpiombo   PIC  X(2).
           88 Valid-STATUS-tpiombo VALUE IS "00" THRU "09". 
       77 STATUS-tscorte   PIC  X(2).
           88 Valid-STATUS-tscorte VALUE IS "00" THRU "09". 
       77 STATUS-tsetinvio PIC  X(2).
           88 Valid-STATUS-tsetinvio VALUE IS "00" THRU "09". 
       77 STATUS-tmarche   PIC  X(2).
           88 Valid-STATUS-tmarche VALUE IS "00" THRU "09". 
       77 copia-base-bmp   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       78 mod-copia VALUE IS 5000. 
       77 e-copia          PIC  9
                  VALUE IS 0.
       77 path-lineseq-mail            PIC  X(256).
       77 STATUS-lineseq-mail          PIC  X(2).
           88 Valid-STATUS-lineseq-mail VALUE IS "00" THRU "09". 
       77 path-fileseq     PIC  X(500).
       77 STATUS-fileseq   PIC  X(2).
           88 Valid-STATUS-fileseq VALUE IS "00" THRU "09". 

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
      * DATA CONTROL BUFFER
       01 Form1-BUF.
      * Data.Entry-Field
              05 ef-codice-BUF PIC z(15).
              05 ef-codice-VALUEBUF PIC 9(15).
      * Data.Entry-Field
              05 ef-gdo-BUF PIC X(5).
              05 ef-gdo-VALUEBUF PIC X(5).
      * Data.Entry-Field
              05 ef-ini-dpo-BUF PIC 99/99/9999.
              05 ef-ini-dpo-VALUEBUF PIC 9(8).
      * Data.Entry-Field
              05 ef-fine-dpo-BUF PIC 99/99/9999.
              05 ef-fine-dpo-VALUEBUF PIC 9(8).
      * Data.Entry-Field
              05 ef-nome-BUF PIC X(50).
      * Data.Entry-Field
              05 ef-ini-vol-BUF PIC 99/99/9999.
              05 ef-ini-vol-VALUEBUF PIC 9(8).
      * Data.Entry-Field
              05 ef-fine-vol-BUF PIC 99/99/9999.
              05 ef-fine-vol-VALUEBUF PIC 9(8).
      * Data.Entry-Field
              05 ef-sett-BUF PIC zz9.
      * Data.Entry-Field
              05 ef-nomea-BUF PIC X(35).
      * Data.Label
              05 lab-nome-BUF PIC X(50).

       77 TMP-Form1-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Form1-tpromo-RESTOREBUF  PIC X(263).
       77 TMP-Form1-KEYIS  PIC 9(3) VALUE 1.
       77 Form1-MULKEY-TMPBUF   PIC X(263).
       77 STATUS-Screen1-FLAG-REFRESH PIC  9.
          88 Screen1-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-DataSet1-destini-BUF     PIC X(3676).
       77 TMP-DataSet1-articoli-BUF     PIC X(3669).
       77 TMP-DataSet1-rpromo-BUF     PIC X(209).
       77 TMP-DataSet1-tgrupgdo-BUF     PIC X(1206).
       77 TMP-DataSet1-tpromo-BUF     PIC X(263).
       77 TMP-DataSet1-tpromo1-BUF     PIC X(263).
       77 TMP-DataSet1-listini-BUF     PIC X(207).
       77 TMP-DataSet1-locali-BUF     PIC X(203).
       77 TMP-DataSet1-timposte-BUF     PIC X(717).
       77 TMP-DataSet1-timballi-BUF     PIC X(210).
       77 TMP-DataSet1-timbalqta-BUF     PIC X(167).
       77 TMP-DataSet1-lineseq-BUF     PIC X(1000).
       77 TMP-DataSet1-blister-BUF     PIC X(2967).
       77 TMP-DataSet1-clienti-BUF     PIC X(3610).
       77 TMP-DataSet1-tsetinvio-BUF     PIC X(1023).
       77 TMP-DataSet1-tscorte-BUF     PIC X(205).
       77 TMP-DataSet1-tmarche-BUF     PIC X(217).
       77 TMP-DataSet1-lineseq-mail-BUF     PIC X(1000).
       77 TMP-DataSet1-fileseq-BUF     PIC X(32000).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-destini-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-destini-LOCK  VALUE "Y".
       77 DataSet1-destini-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-destini-KEY-Asc  VALUE "A".
          88 DataSet1-destini-KEY-Desc VALUE "D".
       77 DataSet1-articoli-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-articoli-LOCK  VALUE "Y".
       77 DataSet1-articoli-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-articoli-KEY-Asc  VALUE "A".
          88 DataSet1-articoli-KEY-Desc VALUE "D".
       77 DataSet1-rpromo-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-rpromo-LOCK  VALUE "Y".
       77 DataSet1-rpromo-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-rpromo-KEY-Asc  VALUE "A".
          88 DataSet1-rpromo-KEY-Desc VALUE "D".
       77 DataSet1-tgrupgdo-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tgrupgdo-LOCK  VALUE "Y".
       77 DataSet1-tgrupgdo-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tgrupgdo-KEY-Asc  VALUE "A".
          88 DataSet1-tgrupgdo-KEY-Desc VALUE "D".
       77 DataSet1-tpromo-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tpromo-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-tpromo-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-tpromo-KEY1-Asc  VALUE "A".
          88 DataSet1-tpromo-KEY1-Desc VALUE "D".
       77 DataSet1-tpromo1-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tpromo1-LOCK  VALUE "Y".
       77 DataSet1-tpromo1-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tpromo1-KEY-Asc  VALUE "A".
          88 DataSet1-tpromo1-KEY-Desc VALUE "D".
       77 DataSet1-listini-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-listini-LOCK  VALUE "Y".
       77 DataSet1-listini-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-listini-KEY-Asc  VALUE "A".
          88 DataSet1-listini-KEY-Desc VALUE "D".
       77 DataSet1-locali-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-locali-LOCK  VALUE "Y".
       77 DataSet1-locali-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-locali-KEY-Asc  VALUE "A".
          88 DataSet1-locali-KEY-Desc VALUE "D".
       77 DataSet1-timposte-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-timposte-LOCK  VALUE "Y".
       77 DataSet1-timposte-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-timposte-KEY-Asc  VALUE "A".
          88 DataSet1-timposte-KEY-Desc VALUE "D".
       77 DataSet1-timballi-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-timballi-LOCK  VALUE "Y".
       77 DataSet1-timballi-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-timballi-KEY-Asc  VALUE "A".
          88 DataSet1-timballi-KEY-Desc VALUE "D".
       77 DataSet1-timbalqta-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-timbalqta-LOCK  VALUE "Y".
       77 DataSet1-timbalqta-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-timbalqta-KEY-Asc  VALUE "A".
          88 DataSet1-timbalqta-KEY-Desc VALUE "D".
       77 DataSet1-lineseq-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-lineseq-LOCK  VALUE "Y".
       77 DataSet1-lineseq-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-lineseq-KEY-Asc  VALUE "A".
          88 DataSet1-lineseq-KEY-Desc VALUE "D".
       77 DataSet1-blister-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-blister-LOCK  VALUE "Y".
       77 DataSet1-blister-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-blister-KEY-Asc  VALUE "A".
          88 DataSet1-blister-KEY-Desc VALUE "D".
       77 DataSet1-clienti-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-clienti-LOCK  VALUE "Y".
       77 DataSet1-clienti-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-clienti-KEY-Asc  VALUE "A".
          88 DataSet1-clienti-KEY-Desc VALUE "D".
       77 DataSet1-tsetinvio-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tsetinvio-LOCK  VALUE "Y".
       77 DataSet1-tsetinvio-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tsetinvio-KEY-Asc  VALUE "A".
          88 DataSet1-tsetinvio-KEY-Desc VALUE "D".
       77 DataSet1-tscorte-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tscorte-LOCK  VALUE "Y".
       77 DataSet1-tscorte-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tscorte-KEY-Asc  VALUE "A".
          88 DataSet1-tscorte-KEY-Desc VALUE "D".
       77 DataSet1-tmarche-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tmarche-LOCK  VALUE "Y".
       77 DataSet1-tmarche-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tmarche-KEY-Asc  VALUE "A".
          88 DataSet1-tmarche-KEY-Desc VALUE "D".
       77 DataSet1-lineseq-mail-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-lineseq-mail-LOCK  VALUE "Y".
       77 DataSet1-lineseq-mail-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-lineseq-mail-KEY-Asc  VALUE "A".
          88 DataSet1-lineseq-mail-KEY-Desc VALUE "D".
       77 DataSet1-fileseq-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-fileseq-LOCK  VALUE "Y".
       77 DataSet1-fileseq-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-fileseq-KEY-Asc  VALUE "A".
          88 DataSet1-fileseq-KEY-Desc VALUE "D".

       77 destini-K1-SPLITBUF  PIC X(111).
       77 destini-k-localita-SPLITBUF  PIC X(36).
       77 articoli-art-k1-SPLITBUF  PIC X(51).
       77 articoli-art-k-frn-SPLITBUF  PIC X(16).
       77 rpromo-k-stampa-SPLITBUF  PIC X(32).
       77 tgrupgdo-gdo-k-g2-SPLITBUF  PIC X(9).
       77 tpromo-tpr-chiave-ricerca-SPLITBUF  PIC X(22).
       77 tpromo-tpr-chiave-gdo-fine-SPLITBUF  PIC X(22).
       77 tpromo-tpr-chiave-fine-SPLITBUF  PIC X(22).
       77 tpromo-tpr-chiave-ini-SPLITBUF  PIC X(22).
       77 tpromo-tpr-chiave-volantino-SPLITBUF  PIC X(22).
       77 tpromo-tpr-k-fine-vol-SPLITBUF  PIC X(22).
       77 tpromo-tpr-k-data-ins-SPLITBUF  PIC X(29).
       77 tpromo1-tpr-chiave-ricerca-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-chiave-gdo-fine-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-chiave-fine-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-chiave-ini-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-chiave-volantino-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-k-fine-vol-SPLITBUF  PIC X(22).
       77 tpromo1-tpr-k-data-ins-SPLITBUF  PIC X(29).
       77 listini-lst-k-articolo-SPLITBUF  PIC X(20).
       77 listini-lst-k-cod-art-cli-SPLITBUF  PIC X(29).
       77 listini-lst-k-data-SPLITBUF  PIC X(29).
       77 locali-loc-chiave-gdo-fine-SPLITBUF  PIC X(32).
       77 locali-loc-chiave-fine-SPLITBUF  PIC X(32).
       77 locali-loc-chiave-ini-SPLITBUF  PIC X(32).
       77 blister-k-magaz-SPLITBUF  PIC X(10).
       77 blister-k-des-SPLITBUF  PIC X(51).
       77 clienti-cli-K1-SPLITBUF  PIC X(47).
       77 clienti-cli-K3-SPLITBUF  PIC X(12).
       77 clienti-cli-K4-SPLITBUF  PIC X(8).

      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
       78  78-ID-ef-codice VALUE 5001.
       78  78-ID-ef-gdo VALUE 5002.
       78  78-ID-gd-dest VALUE 5003.
       78  78-ID-ef-ini-dpo VALUE 5004.
       78  78-ID-ef-fine-dpo VALUE 5005.
       78  78-ID-ef-nome VALUE 5006.
       78  78-ID-ef-ini-vol VALUE 5007.
       78  78-ID-ef-fine-vol VALUE 5008.
       78  78-ID-ef-sett VALUE 5009.
       78  78-ID-ef-nomea VALUE 5010.
       78  78-ID-gd1 VALUE 5011.
       78  78-ID-ef-des VALUE 5001.
       78  78-ID-ef-sconto VALUE 5002.
       78  78-ID-gd-art VALUE 5003.
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE
           COPY  "COMMON-LINKAGE.DEF".
       77 link-codice-volantino        PIC  9(15).

      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           AFTER PROCEDURE Form1-AfterProcedure,
           BEFORE PROCEDURE Form1-BeforeProcedure,
           .

      * ENTRY FIELD
       05
           ef-codice, 
           Entry-Field, 
           COL 17,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 10,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod-k,
           FONT IS Small-Font,
           ID IS 78-ID-ef-codice,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           MAX-TEXT 15,
           VALUE ef-codice-BUF,
           .

      * PUSH BUTTON
       05
           pb-copia, 
           Push-Button, 
           COL 147,00, 
           LINE 1,00,
           LINES 2,85 ,
           SIZE 10,50 ,
           BITMAP-HANDLE COPIA-BASE-BMP,
           BITMAP-NUMBER 3,
           UNFRAMED,
           SQUARE,
           ENABLED e-copia,
           EXCEPTION-VALUE mod-copia,
           FLAT,
           FONT IS Small-Font,
           ID IS 30,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Copia promo",
           AFTER PROCEDURE pb-copia-AfterProcedure, 
           BEFORE PROCEDURE pb-copia-BeforeProcedure, 
           .

      * ENTRY FIELD
       05
           ef-gdo, 
           Entry-Field, 
           COL 17,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 10,00 ,
           BOXED,
           UPPER,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-gdo,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 5,
           VALUE ef-gdo-BUF,
           .

      * GRID
       05
           gd-dest, 
           Grid, 
           COL 17,00, 
           LINE 7,00,
           LINES 9,31 ,
           SIZE 139,17 ,
           ADJUSTABLE-COLUMNS,
           BOXED,
           DATA-COLUMNS (1, 41, 81, 121, 161, 166),
           ALIGNMENT ("U", "U", "U", "U", "R", "U"),
           SEPARATION (5, 5, 5, 5, 5, 5),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 0,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           ID IS 78-ID-gd-dest,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 136,
           VPADDING 30,
           VSCROLL,
           EVENT PROCEDURE Screen1-Gd-1-Event-Proc,
           .

      * ENTRY FIELD
       05
           ef-ini-dpo, 
           Entry-Field, 
           COL 17,00, 
           LINE 17,00,
           LINES 1,31 ,
           SIZE 11,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-ini-dpo,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           MAX-TEXT 8,
           VALUE ef-ini-dpo-BUF,
           .

      * ENTRY FIELD
       05
           ef-fine-dpo, 
           Entry-Field, 
           COL 46,33, 
           LINE 17,00,
           LINES 1,31 ,
           SIZE 11,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-fine-dpo,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           MAX-TEXT 8,
           VALUE ef-fine-dpo-BUF,
           .

      * ENTRY FIELD
       05
           ef-nome, 
           Entry-Field, 
           COL 17,00, 
           LINE 19,00,
           LINES 1,31 ,
           SIZE 70,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-nome,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 50,
           VALUE ef-nome-BUF,
           .

      * ENTRY FIELD
       05
           ef-ini-vol, 
           Entry-Field, 
           COL 17,00, 
           LINE 21,00,
           LINES 1,31 ,
           SIZE 11,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-ini-vol,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           MAX-TEXT 8,
           VALUE ef-ini-vol-BUF,
           .

      * ENTRY FIELD
       05
           ef-fine-vol, 
           Entry-Field, 
           COL 46,33, 
           LINE 21,00,
           LINES 1,31 ,
           SIZE 11,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-fine-vol,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           MAX-TEXT 8,
           VALUE ef-fine-vol-BUF,
           .

      * ENTRY FIELD
       05
           ef-sett, 
           Entry-Field, 
           COL 81,00, 
           LINE 21,00,
           LINES 1,31 ,
           SIZE 6,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-sett,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           MAX-TEXT 3,
           VALUE ef-sett-BUF,
           .

      * ENTRY FIELD
       05
           ef-nomea, 
           Entry-Field, 
           COL 17,00, 
           LINE 23,00,
           LINES 1,31 ,
           SIZE 70,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod,
           FONT IS Small-Font,
           ID IS 78-ID-ef-nomea,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 35,
           VALUE ef-nomea-BUF,
           .

      * GRID
       05
           gd1, 
           Grid, 
           COL 3,00, 
           LINE 27,62,
           LINES 23,23 ,
           SIZE 153,17 ,
           ADJUSTABLE-COLUMNS,
           BOXED,
           CENTERED-HEADINGS,
           DATA-COLUMNS (1, 7, 57, 69, 81),
           ALIGNMENT ("R", "U", "R", "R", "R"),
           SEPARATION (5, 5, 5, 5, 5),
           DATA-TYPES ("z(6)", "X", "X", "z.zzz.zz9,99", "zzz.zzz.zz9"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           HSCROLL,
           ID IS 78-ID-gd1,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 150,
           VPADDING 50,
           VSCROLL,
           EVENT PROCEDURE Screen1-Gd-1-Event-Proc,
           .

      * PUSH BUTTON
       05
           pb-blister, 
           Push-Button, 
           COL 3,33, 
           LINE 24,92,
           LINES 2,00 ,
           SIZE 16,00 ,
           ENABLED mod,
           EXCEPTION-VALUE 1000,
           FONT IS Small-Font,
           ID IS AUTO-ID,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Seleziona &Blister",
           .

      * LABEL
       05
           Screen1-La-1, 
           Label, 
           COL 3,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 11,00 ,
           FONT IS Small-Font,
           ID IS 100,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "ID Volantino",
           .

      * PUSH BUTTON
       05
           pb-extra, 
           Push-Button, 
           COL 20,50, 
           LINE 24,92,
           LINES 2,00 ,
           SIZE 16,00 ,
           ENABLED mod,
           EXCEPTION-VALUE 1003,
           FONT IS Small-Font,
           ID IS 11,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "&Inserisci Extra %",
           .

      * BAR
       05
           Screen1-Br-1, 
           Bar,
           COL 1,00, 
           LINE 4,00,
           SIZE 157,67 ,
           ID IS 22,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (8),
           SHADING (-1),
           WIDTH 1,
           .

      * DB_LABEL
       05
           lab-nome, 
           Label, 
           COL 28,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 55,00 ,
           COLOR IS 2,
           FONT IS Small-Font,
           ID IS 23,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE lab-nome-BUF,
           TRANSPARENT,
           .

      * LABEL
       05
           Screen1-La-2, 
           Label, 
           COL 3,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Gruppo GDO",
           .

      * LABEL
       05
           Screen1-La-3, 
           Label, 
           COL 3,00, 
           LINE 17,00,
           LINES 1,31 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 5,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Inizio D.P.O.",
           .

      * LABEL
       05
           Screen1-La-4, 
           Label, 
           COL 31,67, 
           LINE 17,00,
           LINES 1,31 ,
           SIZE 12,00 ,
           FONT IS Small-Font,
           ID IS 7,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Fine D.P.O.",
           .

      * LABEL
       05
           Screen1-La-7, 
           Label, 
           COL 3,00, 
           LINE 19,00,
           LINES 1,23 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 13,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Nome Volantino",
           .

      * LABEL
       05
           Screen1-La-8, 
           Label, 
           COL 3,00, 
           LINE 21,00,
           LINES 1,31 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 15,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Inizio Volantino",
           .

      * LABEL
       05
           Screen1-La-9, 
           Label, 
           COL 31,67, 
           LINE 21,00,
           LINES 1,31 ,
           SIZE 12,00 ,
           FONT IS Small-Font,
           ID IS 17,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Fine Volantino",
           .

      * LABEL
       05
           Screen1-La-10, 
           Label, 
           COL 64,00, 
           LINE 20,85,
           LINES 1,31 ,
           SIZE 16,00 ,
           FONT IS Small-Font,
           ID IS 20,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Settimana di uscita",
           .

      * LABEL
       05
           lab-gdo, 
           Label, 
           COL 28,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 50,00 ,
           COLOR IS 5,
           FONT IS Small-Font,
           ID IS 21,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE lab-gdo-buf,
           .

      * FRAME
       05
           Screen1-Fr-1, 
           Frame, 
           COL 88,83, 
           LINE 18,31,
           LINES 3,50 ,
           SIZE 18,00 ,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Tipo Volantino",
           TITLE-POSITION 2,
           .

      * LABEL
       05
           lab-tipo-volantino, 
           Label, 
           COL 91,33, 
           LINE 19,85,
           LINES 1,15 ,
           SIZE 13,00 ,
           COLOR IS 5,
           FONT IS Small-Font,
           ID IS 1,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE lab-tipo-buf,
           .

      * LABEL
       05
           Screen1-La-5, 
           Label, 
           COL 3,00, 
           LINE 7,00,
           LINES 1,31 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 9,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Destino",
           .

      * PUSH BUTTON
       05
           pb-nazio, 
           Push-Button, 
           COL 3,00, 
           LINE 8,85,
           LINES 2,54 ,
           SIZE 12,00 ,
           ENABLED mod,
           EXCEPTION-VALUE 2001,
           FONT IS Small-Font,
           ID IS 1111,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Nazionale",
           .

      * PUSH BUTTON
       05
           pb-locale, 
           Push-Button, 
           COL 3,00, 
           LINE 11,92,
           LINES 2,54 ,
           SIZE 12,00 ,
           ENABLED mod,
           EXCEPTION-VALUE 2000,
           FONT IS Small-Font,
           ID IS 2222,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Locale",
           VISIBLE 1,
           .

      * LABEL
       05
           Screen1-blockpgm-1, 
           Label, 
           COL 88,17, 
           LINE 2,31,
           LINES 1,23 ,
           SIZE 4,83 ,
           ID IS 10,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "BlockPgm",
           VISIBLE v-custom,
           .

      * LABEL
       05
           Screen1-Custom1-1, 
           Label, 
           COL 96,17, 
           LINE 1,77,
           LINES 2,00 ,
           SIZE 6,67 ,
           FONT IS Default-Font,
           ID IS 12,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * CHECK BOX
       05
           chk-mail, 
           Check-Box, 
           COL 99,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 2,50 ,
           FLAT,
           FONT IS Small-Font,
           ID IS 18,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LEFT-TEXT,
           TITLE "Check Box",
           VALUE chk-mail-buf,
           AFTER PROCEDURE Screen1-Cb-1-AfterProcedure,
           BEFORE PROCEDURE Screen1-Cb-1-BeforeProcedure, 
           .
      * LABEL
       05
           lab-mail, 
           Label, 
           COL 83,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 14,00 ,
           FONT IS Small-Font,
           ID IS 28,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Blocca invio mail",
           .

      * LABEL
       05
           Screen1-La-7a, 
           Label, 
           COL 3,00, 
           LINE 23,00,
           LINES 1,23 ,
           SIZE 13,00 ,
           FONT IS Small-Font,
           ID IS 29,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Note (su bozza)",
           .

      * TOOLBAR
       01
           Form1-Tb-1,
           .    

      * PUSH BUTTON
       05
           TOOL-ESCI, 
           Push-Button, 
           COL 1,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED E-ESCI,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 72,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "Esci (Esc)",
           .

      * PUSH BUTTON
       05
           TOOL-NUOVO, 
           Push-Button, 
           COL 6,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-NUOVO,
           EXCEPTION-VALUE 2,
           FLAT,
           ID IS 73,
           SELF-ACT,
           TITLE "Nuovo (F2)",
           BITMAP-NUMBER BitmapNumNew
           .

      * PUSH BUTTON
       05
           TOOL-CANCELLA, 
           Push-Button, 
           COL 16,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-CANCELLA,
           EXCEPTION-VALUE 4,
           FLAT,
           ID IS 74,
           SELF-ACT,
           TITLE "Cancella (F4)",
           BITMAP-NUMBER BitmapNumDelete
           .

      * PUSH BUTTON
       05
           TOOL-SALVA, 
           Push-Button, 
           COL 11,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-SALVA,
           EXCEPTION-VALUE 3,
           FLAT,
           ID IS 75,
           SELF-ACT,
           TITLE "Salva (F3)",
           BITMAP-NUMBER BitmapNumSave
           .

      * PUSH BUTTON
       05
           TOOL-ANTEPRIMA, 
           Push-Button, 
           COL 26,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-ANTEPRIMA,
           EXCEPTION-VALUE 6,
           FLAT,
           ID IS 76,
           SELF-ACT,
           TITLE "Anteprima (F6)",
           BITMAP-NUMBER BitmapNumPreview
           .

      * CHECK BOX
       05
           TOOL-MODIFICA, 
           Check-Box, 
           COL 21,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 5,
           FRAMED,
           SQUARE,
           ENABLED E-MODIFICA,
           EXCEPTION-VALUE 150
           FLAT,
           ID IS 77,
           SELF-ACT,
           TITLE "Modifica (F5)",
           VALUE MOD,
           BITMAP-NUMBER BitmapNumEdit
           AFTER PROCEDURE TOOL-MODIFICA-AfterProcedure,
           BEFORE PROCEDURE TOOL-MODIFICA-BeforeProcedure, 
           .
      * PUSH BUTTON
       05
           TOOL-STAMPA, 
           Push-Button, 
           COL 31,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-STAMPA,
           EXCEPTION-VALUE 7,
           FLAT,
           ID IS 110,
           SELF-ACT,
           TITLE "Stampa (F7)",
           BITMAP-NUMBER BitmapNumPrint
           .

      * PUSH BUTTON
       05
           TOOL-CERCA, 
           Push-Button, 
           COL 36,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-CERCA,
           EXCEPTION-VALUE 8,
           FLAT,
           ID IS 111,
           SELF-ACT,
           TITLE "Cerca (F8)",
           BITMAP-NUMBER BitmapNumZoom
           .

      * PUSH BUTTON
       05
           TOOL-SELEZIONA, 
           Push-Button, 
           COL 41,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 9,
           FRAMED,
           SQUARE,
           ENABLED E-SELEZIONA,
           EXCEPTION-VALUE 9,
           FLAT,
           ID IS 112,
           SELF-ACT,
           TITLE "Seleziona (F9)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1a, 
           Push-Button, 
           COL 46,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 10,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 1002,
           FLAT,
           ID IS 113,
           SELF-ACT,
           TITLE "&Primo",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1b, 
           Push-Button, 
           COL 51,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 11,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 67,
           FLAT,
           ID IS 114,
           SELF-ACT,
           TITLE "Precedente (PgDn)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1c, 
           Push-Button, 
           COL 56,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 12,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 68,
           FLAT,
           ID IS 115,
           SELF-ACT,
           TITLE "Successivo (PgUp)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1d, 
           Push-Button, 
           COL 61,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 13,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 1006,
           FLAT,
           ID IS 116,
           SELF-ACT,
           TITLE "&Ultimo",
           .

      * FORM
       01 
           Screen1, 
           BEFORE PROCEDURE Screen1-BeforeProcedure,
           AFTER PROCEDURE  Screen1-AFTER-SCREEN
           .

      * FRAME
       05
           Screen4-Fr-1a, 
           Frame, 
           COL 1,00, 
           LINE 36,11,
           LINES 2,83 ,
           SIZE 66,80 ,
           ID IS 29,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           .

      * PUSH BUTTON
       05
           pb-ok-s, 
           Push-Button, 
           COL 51,80, 
           LINE 36,78,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-OK-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1000,
           FLAT,
           ID IS 200,
           AFTER PROCEDURE pb-ok-s-AfterProcedure, 
           BEFORE PROCEDURE pb-ok-s-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           pb-annulla-s, 
           Push-Button, 
           COL 59,60, 
           LINE 36,78,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-CANCEL-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 201,
           SELF-ACT,
           ESCAPE-BUTTON,
           AFTER PROCEDURE pb-annulla-s-AfterProcedure, 
           BEFORE PROCEDURE pb-annulla-s-BeforeProcedure, 
           .

      * LABEL
       05
           lab2, 
           Label, 
           COL 9,00, 
           LINE 37,39,
           LINES 1,06 ,
           SIZE 35,00 ,
           COLOR IS 5,
           ID IS 4,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "Riporto righe in corso. Attendere prego...",
           .

      * FRAME
       05
           Screen1-Fr-1a, 
           Frame, 
           COL 1,80, 
           LINE 1,50,
           LINES 7,28 ,
           SIZE 65,10 ,
           ID IS 202,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Parametri",
           TITLE-POSITION 2,
           .

      * ENTRY FIELD
       05
           ef-des, 
           Entry-Field, 
           COL 15,80, 
           LINE 3,50,
           LINES 1,28 ,
           SIZE 48,70 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-des,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           VALUE ef-des-buf,
           AFTER PROCEDURE ef-des-AfterProcedure, 
           .

      * ENTRY FIELD
       05
           ef-sconto, 
           Entry-Field, 
           COL 15,80, 
           LINE 6,00,
           LINES 1,28 ,
           SIZE 7,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-sconto,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           VALUE ef-sconto-buf,
           AFTER PROCEDURE ef-sconto-AfterProcedure, 
           .

      * PUSH BUTTON
       05
           pb-genera, 
           Push-Button, 
           COL 56,40, 
           LINE 5,72,
           LINES 2,06 ,
           SIZE 8,10 ,
           BITMAP-HANDLE GENERA-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1001,
           FLAT,
           FONT IS Small-Font,
           ID IS 1000,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Push Button",
           AFTER PROCEDURE pb-genera-AfterProcedure, 
           BEFORE PROCEDURE pb-genera-BeforeProcedure, 
           .

      * LABEL
       05
           Screen1-La-1a, 
           Label, 
           COL 23,30, 
           LINE 6,00,
           LINES 1,28 ,
           SIZE 2,00 ,
           ID IS 205,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "%",
           .

      * LABEL
       05
           Screen1-La-2a, 
           Label, 
           COL 3,80, 
           LINE 6,00,
           LINES 1,28 ,
           SIZE 7,90 ,
           ID IS 206,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Sconto",
           .

      * LABEL
       05
           Screen1-La-2aa, 
           Label, 
           COL 3,80, 
           LINE 3,50,
           LINES 2,06 ,
           SIZE 10,00 ,
           ID IS 207,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Descrizione (contiene)",
           .

      * LABEL
       05
           Screen1-Custom1-1a, 
           Label, 
           COL 38,40, 
           LINE 6,50,
           LINES 0,44 ,
           SIZE 3,80 ,
           FONT IS Default-Font,
           ID IS 1,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * LABEL
       05
           lab, 
           Label, 
           COL 9,30, 
           LINE 7,39,
           LINES 1,06 ,
           SIZE 50,00 ,
           COLOR IS 5,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "Generazione righe extra sconto in corso. Attendere pre
      -    "go...",
           .

      * LABEL
       05
           Screen1a-La-1, 
           Label, 
           COL 15,80, 
           LINE 4,78,
           LINES 0,83 ,
           SIZE 48,70 ,
           COLOR IS 2,
           ID IS 5,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "<<HELP  * = TUTTI>>",
           .

      * GRID
       05
           gd-art, 
           Grid, 
           COL 1,80, 
           LINE 9,33,
           LINES 26,78 ,
           SIZE 65,10 ,
           BOXED,
           DATA-COLUMNS (1, 7, 57, 67),
           ALIGNMENT ("R", "U", "R", "R"),
           SEPARATION (5, 5, 5, 5),
           DATA-TYPES ("X", "X", "zzz.zz9,99", "zzz.zz9"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           ID IS 78-ID-gd-art,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RECORD-DATA gd-art-rec,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 63,
           VPADDING 30,
           VSCROLL,
           EVENT PROCEDURE Screen1a-Gd-1-Event-Proc,
           .

      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE  DIVISION USING LK-BLOCKPGM, USER-CODI, LIVELLO-ABIL, 
           link-codice-volantino.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:lab-gpromo, INIT:lab-gpromo, BeforeDeclarative>
       copy "mail-decl.cpy".

       TPROMO-ERROR SECTION.
           use after error procedure on tpromo.
           set RecLocked to false.
           evaluate status-tpromo
           when "35"
                display message "File [TPROMO] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [TPROMO] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[TPROMO] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           when "99"
           when "93"
                set RecLocked to true
                set errori    to true
                move 0 to mod
                modify tool-modifica, value = mod
                move 1 to mod-k
                display form1
                set StatusVisua to true
                perform STATUS-BAR-MSG
                move "00" to status-tpromo
                if ReadSecca
                   read tpromo       no lock 
                        invalid      continue
                        not invalid  perform FORM1-IUD-DISPLAY
                   end-read
                end-if
                display message box MSG-Record-gia-in-uso
                        title = tit-err
                        icon is mb-error-icon
           when "23"
                move 1 to mod-k
                move 0 to mod
                modify tool-modifica, value = mod
                set StatusVisua to true
                perform STATUS-BAR-MSG 
                if nuovo              
                   initialize tpr-dati of tpromo
                              replacing numeric data by zeroes
                                   alphanumeric data by spaces
                   perform FORM1-FLD-TO-BUF
                   display form1-tb-1
                   set vecchio to true
                end-if      
                perform ABILITAZIONI
                display form1
                |RISETTO IL VALORE A "23" PERCHE DENTRO AL PAR. CLEAR-SCREEN
                |CON L'OPERAZIONE UNLOCK VIENE RISETTATO A ZERO COSICCHÈ 
                |QUANDO TORNA DENTRO AI PAR. DI SCORRIMENTO DI TOTEM SI 
                |TROVA IN UNA SITUAZIONE CORRETTA E PROSEGUE CON LA READ
                |USCENDO CON UN MESSAGGIO DI ERRORE DI TIPO "46"
                move "23" to status-tpromo
           end-evaluate.
 
      ***---
       RPROMO-ERR SECTION.
           use after error procedure on rpromo.
           set tutto-ok  to true.
           evaluate status-rpromo
           when "35"
                display message "File [RPROMO] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [RPROMO] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[RPROMO] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
 
      ***---
       CLIENTI-ERR SECTION.
           use after error procedure on clienti.
           set tutto-ok  to true.
           evaluate status-clienti
           when "35"
                display message "File [CLIENTI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [CLIENTI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[CLIENTI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
 
      ***---
       DESTINI-ERR SECTION.
           use after error procedure on destini.
           set tutto-ok  to true.
           evaluate status-destini
           when "35"
                display message "File [DESTINI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [DESTINI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[DESTINI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
 
      ***---
       ARTICOLI-ERR SECTION.
           use after error procedure on articoli.
           set tutto-ok  to true.
           evaluate status-articoli
           when "35"
                display message "File [ARTICOLI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [ARTICOLI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[ARTICOLI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
 
      ***---
       TGRUPGDO-ERR SECTION.
           use after error procedure on tgrupgdo.
           set tutto-ok  to true.
           evaluate status-tgrupgdo
           when "35"
                display message "File [TGRUPGDO] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [TGRUPGDO] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[TGRUPGDO] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM ginqui-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:lab-gpromo, INIT:lab-gpromo, BeforeDestroyResource>
      * <TOTEM:END>
           DESTROY Verdana12-Occidentale
           CALL "w$bitmap" USING WBITMAP-DESTROY, COPIA-BASE-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, toolbar-bmp
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-OK-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-CANCEL-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, GENERA-BMP
      *    After-Program
           PERFORM ginqui-Ev-After-Program
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
      *    After Init
           .
    
       INIT-FONT.
      * Verdana12-Occidentale
           INITIALIZE WFONT-DATA Verdana12-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12-Occidentale, WFONT-DATA
           .

       INIT-BMP.
      * pb-copia
           COPY RESOURCE "COPIA-BASE.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "COPIA-BASE.BMP", 
                   GIVING COPIA-BASE-BMP.
      * TOOL-ESCI
           COPY RESOURCE "toolbar.bmp".
           CALL "w$bitmap" USING WBITMAP-LOAD "toolbar.bmp", 
                   GIVING toolbar-bmp.
      * pb-ok-s
           COPY RESOURCE "BOTTONE-OK.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-OK.BMP", 
                   GIVING BOTTONE-OK-BMP.
      * pb-annulla-s
           COPY RESOURCE "BOTTONE-CANCEL.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-CANCEL.BMP", 
                   GIVING BOTTONE-CANCEL-BMP.
      * pb-genera
           COPY RESOURCE "GENERA.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "GENERA.BMP", 
                   GIVING GENERA-BMP.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-destini
           PERFORM OPEN-articoli
           PERFORM OPEN-rpromo
           PERFORM OPEN-tgrupgdo
           PERFORM OPEN-tpromo
           PERFORM OPEN-tpromo1
           PERFORM OPEN-listini
           PERFORM OPEN-locali
           PERFORM OPEN-timposte
           PERFORM OPEN-timballi
           PERFORM OPEN-timbalqta
      *    lineseq OPEN MODE IS FALSE
      *    PERFORM OPEN-lineseq
           PERFORM OPEN-blister
           PERFORM OPEN-clienti
      *    tsetinvio OPEN MODE IS FALSE
      *    PERFORM OPEN-tsetinvio
           PERFORM OPEN-tscorte
           PERFORM OPEN-tmarche
      *    lineseq-mail OPEN MODE IS FALSE
      *    PERFORM OPEN-lineseq-mail
      *    fileseq OPEN MODE IS FALSE
      *    PERFORM OPEN-fileseq
      *    After Open
           .

       OPEN-destini.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:destini, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT destini
           IF NOT Valid-STATUS-destini
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:destini, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-articoli.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:articoli, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT articoli
           IF NOT Valid-STATUS-articoli
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:articoli, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-rpromo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:rpromo, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O rpromo
           IF STATUS-rpromo = "35"
              OPEN OUTPUT rpromo
                IF Valid-STATUS-rpromo
                   CLOSE rpromo
                   OPEN I-O rpromo
                END-IF
           END-IF
           IF NOT Valid-STATUS-rpromo
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:rpromo, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tgrupgdo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tgrupgdo, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tgrupgdo
           IF NOT Valid-STATUS-tgrupgdo
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tgrupgdo, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tpromo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O tpromo
           IF STATUS-tpromo = "35"
              OPEN OUTPUT tpromo
                IF Valid-STATUS-tpromo
                   CLOSE tpromo
                   OPEN I-O tpromo
                END-IF
           END-IF
           IF NOT Valid-STATUS-tpromo
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tpromo1.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo1, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tpromo1
           IF NOT VALID-STATUS-tpromo1
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo1, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-listini.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:listini, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT listini
           IF NOT Valid-STATUS-listini
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:listini, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-locali.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:locali, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O locali
           IF STATUS-locali = "35"
              OPEN OUTPUT locali
                IF Valid-STATUS-locali
                   CLOSE locali
                   OPEN I-O locali
                END-IF
           END-IF
           IF NOT Valid-STATUS-locali
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:locali, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-timposte.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timposte, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT timposte
           IF NOT Valid-STATUS-timposte
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timposte, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-timballi.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timballi, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT timballi
           IF NOT Valid-STATUS-timballi
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timballi, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-timbalqta.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timbalqta, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT timbalqta
           IF NOT Valid-STATUS-timbalqta
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timbalqta, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-lineseq.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq, BeforeOpen>
      * <TOTEM:END>
           OPEN  OUTPUT lineseq
           IF NOT Valid-STATUS-lineseq
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-blister.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:blister, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT blister
           IF NOT Valid-STATUS-blister
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:blister, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-clienti.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:clienti, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT clienti
           IF NOT Valid-STATUS-clienti
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:clienti, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tsetinvio.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tsetinvio, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O tsetinvio
           IF STATUS-tsetinvio = "35"
              OPEN OUTPUT tsetinvio
                IF Valid-STATUS-tsetinvio
                   CLOSE tsetinvio
                   OPEN I-O tsetinvio
                END-IF
           END-IF
           IF NOT Valid-STATUS-tsetinvio
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tsetinvio, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tscorte.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tscorte, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tscorte
           IF NOT Valid-STATUS-tscorte
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tscorte, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tmarche.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tmarche, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tmarche
           IF NOT Valid-STATUS-tmarche
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tmarche, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-lineseq-mail.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq-mail, BeforeOpen>
      * <TOTEM:END>
           OPEN  OUTPUT lineseq-mail
           IF NOT Valid-STATUS-lineseq-mail
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq-mail, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-fileseq.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:fileseq, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT fileseq
           IF NOT Valid-STATUS-fileseq
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:lab-gpromo, FD:fileseq, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-destini
           PERFORM CLOSE-articoli
           PERFORM CLOSE-rpromo
           PERFORM CLOSE-tgrupgdo
           PERFORM CLOSE-tpromo
           PERFORM CLOSE-tpromo1
           PERFORM CLOSE-listini
           PERFORM CLOSE-locali
           PERFORM CLOSE-timposte
           PERFORM CLOSE-timballi
           PERFORM CLOSE-timbalqta
      *    lineseq CLOSE MODE IS FALSE
      *    PERFORM CLOSE-lineseq
           PERFORM CLOSE-blister
           PERFORM CLOSE-clienti
      *    tsetinvio CLOSE MODE IS FALSE
      *    PERFORM CLOSE-tsetinvio
           PERFORM CLOSE-tscorte
           PERFORM CLOSE-tmarche
      *    lineseq-mail CLOSE MODE IS FALSE
      *    PERFORM CLOSE-lineseq-mail
      *    fileseq CLOSE MODE IS FALSE
      *    PERFORM CLOSE-fileseq
      *    After Close
           .

       CLOSE-destini.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:destini, BeforeClose>
      * <TOTEM:END>
           CLOSE destini
           .

       CLOSE-articoli.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:articoli, BeforeClose>
      * <TOTEM:END>
           CLOSE articoli
           .

       CLOSE-rpromo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:rpromo, BeforeClose>
      * <TOTEM:END>
           CLOSE rpromo
           .

       CLOSE-tgrupgdo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tgrupgdo, BeforeClose>
      * <TOTEM:END>
           CLOSE tgrupgdo
           .

       CLOSE-tpromo.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo, BeforeClose>
      * <TOTEM:END>
           CLOSE tpromo
           .

       CLOSE-tpromo1.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tpromo1, BeforeClose>
      * <TOTEM:END>
           CLOSE tpromo1
           .

       CLOSE-listini.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:listini, BeforeClose>
      * <TOTEM:END>
           CLOSE listini
           .

       CLOSE-locali.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:locali, BeforeClose>
      * <TOTEM:END>
           CLOSE locali
           .

       CLOSE-timposte.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timposte, BeforeClose>
      * <TOTEM:END>
           CLOSE timposte
           .

       CLOSE-timballi.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timballi, BeforeClose>
      * <TOTEM:END>
           CLOSE timballi
           .

       CLOSE-timbalqta.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:timbalqta, BeforeClose>
      * <TOTEM:END>
           CLOSE timbalqta
           .

       CLOSE-lineseq.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-blister.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:blister, BeforeClose>
      * <TOTEM:END>
           CLOSE blister
           .

       CLOSE-clienti.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:clienti, BeforeClose>
      * <TOTEM:END>
           CLOSE clienti
           .

       CLOSE-tsetinvio.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tsetinvio, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-tscorte.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tscorte, BeforeClose>
      * <TOTEM:END>
           CLOSE tscorte
           .

       CLOSE-tmarche.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:tmarche, BeforeClose>
      * <TOTEM:END>
           CLOSE tmarche
           .

       CLOSE-lineseq-mail.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:lineseq-mail, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-fileseq.
      * <TOTEM:EPT. INIT:lab-gpromo, FD:fileseq, BeforeClose>
      * <TOTEM:END>
           .

       destini-K1-MERGE-SPLITBUF.
           INITIALIZE destini-K1-SPLITBUF
           MOVE des-ragsoc-1(1:100) TO destini-K1-SPLITBUF(1:100)
           MOVE des-codice(1:5) TO destini-K1-SPLITBUF(101:5)
           MOVE des-prog(1:5) TO destini-K1-SPLITBUF(106:5)
           .

       destini-k-localita-MERGE-SPLITBUF.
           INITIALIZE destini-k-localita-SPLITBUF
           MOVE des-localita(1:35) TO destini-k-localita-SPLITBUF(1:35)
           .

       DataSet1-destini-INITSTART.
           IF DataSet1-destini-KEY-Asc
              MOVE Low-Value TO des-chiave
           ELSE
              MOVE High-Value TO des-chiave
           END-IF
           .

       DataSet1-destini-INITEND.
           IF DataSet1-destini-KEY-Asc
              MOVE High-Value TO des-chiave
           ELSE
              MOVE Low-Value TO des-chiave
           END-IF
           .

      * destini
       DataSet1-destini-START.
           IF DataSet1-destini-KEY-Asc
              START destini KEY >= des-chiave
           ELSE
              START destini KEY <= des-chiave
           END-IF
           .

       DataSet1-destini-START-NOTGREATER.
           IF DataSet1-destini-KEY-Asc
              START destini KEY <= des-chiave
           ELSE
              START destini KEY >= des-chiave
           END-IF
           .

       DataSet1-destini-START-GREATER.
           IF DataSet1-destini-KEY-Asc
              START destini KEY > des-chiave
           ELSE
              START destini KEY < des-chiave
           END-IF
           .

       DataSet1-destini-START-LESS.
           IF DataSet1-destini-KEY-Asc
              START destini KEY < des-chiave
           ELSE
              START destini KEY > des-chiave
           END-IF
           .

       DataSet1-destini-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-destini-LOCK
              READ destini WITH LOCK 
              KEY des-chiave
           ELSE
              READ destini WITH NO LOCK 
              KEY des-chiave
           END-IF
           PERFORM destini-K1-MERGE-SPLITBUF
           PERFORM destini-k-localita-MERGE-SPLITBUF
           MOVE STATUS-destini TO TOTEM-ERR-STAT 
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-destini-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-destini-KEY-Asc
              IF DataSet1-destini-LOCK
                 READ destini NEXT WITH LOCK
              ELSE
                 READ destini NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-destini-LOCK
                 READ destini PREVIOUS WITH LOCK
              ELSE
                 READ destini PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM destini-K1-MERGE-SPLITBUF
           PERFORM destini-k-localita-MERGE-SPLITBUF
           MOVE STATUS-destini TO TOTEM-ERR-STAT
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-destini-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-destini-KEY-Asc
              IF DataSet1-destini-LOCK
                 READ destini PREVIOUS WITH LOCK
              ELSE
                 READ destini PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-destini-LOCK
                 READ destini NEXT WITH LOCK
              ELSE
                 READ destini NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM destini-K1-MERGE-SPLITBUF
           PERFORM destini-k-localita-MERGE-SPLITBUF
           MOVE STATUS-destini TO TOTEM-ERR-STAT
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-destini-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-destini TO TOTEM-ERR-STAT
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-destini-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-destini TO TOTEM-ERR-STAT
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-destini-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:destini, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-destini TO TOTEM-ERR-STAT
           MOVE "destini" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:destini, AfterDelete>
      * <TOTEM:END>
           .

       articoli-art-k1-MERGE-SPLITBUF.
           INITIALIZE articoli-art-k1-SPLITBUF
           MOVE art-descrizione OF articoli(1:50) TO 
           articoli-art-k1-SPLITBUF(1:50)
           .

       articoli-art-k-frn-MERGE-SPLITBUF.
           INITIALIZE articoli-art-k-frn-SPLITBUF
           MOVE art-cod-art-frn OF articoli(1:15) TO 
           articoli-art-k-frn-SPLITBUF(1:15)
           .

       DataSet1-articoli-INITSTART.
           IF DataSet1-articoli-KEY-Asc
              MOVE Low-Value TO art-chiave OF articoli
           ELSE
              MOVE High-Value TO art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-INITEND.
           IF DataSet1-articoli-KEY-Asc
              MOVE High-Value TO art-chiave OF articoli
           ELSE
              MOVE Low-Value TO art-chiave OF articoli
           END-IF
           .

      * articoli
       DataSet1-articoli-START.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY >= art-chiave OF articoli
           ELSE
              START articoli KEY <= art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-NOTGREATER.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY <= art-chiave OF articoli
           ELSE
              START articoli KEY >= art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-GREATER.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY > art-chiave OF articoli
           ELSE
              START articoli KEY < art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-LESS.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY < art-chiave OF articoli
           ELSE
              START articoli KEY > art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-articoli-LOCK
              READ articoli WITH LOCK 
              KEY art-chiave OF articoli
           ELSE
              READ articoli WITH NO LOCK 
              KEY art-chiave OF articoli
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT 
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-articoli-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-articoli-KEY-Asc
              IF DataSet1-articoli-LOCK
                 READ articoli NEXT WITH LOCK
              ELSE
                 READ articoli NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-articoli-LOCK
                 READ articoli PREVIOUS WITH LOCK
              ELSE
                 READ articoli PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-articoli-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-articoli-KEY-Asc
              IF DataSet1-articoli-LOCK
                 READ articoli PREVIOUS WITH LOCK
              ELSE
                 READ articoli PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-articoli-LOCK
                 READ articoli NEXT WITH LOCK
              ELSE
                 READ articoli NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterDelete>
      * <TOTEM:END>
           .

       rpromo-k-stampa-MERGE-SPLITBUF.
           INITIALIZE rpromo-k-stampa-SPLITBUF
           MOVE rpr-codice(1:15) TO rpromo-k-stampa-SPLITBUF(1:15)
           MOVE rpr-data-creazione(1:8) TO 
           rpromo-k-stampa-SPLITBUF(16:8)
           MOVE rpr-ora-creazione(1:8) TO rpromo-k-stampa-SPLITBUF(24:8)
           .

       DataSet1-rpromo-INITSTART.
           IF DataSet1-rpromo-KEY-Asc
              MOVE Low-Value TO rpr-chiave
           ELSE
              MOVE High-Value TO rpr-chiave
           END-IF
           .

       DataSet1-rpromo-INITEND.
           IF DataSet1-rpromo-KEY-Asc
              MOVE High-Value TO rpr-chiave
           ELSE
              MOVE Low-Value TO rpr-chiave
           END-IF
           .

      * rpromo
       DataSet1-rpromo-START.
           IF DataSet1-rpromo-KEY-Asc
              START rpromo KEY >= rpr-chiave
           ELSE
              START rpromo KEY <= rpr-chiave
           END-IF
           .

       DataSet1-rpromo-START-NOTGREATER.
           IF DataSet1-rpromo-KEY-Asc
              START rpromo KEY <= rpr-chiave
           ELSE
              START rpromo KEY >= rpr-chiave
           END-IF
           .

       DataSet1-rpromo-START-GREATER.
           IF DataSet1-rpromo-KEY-Asc
              START rpromo KEY > rpr-chiave
           ELSE
              START rpromo KEY < rpr-chiave
           END-IF
           .

       DataSet1-rpromo-START-LESS.
           IF DataSet1-rpromo-KEY-Asc
              START rpromo KEY < rpr-chiave
           ELSE
              START rpromo KEY > rpr-chiave
           END-IF
           .

       DataSet1-rpromo-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-rpromo-LOCK
              READ rpromo WITH LOCK 
              KEY rpr-chiave
           ELSE
              READ rpromo WITH NO LOCK 
              KEY rpr-chiave
           END-IF
           PERFORM rpromo-k-stampa-MERGE-SPLITBUF
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT 
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-rpromo-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-rpromo-KEY-Asc
              IF DataSet1-rpromo-LOCK
                 READ rpromo NEXT WITH LOCK
              ELSE
                 READ rpromo NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-rpromo-LOCK
                 READ rpromo PREVIOUS WITH LOCK
              ELSE
                 READ rpromo PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM rpromo-k-stampa-MERGE-SPLITBUF
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-rpromo-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-rpromo-KEY-Asc
              IF DataSet1-rpromo-LOCK
                 READ rpromo PREVIOUS WITH LOCK
              ELSE
                 READ rpromo PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-rpromo-LOCK
                 READ rpromo NEXT WITH LOCK
              ELSE
                 READ rpromo NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM rpromo-k-stampa-MERGE-SPLITBUF
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-rpromo-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeWrite>
      * <TOTEM:END>
           WRITE rpr-rec OF rpromo.
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-rpromo-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeRewrite>
      * <TOTEM:END>
           REWRITE rpr-rec OF rpromo.
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-rpromo-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, BeforeDelete>
      * <TOTEM:END>
           DELETE rpromo.
           MOVE STATUS-rpromo TO TOTEM-ERR-STAT
           MOVE "rpromo" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:rpromo, AfterDelete>
      * <TOTEM:END>
           .

       tgrupgdo-gdo-k-g2-MERGE-SPLITBUF.
           INITIALIZE tgrupgdo-gdo-k-g2-SPLITBUF
           MOVE gdo-codice-G2 OF tgrupgdo(1:3) TO 
           tgrupgdo-gdo-k-g2-SPLITBUF(1:3)
           MOVE gdo-chiave OF tgrupgdo(1:5) TO 
           tgrupgdo-gdo-k-g2-SPLITBUF(4:5)
           .

       DataSet1-tgrupgdo-INITSTART.
           IF DataSet1-tgrupgdo-KEY-Asc
              MOVE Low-Value TO gdo-chiave OF tgrupgdo
           ELSE
              MOVE High-Value TO gdo-chiave OF tgrupgdo
           END-IF
           .

       DataSet1-tgrupgdo-INITEND.
           IF DataSet1-tgrupgdo-KEY-Asc
              MOVE High-Value TO gdo-chiave OF tgrupgdo
           ELSE
              MOVE Low-Value TO gdo-chiave OF tgrupgdo
           END-IF
           .

      * tgrupgdo
       DataSet1-tgrupgdo-START.
           IF DataSet1-tgrupgdo-KEY-Asc
              START tgrupgdo KEY >= gdo-chiave OF tgrupgdo
           ELSE
              START tgrupgdo KEY <= gdo-chiave OF tgrupgdo
           END-IF
           .

       DataSet1-tgrupgdo-START-NOTGREATER.
           IF DataSet1-tgrupgdo-KEY-Asc
              START tgrupgdo KEY <= gdo-chiave OF tgrupgdo
           ELSE
              START tgrupgdo KEY >= gdo-chiave OF tgrupgdo
           END-IF
           .

       DataSet1-tgrupgdo-START-GREATER.
           IF DataSet1-tgrupgdo-KEY-Asc
              START tgrupgdo KEY > gdo-chiave OF tgrupgdo
           ELSE
              START tgrupgdo KEY < gdo-chiave OF tgrupgdo
           END-IF
           .

       DataSet1-tgrupgdo-START-LESS.
           IF DataSet1-tgrupgdo-KEY-Asc
              START tgrupgdo KEY < gdo-chiave OF tgrupgdo
           ELSE
              START tgrupgdo KEY > gdo-chiave OF tgrupgdo
           END-IF
           .

       DataSet1-tgrupgdo-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tgrupgdo-LOCK
              READ tgrupgdo WITH LOCK 
              KEY gdo-chiave OF tgrupgdo
           ELSE
              READ tgrupgdo WITH NO LOCK 
              KEY gdo-chiave OF tgrupgdo
           END-IF
           PERFORM tgrupgdo-gdo-k-g2-MERGE-SPLITBUF
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT 
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tgrupgdo-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tgrupgdo-KEY-Asc
              IF DataSet1-tgrupgdo-LOCK
                 READ tgrupgdo NEXT WITH LOCK
              ELSE
                 READ tgrupgdo NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tgrupgdo-LOCK
                 READ tgrupgdo PREVIOUS WITH LOCK
              ELSE
                 READ tgrupgdo PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM tgrupgdo-gdo-k-g2-MERGE-SPLITBUF
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tgrupgdo-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tgrupgdo-KEY-Asc
              IF DataSet1-tgrupgdo-LOCK
                 READ tgrupgdo PREVIOUS WITH LOCK
              ELSE
                 READ tgrupgdo PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tgrupgdo-LOCK
                 READ tgrupgdo NEXT WITH LOCK
              ELSE
                 READ tgrupgdo NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM tgrupgdo-gdo-k-g2-MERGE-SPLITBUF
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tgrupgdo-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tgrupgdo-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tgrupgdo-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tgrupgdo TO TOTEM-ERR-STAT
           MOVE "tgrupgdo" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tgrupgdo, AfterDelete>
      * <TOTEM:END>
           .

       tpromo-tpr-chiave-ricerca-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-chiave-ricerca-SPLITBUF
           MOVE tpr-chiave-ricerca OF tpromo(1:21) TO 
           tpromo-tpr-chiave-ricerca-SPLITBUF(1:21)
           .

       tpromo-tpr-chiave-gdo-fine-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-chiave-gdo-fine-SPLITBUF
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-chiave-gdo-fine-SPLITBUF(1:5)
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-gdo-fine-SPLITBUF(6:8)
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-gdo-fine-SPLITBUF(14:8)
           .

       tpromo-tpr-chiave-fine-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-chiave-fine-SPLITBUF
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-fine-SPLITBUF(1:8)
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-fine-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-chiave-fine-SPLITBUF(17:5)
           .

       tpromo-tpr-chiave-ini-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-chiave-ini-SPLITBUF
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-ini-SPLITBUF(1:8)
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo-tpr-chiave-ini-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-chiave-ini-SPLITBUF(17:5)
           .

       tpromo-tpr-chiave-volantino-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-chiave-volantino-SPLITBUF
           MOVE tpr-ini-volantino OF tpromo(1:8) TO 
           tpromo-tpr-chiave-volantino-SPLITBUF(1:8)
           MOVE tpr-fine-volantino OF tpromo(1:8) TO 
           tpromo-tpr-chiave-volantino-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-chiave-volantino-SPLITBUF(17:5)
           .

       tpromo-tpr-k-fine-vol-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-k-fine-vol-SPLITBUF
           MOVE tpr-fine-volantino OF tpromo(1:8) TO 
           tpromo-tpr-k-fine-vol-SPLITBUF(1:8)
           MOVE tpr-ini-volantino OF tpromo(1:8) TO 
           tpromo-tpr-k-fine-vol-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-k-fine-vol-SPLITBUF(17:5)
           .

       tpromo-tpr-k-data-ins-MERGE-SPLITBUF.
           INITIALIZE tpromo-tpr-k-data-ins-SPLITBUF
           MOVE tpr-data-creazione OF tpromo(1:8) TO 
           tpromo-tpr-k-data-ins-SPLITBUF(1:8)
           MOVE tpr-codice OF tpromo(1:15) TO 
           tpromo-tpr-k-data-ins-SPLITBUF(9:15)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo-tpr-k-data-ins-SPLITBUF(24:5)
           .

       DataSet1-tpromo-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 MOVE Low-Value TO tpr-chiave OF tpromo
              ELSE
                 MOVE High-Value TO tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-tpromo-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 MOVE High-Value TO tpr-chiave OF tpromo
              ELSE
                 MOVE Low-Value TO tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tpromo-KEY1-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tpromo-KEY1-ORDER
           END-EVALUATE
           .

      * tpromo
       DataSet1-tpromo-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 START tpromo KEY >= tpr-chiave OF tpromo
              ELSE
                 START tpromo KEY <= tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-tpromo-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 START tpromo KEY <= tpr-chiave OF tpromo
              ELSE
                 START tpromo KEY >= tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-tpromo-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 START tpromo KEY > tpr-chiave OF tpromo
              ELSE
                 START tpromo KEY < tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-tpromo-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 START tpromo KEY < tpr-chiave OF tpromo
              ELSE
                 START tpromo KEY > tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           .

       DataSet1-tpromo-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-LOCK
                 READ tpromo WITH LOCK 
                 KEY tpr-chiave OF tpromo
              ELSE
                 READ tpromo WITH NO LOCK 
                 KEY tpr-chiave OF tpromo
              END-IF
           END-EVALUATE
           PERFORM tpromo-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT 
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tpromo-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 IF DataSet1-tpromo-LOCK
                    READ tpromo NEXT WITH LOCK
                 ELSE
                    READ tpromo NEXT WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tpromo-LOCK
                    READ tpromo PREVIOUS WITH LOCK
                 ELSE
                    READ tpromo PREVIOUS WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           PERFORM tpromo-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tpromo-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tpromo-KEY1-Asc
                 IF DataSet1-tpromo-LOCK
                    READ tpromo PREVIOUS WITH LOCK
                 ELSE
                    READ tpromo PREVIOUS WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tpromo-LOCK
                    READ tpromo NEXT WITH LOCK
                 ELSE
                    READ tpromo NEXT WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           PERFORM tpromo-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tpromo-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeWrite>
      * <TOTEM:END>
           WRITE tpr-rec OF tpromo.
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tpromo-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeRewrite>
      * <TOTEM:END>
           REWRITE tpr-rec OF tpromo.
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tpromo-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, BeforeDelete>
      * <TOTEM:END>
           DELETE tpromo.
           MOVE STATUS-tpromo TO TOTEM-ERR-STAT
           MOVE "tpromo" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo, AfterDelete>
      * <TOTEM:END>
           .

       tpromo1-tpr-chiave-ricerca-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-chiave-ricerca-SPLITBUF
           MOVE tpr-chiave-ricerca OF tpromo(1:21) TO 
           tpromo1-tpr-chiave-ricerca-SPLITBUF(1:21)
           .

       tpromo1-tpr-chiave-gdo-fine-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-chiave-gdo-fine-SPLITBUF
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-chiave-gdo-fine-SPLITBUF(1:5)
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-gdo-fine-SPLITBUF(6:8)
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-gdo-fine-SPLITBUF(14:8)
           .

       tpromo1-tpr-chiave-fine-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-chiave-fine-SPLITBUF
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-fine-SPLITBUF(1:8)
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-fine-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-chiave-fine-SPLITBUF(17:5)
           .

       tpromo1-tpr-chiave-ini-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-chiave-ini-SPLITBUF
           MOVE tpr-ini-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-ini-SPLITBUF(1:8)
           MOVE tpr-fine-dpo OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-ini-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-chiave-ini-SPLITBUF(17:5)
           .

       tpromo1-tpr-chiave-volantino-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-chiave-volantino-SPLITBUF
           MOVE tpr-ini-volantino OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-volantino-SPLITBUF(1:8)
           MOVE tpr-fine-volantino OF tpromo(1:8) TO 
           tpromo1-tpr-chiave-volantino-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-chiave-volantino-SPLITBUF(17:5)
           .

       tpromo1-tpr-k-fine-vol-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-k-fine-vol-SPLITBUF
           MOVE tpr-fine-volantino OF tpromo(1:8) TO 
           tpromo1-tpr-k-fine-vol-SPLITBUF(1:8)
           MOVE tpr-ini-volantino OF tpromo(1:8) TO 
           tpromo1-tpr-k-fine-vol-SPLITBUF(9:8)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-k-fine-vol-SPLITBUF(17:5)
           .

       tpromo1-tpr-k-data-ins-MERGE-SPLITBUF.
           INITIALIZE tpromo1-tpr-k-data-ins-SPLITBUF
           MOVE tpr-data-creazione OF tpromo(1:8) TO 
           tpromo1-tpr-k-data-ins-SPLITBUF(1:8)
           MOVE tpr-codice OF tpromo(1:15) TO 
           tpromo1-tpr-k-data-ins-SPLITBUF(9:15)
           MOVE tpr-gdo OF tpromo(1:5) TO 
           tpromo1-tpr-k-data-ins-SPLITBUF(24:5)
           .

       DataSet1-tpromo1-INITSTART.
           IF DataSet1-tpromo1-KEY-Asc
              MOVE Low-Value TO tpr-chiave OF tpromo1
           ELSE
              MOVE High-Value TO tpr-chiave OF tpromo1
           END-IF
           .

       DataSet1-tpromo1-INITEND.
           IF DataSet1-tpromo1-KEY-Asc
              MOVE High-Value TO tpr-chiave OF tpromo1
           ELSE
              MOVE Low-Value TO tpr-chiave OF tpromo1
           END-IF
           .

      * tpromo1
       DataSet1-tpromo1-START.
           IF DataSet1-tpromo1-KEY-Asc
              START tpromo1 KEY >= tpr-chiave OF tpromo1
           ELSE
              START tpromo1 KEY <= tpr-chiave OF tpromo1
           END-IF
           .

       DataSet1-tpromo1-START-NOTGREATER.
           IF DataSet1-tpromo1-KEY-Asc
              START tpromo1 KEY <= tpr-chiave OF tpromo1
           ELSE
              START tpromo1 KEY >= tpr-chiave OF tpromo1
           END-IF
           .

       DataSet1-tpromo1-START-GREATER.
           IF DataSet1-tpromo1-KEY-Asc
              START tpromo1 KEY > tpr-chiave OF tpromo1
           ELSE
              START tpromo1 KEY < tpr-chiave OF tpromo1
           END-IF
           .

       DataSet1-tpromo1-START-LESS.
           IF DataSet1-tpromo1-KEY-Asc
              START tpromo1 KEY < tpr-chiave OF tpromo1
           ELSE
              START tpromo1 KEY > tpr-chiave OF tpromo1
           END-IF
           .

       DataSet1-tpromo1-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tpromo1-LOCK
              READ tpromo1 WITH LOCK 
              KEY tpr-chiave OF tpromo1
           ELSE
              READ tpromo1 WITH NO LOCK 
              KEY tpr-chiave OF tpromo1
           END-IF
           PERFORM tpromo1-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT 
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tpromo1-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tpromo1-KEY-Asc
              IF DataSet1-tpromo1-LOCK
                 READ tpromo1 NEXT WITH LOCK
              ELSE
                 READ tpromo1 NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tpromo1-LOCK
                 READ tpromo1 PREVIOUS WITH LOCK
              ELSE
                 READ tpromo1 PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM tpromo1-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tpromo1-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tpromo1-KEY-Asc
              IF DataSet1-tpromo1-LOCK
                 READ tpromo1 PREVIOUS WITH LOCK
              ELSE
                 READ tpromo1 PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tpromo1-LOCK
                 READ tpromo1 NEXT WITH LOCK
              ELSE
                 READ tpromo1 NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM tpromo1-tpr-chiave-ricerca-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-fine-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-ini-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-chiave-volantino-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-fine-vol-MERGE-SPLITBUF
           PERFORM tpromo1-tpr-k-data-ins-MERGE-SPLITBUF
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tpromo1-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tpromo1-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tpromo1-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tpromo1 TO TOTEM-ERR-STAT
           MOVE "tpromo1" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tpromo1, AfterDelete>
      * <TOTEM:END>
           .

       listini-lst-k-articolo-MERGE-SPLITBUF.
           INITIALIZE listini-lst-k-articolo-SPLITBUF
           MOVE lst-gdo OF listini(1:5) TO 
           listini-lst-k-articolo-SPLITBUF(1:5)
           MOVE lst-articolo OF listini(1:6) TO 
           listini-lst-k-articolo-SPLITBUF(6:6)
           MOVE lst-data OF listini(1:8) TO 
           listini-lst-k-articolo-SPLITBUF(12:8)
           .

       listini-lst-k-cod-art-cli-MERGE-SPLITBUF.
           INITIALIZE listini-lst-k-cod-art-cli-SPLITBUF
           MOVE lst-gdo OF listini(1:5) TO 
           listini-lst-k-cod-art-cli-SPLITBUF(1:5)
           MOVE lst-cod-art-cli OF listini(1:15) TO 
           listini-lst-k-cod-art-cli-SPLITBUF(6:15)
           MOVE lst-data OF listini(1:8) TO 
           listini-lst-k-cod-art-cli-SPLITBUF(21:8)
           .

       listini-lst-k-data-MERGE-SPLITBUF.
           INITIALIZE listini-lst-k-data-SPLITBUF
           MOVE lst-data OF listini(1:8) TO 
           listini-lst-k-data-SPLITBUF(1:8)
           MOVE lst-gdo OF listini(1:5) TO 
           listini-lst-k-data-SPLITBUF(9:5)
           MOVE lst-cod-art-cli OF listini(1:15) TO 
           listini-lst-k-data-SPLITBUF(14:15)
           .

       DataSet1-listini-INITSTART.
           IF DataSet1-listini-KEY-Asc
              MOVE Low-Value TO lst-chiave OF listini
           ELSE
              MOVE High-Value TO lst-chiave OF listini
           END-IF
           .

       DataSet1-listini-INITEND.
           IF DataSet1-listini-KEY-Asc
              MOVE High-Value TO lst-chiave OF listini
           ELSE
              MOVE Low-Value TO lst-chiave OF listini
           END-IF
           .

      * listini
       DataSet1-listini-START.
           IF DataSet1-listini-KEY-Asc
              START listini KEY >= lst-chiave OF listini
           ELSE
              START listini KEY <= lst-chiave OF listini
           END-IF
           .

       DataSet1-listini-START-NOTGREATER.
           IF DataSet1-listini-KEY-Asc
              START listini KEY <= lst-chiave OF listini
           ELSE
              START listini KEY >= lst-chiave OF listini
           END-IF
           .

       DataSet1-listini-START-GREATER.
           IF DataSet1-listini-KEY-Asc
              START listini KEY > lst-chiave OF listini
           ELSE
              START listini KEY < lst-chiave OF listini
           END-IF
           .

       DataSet1-listini-START-LESS.
           IF DataSet1-listini-KEY-Asc
              START listini KEY < lst-chiave OF listini
           ELSE
              START listini KEY > lst-chiave OF listini
           END-IF
           .

       DataSet1-listini-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-listini-LOCK
              READ listini WITH LOCK 
              KEY lst-chiave OF listini
           ELSE
              READ listini WITH NO LOCK 
              KEY lst-chiave OF listini
           END-IF
           PERFORM listini-lst-k-articolo-MERGE-SPLITBUF
           PERFORM listini-lst-k-cod-art-cli-MERGE-SPLITBUF
           PERFORM listini-lst-k-data-MERGE-SPLITBUF
           MOVE STATUS-listini TO TOTEM-ERR-STAT 
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-listini-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-listini-KEY-Asc
              IF DataSet1-listini-LOCK
                 READ listini NEXT WITH LOCK
              ELSE
                 READ listini NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-listini-LOCK
                 READ listini PREVIOUS WITH LOCK
              ELSE
                 READ listini PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM listini-lst-k-articolo-MERGE-SPLITBUF
           PERFORM listini-lst-k-cod-art-cli-MERGE-SPLITBUF
           PERFORM listini-lst-k-data-MERGE-SPLITBUF
           MOVE STATUS-listini TO TOTEM-ERR-STAT
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-listini-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-listini-KEY-Asc
              IF DataSet1-listini-LOCK
                 READ listini PREVIOUS WITH LOCK
              ELSE
                 READ listini PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-listini-LOCK
                 READ listini NEXT WITH LOCK
              ELSE
                 READ listini NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM listini-lst-k-articolo-MERGE-SPLITBUF
           PERFORM listini-lst-k-cod-art-cli-MERGE-SPLITBUF
           PERFORM listini-lst-k-data-MERGE-SPLITBUF
           MOVE STATUS-listini TO TOTEM-ERR-STAT
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-listini-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-listini TO TOTEM-ERR-STAT
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-listini-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-listini TO TOTEM-ERR-STAT
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-listini-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:listini, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-listini TO TOTEM-ERR-STAT
           MOVE "listini" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:listini, AfterDelete>
      * <TOTEM:END>
           .

       locali-loc-chiave-gdo-fine-MERGE-SPLITBUF.
           INITIALIZE locali-loc-chiave-gdo-fine-SPLITBUF
           MOVE loc-gdo(1:5) TO locali-loc-chiave-gdo-fine-SPLITBUF(1:5)
           MOVE loc-cliente(1:5) TO 
           locali-loc-chiave-gdo-fine-SPLITBUF(6:5)
           MOVE loc-destino(1:5) TO 
           locali-loc-chiave-gdo-fine-SPLITBUF(11:5)
           MOVE loc-fine-dpo(1:8) TO 
           locali-loc-chiave-gdo-fine-SPLITBUF(16:8)
           MOVE loc-ini-dpo(1:8) TO 
           locali-loc-chiave-gdo-fine-SPLITBUF(24:8)
           .

       locali-loc-chiave-fine-MERGE-SPLITBUF.
           INITIALIZE locali-loc-chiave-fine-SPLITBUF
           MOVE loc-fine-dpo(1:8) TO 
           locali-loc-chiave-fine-SPLITBUF(1:8)
           MOVE loc-ini-dpo(1:8) TO locali-loc-chiave-fine-SPLITBUF(9:8)
           MOVE loc-gdo(1:5) TO locali-loc-chiave-fine-SPLITBUF(17:5)
           MOVE loc-cliente(1:5) TO 
           locali-loc-chiave-fine-SPLITBUF(22:5)
           MOVE loc-destino(1:5) TO 
           locali-loc-chiave-fine-SPLITBUF(27:5)
           .

       locali-loc-chiave-ini-MERGE-SPLITBUF.
           INITIALIZE locali-loc-chiave-ini-SPLITBUF
           MOVE loc-ini-dpo(1:8) TO locali-loc-chiave-ini-SPLITBUF(1:8)
           MOVE loc-fine-dpo(1:8) TO locali-loc-chiave-ini-SPLITBUF(9:8)
           MOVE loc-gdo(1:5) TO locali-loc-chiave-ini-SPLITBUF(17:5)
           MOVE loc-cliente(1:5) TO locali-loc-chiave-ini-SPLITBUF(22:5)
           MOVE loc-destino(1:5) TO locali-loc-chiave-ini-SPLITBUF(27:5)
           .

       DataSet1-locali-INITSTART.
           IF DataSet1-locali-KEY-Asc
              MOVE Low-Value TO loc-chiave
           ELSE
              MOVE High-Value TO loc-chiave
           END-IF
           .

       DataSet1-locali-INITEND.
           IF DataSet1-locali-KEY-Asc
              MOVE High-Value TO loc-chiave
           ELSE
              MOVE Low-Value TO loc-chiave
           END-IF
           .

      * locali
       DataSet1-locali-START.
           IF DataSet1-locali-KEY-Asc
              START locali KEY >= loc-chiave
           ELSE
              START locali KEY <= loc-chiave
           END-IF
           .

       DataSet1-locali-START-NOTGREATER.
           IF DataSet1-locali-KEY-Asc
              START locali KEY <= loc-chiave
           ELSE
              START locali KEY >= loc-chiave
           END-IF
           .

       DataSet1-locali-START-GREATER.
           IF DataSet1-locali-KEY-Asc
              START locali KEY > loc-chiave
           ELSE
              START locali KEY < loc-chiave
           END-IF
           .

       DataSet1-locali-START-LESS.
           IF DataSet1-locali-KEY-Asc
              START locali KEY < loc-chiave
           ELSE
              START locali KEY > loc-chiave
           END-IF
           .

       DataSet1-locali-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-locali-LOCK
              READ locali WITH LOCK 
              KEY loc-chiave
           ELSE
              READ locali WITH NO LOCK 
              KEY loc-chiave
           END-IF
           PERFORM locali-loc-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-ini-MERGE-SPLITBUF
           MOVE STATUS-locali TO TOTEM-ERR-STAT 
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-locali-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-locali-KEY-Asc
              IF DataSet1-locali-LOCK
                 READ locali NEXT WITH LOCK
              ELSE
                 READ locali NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-locali-LOCK
                 READ locali PREVIOUS WITH LOCK
              ELSE
                 READ locali PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM locali-loc-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-ini-MERGE-SPLITBUF
           MOVE STATUS-locali TO TOTEM-ERR-STAT
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-locali-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-locali-KEY-Asc
              IF DataSet1-locali-LOCK
                 READ locali PREVIOUS WITH LOCK
              ELSE
                 READ locali PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-locali-LOCK
                 READ locali NEXT WITH LOCK
              ELSE
                 READ locali NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM locali-loc-chiave-gdo-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-fine-MERGE-SPLITBUF
           PERFORM locali-loc-chiave-ini-MERGE-SPLITBUF
           MOVE STATUS-locali TO TOTEM-ERR-STAT
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-locali-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeWrite>
      * <TOTEM:END>
           WRITE loc-rec OF locali.
           MOVE STATUS-locali TO TOTEM-ERR-STAT
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-locali-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeRewrite>
      * <TOTEM:END>
           REWRITE loc-rec OF locali.
           MOVE STATUS-locali TO TOTEM-ERR-STAT
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-locali-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:locali, BeforeDelete>
      * <TOTEM:END>
           DELETE locali.
           MOVE STATUS-locali TO TOTEM-ERR-STAT
           MOVE "locali" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:locali, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-timposte-INITSTART.
           IF DataSet1-timposte-KEY-Asc
              MOVE Low-Value TO imp-chiave
           ELSE
              MOVE High-Value TO imp-chiave
           END-IF
           .

       DataSet1-timposte-INITEND.
           IF DataSet1-timposte-KEY-Asc
              MOVE High-Value TO imp-chiave
           ELSE
              MOVE Low-Value TO imp-chiave
           END-IF
           .

      * timposte
       DataSet1-timposte-START.
           IF DataSet1-timposte-KEY-Asc
              START timposte KEY >= imp-chiave
           ELSE
              START timposte KEY <= imp-chiave
           END-IF
           .

       DataSet1-timposte-START-NOTGREATER.
           IF DataSet1-timposte-KEY-Asc
              START timposte KEY <= imp-chiave
           ELSE
              START timposte KEY >= imp-chiave
           END-IF
           .

       DataSet1-timposte-START-GREATER.
           IF DataSet1-timposte-KEY-Asc
              START timposte KEY > imp-chiave
           ELSE
              START timposte KEY < imp-chiave
           END-IF
           .

       DataSet1-timposte-START-LESS.
           IF DataSet1-timposte-KEY-Asc
              START timposte KEY < imp-chiave
           ELSE
              START timposte KEY > imp-chiave
           END-IF
           .

       DataSet1-timposte-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-timposte-LOCK
              READ timposte WITH LOCK 
              KEY imp-chiave
           ELSE
              READ timposte WITH NO LOCK 
              KEY imp-chiave
           END-IF
           MOVE STATUS-timposte TO TOTEM-ERR-STAT 
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-timposte-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-timposte-KEY-Asc
              IF DataSet1-timposte-LOCK
                 READ timposte NEXT WITH LOCK
              ELSE
                 READ timposte NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timposte-LOCK
                 READ timposte PREVIOUS WITH LOCK
              ELSE
                 READ timposte PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timposte TO TOTEM-ERR-STAT
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-timposte-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-timposte-KEY-Asc
              IF DataSet1-timposte-LOCK
                 READ timposte PREVIOUS WITH LOCK
              ELSE
                 READ timposte PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timposte-LOCK
                 READ timposte NEXT WITH LOCK
              ELSE
                 READ timposte NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timposte TO TOTEM-ERR-STAT
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-timposte-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-timposte TO TOTEM-ERR-STAT
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-timposte-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-timposte TO TOTEM-ERR-STAT
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-timposte-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-timposte TO TOTEM-ERR-STAT
           MOVE "timposte" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timposte, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-timballi-INITSTART.
           IF DataSet1-timballi-KEY-Asc
              MOVE Low-Value TO imb-chiave
           ELSE
              MOVE High-Value TO imb-chiave
           END-IF
           .

       DataSet1-timballi-INITEND.
           IF DataSet1-timballi-KEY-Asc
              MOVE High-Value TO imb-chiave
           ELSE
              MOVE Low-Value TO imb-chiave
           END-IF
           .

      * timballi
       DataSet1-timballi-START.
           IF DataSet1-timballi-KEY-Asc
              START timballi KEY >= imb-chiave
           ELSE
              START timballi KEY <= imb-chiave
           END-IF
           .

       DataSet1-timballi-START-NOTGREATER.
           IF DataSet1-timballi-KEY-Asc
              START timballi KEY <= imb-chiave
           ELSE
              START timballi KEY >= imb-chiave
           END-IF
           .

       DataSet1-timballi-START-GREATER.
           IF DataSet1-timballi-KEY-Asc
              START timballi KEY > imb-chiave
           ELSE
              START timballi KEY < imb-chiave
           END-IF
           .

       DataSet1-timballi-START-LESS.
           IF DataSet1-timballi-KEY-Asc
              START timballi KEY < imb-chiave
           ELSE
              START timballi KEY > imb-chiave
           END-IF
           .

       DataSet1-timballi-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-timballi-LOCK
              READ timballi WITH LOCK 
              KEY imb-chiave
           ELSE
              READ timballi WITH NO LOCK 
              KEY imb-chiave
           END-IF
           MOVE STATUS-timballi TO TOTEM-ERR-STAT 
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-timballi-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-timballi-KEY-Asc
              IF DataSet1-timballi-LOCK
                 READ timballi NEXT WITH LOCK
              ELSE
                 READ timballi NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timballi-LOCK
                 READ timballi PREVIOUS WITH LOCK
              ELSE
                 READ timballi PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timballi TO TOTEM-ERR-STAT
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-timballi-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-timballi-KEY-Asc
              IF DataSet1-timballi-LOCK
                 READ timballi PREVIOUS WITH LOCK
              ELSE
                 READ timballi PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timballi-LOCK
                 READ timballi NEXT WITH LOCK
              ELSE
                 READ timballi NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timballi TO TOTEM-ERR-STAT
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-timballi-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-timballi TO TOTEM-ERR-STAT
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-timballi-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-timballi TO TOTEM-ERR-STAT
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-timballi-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-timballi TO TOTEM-ERR-STAT
           MOVE "timballi" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timballi, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-INITSTART.
           IF DataSet1-timbalqta-KEY-Asc
              MOVE Low-Value TO imq-chiave
           ELSE
              MOVE High-Value TO imq-chiave
           END-IF
           .

       DataSet1-timbalqta-INITEND.
           IF DataSet1-timbalqta-KEY-Asc
              MOVE High-Value TO imq-chiave
           ELSE
              MOVE Low-Value TO imq-chiave
           END-IF
           .

      * timbalqta
       DataSet1-timbalqta-START.
           IF DataSet1-timbalqta-KEY-Asc
              START timbalqta KEY >= imq-chiave
           ELSE
              START timbalqta KEY <= imq-chiave
           END-IF
           .

       DataSet1-timbalqta-START-NOTGREATER.
           IF DataSet1-timbalqta-KEY-Asc
              START timbalqta KEY <= imq-chiave
           ELSE
              START timbalqta KEY >= imq-chiave
           END-IF
           .

       DataSet1-timbalqta-START-GREATER.
           IF DataSet1-timbalqta-KEY-Asc
              START timbalqta KEY > imq-chiave
           ELSE
              START timbalqta KEY < imq-chiave
           END-IF
           .

       DataSet1-timbalqta-START-LESS.
           IF DataSet1-timbalqta-KEY-Asc
              START timbalqta KEY < imq-chiave
           ELSE
              START timbalqta KEY > imq-chiave
           END-IF
           .

       DataSet1-timbalqta-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-timbalqta-LOCK
              READ timbalqta WITH LOCK 
              KEY imq-chiave
           ELSE
              READ timbalqta WITH NO LOCK 
              KEY imq-chiave
           END-IF
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT 
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-timbalqta-KEY-Asc
              IF DataSet1-timbalqta-LOCK
                 READ timbalqta NEXT WITH LOCK
              ELSE
                 READ timbalqta NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timbalqta-LOCK
                 READ timbalqta PREVIOUS WITH LOCK
              ELSE
                 READ timbalqta PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-timbalqta-KEY-Asc
              IF DataSet1-timbalqta-LOCK
                 READ timbalqta PREVIOUS WITH LOCK
              ELSE
                 READ timbalqta PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-timbalqta-LOCK
                 READ timbalqta NEXT WITH LOCK
              ELSE
                 READ timbalqta NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-timbalqta-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-timbalqta TO TOTEM-ERR-STAT
           MOVE "timbalqta" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:timbalqta, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-lineseq-INITSTART.
           .

       DataSet1-lineseq-INITEND.
           .

       DataSet1-lineseq-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadRecord>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadNext>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeWrite>
      * <TOTEM:END>
           WRITE line-riga OF lineseq.
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-lineseq TO TOTEM-ERR-STAT
           MOVE "lineseq" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq, AfterDelete>
      * <TOTEM:END>
           .

       blister-k-magaz-MERGE-SPLITBUF.
           INITIALIZE blister-k-magaz-SPLITBUF
           MOVE bli-magazzino(1:3) TO blister-k-magaz-SPLITBUF(1:3)
           MOVE bli-codice(1:6) TO blister-k-magaz-SPLITBUF(4:6)
           .

       blister-k-des-MERGE-SPLITBUF.
           INITIALIZE blister-k-des-SPLITBUF
           MOVE bli-descrizione(1:50) TO blister-k-des-SPLITBUF(1:50)
           .

       DataSet1-blister-INITSTART.
           IF DataSet1-blister-KEY-Asc
              MOVE Low-Value TO bli-chiave
           ELSE
              MOVE High-Value TO bli-chiave
           END-IF
           .

       DataSet1-blister-INITEND.
           IF DataSet1-blister-KEY-Asc
              MOVE High-Value TO bli-chiave
           ELSE
              MOVE Low-Value TO bli-chiave
           END-IF
           .

      * blister
       DataSet1-blister-START.
           IF DataSet1-blister-KEY-Asc
              START blister KEY >= bli-chiave
           ELSE
              START blister KEY <= bli-chiave
           END-IF
           .

       DataSet1-blister-START-NOTGREATER.
           IF DataSet1-blister-KEY-Asc
              START blister KEY <= bli-chiave
           ELSE
              START blister KEY >= bli-chiave
           END-IF
           .

       DataSet1-blister-START-GREATER.
           IF DataSet1-blister-KEY-Asc
              START blister KEY > bli-chiave
           ELSE
              START blister KEY < bli-chiave
           END-IF
           .

       DataSet1-blister-START-LESS.
           IF DataSet1-blister-KEY-Asc
              START blister KEY < bli-chiave
           ELSE
              START blister KEY > bli-chiave
           END-IF
           .

       DataSet1-blister-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-blister-LOCK
              READ blister WITH LOCK 
              KEY bli-chiave
           ELSE
              READ blister WITH NO LOCK 
              KEY bli-chiave
           END-IF
           PERFORM blister-k-magaz-MERGE-SPLITBUF
           PERFORM blister-k-des-MERGE-SPLITBUF
           MOVE STATUS-blister TO TOTEM-ERR-STAT 
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-blister-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-blister-KEY-Asc
              IF DataSet1-blister-LOCK
                 READ blister NEXT WITH LOCK
              ELSE
                 READ blister NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-blister-LOCK
                 READ blister PREVIOUS WITH LOCK
              ELSE
                 READ blister PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM blister-k-magaz-MERGE-SPLITBUF
           PERFORM blister-k-des-MERGE-SPLITBUF
           MOVE STATUS-blister TO TOTEM-ERR-STAT
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-blister-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-blister-KEY-Asc
              IF DataSet1-blister-LOCK
                 READ blister PREVIOUS WITH LOCK
              ELSE
                 READ blister PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-blister-LOCK
                 READ blister NEXT WITH LOCK
              ELSE
                 READ blister NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM blister-k-magaz-MERGE-SPLITBUF
           PERFORM blister-k-des-MERGE-SPLITBUF
           MOVE STATUS-blister TO TOTEM-ERR-STAT
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-blister-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-blister TO TOTEM-ERR-STAT
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-blister-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-blister TO TOTEM-ERR-STAT
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-blister-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:blister, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-blister TO TOTEM-ERR-STAT
           MOVE "blister" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:blister, AfterDelete>
      * <TOTEM:END>
           .

       clienti-cli-K1-MERGE-SPLITBUF.
           INITIALIZE clienti-cli-K1-SPLITBUF
           MOVE cli-tipo-CF OF clienti(1:1) TO 
           clienti-cli-K1-SPLITBUF(1:1)
           MOVE cli-ragsoc-1 OF clienti(1:40) TO 
           clienti-cli-K1-SPLITBUF(2:40)
           MOVE cli-codice OF clienti(1:5) TO 
           clienti-cli-K1-SPLITBUF(42:5)
           .

       clienti-cli-K3-MERGE-SPLITBUF.
           INITIALIZE clienti-cli-K3-SPLITBUF
           MOVE cli-gdo OF clienti(1:5) TO clienti-cli-K3-SPLITBUF(1:5)
           MOVE cli-chiave OF clienti(1:6) TO 
           clienti-cli-K3-SPLITBUF(6:6)
           .

       clienti-cli-K4-MERGE-SPLITBUF.
           INITIALIZE clienti-cli-K4-SPLITBUF
           MOVE cli-utf OF clienti(1:1) TO clienti-cli-K4-SPLITBUF(1:1)
           MOVE cli-chiave OF clienti(1:6) TO 
           clienti-cli-K4-SPLITBUF(2:6)
           .

       DataSet1-clienti-INITSTART.
           IF DataSet1-clienti-KEY-Asc
              MOVE Low-Value TO cli-chiave OF clienti
           ELSE
              MOVE High-Value TO cli-chiave OF clienti
           END-IF
           .

       DataSet1-clienti-INITEND.
           IF DataSet1-clienti-KEY-Asc
              MOVE High-Value TO cli-chiave OF clienti
           ELSE
              MOVE Low-Value TO cli-chiave OF clienti
           END-IF
           .

      * clienti
       DataSet1-clienti-START.
           IF DataSet1-clienti-KEY-Asc
              START clienti KEY >= cli-chiave OF clienti
           ELSE
              START clienti KEY <= cli-chiave OF clienti
           END-IF
           .

       DataSet1-clienti-START-NOTGREATER.
           IF DataSet1-clienti-KEY-Asc
              START clienti KEY <= cli-chiave OF clienti
           ELSE
              START clienti KEY >= cli-chiave OF clienti
           END-IF
           .

       DataSet1-clienti-START-GREATER.
           IF DataSet1-clienti-KEY-Asc
              START clienti KEY > cli-chiave OF clienti
           ELSE
              START clienti KEY < cli-chiave OF clienti
           END-IF
           .

       DataSet1-clienti-START-LESS.
           IF DataSet1-clienti-KEY-Asc
              START clienti KEY < cli-chiave OF clienti
           ELSE
              START clienti KEY > cli-chiave OF clienti
           END-IF
           .

       DataSet1-clienti-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-clienti-LOCK
              READ clienti WITH LOCK 
              KEY cli-chiave OF clienti
           ELSE
              READ clienti WITH NO LOCK 
              KEY cli-chiave OF clienti
           END-IF
           PERFORM clienti-cli-K1-MERGE-SPLITBUF
           PERFORM clienti-cli-K3-MERGE-SPLITBUF
           PERFORM clienti-cli-K4-MERGE-SPLITBUF
           MOVE STATUS-clienti TO TOTEM-ERR-STAT 
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-clienti-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-clienti-KEY-Asc
              IF DataSet1-clienti-LOCK
                 READ clienti NEXT WITH LOCK
              ELSE
                 READ clienti NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-clienti-LOCK
                 READ clienti PREVIOUS WITH LOCK
              ELSE
                 READ clienti PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM clienti-cli-K1-MERGE-SPLITBUF
           PERFORM clienti-cli-K3-MERGE-SPLITBUF
           PERFORM clienti-cli-K4-MERGE-SPLITBUF
           MOVE STATUS-clienti TO TOTEM-ERR-STAT
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-clienti-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-clienti-KEY-Asc
              IF DataSet1-clienti-LOCK
                 READ clienti PREVIOUS WITH LOCK
              ELSE
                 READ clienti PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-clienti-LOCK
                 READ clienti NEXT WITH LOCK
              ELSE
                 READ clienti NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM clienti-cli-K1-MERGE-SPLITBUF
           PERFORM clienti-cli-K3-MERGE-SPLITBUF
           PERFORM clienti-cli-K4-MERGE-SPLITBUF
           MOVE STATUS-clienti TO TOTEM-ERR-STAT
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-clienti-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-clienti TO TOTEM-ERR-STAT
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-clienti-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-clienti TO TOTEM-ERR-STAT
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-clienti-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-clienti TO TOTEM-ERR-STAT
           MOVE "clienti" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:clienti, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-INITSTART.
           IF DataSet1-tsetinvio-KEY-Asc
              MOVE Low-Value TO tsi-chiave
           ELSE
              MOVE High-Value TO tsi-chiave
           END-IF
           .

       DataSet1-tsetinvio-INITEND.
           IF DataSet1-tsetinvio-KEY-Asc
              MOVE High-Value TO tsi-chiave
           ELSE
              MOVE Low-Value TO tsi-chiave
           END-IF
           .

      * tsetinvio
       DataSet1-tsetinvio-START.
           IF DataSet1-tsetinvio-KEY-Asc
              START tsetinvio KEY >= tsi-chiave
           ELSE
              START tsetinvio KEY <= tsi-chiave
           END-IF
           .

       DataSet1-tsetinvio-START-NOTGREATER.
           IF DataSet1-tsetinvio-KEY-Asc
              START tsetinvio KEY <= tsi-chiave
           ELSE
              START tsetinvio KEY >= tsi-chiave
           END-IF
           .

       DataSet1-tsetinvio-START-GREATER.
           IF DataSet1-tsetinvio-KEY-Asc
              START tsetinvio KEY > tsi-chiave
           ELSE
              START tsetinvio KEY < tsi-chiave
           END-IF
           .

       DataSet1-tsetinvio-START-LESS.
           IF DataSet1-tsetinvio-KEY-Asc
              START tsetinvio KEY < tsi-chiave
           ELSE
              START tsetinvio KEY > tsi-chiave
           END-IF
           .

       DataSet1-tsetinvio-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tsetinvio-LOCK
              READ tsetinvio WITH LOCK 
              KEY tsi-chiave
           ELSE
              READ tsetinvio WITH NO LOCK 
              KEY tsi-chiave
           END-IF
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT 
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tsetinvio-KEY-Asc
              IF DataSet1-tsetinvio-LOCK
                 READ tsetinvio NEXT WITH LOCK
              ELSE
                 READ tsetinvio NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tsetinvio-LOCK
                 READ tsetinvio PREVIOUS WITH LOCK
              ELSE
                 READ tsetinvio PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tsetinvio-KEY-Asc
              IF DataSet1-tsetinvio-LOCK
                 READ tsetinvio PREVIOUS WITH LOCK
              ELSE
                 READ tsetinvio PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tsetinvio-LOCK
                 READ tsetinvio NEXT WITH LOCK
              ELSE
                 READ tsetinvio NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeWrite>
      * <TOTEM:END>
           WRITE tsi-rec OF tsetinvio.
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeRewrite>
      * <TOTEM:END>
           REWRITE tsi-rec OF tsetinvio.
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tsetinvio-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, BeforeDelete>
      * <TOTEM:END>
           DELETE tsetinvio.
           MOVE STATUS-tsetinvio TO TOTEM-ERR-STAT
           MOVE "tsetinvio" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tsetinvio, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tscorte-INITSTART.
           IF DataSet1-tscorte-KEY-Asc
              MOVE Low-Value TO sco-chiave
           ELSE
              MOVE High-Value TO sco-chiave
           END-IF
           .

       DataSet1-tscorte-INITEND.
           IF DataSet1-tscorte-KEY-Asc
              MOVE High-Value TO sco-chiave
           ELSE
              MOVE Low-Value TO sco-chiave
           END-IF
           .

      * tscorte
       DataSet1-tscorte-START.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY >= sco-chiave
           ELSE
              START tscorte KEY <= sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-NOTGREATER.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY <= sco-chiave
           ELSE
              START tscorte KEY >= sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-GREATER.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY > sco-chiave
           ELSE
              START tscorte KEY < sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-LESS.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY < sco-chiave
           ELSE
              START tscorte KEY > sco-chiave
           END-IF
           .

       DataSet1-tscorte-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tscorte-LOCK
              READ tscorte WITH LOCK 
              KEY sco-chiave
           ELSE
              READ tscorte WITH NO LOCK 
              KEY sco-chiave
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT 
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tscorte-KEY-Asc
              IF DataSet1-tscorte-LOCK
                 READ tscorte NEXT WITH LOCK
              ELSE
                 READ tscorte NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tscorte-LOCK
                 READ tscorte PREVIOUS WITH LOCK
              ELSE
                 READ tscorte PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tscorte-KEY-Asc
              IF DataSet1-tscorte-LOCK
                 READ tscorte PREVIOUS WITH LOCK
              ELSE
                 READ tscorte PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tscorte-LOCK
                 READ tscorte NEXT WITH LOCK
              ELSE
                 READ tscorte NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tmarche-INITSTART.
           IF DataSet1-tmarche-KEY-Asc
              MOVE Low-Value TO mar-chiave
           ELSE
              MOVE High-Value TO mar-chiave
           END-IF
           .

       DataSet1-tmarche-INITEND.
           IF DataSet1-tmarche-KEY-Asc
              MOVE High-Value TO mar-chiave
           ELSE
              MOVE Low-Value TO mar-chiave
           END-IF
           .

      * tmarche
       DataSet1-tmarche-START.
           IF DataSet1-tmarche-KEY-Asc
              START tmarche KEY >= mar-chiave
           ELSE
              START tmarche KEY <= mar-chiave
           END-IF
           .

       DataSet1-tmarche-START-NOTGREATER.
           IF DataSet1-tmarche-KEY-Asc
              START tmarche KEY <= mar-chiave
           ELSE
              START tmarche KEY >= mar-chiave
           END-IF
           .

       DataSet1-tmarche-START-GREATER.
           IF DataSet1-tmarche-KEY-Asc
              START tmarche KEY > mar-chiave
           ELSE
              START tmarche KEY < mar-chiave
           END-IF
           .

       DataSet1-tmarche-START-LESS.
           IF DataSet1-tmarche-KEY-Asc
              START tmarche KEY < mar-chiave
           ELSE
              START tmarche KEY > mar-chiave
           END-IF
           .

       DataSet1-tmarche-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tmarche-LOCK
              READ tmarche WITH LOCK 
              KEY mar-chiave
           ELSE
              READ tmarche WITH NO LOCK 
              KEY mar-chiave
           END-IF
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT 
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tmarche-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tmarche-KEY-Asc
              IF DataSet1-tmarche-LOCK
                 READ tmarche NEXT WITH LOCK
              ELSE
                 READ tmarche NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tmarche-LOCK
                 READ tmarche PREVIOUS WITH LOCK
              ELSE
                 READ tmarche PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tmarche-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tmarche-KEY-Asc
              IF DataSet1-tmarche-LOCK
                 READ tmarche PREVIOUS WITH LOCK
              ELSE
                 READ tmarche PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tmarche-LOCK
                 READ tmarche NEXT WITH LOCK
              ELSE
                 READ tmarche NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tmarche-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tmarche-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tmarche-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tmarche TO TOTEM-ERR-STAT
           MOVE "tmarche" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmarche, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-INITSTART.
           .

       DataSet1-lineseq-mail-INITEND.
           .

       DataSet1-lineseq-mail-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeReadRecord>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeReadNext>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeWrite>
      * <TOTEM:END>
           WRITE line-riga-mail OF lineseq-mail.
           MOVE STATUS-lineseq-mail TO TOTEM-ERR-STAT
           MOVE "lineseq-mail" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-lineseq-mail TO TOTEM-ERR-STAT
           MOVE "lineseq-mail" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-lineseq-mail-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-lineseq-mail TO TOTEM-ERR-STAT
           MOVE "lineseq-mail" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:lineseq-mail, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-fileseq-INITSTART.
           .

       DataSet1-fileseq-INITEND.
           .

       DataSet1-fileseq-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-fileseq-LOCK
              READ fileseq WITH LOCK 
           ELSE
              READ fileseq WITH NO LOCK 
           END-IF
           MOVE STATUS-fileseq TO TOTEM-ERR-STAT 
           MOVE "fileseq" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-fileseq-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-fileseq-KEY-Asc
              IF DataSet1-fileseq-LOCK
                 READ fileseq NEXT WITH LOCK
              ELSE
                 READ fileseq NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-fileseq TO TOTEM-ERR-STAT
           MOVE "fileseq" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-fileseq-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-fileseq-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-fileseq TO TOTEM-ERR-STAT
           MOVE "fileseq" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-fileseq-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-fileseq TO TOTEM-ERR-STAT
           MOVE "fileseq" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-fileseq-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-fileseq TO TOTEM-ERR-STAT
           MOVE "fileseq" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:fileseq, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-INIT-RECORD.
           INITIALIZE des-rec OF destini
           INITIALIZE art-rec OF articoli
           INITIALIZE rpr-rec OF rpromo
           INITIALIZE gdo-rec OF tgrupgdo
           INITIALIZE tpr-rec OF tpromo
           INITIALIZE tpr-rec OF tpromo1
           INITIALIZE lst-rec OF listini
           INITIALIZE loc-rec OF locali
           INITIALIZE imp-rec OF timposte
           INITIALIZE imb-rec OF timballi
           INITIALIZE imq-rec OF timbalqta
           INITIALIZE line-riga OF lineseq
           INITIALIZE bli-rec OF blister
           INITIALIZE cli-rec OF clienti
           INITIALIZE tsi-rec OF tsetinvio
           INITIALIZE sco-rec OF tscorte
           INITIALIZE mar-rec OF tmarche
           INITIALIZE line-riga-mail OF lineseq-mail
           INITIALIZE rec-stampa OF fileseq
           .


      * GRID
       gd-dest-Content.
      * CELLS' SETTING
              MODIFY gd-dest, X = 1, Y = 1,
                CELL-DATA = "Ragione Sociale",
      * CELLS' SETTING
              MODIFY gd-dest, X = 2, Y = 1,
                CELL-DATA = "Destino",
      * CELLS' SETTING
              MODIFY gd-dest, X = 3, Y = 1,
                CELL-DATA = "Località",
      * CELLS' SETTING
              MODIFY gd-dest, X = 4, Y = 1,
                CELL-DATA = "Indirizzo",
      * CELLS' SETTING
              MODIFY gd-dest, X = 5, Y = 1,
                CELL-DATA = "CAP",
      * CELLS' SETTING
              MODIFY gd-dest, X = 6, Y = 1,
                CELL-DATA = "Prov",
           .

      * GRID
       gd1-Content.
      * CELLS' SETTING
              MODIFY gd1, X = 1, Y = 1,
                CELL-DATA = "Articolo",
      * CELLS' SETTING
              MODIFY gd1, X = 2, Y = 1,
                CELL-DATA = "Descrizione",
      * CELLS' SETTING
              MODIFY gd1, X = 3, Y = 1,
                CELL-DATA = "Prezzo Vendita",
      * CELLS' SETTING
              MODIFY gd1, X = 4, Y = 1,
                CELL-DATA = "Prezzo Acquisto",
      * CELLS' SETTING
              MODIFY gd1, X = 5, Y = 1,
                CELL-DATA = "Quantità",
           .

      * GRID
       gd-art-Content.
      * CELLS' SETTING
              MODIFY gd-art, X = 1, Y = 1,
                CELL-DATA = "Codice",
      * CELLS' SETTING
              MODIFY gd-art, X = 2, Y = 1,
                CELL-DATA = "Descrizione",
      * CELLS' SETTING
              MODIFY gd-art, X = 3, Y = 1,
                CELL-DATA = "Prezzo",
      * CELLS' SETTING
              MODIFY gd-art, X = 4, Y = 1,
                CELL-DATA = "Q.tà",
           .

      * FD's Initialize Paragraph
       DataSet1-destini-INITREC.
           INITIALIZE des-rec OF destini
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-articoli-INITREC.
           INITIALIZE art-rec OF articoli
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-rpromo-INITREC.
           INITIALIZE rpr-rec OF rpromo
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tgrupgdo-INITREC.
           INITIALIZE gdo-rec OF tgrupgdo
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tpromo-INITREC.
           INITIALIZE tpr-rec OF tpromo
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tpromo1-INITREC.
           INITIALIZE tpr-rec OF tpromo1
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-listini-INITREC.
           INITIALIZE lst-rec OF listini
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-locali-INITREC.
           INITIALIZE loc-rec OF locali
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-timposte-INITREC.
           INITIALIZE imp-rec OF timposte
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-timballi-INITREC.
           INITIALIZE imb-rec OF timballi
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-timbalqta-INITREC.
           INITIALIZE imq-rec OF timbalqta
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-lineseq-INITREC.
           INITIALIZE line-riga OF lineseq
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-blister-INITREC.
           INITIALIZE bli-rec OF blister
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-clienti-INITREC.
           INITIALIZE cli-rec OF clienti
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tsetinvio-INITREC.
           INITIALIZE tsi-rec OF tsetinvio
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tscorte-INITREC.
           INITIALIZE sco-rec OF tscorte
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tmarche-INITREC.
           INITIALIZE mar-rec OF tmarche
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-lineseq-mail-INITREC.
           INITIALIZE line-riga-mail OF lineseq-mail
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-fileseq-INITREC.
           INITIALIZE rec-stampa OF fileseq
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 1 ALSO 0
                  PERFORM Form1-Buf-To-Fld
           END-EVALUATE
           .

       Form1-DISPLAY-STATUS-MSG.
            MODIFY Form1-St-1-Handle PANEL-INDEX = 1
                PANEL-TEXT = TOTEM-HINT-TEXT
           .

       Form1-CLEAR-STATUS-MSG.
           MOVE SPACES TO TOTEM-MSG-1, TOTEM-MSG-2, TOTEM-MSG-3, 
           TOTEM-MSG-TEXT
           PERFORM Form1-DISPLAY-STATUS-MSG
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           DISPLAY Form1-Tb-1
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 51,77,
              SIZE 157,67,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Small-Font,
              LABEL-OFFSET 23,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              AUTO-MINIMIZE,
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS form1-Handle,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
           DISPLAY TOOL-BAR 
              LINES 2,69,   
              HANDLE IN Form1-Tb-1-Handle
           DISPLAY Form1-Tb-1 UPON Form1-Tb-1-Handle

      * Status-bar
           DISPLAY STATUS-BAR
              FONT IS Small-Font,
              GRIP,
              PANEL-WIDTHS (95, 23, 999),
              PANEL-STYLE  (1, 1, 1),
              PANEL-TEXT   (SPACE, SPACE, SPACE),
              HANDLE IS Form1-St-1-Handle
           DISPLAY Form1 UPON form1-Handle
      * DISPLAY-COLUMNS settings
              MODIFY gd-dest, DISPLAY-COLUMNS (1, 31, 61, 91, 121, 130)
              MODIFY gd1, DISPLAY-COLUMNS (1, 13, 91, 111, 131)
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
           perform INIT.
           perform ABILITA-TOOLBAR.
           perform ABILITAZIONI.
           perform STATUS-BAR-MSG.
           call "C$CALLEDBY" using CallingPgm.
           if CallingPgm = "lab-promo-art"
              move link-codice-volantino to ef-codice-buf
              display ef-codice
              perform CURRENT-RECORD
           end-if.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY form1-Handle
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
           evaluate key-status
           when 5 |MODIFICA
                inquire tool-modifica, enabled in e-modifica
                if e-modifica = 1
                   if mod = zero 
                      move 1    to mod
                   else          
                      move zero to mod
                   end-if
                   modify tool-modifica, value = mod
                   perform MODIFICA
                end-if
           end-evaluate.

           .
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = mod-copia
                 PERFORM pb-copia-LinkTo
              WHEN Key-Status = 1000
                 PERFORM pb-blister-LinkTo
              WHEN Key-Status = 1003
                 PERFORM pb-extra-LinkTo
              WHEN Key-Status = 2001
                 PERFORM pb-nazio-LinkTo
              WHEN Key-Status = 2000
                 PERFORM pb-dest-LinkTo
              WHEN Key-Status = 2
                 PERFORM NUOVO-LinkTo
              WHEN Key-Status = 4
                 PERFORM CANCELLA-LinkTo
              WHEN Key-Status = 3
                 PERFORM TOOL-SALVA-LinkTo
              WHEN Key-Status = 6
                 PERFORM ANTEPRIMA-LinkTo
              WHEN Key-Status = 150
                 PERFORM TOOL-MODIFICA-LinkTo
              WHEN Key-Status = 7
                 PERFORM STAMPA-LinkTo
              WHEN Key-Status = 8
                 PERFORM TOOL-CERCA-LinkTo
              WHEN Key-Status = 9
                 PERFORM TOOL-SELEZIONA-LinkTo
              WHEN Key-Status = 1002
                 PERFORM TOOL-PRIMO
              WHEN Key-Status = 67
                 PERFORM TOOL-PRECEDENTE
              WHEN Key-Status = 68
                 PERFORM TOOL-SUCCESSIVO
              WHEN Key-Status = 1006
                 PERFORM TOOL-ULTIMO
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1-Tb-1
           DISPLAY Form1 UPON form1-Handle
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
           perform SALV-MOD.

           if errori
              move 26 to key-status
              exit paragraph
           end-if.

           .
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM gd-dest-Content
      * GRID
           PERFORM gd1-Content
           .

       Form1-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tpromo-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tpromo-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Update-Key.
           MOVE tpr-rec OF tpromo TO
                     Form1-MULKEY-TMPBUF
           PERFORM Form1-CLEAR
           PERFORM Form1-INIT-DATA
           MOVE Form1-MULKEY-TMPBUF TO
                     tpr-rec OF tpromo
           PERFORM DataSet1-tpromo-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
           .

       Form1-DUPLICATE-MOVEKEY.
           .

       Form1-First.
           PERFORM Form1-DUMMY-FIRST
           PERFORM DataSet1-tpromo-INITSTART
           PERFORM DataSet1-tpromo-START
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-tpromo-Read-Next
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFirst>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Previous.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-tpromo-START-LESS
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-tpromo-Read-Prev
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterPrevious>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-PREVIOUS
           PERFORM Form1-IUD-Display
           .

       Form1-Next.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-tpromo-START-GREATER
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-tpromo-Read-Next
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterNext>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-NEXT
           PERFORM Form1-IUD-Display
           .
      
       Form1-Last.
           PERFORM Form1-DUMMY-LAST
           PERFORM DataSet1-tpromo-INITEND
           PERFORM DataSet1-tpromo-START-NOTGREATER
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-tpromo-Read-Prev
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterLast>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Curr.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tpromo-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCurrent>
      * <TOTEM:END>
           .

       Form1-IUD-Display.
           IF Valid-STATUS-tpromo
              PERFORM Form1-ALLGRID-RESET
              PERFORM Form1-Fld-To-Buf
              PERFORM Form1-NAVI-FOR-MASTERGRID
              PERFORM Form1-DISPLAY
           ELSE
              IF Form1-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Form1-Extended-File-Status
              END-IF
           END-IF
           .

       Form1-Add.
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-ADD
           PERFORM DataSet1-tpromo-INITREC
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tpromo-Rec-Write
           IF Valid-STATUS-tpromo
              PERFORM Form1-RESUMMARY-INS
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAdd>
      * <TOTEM:END>
           .
     
       Form1-Update.
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tpromo-START              
           IF NOT Valid-STATUS-tpromo
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-tpromo-Read
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-UPDATE
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tpromo-Rec-Rewrite
           IF Valid-STATUS-tpromo
              PERFORM Form1-RESUMMARY-DEL
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterUpdate>
      * <TOTEM:END>
           .

       Form1-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDelete>
      * <TOTEM:END>
           PERFORM Form1-DUMMY-DELETE
      * delete
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tpromo-Rec-Delete
           IF Valid-STATUS-tpromo
              PERFORM Form1-CLEAR
              PERFORM Form1-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to STATUS-tpromo
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDelete>
      * <TOTEM:END>
           PERFORM Form1-ERR-CHECKING
           .

       Form1-NAVI-FOR-MASTERGRID.
           .

       Form1-ERR-CHECKING.
           IF Valid-STATUS-tpromo
              PERFORM Form1-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Form1-Extended-File-Status
           END-IF
           .

       Form1-RESUMMARY-INS.
           .

       Form1-RESUMMARY-DEL.
           .


       Form1-DUMMY-FIRST.
           .

       Form1-DUMMY-PREVIOUS.
           .

       Form1-DUMMY-NEXT.
           .

       Form1-DUMMY-LAST.
           .

       Form1-DUMMY-CURR.
           .

       Form1-DUMMY-ADD.
           .

       Form1-DUMMY-UPDATE.
           .

       Form1-DUMMY-UPDATE-INIT.
           .

       Form1-DUMMY-DELETE.
           .

       Form1-DUMMY-DELETE-INIT.
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
           INITIALIZE Form1-BUF
      * FORM : Form1
           PERFORM DataSet1-INIT-RECORD
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
      * ef-codice's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-codice-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5001 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-gdo's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-gdo-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5002 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-ini-dpo's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-ini-dpo-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5004 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-fine-dpo's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-fine-dpo-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5005 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-nome's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-nome-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5006 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-ini-vol's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-ini-vol-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5007 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-fine-vol's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-fine-vol-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5008 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-sett's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-sett-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5009 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-nomea's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-nomea-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5010 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
           .

       ef-codice-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-codice, BeforeValidation>
      * <TOTEM:END>
           .

       ef-codice-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-codice, AfterValidation>
      * <TOTEM:END>
           .

      * ef-codice's Validation
       ef-codice-VALIDATION.
           PERFORM ef-codice-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-codice-AFTER-VALIDATION
           .

       ef-gdo-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-gdo, BeforeValidation>
      * <TOTEM:END>
           .

       ef-gdo-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-gdo, AfterValidation>
      * <TOTEM:END>
           .

      * ef-gdo's Validation
       ef-gdo-VALIDATION.
           PERFORM ef-gdo-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-gdo-AFTER-VALIDATION
           .

       ef-ini-dpo-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-ini-dpo, BeforeValidation>
      * <TOTEM:END>
           .

       ef-ini-dpo-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-ini-dpo, AfterValidation>
      * <TOTEM:END>
           .

      * ef-ini-dpo's Validation
       ef-ini-dpo-VALIDATION.
           PERFORM ef-ini-dpo-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-ini-dpo-AFTER-VALIDATION
           .

       ef-fine-dpo-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-fine-dpo, BeforeValidation>
      * <TOTEM:END>
           .

       ef-fine-dpo-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-fine-dpo, AfterValidation>
      * <TOTEM:END>
           .

      * ef-fine-dpo's Validation
       ef-fine-dpo-VALIDATION.
           PERFORM ef-fine-dpo-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-fine-dpo-AFTER-VALIDATION
           .

       ef-nome-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-nome, BeforeValidation>
      * <TOTEM:END>
           .

       ef-nome-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-nome, AfterValidation>
      * <TOTEM:END>
           .

      * ef-nome's Validation
       ef-nome-VALIDATION.
           PERFORM ef-nome-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-nome-AFTER-VALIDATION
           .

       ef-ini-vol-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-ini-vol, BeforeValidation>
      * <TOTEM:END>
           .

       ef-ini-vol-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-ini-vol, AfterValidation>
      * <TOTEM:END>
           .

      * ef-ini-vol's Validation
       ef-ini-vol-VALIDATION.
           PERFORM ef-ini-vol-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-ini-vol-AFTER-VALIDATION
           .

       ef-fine-vol-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-fine-vol, BeforeValidation>
      * <TOTEM:END>
           .

       ef-fine-vol-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-fine-vol, AfterValidation>
      * <TOTEM:END>
           .

      * ef-fine-vol's Validation
       ef-fine-vol-VALIDATION.
           PERFORM ef-fine-vol-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-fine-vol-AFTER-VALIDATION
           .

       ef-sett-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-sett, BeforeValidation>
      * <TOTEM:END>
           .

       ef-sett-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-sett, AfterValidation>
      * <TOTEM:END>
           .

      * ef-sett's Validation
       ef-sett-VALIDATION.
           PERFORM ef-sett-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-sett-AFTER-VALIDATION
           .

       ef-nomea-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-nomea, BeforeValidation>
      * <TOTEM:END>
           .

       ef-nomea-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-nomea, AfterValidation>
      * <TOTEM:END>
           .

      * ef-nomea's Validation
       ef-nomea-VALIDATION.
           PERFORM ef-nomea-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-nomea-AFTER-VALIDATION
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * DB_Entry-Field : ef-codice
           MOVE ef-codice-BUF TO tpr-codice of tpromo
      * DB_Entry-Field : ef-gdo
           MOVE ef-gdo-BUF TO tpr-gdo of tpromo
      * DB_Entry-Field : ef-ini-dpo
           MOVE ef-ini-dpo-BUF TO tpr-ini-dpo of tpromo
      * DB_Entry-Field : ef-fine-dpo
           MOVE ef-fine-dpo-BUF TO tpr-fine-dpo of tpromo
      * DB_Entry-Field : ef-nome
           MOVE ef-nome-BUF TO tpr-descrizione of tpromo
      * DB_Entry-Field : ef-ini-vol
           MOVE ef-ini-vol-BUF TO tpr-ini-volantino of tpromo
      * DB_Entry-Field : ef-fine-vol
           MOVE ef-fine-vol-BUF TO tpr-fine-volantino of tpromo
      * DB_Entry-Field : ef-sett
           MOVE ef-sett-BUF TO tpr-sett-uscita of tpromo
      * DB_Entry-Field : ef-nomea
           MOVE ef-nomea-BUF TO tpr-note of tpromo
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
           move ef-ini-dpo-buf to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-ini-dpo of tpromo.

           move ef-fine-dpo-buf to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-fine-dpo of tpromo.

           move ef-ini-vol-buf to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-ini-volantino of tpromo.

           move ef-fine-vol-buf to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-fine-volantino of tpromo.

           .
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
      * <TOTEM:END>
      * DB_Entry-Field : ef-codice
           MOVE tpr-codice of tpromo TO ef-codice-BUF
      * DB_Entry-Field : ef-gdo
           MOVE tpr-gdo of tpromo TO ef-gdo-BUF
      * DB_Entry-Field : ef-ini-dpo
           MOVE tpr-ini-dpo of tpromo TO ef-ini-dpo-BUF
      * DB_Entry-Field : ef-fine-dpo
           MOVE tpr-fine-dpo of tpromo TO ef-fine-dpo-BUF
      * DB_Entry-Field : ef-nome
           MOVE tpr-descrizione of tpromo TO ef-nome-BUF
      * DB_Entry-Field : ef-ini-vol
           MOVE tpr-ini-volantino of tpromo TO ef-ini-vol-BUF
      * DB_Entry-Field : ef-fine-vol
           MOVE tpr-fine-volantino of tpromo TO ef-fine-vol-BUF
      * DB_Entry-Field : ef-sett
           MOVE tpr-sett-uscita of tpromo TO ef-sett-BUF
      * DB_Entry-Field : ef-nomea
           MOVE tpr-note of tpromo TO ef-nomea-BUF
      * DB_LABEL : lab-nome
              MOVE tpr-descrizione of tpromo  TO lab-nome-BUF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
           perform ABILITAZIONI.

           move tpr-gdo of tpromo to gdo-codice.
           read tgrupgdo no lock
                invalid move spaces to gdo-intestazione
           end-read.
           move gdo-intestazione to lab-gdo-buf.

           move tpr-ini-dpo of tpromo to como-data.
           perform DATE-TO-SCREEN.
           move como-data to ef-ini-dpo-buf.

           move tpr-fine-dpo of tpromo to como-data.
           perform DATE-TO-SCREEN.
           move como-data to ef-fine-dpo-buf.

           move tpr-ini-volantino of tpromo to como-data.
           perform DATE-TO-SCREEN.
           move como-data to ef-ini-vol-buf.

           move tpr-fine-volantino of tpromo to como-data.
           perform DATE-TO-SCREEN.
           move como-data to ef-fine-vol-buf.

           Perform VALORIZZA-OLD.

           .
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.

           if tpr-gdo of tpromo not = old-tpr-gdo
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-gdo è l'ID del campo ef-gdo
              move 78-ID-ef-gdo to store-id 
           end-if


           if tpr-ini-dpo of tpromo not = old-tpr-ini-dpo
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-ini-dpo è l'ID del campo ef-ini-dpo
              move 78-ID-ef-ini-dpo to store-id 
           end-if


           if tpr-fine-dpo of tpromo not = old-tpr-fine-dpo
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-fine-dpo è l'ID del campo ef-fine-dpo
              move 78-ID-ef-fine-dpo to store-id 
           end-if


           if tpr-descrizione of tpromo not = old-tpr-descrizione
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-nome è l'ID del campo ef-nome
              move 78-ID-ef-nome to store-id 
           end-if


           if tpr-ini-volantino of tpromo not = old-tpr-ini-volantino
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-ini-vol è l'ID del campo ef-ini-vol
              move 78-ID-ef-ini-vol to store-id 
           end-if


           if tpr-fine-volantino of tpromo not = old-tpr-fine-volantino
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-fine-vol è l'ID del campo ef-fine-vol
              move 78-ID-ef-fine-vol to store-id 
           end-if


           if tpr-sett-uscita of tpromo not = old-tpr-sett-uscita
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-sett è l'ID del campo ef-sett
              move 78-ID-ef-sett to store-id 
           end-if


           if tpr-note of tpromo not = old-tpr-note
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-nomea è l'ID del campo ef-nomea
              move 78-ID-ef-nomea to store-id 
           end-if

           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           MOVE DataSet1-tpromo-KEY1-ORDER TO TMP-Form1-KEY1-ORDER
           MOVE DataSet1-KEYIS TO TMP-Form1-KEYIS
           MOVE tpr-rec OF tpromo TO 
              TMP-Form1-tpromo-RESTOREBUF
           .             

       Form1-Restore-Status.
           MOVE TMP-Form1-KEY1-ORDER TO DataSet1-tpromo-KEY1-ORDER
           MOVE TMP-Form1-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Form1-tpromo-RESTOREBUF TO
              tpr-rec OF tpromo
           PERFORM DataSet1-tpromo-START
           IF Valid-STATUS-tpromo
              PERFORM DataSet1-tpromo-Read-Next
           ELSE
              PERFORM DataSet1-tpromo-INITREC
           END-IF
           PERFORM UNTIL NOT Valid-STATUS-tpromo OR
              (Valid-STATUS-tpromo AND
                 tpr-rec OF tpromo = 
                   TMP-Form1-tpromo-RESTOREBUF)
              PERFORM DataSet1-tpromo-Read-Next
           END-PERFORM
           .


      * Paragrafo per la struttura del codice in BEFORE sulla screen Form1
      ***---
       Form1-BEFORE-SCREEN.
           evaluate control-id
           |78-ID-ef-gdo è l'ID del campo ef-gdo
           when 78-ID-ef-gdo
                move 1 to StatusHelp
                perform STATUS-HELP
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella BEFORE della screen
           when 99999 continue
           when other continue
           end-evaluate.

      * Generazione settaggio keyboard "." ---> ","

      * Paragrafo per la struttura del codice in AFTER sulla screen Form1
      ***---
       Form1-AFTER-SCREEN.
           evaluate control-id
           |78-ID-ef-gdo è l'ID del campo ef-gdo
           when 78-ID-ef-gdo
                move 0 to StatusHelp
                perform STATUS-HELP

           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER della screen
           when 99999 continue
           when other continue
           end-evaluate.

      * Generazione risettaggio keyboard "." ---> "."

      * Generazione stringa perform CONTROLLO
           evaluate control-id
           |78-ID-ef-codice è l'ID del campo ef-codice
           when 78-ID-ef-codice
                perform CONTROLLO
           |78-ID-ef-gdo è l'ID del campo ef-gdo
           when 78-ID-ef-gdo
                perform CONTROLLO
           |78-ID-ef-ini-dpo è l'ID del campo ef-ini-dpo
           when 78-ID-ef-ini-dpo
                perform CONTROLLO
           |78-ID-ef-fine-dpo è l'ID del campo ef-fine-dpo
           when 78-ID-ef-fine-dpo
                perform CONTROLLO
           |78-ID-ef-nome è l'ID del campo ef-nome
           when 78-ID-ef-nome
                perform CONTROLLO
           |78-ID-ef-ini-vol è l'ID del campo ef-ini-vol
           when 78-ID-ef-ini-vol
                perform CONTROLLO
           |78-ID-ef-fine-vol è l'ID del campo ef-fine-vol
           when 78-ID-ef-fine-vol
                perform CONTROLLO
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER CONTROLLO della screen
           when 99999 continue
           when other continue
           end-evaluate.

       Screen1-Open-Routine.
           PERFORM Screen1-Scrn
           PERFORM Screen1-Proc
           .

       Screen1-Scrn.
           PERFORM Screen1-Create-Win
           PERFORM Screen1-Init-Value
           PERFORM Screen1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM Screen1-DISPLAY
           .

       Screen1-Create-Win.
           Display Floating GRAPHICAL WINDOW
              LINES 37,94,
              SIZE 66,80,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Verdana12-Occidentale,
              LINK TO THREAD,
              NO SCROLL,
              TITLE-BAR,
              TITLE "GESLUX - Inserimento Extra Sconti",
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS Screen1-Handle,
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY Screen1 UPON Screen1-Handle
      * DISPLAY-COLUMNS settings
              MODIFY gd-art, DISPLAY-COLUMNS (1, 9, 47, 56)
           .

       Screen1-PROC.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeAccept>
           modify lab,  visible false.
           modify lab2, visible false.
           move spaces to ef-des-buf.
           move 0      to ef-sconto-buf.     
           modify pb-ok-s,      bitmap-number = 1.
           modify pb-annulla-s, bitmap-number = 1.
           move 78-ID-ef-des to control-id.
           move 4            to accept-control.
           display ef-des ef-sconto.
           modify gd-art, reset-grid = 1.
           perform GD-ART-CONTENT.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Screen1
                 ON EXCEPTION
                    PERFORM Screen1-Evaluate-Func
                 MOVE 2 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Screen1-Handle
           INITIALIZE Key-Status
           .

       Screen1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Screen1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Screen1-Exit
                 END-IF
              WHEN Key-Status = 1000
                 PERFORM pb-ok-s-LinkTo
              WHEN Key-Status = 1001
                 PERFORM pb-genera-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Screen1-CLEAR.
           PERFORM Screen1-INIT-VALUE
           PERFORM Screen1-DISPLAY
           .

       Screen1-DISPLAY.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Screen1 UPON Screen1-Handle
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Screen1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Screen1-Init-Data.
           MOVE 2 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM gd-art-Content
           .

       Screen1-Init-Value.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, SetDefault>
      * <TOTEM:END>
           PERFORM Screen1-FLD-TO-BUF
           .


       Screen1-ALLGRID-RESET.
           .

      * for Form's Validation
       Screen1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       Screen1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterBufToFld>
      * <TOTEM:END>
           .

       Screen1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Screen1, FORM:Screen1, AfterFldToBuf>
      * <TOTEM:END>
           .

       Screen1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Screen1-BUF-TO-FLD.
           move 0 to scelta.
           .
       Screen1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Screen1-SHOW-MSG-ROUTINE
           .

       Screen1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Screen1-DISPLAY-MESSAGE
           .

       Screen1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Screen1-Save-Status.
           .             

       Screen1-Restore-Status.
           .


      * Paragrafo per la struttura del codice in BEFORE sulla screen Screen1
      ***---
       Screen1-BEFORE-SCREEN.
           evaluate control-id
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella BEFORE della screen
           when 99999 continue
           when other continue
           end-evaluate.

      * Generazione settaggio keyboard "." ---> ","

      * Paragrafo per la struttura del codice in AFTER sulla screen Screen1
      ***---
       Screen1-AFTER-SCREEN.
           evaluate control-id
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER della screen
           when 99999 continue
           when other continue
           end-evaluate.

      * Generazione risettaggio keyboard "." ---> "."

      * Generazione stringa perform CONTROLLO
           evaluate control-id
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER CONTROLLO della screen
           when 99999 continue
           when other continue
           end-evaluate.



       Form1-BeforeProcedure.
           EVALUATE Control-Id
           WHEN 5001 MOVE "Digitare il Codice" to TOTEM-HINT-TEXT
           WHEN 5002 MOVE "Digitare il gruppo GDO" to TOTEM-HINT-TEXT
           WHEN 5004 MOVE "Digitare la data d'inizio DPO" to 
           TOTEM-HINT-TEXT
           WHEN 5005 MOVE "Digitare la data di fine DPO" to 
           TOTEM-HINT-TEXT
           WHEN 5006 MOVE "Digitare il nome del volantino" to 
           TOTEM-HINT-TEXT
           WHEN 5007 MOVE "Digitare la data d'inizio volantino" to 
           TOTEM-HINT-TEXT
           WHEN 5008 MOVE "Digitare la data di fine volantino" to 
           TOTEM-HINT-TEXT
           WHEN 5009 MOVE "Digitare la settimana di uscita" to 
           TOTEM-HINT-TEXT
           WHEN 5010 MOVE "Digitare le note che verranno riportate in te
      -    "sta alla bozza" to TOTEM-HINT-TEXT
           WHEN AUTO-ID MOVE "." to TOTEM-HINT-TEXT
           WHEN OTHER MOVE SPACES TO TOTEM-HINT-TEXT
           END-EVALUATE
           EVALUATE Control-Id
           When 5001 PERFORM Screen1-DaEf-1-BeforeProcedure
           When 5002 PERFORM ef-gdo-BeforeProcedure
           When 5004 PERFORM ef-ini-dpo-BeforeProcedure
           When 5005 PERFORM ef-fine-dpo-BeforeProcedure
           When 5006 PERFORM ef-nome-BeforeProcedure
           When 5007 PERFORM ef-ini-vol-BeforeProcedure
           When 5008 PERFORM ef-fine-vol-BeforeProcedure
           When 5009 PERFORM ef-sett-BeforeProcedure
           When 5010 PERFORM ef-nome-BeforeProcedure
           END-EVALUATE
           PERFORM Form1-DISPLAY-STATUS-MSG
           perform Form1-BEFORE-SCREEN
           .

       Form1-AfterProcedure.
           EVALUATE Control-Id
           When 5001 PERFORM Screen1-DaEf-1-AfterProcedure
           When 5002 PERFORM ef-gdo-AfterProcedure
           When 5004 PERFORM ef-ini-dpo-AfterProcedure
           When 5005 PERFORM ef-fine-dpo-AfterProcedure
           When 5006 PERFORM ef-nome-AfterProcedure
           When 5007 PERFORM ef-ini-vol-AfterProcedure
           When 5008 PERFORM ef-fine-vol-AfterProcedure
           When 5009 PERFORM ef-sett-AfterProcedure
           When 5010 PERFORM ef-nome-AfterProcedure
           END-EVALUATE
           perform Form1-AFTER-SCREEN
           .

       Screen1-BeforeProcedure.
           EVALUATE Control-Id
           WHEN 5001 MOVE "." to TOTEM-HINT-TEXT
           WHEN 5002 MOVE "." to TOTEM-HINT-TEXT
           WHEN OTHER MOVE SPACES TO TOTEM-HINT-TEXT
           END-EVALUATE
           EVALUATE Control-Id
           When 5001 PERFORM ef-des-BeforeProcedure
           When 5002 PERFORM ef-sconto-BeforeProcedure
           END-EVALUATE
           perform Screen1-BEFORE-SCREEN
           .

       Screen1-Event-Proc.
           .

       Screen1-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-End-Drag
           WHEN Msg-Goto-Cell ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5003 ALSO
                    form1-Handle 
              PERFORM gd-dest-Ev-Msg-Goto-Cell-Mouse
           WHEN Msg-Begin-Drag ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5011 ALSO
                    form1-Handle 
              PERFORM gd1-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

       Screen1a-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-End-Drag
           WHEN Msg-Goto-Cell ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5003 ALSO
                    Screen1-Handle 
              PERFORM gd-art-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

      * USER DEFINE PARAGRAPH
       ABILITAZIONI.
      * <TOTEM:PARA. ABILITAZIONI>
           if mod = 1              
              move BitmapDeleteEnabled to BitmapNumDelete
              move BitmapSaveEnabled   to BitmapNumSave
              move 1 to e-salva e-cancella
           else           
              move BitmapDeleteDisabled to BitmapNumDelete
              move BitmapSaveDisabled   to BitmapNumSave
              move 0 to e-salva e-cancella
           end-if.      

      * ISACCO (CORREZIONE SU LIVELLO ABILITAZIONE 2) - 10/11/2003
      * (CANCELLAZIONE NON PERMESSA)
           if livello-abil = 2 
              move 0 to e-cancella
              move BitmapDeleteDisabled to BitmapNumDelete
           end-if.
      * FINE

           modify tool-cancella, enabled = e-cancella.
           modify tool-salva,    enabled = e-salva.
       
      * ISACCO (SERVE SEMPRE PER LA MODIFICA PRCEDENTE E PER RIPRISTINARE
      * LE BITMAP DISABILITATE. - 10/11/2003
      *     perform FORM1-DISPLAY.
           display tool-nuovo, tool-salva, tool-cancella, tool-modifica.
      * FINE 
           .
      * <TOTEM:END>

       ACCODA-RIGA-SU-LISTINO.
      * <TOTEM:PARA. ACCODA-RIGA-SU-LISTINO>
           close    listini.
           open i-o listini.
           move low-value to lst-rec.
           move tpr-gdo   of tpromo to lst-gdo.
           accept lst-data from century-date.
           move rpr-articolo         to lst-articolo.
           move spaces               to lst-cod-art-cli.
           move 0                    to lst-prezzo.
           accept lst-data-creazione from century-date.
           accept lst-ora-creazione  from time.
           move   user-codi          to lst-utente-creazione.
           move   0                  to lst-data-modifica.
           move   0                  to lst-ora-modifica.
           move   spaces             to lst-utente-modifica.
           write lst-rec invalid continue end-write.
           close      listini.
           open input listini 
           .
      * <TOTEM:END>

       ANTEPRIMA.
      * <TOTEM:PARA. ANTEPRIMA>
           set anteprima to true.
           perform STAMPA-ANTEPRIMA 
           .
      * <TOTEM:END>

       CANCELLA.
      * <TOTEM:PARA. CANCELLA>
           if mod = 0 exit paragraph end-if.
      *
           display message box MSG-Cancellare-il-record-corrente
                   title   titolo
                   type    mb-yes-no 
                   default mb-no
                   giving  scelta

           if scelta = mb-yes
              perform RIEMPI-CHIAVE
              delete tpromo record 
                     invalid continue
                 not invalid
                     perform DELETE-RIGHE
                     perform DELETE-DESTINI
              end-delete
              set HoSalvato to true

              move 0 to save-gdo
              move 0 to mod
              move 1 to mod-k
              perform FORM1-CLEAR
              set vecchio to true
              perform CANCELLA-COLORE
              perform INIT-OLD-REC
              perform RESETTA-GRID
              perform RESETTA-GRID-DESTINI
              
              display message box 
           MSG-Cancellazione-avvenuta-con-successo
                      title titolo                         

              unlock tpromo all records

              perform PRIMO 
              move 78-ID-ef-codice to control-id     
              move 4               to accept-control 

              set Statusvisua to true
              perform STATUS-BAR-MSG
              modify TOOL-MODIFICA value = mod
           end-if.         

           if nuovo 
              move 0 to e-copia
           else
              move mod to e-copia
           end-if.

           if e-copia = 0
              modify pb-copia, bitmap-number = 3, enabled = e-copia
           else
              modify pb-copia, bitmap-number = 1, enabled = e-copia
           end-if 
           .
      * <TOTEM:END>

       CERCA.
      * <TOTEM:PARA. CERCA>
           evaluate CONTROL-ID
           when 78-ID-ef-gdo
                inquire ef-gdo, value in gdo-codice
                move "tgrupgdo"     to Como-File
                call   "zoom-gt" using como-file, gdo-rec
                                giving stato-zoom
                cancel "zoom-gt"
                if stato-zoom = 0
                   move gdo-codice       to ef-gdo-buf
                   move gdo-intestazione to lab-gdo-buf
                   display ef-gdo lab-gdo
                   move 4 to accept-control
                end-if
      *
           when 78-ID-gd1
                perform X-Y
                if colonna = 1
                   inquire gd1(riga, 1), cell-data in art-codice
                   move "articoli"     to Como-File
                   call   "zoom-gt" using como-file, art-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      perform CONTROLLA-ARTICOLO-GIA-INSERITO
                      if not trovato
                         perform CONTROLLA-SCORTA
                         if tutto-ok
                            move art-codice          to col-art
                            perform DESCRIZIONE-IMBALLO
                            modify gd1(riga, 1), cell-data = col-art
                            modify gd1(riga, 2), cell-data = col-des
                         end-if
                      end-if
                   end-if
                end-if
           end-evaluate  
           .
      * <TOTEM:END>

       CLEAR-SCREEN.
      * <TOTEM:PARA. CLEAR-SCREEN>
           move tpr-chiave of tpromo to old-tpr-chiave.

           initialize tpr-dati of tpromo 
                     replacing numeric data by zeroes
                          alphanumeric data by spaces.
                         
           perform FORM1-FLD-TO-BUF. 

           perform INIT-OLD-REC.
                                          
           display form1. 

           perform RESETTA-GRID.
           perform RESETTA-GRID-DESTINI.
  
           unlock tpromo all records 
           .
      * <TOTEM:END>

       CHECK-INSERIMENTO.
      * <TOTEM:PARA. CHECK-INSERIMENTO>
      * MODIFICA LA STATUS-BAR
      * CONTROLLO SE DA INSERIMENTO SCORRO. ALLORA DEVO SEGNALARE CHE
      * SONO TORNATO IN MODIFICA.
           inquire tool-modifica, value in mod.

           evaluate mod
           when 1   set StatusModifica to true
           when 0   set StatusVisua    to true   
           end-evaluate.
      
           perform STATUS-BAR-MSG 
           .
      * <TOTEM:END>

       COLORE-RIGA.
      * <TOTEM:PARA. COLORE-RIGA>
           modify gd1, start-x = 1,
                             x = 5,
                       start-y = riga,
                             y = riga,
                  region-color = 257,
                  cursor-color = 481 
           .
      * <TOTEM:END>

       CONTROLLA-ARTICOLO-GIA-INSERITO.
      * <TOTEM:PARA. CONTROLLA-ARTICOLO-GIA-INSERITO>
           set trovato  to false.

           perform varying store-riga from 2 by 1 until
                           store-riga > tot-righe
              inquire gd1(store-riga, 1), cell-data in store-articolo
              if store-articolo  = art-codice and 
                 store-riga  not = riga
                 set trovato to true
                 subtract 1 from store-riga
                 display message "Articolo già inserito a riga: " 
           store-riga
                           title tit-err
                            icon 2
                 set errori to true
                 move spaces to col-des
                 modify gd1(riga, 2), cell-data = col-des
                 exit perform
              end-if
           end-perform 
           .
      * <TOTEM:END>

       CONTROLLA-DESTINO.
      * <TOTEM:PARA. CONTROLLA-DESTINO>
           set tutto-ok to true.
           if save-cliente not = 0 or save-destino not = 0
              move save-cliente to des-codice
              move save-destino to des-prog
              read destini no lock
                   invalid 
                   set errori to true
                   display message "Destino NON valido"
                             title tit-err
                              icon 2
               not invalid
                   set cli-tipo-C  to true
                   move des-codice to cli-codice
                   read clienti no lock
                        invalid
                        set errori to true
                        display message "Cliente NON valido"
                                  title tit-err
                                   icon 2
                    not invalid
                        if cli-gdo not = ef-gdo-buf
                           set errori to true
                           display message "Associazione destino - GDO n
      -    "on valida"
                                     title tit-err
                                      icon 2
                        end-if
                   end-read
              end-read
           end-if 
           .
      * <TOTEM:END>

       CONTROLLA-PERIODO-PROMO.
      * <TOTEM:PARA. CONTROLLA-PERIODO-PROMO>
           move ef-gdo-buf      to store-gdo
                                   tpr-gdo      of tpromo1.
           move ef-codice-buf   to store-codice.
      
           move ef-ini-dpo-buf  to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-ini-dpo of tpromo1 store-ini.
      
           move ef-fine-dpo-buf to como-data.
           perform DATE-TO-FILE.
           move como-data to tpr-fine-dpo of tpromo1 store-fine.

           start tpromo1 key >= tpr-chiave-ricerca of tpromo1
                 invalid continue
             not invalid
                 perform until 1 = 2
                    read tpromo1 next at end exit perform end-read
                    if tpr-gdo      of tpromo1 not = store-gdo or
                       tpr-ini-dpo  of tpromo1 not = store-ini or
                       tpr-fine-dpo of tpromo1 not = store-fine
                       exit perform
                    end-if

                    if tpr-tipo   of tpromo1 = tipo-volantino and
                       tpr-codice of tpromo1 not = tpr-codice of tpromo
                       move tpr-ini-dpo of tpromo1 to como-data
                       perform DATE-TO-SCREEN
                       move como-data to dpo-ini
      
                       move tpr-fine-dpo  of tpromo1 to como-data
                       perform DATE-TO-SCREEN
                       move como-data to dpo-fine
      
                       display message 
                             "Codice: ", tpr-codice of tpromo1
                       x"0d0a"tpr-descrizione       of tpromo1
                       x"0d0a""Periodo DPO: " dpo-ini " - " dpo-fine
                       x"0d0a""Continuare?"
                                 title "ATTENZIONE!!!"
                                  icon 2
                                  type mb-yes-no
                               default mb-no
                                giving scelta
                       if scelta = mb-no
                          set errori to true
                          exit perform
                       end-if
                    end-if
                end-perform
           end-start 
           .
      * <TOTEM:END>

       CONTROLLA-SCORTA.
      * <TOTEM:PARA. CONTROLLA-SCORTA>
           set tutto-ok to true.
           if ef-gdo-buf = spaces exit paragraph end-if.
           move art-scorta to sco-codice.
           read tscorte no lock
                invalid continue
            not invalid
                if sco-no-gdo-si
                   display message "Articolo " art-codice " con scorta n
      -    "on inseribile per promo GDO"
                             title tit-err
                              icon 2
                   set errori to true
                end-if
           end-read 
           .
      * <TOTEM:END>

       CONTROLLA-SCORTA-BLISTER.
      * <TOTEM:PARA. CONTROLLA-SCORTA-BLISTER>
           set tutto-ok to true.
           if ef-gdo-buf = spaces exit paragraph end-if.
           perform varying idx from 1 by 1 
                     until idx > 50
              move bli-el-articolo(idx) to art-codice
              read articoli no lock 
                   invalid continue
               not invalid 
                   perform CONTROLLA-SCORTA
                   if errori exit perform end-if
              end-read
           end-perform 
           .
      * <TOTEM:END>

       CONTROLLO.
      * <TOTEM:PARA. CONTROLLO>
           set tutto-ok to true. 

           evaluate CONTROL-ID
           when 78-ID-ef-codice
                perform RIEMPI-CHIAVE           
                read tpromo no lock
                     invalid
                     if vecchio
                        display message MSG-record-inesistente
                                  title tit-err
                                   icon 2
                        perform CLEAR-SCREEN
                        set errori to true
                     end-if
                 not invalid      
                     if old-tpr-chiave not = tpr-chiave of tpromo or
                      ( tpr-codice of tpromo = 0 and mod = 0 )
                        perform CURRENT-RECORD 
                     end-if
                end-read

           when 78-ID-ef-gdo
                inquire ef-gdo value in gdo-codice
                read tgrupgdo no lock
                     invalid
                     move spaces to gdo-intestazione
                     set errori to true
                     display message "Gruppo GDO non valido"
                               title tit-err
                                icon 2
                end-read
                move gdo-intestazione to lab-gdo-buf
                display lab-gdo
                if tutto-ok
                   if gdo-codice not = save-gdo and not StoSalvando
                      perform RIEMPI-GRID-DESTINI
                   end-if
                end-if

           when 78-ID-ef-ini-dpo
                inquire ef-ini-dpo, value in como-data
                perform DATE-FORMAT
                move como-data to ef-ini-dpo-buf
                display ef-ini-dpo

           when 78-ID-ef-fine-dpo
                inquire ef-fine-dpo, value in como-data
                perform DATE-FORMAT
                move como-data to ef-fine-dpo-buf                
                display ef-fine-dpo
                perform DATE-TO-FILE
                move como-data to como-data-to
                inquire ef-ini-dpo, value in como-data
                perform DATE-TO-FILE
                if como-data-to < como-data
                   set errori to true
                   display message "Range Date DPO errato"
                             title tit-err
                              icon 2
                   move 78-ID-ef-ini-dpo to control-id
                end-if

                if tutto-ok
                   perform CONTROLLA-PERIODO-PROMO
                   if errori
                      move 78-ID-ef-ini-dpo to store-id
                   end-if
                end-if
      
           when 78-ID-ef-nome
                inquire ef-nome, value in lab-nome-buf
                display lab-nome

           when 78-ID-ef-ini-vol
                inquire ef-ini-vol, value in como-data
                perform DATE-FORMAT
                move como-data to ef-ini-vol-buf
                display ef-ini-vol

           when 78-ID-ef-fine-vol
                inquire ef-fine-vol, value in como-data
                perform DATE-FORMAT
                move como-data to ef-fine-vol-buf                
                display ef-fine-vol
                perform DATE-TO-FILE
                move como-data to como-data-to
                inquire ef-ini-vol, value in como-data
                perform DATE-TO-FILE
                if como-data-to < como-data
                   set errori to true
                   display message "Range Date Volantino errato"
                             title tit-err
                              icon 2
                   move 78-ID-ef-ini-dpo to control-id
                end-if
           end-evaluate.
      
           if errori
              perform CANCELLA-COLORE
              move CONTROL-ID to store-id
              move 4          to ACCEPT-CONTROL
           end-if 
           .
      * <TOTEM:END>

       CONTROLLO-S.
      * <TOTEM:PARA. CONTROLLO-S>
           set tutto-ok to true. 

           evaluate control-id
           when 78-ID-ef-des
                inquire ef-des, value in ef-des-buf
                if ef-des-buf = spaces
                   display message "Testo obbligatorio"
                             title tit-err
                              icon 2
                   set errori to true
                end-if

           when 78-ID-ef-sconto
                inquire ef-sconto, value in ef-sconto-buf
           end-evaluate.
      
           if errori
              perform CANCELLA-COLORE
              move control-id to store-id
              move 4          to accept-control
           end-if 
           .
      * <TOTEM:END>

       CONTROLLO-RIGA.
      * <TOTEM:PARA. CONTROLLO-RIGA>
           set tutto-ok to true.
           if mod = 0 exit paragraph end-if.

           evaluate colonna
           when 1
                set blister to false
                read articoli no lock
                     invalid
                     move art-codice to bli-codice
                     read blister no lock
                          invalid
                          set errori to true
                          display message "Articolo NON valido"
                                    title tit-err
                                     icon 2
                          move spaces to art-descrizione
                      not invalid
                          perform CONTROLLA-SCORTA-BLISTER
                          if tutto-ok
                             move bli-descrizione to art-descrizione
                             set blister to true
                             perform DESCRIZIONE-IMBALLO
                          end-if
                     end-read
                 not invalid
                     if art-collegato not = 0
                        move art-scorta to sco-codice
                        read tscorte no lock
                        if sco-avviso-promo-si
                           display message "Articolo con: "
                                    x"0d0a""- Collegato codice:  " 
           art-collegato
                                    x"0d0a""- Scorta:  " sco-codice
                                    x"0d0a""Confermi l'inserimento?"
                                     title titolo
                                      icon 2
                                      type mb-yes-no
                                    giving scelta
                           if scelta = mb-no
                              set errori to true
                           end-if
                        end-if
                        if tutto-ok
                           perform CONTROLLA-SCORTA
                        end-if
                     end-if
                end-read
                if tutto-ok
                   perform DESCRIZIONE-IMBALLO
                end-if
                modify gd1(riga, 2), cell-data col-des
      *****     when 4
      *****          if como-acq = 0
      *****             set errori to true
      *****             display message "Prezzo di acquisto obbligatorio"
      *****                       title tit-err
      *****                        icon 2
      *****          end-if
           end-evaluate 
           .
      * <TOTEM:END>

       CREA-CSV.
      * <TOTEM:PARA. CREA-CSV>
           initialize wstampa.
           accept  como-ora from time.
           accept  wstampa  from environment "PATH_ST".
           inspect wstampa  replacing trailing spaces by low-value.
           string  wstampa       delimited low-value
                   "promo.csv"   delimited low-value
                   into wstampa
           end-string.
           open output lineseq.
                              
           accept separatore from environment "SEPARATORE"
                  on exception move "," to separatore
              not on exception
                  if separatore = space
                     move "," to separatore
                  end-if
           end-accept.

           move tpr-gdo of tpromo to gdo-codice.
           read tgrupgdo no lock invalid continue end-read.
           initialize line-riga of lineseq.
           string separatore                delimited size
                  "PROSPETTO PROMO URGENTE" delimited size
                  into line-riga of lineseq
           end-string.
           write line-riga of lineseq.

           initialize line-riga of lineseq.
           string separatore        delimited size
                  "Cliente: "       delimited size
                  gdo-intestazione  delimited size
                  into line-riga of lineseq
           end-string.
           write line-riga of lineseq after 2.

           initialize line-riga of lineseq.
           string separatore                        delimited size
                  "Inizio Volantino: "              delimited size
                  tpr-ini-volantino of tpromo(7:2)  delimited size
                  "/"                               delimited size
                  tpr-ini-volantino of tpromo(5:2)  delimited size
                  "/"                               delimited size
                  tpr-ini-volantino of tpromo(1:4)  delimited size
                  " - "                             delimited size
                  "Fine Volantino: "                delimited size
                  tpr-fine-volantino of tpromo(7:2) delimited size
                  "/"                               delimited size
                  tpr-fine-volantino of tpromo(5:2) delimited size
                  "/"                               delimited size
                  tpr-fine-volantino of tpromo(1:4) delimited size
                  into line-riga of lineseq
           end-string.
           write line-riga of lineseq after 2.

           initialize line-riga of lineseq.
           string separatore                  delimited size
                  "Inizio DPO:"               delimited size 
                  tpr-ini-dpo of tpromo(7:2)  delimited size
                  "/"                         delimited size
                  tpr-ini-dpo of tpromo(5:2)  delimited size
                  "/"                         delimited size
                  tpr-ini-dpo of tpromo(1:4)  delimited size
                  " - "                       delimited size
                  "Fine DPO:"                 delimited size
                  tpr-fine-dpo of tpromo(7:2) delimited size
                  "/"                         delimited size
                  tpr-fine-dpo of tpromo(5:2) delimited size
                  "/"                         delimited size
                  tpr-fine-dpo of tpromo(1:4) delimited size
                  into line-riga of lineseq
           end-string.
           write line-riga of lineseq.

           move tpr-sett-uscita of tpromo to SettimanaUscita.
           initialize line-riga of lineseq.
           string separatore              delimited size
                  "Settimana di uscita: " delimited size
                  SettimanaUscita         delimited size
                  into line-riga of lineseq
           end-string.
           write line-riga of lineseq after 2.

           move tpr-codice of tpromo to rpr-codice.
           move low-value  to rpr-articolo.
           start rpromo key >= rpr-chiave
                 invalid continue
             not invalid
                 initialize line-riga of lineseq
                 string "CODICE"        delimited size
                        separatore      delimited size
                        "DESCRIZIONE"   delimited size
                        separatore      delimited size
                        "QUANTITA'"     delimited size
                        into line-riga of lineseq
                 end-string
                 write line-riga of lineseq after 2
                 perform until 1 = 2
                    read rpromo next at end exit perform end-read
                    if rpr-codice not = tpr-codice of tpromo 
                       exit perform 
                    end-if
                    move rpr-articolo to art-codice
                    read articoli no lock
                         invalid
                         |Provo sui blister
                         move art-codice to bli-codice
                         read blister no lock
                              invalid move spaces  to art-descrizione
                          not invalid
                              move bli-descrizione to art-descrizione
                         end-read
                    end-read
                    move art-codice          to col-art
                    move rpr-qta             to col-qta
                    initialize line-riga of lineseq
                    string col-art         delimited size
                           separatore      delimited size
                           art-descrizione delimited size
                           separatore      delimited size
                           col-qta         delimited size
                           into line-riga of lineseq
                    end-string
                    write line-riga of lineseq
                 end-perform
           end-start.
           close lineseq 
           .
      * <TOTEM:END>

       CURRENT-RECORD.
      * <TOTEM:PARA. CURRENT-RECORD>
           perform RIEMPI-CHIAVE.
           set tutto-ok  to true.
           set ReadSecca to true.
           if nuovo move 0 to mod end-if.
      
           if mod = 1
              read tpromo lock invalid
                 set errori to true 
              end-read
           else
              read tpromo no lock invalid 
                 set errori to true 
              end-read
           end-if.                    
           set ReadSecca to false.
      
           if RecLocked
              set RecLocked to false
           else
              if tutto-ok
                 perform CANCELLA-COLORE
                 if nuovo
                    move 0      to mod
                    move 1      to mod-k
                    move 78-ID-ef-codice to control-id
                    move 4      to accept-control
                 else
                    move 78-ID-ef-gdo to control-id
                    move 4      to accept-control
                 end-if   
                 perform FORM1-IUD-DISPLAY
                 set vecchio to true
                 if mod = 1
                    set StatusModifica to true
                 else                         
                    set StatusVisua    to true
                 end-if
                 perform STATUS-BAR-MSG
                 perform VALORIZZA-OLD
                 perform RIEMPI-GRID

                 if tpr-nazionale of tpromo
                    move "NAZIONALE" to lab-tipo-buf
                    perform RESETTA-GRID-DESTINI
                 else
                    move "LOCALE"    to lab-tipo-buf
                    perform RIEMPI-GRID-FROM-LOCALI
                 end-if
                 display lab-tipo-volantino

              else
                 move 0 to mod
                 move 1 to mod-k
                 if vecchio
                    perform CLEAR-SCREEN
                    if YesMessage
                       move 78-ID-ef-codice to CONTROL-ID
                       move 4               to accept-control
                       display message MSG-Record-inesistente
                                 title tit-err
                                  icon 2
                    end-if
                 end-if
              end-if
           end-if.       

           if nuovo 
              move 0 to e-copia
           else
              move mod to e-copia
           end-if.

           if e-copia = 0
              modify pb-copia, bitmap-number = 3, enabled = e-copia
           else
              modify pb-copia, bitmap-number = 1, enabled = e-copia
           end-if 
           .
      * <TOTEM:END>

       DELETE-DESTINI.
      * <TOTEM:PARA. DELETE-DESTINI>
           move low-value  to loc-rec.
           move tpr-codice of tpromo to loc-codice.
           start locali key >= loc-chiave
                 invalid continue
             not invalid
                 perform until 1 = 2
                    read locali next at end exit perform end-read
                    if loc-codice not = tpr-codice of tpromo
                       exit perform
                    end-if
                    delete locali record invalid continue end-delete
                 end-perform
           end-start 
           .
      * <TOTEM:END>

       DELETE-RIGHE.
      * <TOTEM:PARA. DELETE-RIGHE>
           initialize tab-righe-old.
           move tpr-codice of tpromo to rpr-codice.
           move low-value  to rpr-articolo.
           start rpromo key >= rpr-chiave
                 invalid continue
             not invalid
                 move 0 to idx-old
                 perform until 1 = 2
                    read rpromo next at end exit perform end-read
                    if rpr-codice not = tpr-codice of tpromo
                       exit perform 
                    end-if
                    delete rpromo record invalid continue end-delete
                    if StoSalvando
                       add 1 to idx-old
                       move rpr-articolo         to el-art(idx-old)
                       move rpr-data-creazione   to 
           el-data-creazione(idx-old)
                       move rpr-ora-creazione    to 
           el-ora-creazione(idx-old)
                       move rpr-utente-creazione to 
           el-utente-creazione(idx-old)
                    end-if
                 end-perform
           end-start 
           .
      * <TOTEM:END>

       DESCRIZIONE-IMBALLO.
      * <TOTEM:PARA. DESCRIZIONE-IMBALLO>
           initialize imb-descrizione col-des.
           if blister
              inspect art-descrizione replacing trailing spaces 
                                             by low-value
              initialize col-des
              string  art-descrizione delimited by low-value
                      " - BLISTER"    delimited by low-value
                      into col-des
              end-string
           else
              move art-imballo-standard to imq-codice
              read timbalqta no lock 
                   invalid continue
               not invalid
                   move imq-tipo to imb-codice
                   read timballi no lock
                        invalid continue
                   end-read
              end-read
              move imq-qta-imb    to imballi-ed
              call "C$JUSTIFY" using imballi-ed, "L"
              inspect art-descrizione replacing trailing spaces 
                                             by low-value
              inspect imb-descrizione replacing trailing spaces 
                                             by low-value
              initialize col-des
              string  art-descrizione delimited by low-value
                      " - "           delimited by size
                      imb-descrizione delimited by low-value
                      " da "          delimited by size
                      imballi-ed      delimited by spaces
                      " x "           delimited by size
                      art-udm-imballo delimited by size
                      into col-des
              end-string
           end-if
           .
      * <TOTEM:END>

       HELP-GRID.
      * <TOTEM:PARA. HELP-GRID>
           move 0 to StatusHelp.

           evaluate colonna
           when 1   if mod = 1
                       move "Digitare l'articolo" to totem-hint-text
                    else
                       move "Codice articolo"     to totem-hint-text
                    end-if
                    if mod = 1 
                       move 1 to StatusHelp
                    end-if
           when 2   move "Descrizione vendita"  to totem-hint-text
           when 3   move "Prezzo di vendita"    to totem-hint-text
           when 4   if mod = 1
                       move "Digitare il prezzo di acquisto" to 
           totem-hint-text
                    else
                       move "Prezzo di acquisto" to totem-hint-text
                    end-if
           when 5   if mod = 1
                       move "Digitare la quantità" to totem-hint-text
                    else
                       move "Quantità" to totem-hint-text
                    end-if
           end-evaluate.

           modify Form1-St-1-Handle, panel-index = 1,
                                     panel-text  = totem-hint-text.
           perform STATUS-HELP 
           .
      * <TOTEM:END>

       INIT.
      * <TOTEM:PARA. INIT>
           move 0 to StatusHelp.
           move 1 to mod-k.
           set StatusVisua    to true  
           .
      * <TOTEM:END>

       INIT-OLD-REC.
      * <TOTEM:PARA. INIT-OLD-REC>
           initialize old-tpr-rec replacing numeric data by zeroes
                                       alphanumeric data by spaces.

           initialize old-rpr-rec replacing numeric data by zeroes
                                       alphanumeric data by spaces 
           .
      * <TOTEM:END>

       INVIO-MAIL.
      * <TOTEM:PARA. INVIO-MAIL>
           initialize LinkBody.
           move user-codi to como-user.
           inspect como-user replacing trailing spaces by low-value.
           accept como-ora  from time.
           accept como-data from century-date.
           string "DATA: "                  delimited size
                  como-data(7:2)            delimited size
                  "/"                       delimited size
                  como-data(5:2)            delimited size
                  "/"                       delimited size
                  como-data(1:4)            delimited size
                  " - ORA: "                delimited size
                  como-ora(1:2)             delimited size
                  ":"                       delimited size
                  como-ora(3:2)             delimited size
                  " - UTENTE: "             delimited size
                  como-user                 delimited low-value
                  ". In allegato dettagli " delimited size
                  "volantino in oggetto."   delimited size
                  into LinkBody
           end-string.

           move wstampa to LinkAttach.

           move "PROSPETTO PROMO URGENTE" to LinkSubject.
           accept LinkAddress from environment "PROMO_ADDRESSES".

           move 5 to tentativi-mail.
           perform CICLO-SEND-MAIL.

           if mail-ko
              display message "Invio mail impossibile!"
                       x"0d0a" line-riga-mail
                        title tit-err
                         icon 3
           end-if.

      ***---
       AFTER-SEND-MAIL 
           .
      * <TOTEM:END>

       MODIFICA.
      * <TOTEM:PARA. MODIFICA>
           move 5 to key-status.
           inquire tool-modifica, value in mod.
           set tutto-ok to true.

           if nuovo
              move 1 to mod                  
              modify tool-modifica, value mod
           else               
                 
      *  SE L'UTENTE E' ABILITATO PUO' MODIFICARE UN RECORD
              if mod = 1
                 set YesMessage to true
                 perform CURRENT-RECORD
                 if tutto-ok
                    move 0 to mod-k
                    move 1 to mod
                    set StatusModifica to true
                    perform STATUS-BAR-MSG
                 end-if
              else
                 move 1 to mod
                 perform SALV-MOD            
                 move 0 to mod
                 move 1 to mod-k
                 if errori
                    move 1 to mod
                    move 0 to mod-k
                 else
                    move 78-ID-ef-codice to control-id
                    set NoMessage to true
                    perform CURRENT-RECORD
                    set StatusVisua to true
                    perform STATUS-BAR-MSG 
                    unlock tpromo all records
                 end-if
              end-if
                                   
              inquire ef-codice, value in tpr-codice of tpromo
              if tpr-codice of tpromo >= 999999
                 display message "Impossibile modificare promo fittizia"
                           title titolo
                            icon 2
                 move 0 to mod
                 move 1 to mod-k
              end-if          
                                   
              move 4 to ACCEPT-CONTROL
              perform CANCELLA-COLORE 
              modify tool-modifica, value mod     
              display form1
           end-if.

           if nuovo 
              move 0 to e-copia
           else
              move mod to e-copia
           end-if.

           if e-copia = 0
              modify pb-copia, bitmap-number = 3, enabled = e-copia
           else
              modify pb-copia, bitmap-number = 1, enabled = e-copia
           end-if 
           .
      * <TOTEM:END>

       NUOVO.
      * <TOTEM:PARA. NUOVO>
           perform SALV-MOD.

           if tutto-ok  
              move 78-ID-ef-gdo to control-id       
              move 4            to accept-control   
              move 1            to mod mod-k
              modify tool-modifica,  value = mod
              perform CANCELLA-COLORE                  
              perform VALORIZZA-NUOVO

              accept path-fileseq from environment "PATH_AUTO_PROMO"
                              
              accept separatore from environment "SEPARATORE"
                     on exception move ";" to separatore
                 not on exception
                     if separatore = space
                        move ";" to separatore
                     end-if
              end-accept

              open input fileseq
              move 1 to riga
              if status-fileseq = "00"
                 read fileseq next |Salto l'ìntestazione
                 perform until 1 = 2
                    initialize rec-stampa
                    read fileseq next at end exit perform end-read
                    unstring rec-stampa delimited by separatore
                        into r-art
                             r-prz-v
                             r-prz-a
                             r-qta 
                    move r-art to art-codice convert
                    read articoli no lock 
                         invalid move "*** NON TROVATO ***" to 
           art-descrizione
                    end-read
                    move art-codice      to col-art
                    move art-descrizione to col-des
                    move r-prz-v         to col-ven convert
                    move r-prz-a         to col-acq convert
                    move r-qta           to col-qta convert
                    add 1 to riga                          
                    modify gd1 (riga, 1), cell-data col-art
                    modify gd1 (riga, 2), cell-data col-des
                    modify gd1 (riga, 3), cell-data col-ven
                    modify gd1 (riga, 4), cell-data col-acq
                    modify gd1 (riga, 5), cell-data col-qta
                 end-perform
                 close fileseq
              end-if

              perform INIT-OLD-REC
              move tpr-chiave of tpromo to old-tpr-chiave
              set StatusIns to true
              perform STATUS-BAR-MSG  
              set nuovo to true
              modify chk-mail visible true
              modify lab-mail visible true  

              move 0 to e-copia
              modify pb-copia, bitmap-number = 3, enabled = e-copia

           end-if 
           .
      * <TOTEM:END>

       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "abilita-toolbar.cpy".
           copy "color-custom.cpy".
           copy "status.cpy".
           copy "utydata.cpy".
           copy "imposte.cpy".
           copy "mail.cpy" 
           .
      * <TOTEM:END>

       PRECEDENTE.
      * <TOTEM:PARA. PRECEDENTE>
           perform SALV-MOD.           
           if tutto-ok     
              perform CHECK-INSERIMENTO
              unlock tpromo all records 
      
              perform RIEMPI-CHIAVE
      
              start tpromo key < tpr-chiave of tpromo
                    invalid  set errori to true
                not invalid 
                    read tpromo previous no lock
                         at end   set errori to true 
                    end-read
              end-start
      
              if tutto-ok
                 if nuovo
                    perform CANCELLA-COLORE
                    move 78-ID-ef-codice to control-id
                    move 4               to accept-control
                 end-if
                 move tpr-codice of tpromo to ef-codice-buf
                 display ef-codice
                 set ReadSecca             to false
                 perform CURRENT-RECORD
              else
                 display message "File [TPROMO]"
                          x"0d0a""Raggiunto inizio file"
                           title titolo
              end-if
      
           end-if 
           .
      * <TOTEM:END>

       PRIMO.
      * <TOTEM:PARA. PRIMO>
           perform SALV-MOD.
           if tutto-ok
              perform CHECK-INSERIMENTO
              unlock tpromo all records 
      
              move low-value   to tpr-chiave of tpromo
              start tpromo key >= tpr-chiave of tpromo
                    invalid  set errori to true
                not invalid 
                    read tpromo next no lock
                         at end   set errori to true 
                    end-read
              end-start
      
              if tutto-ok
                 if nuovo
                    perform CANCELLA-COLORE
                    move 78-ID-ef-codice to control-id
                    move 4               to accept-control
                 end-if
                 move tpr-codice of tpromo to ef-codice-buf
                 display ef-codice
                 set  ReadSecca            to false
                 perform CURRENT-RECORD
              else
                 perform CLEAR-SCREEN
                 display message "File [TPROMO]"
                          x"0d0a""Archivio vuoto"
                           title titolo
                 perform CANCELLA-COLORE
                 move 78-ID-ef-codice to control-id
                 move 4               to accept-control
              end-if
      
           end-if 
           .
      * <TOTEM:END>

       PUNTA-CELLA.
      * <TOTEM:PARA. PUNTA-CELLA>
           move 78-ID-gd1    to control-id store-id.
           move 4            to accept-control.
           modify gd1,       cursor-y riga, 
                             cursor-x colonna.
           perform COLORE-RIGA 
           .
      * <TOTEM:END>

       PUNTA-CELLA-DESTINI.
      * <TOTEM:PARA. PUNTA-CELLA-DESTINI>
           inquire gd-dest, cursor-y in store-riga.
           modify gd-dest(store-riga), row-font Small-Font.
           move 78-ID-gd-dest to control-id store-id.
           move 4             to accept-control.
           modify gd-dest,    cursor-y riga, 
                              cursor-x colonna.
           modify gd-dest(riga), row-font font-evidenzia-griglia
           .
      * <TOTEM:END>

       RESETTA-GRID.
      * <TOTEM:PARA. RESETTA-GRID>
           modify gd1, reset-grid = 1.
           perform GD1-CONTENT.
           initialize rec-grid.
           modify gd1, insert-rows = 999 
           .
      * <TOTEM:END>

       RESETTA-GRID-DESTINI.
      * <TOTEM:PARA. RESETTA-GRID-DESTINI>
           modify gd-dest, reset-grid = 1.
           perform GD-DEST-CONTENT 
           .
      * <TOTEM:END>

       RIEMPI-CHIAVE.
      * <TOTEM:PARA. RIEMPI-CHIAVE>
           inquire ef-codice, value in tpr-codice of tpromo 
           .
      * <TOTEM:END>

       RIEMPI-GRID.
      * <TOTEM:PARA. RIEMPI-GRID>
           modify gd1, mass-update = 1.
           perform RESETTA-GRID.
           move tpr-codice of tpromo to rpr-codice.
           move low-value            to rpr-articolo.
           start rpromo key >= rpr-chiave
                 invalid continue
             not invalid
                 move 2 to riga
                 perform until 1 = 2
                    read rpromo next no lock at end exit perform 
           end-read
                    if rpr-codice not = tpr-codice of tpromo
                       exit perform
                    end-if
                    if rpr-articolo = link-articolo
                       move riga to store-riga
                    end-if
                    set blister to false
                    move rpr-articolo to art-codice col-art
                    read articoli no lock 
                         invalid 
                         move rpr-articolo to bli-codice
                         read blister no lock 
                              invalid
                              move "** NON TROVATO **" to 
           art-descrizione
                          not invalid
                              set blister to true
                              move bli-descrizione to art-descrizione
                         end-read
                    end-read
                    perform DESCRIZIONE-IMBALLO
                    move rpr-prz-ven     to col-ven
                    move rpr-prz-acq     to col-acq
                    move rpr-qta         to col-qta
                    modify gd1(riga, 1), cell-data = col-art
                    modify gd1(riga, 2), cell-data = col-des
                    modify gd1(riga, 3), cell-data = col-ven    
                    modify gd1(riga, 4), cell-data = col-acq
                    modify gd1(riga, 5), cell-data = col-qta
                    add 1 to riga
                 end-perform
                 subtract 2 from riga giving RigheIniziali
           end-start.
           modify gd1, mass-update = 0.
           move 2 to riga.
           move 1 to colonna.
           perform PUNTA-CELLA.
           perform VALORE-RIGA.
           move rpr-rec to old-rpr-rec 
           .
      * <TOTEM:END>

       RIEMPI-GRID-DESTINI.
      * <TOTEM:PARA. RIEMPI-GRID-DESTINI>
           set trovato to false.
           modify gd-dest, mass-update = 1.
           perform RESETTA-GRID-DESTINI.

           set nazionale to true.
           move 1 to riga.
           move low-value to cli-rec.
           start clienti key >= cli-k1
                 invalid continue
             not invalid
                 perform until 1 = 2
                    read clienti next at end exit perform end-read
                    if cli-tipo-F exit perform end-if
                    if cli-gdo = gdo-codice
                       move cli-codice to des-codice
                       move low-value  to des-prog
                       start destini key >= des-chiave
                             invalid continue
                         not invalid
                             perform until 1 = 2
                                read destini next 
                                     at end exit perform 
                                end-read
                                if des-codice not = cli-codice 
                                   exit perform 
                                end-if
                                if des-bloccato or des-disattivo 
                                   exit perform cycle
                                end-if

                                set  trovato to true
                                move cli-gdo to save-gdo

                                move cli-codice    to hid-cliente
                                move des-prog      to hid-destino

                                move cli-ragsoc-1  to col-ragsoc
                                move des-ragsoc-1  to col-destino
                                move des-localita  to col-loca
                                move des-indirizzo to col-ind
                                move des-cap       to col-cap
                                move des-prov      to col-prov

                                add 1 to riga
                                
                                modify gd-dest, 
                                       record-to-add = rec-grid-dest
                                modify gd-dest(riga, 1), 
                                       hidden-data = HiddenDati
                                move tpr-gdo      of tpromo to loc-gdo
                                move tpr-ini-dpo  of tpromo to 
           loc-ini-dpo
                                move tpr-fine-dpo of tpromo to 
           loc-fine-dpo
                                move des-codice             to 
           loc-cliente
                                move des-prog               to 
           loc-destino
                                read locali key loc-chiave-ricerca
                                     invalid set NoSel to true
                                             move 513 to colore
                                 not invalid 
                                     if loc-codice = tpr-codice of 
           tpromo
                                        set YesSel to true
                                        move 176 to colore
                                     else
                                        set NoSel to true
                                        move 513 to colore
                                     end-if
                                end-read
                                modify gd-dest(riga, 2), 
                                       hidden-data = HiddenSel
                                modify gd-dest(riga), 
                                       row-color = colore
                             end-perform
                       end-start
                    end-if
                 end-perform
           end-start.
           modify gd-dest, mass-update = 0 
           .
      * <TOTEM:END>

       RIEMPI-GRID-FROM-LOCALI.
      * <TOTEM:PARA. RIEMPI-GRID-FROM-LOCALI>
           modify gd-dest, mass-update = 1.
           perform RESETTA-GRID-DESTINI.

           move low-value              to loc-rec.
           move tpr-codice   of tpromo to loc-codice.
           start locali key >= loc-chiave
                 invalid continue
             not invalid
                 move 1 to riga
                 perform until 1 = 2
                    read locali next at end exit perform end-read
                    if loc-codice   not = tpr-codice   of tpromo
                       exit perform
                    end-if

                    move loc-cliente to cli-codice
                    move loc-destino to des-prog

                    move cli-gdo to save-gdo

                    move cli-codice    to hid-cliente des-codice 
           cli-codice
                    move des-prog      to hid-destino des-prog

                    set cli-tipo-C to true
                    read clienti no lock 
                         invalid move "** NON TROVATO **" to 
           cli-ragsoc-1 
                    end-read

                    read destini no lock 
                         invalid move "** NON TROVATO **" to 
           des-localita
                                 move "** NON TROVATO **" to 
           des-indirizzo
                    end-read
                    if des-bloccato or des-disattivo
                       exit perform cycle
                    end-if

                    move cli-ragsoc-1  to col-ragsoc
                    move des-ragsoc-1  to col-destino
                    move des-localita  to col-loca
                    move des-indirizzo to col-ind
                    move des-cap       to col-cap
                    move des-prov      to col-prov

                    add 1 to riga
                    
                    modify gd-dest, 
                           record-to-add = rec-grid-dest
                    modify gd-dest(riga, 1), 
                           hidden-data = HiddenDati
                    move tpr-codice   of tpromo to loc-codice
                    move tpr-ini-dpo  of tpromo to loc-ini-dpo
                    move tpr-fine-dpo of tpromo to loc-fine-dpo
                    move des-codice             to loc-cliente
                    move des-prog               to loc-destino

                    set YesSel to true
                    move 176 to colore
                    modify gd-dest(riga, 2), hidden-data = HiddenSel
                    modify gd-dest(riga),    row-color   = colore

                 end-perform
           end-start.
           modify gd-dest, mass-update = 0 
           .
      * <TOTEM:END>

       SALVA.
      * <TOTEM:PARA. SALVA>
           if mod = 0 exit paragraph end-if.
           set StoSalvando to true.
      
           set tutto-ok to true.
      
           perform varying control-id from 78-ID-ef-codice by 1
                     until control-id > 78-ID-ef-fine-vol
              perform CONTROLLO
              if errori 
                 exit perform
              end-if
           end-perform.
      
           if tutto-ok
              perform CONTROLLA-DESTINO
              if errori
                 perform CANCELLA-COLORE
                 move 78-ID-pb-dest to store-id
              end-if
           end-if.
      
           if tutto-ok
              perform X-Y
              if tot-righe = 1
                 set errori to true
                 display message "Nessun articolo inserito"
                           title tit-err
                            icon 2
                 move 78-ID-gd1 to control-id
                 move 1 to colonna
              else
                 perform varying riga from 2 by 1 
                           until riga > tot-righe
                    perform VALORE-RIGA
                    perform varying colonna from 1 by 1
                              until colonna > 5
                       perform CONTROLLO-RIGA
                       if errori 
                          move 78-ID-gd1 to store-id
                          exit perform 
                       end-if
                    end-perform
                    if errori exit perform end-if
                 end-perform
              end-if
           end-if.
      
           if errori
              perform ABILITAZIONI
              if store-id = 78-ID-gd1
                 perform CANCELLA-COLORE
                 perform PUNTA-CELLA
              else
                 move store-id to control-id
                 move 4        to accept-control
              end-if
           else
              
              perform FORM1-BUF-TO-FLD
              perform VALORIZZA-DATI-COMUNI
              perform CANCELLA-COLORE

              perform DELETE-RIGHE
              perform SCRIVI-RIGHE

              perform SCRIVI-DESTINI
                   
              set HoSalvato to true
              write tpr-rec of tpromo
                    invalid rewrite tpr-rec of tpromo 
              end-write                                     
                      
              accept  data-oggi from century-date
              if nuovo
                 compute como-data = function integer-of-date 
           (tpr-ini-dpo of tpromo)
                 subtract 20 from como-data
                 compute como-data = function date-of-integer 
           (como-data)

                 if como-data < data-oggi
                    perform CREA-CSV
                    inquire chk-mail, value in chk-mail-buf
                    if chk-mail-buf = 0
                       perform INVIO-MAIL
                    end-if
                 end-if
              end-if
   
              set vecchio      to true
              set stampa       to true
              set PromoUrgente to true
              perform STAMPA-ANTEPRIMA

              perform TORNA-IN-VISUA

              if tpr-nazionale of tpromo
                 move "NAZIONALE" to lab-tipo-buf
              else
                 move "LOCALE"    to lab-tipo-buf
              end-if
              display lab-tipo-volantino

           end-if.

           display form1.
           set StoSalvando to false.

           modify chk-mail visible false.
           modify lab-mail visible false.      

           if nuovo 
              move 0 to e-copia
           else
              move mod to e-copia
           end-if.

           if e-copia = 0
              modify pb-copia, bitmap-number = 3, enabled = e-copia
           else
              modify pb-copia, bitmap-number = 1, enabled = e-copia
           end-if 
           .
      * <TOTEM:END>

       SALV-MOD.
      * <TOTEM:PARA. SALV-MOD>
           set tutto-ok to true.
           perform FORM1-CONTROLLO-OLD.

           if SiSalvato and mod = 1
              |Se ho cambiato i destini...
              if VariazioneDestini
                 inquire gd-dest, last-row in tot-righe
                 if tot-righe > 1
                    set NoSalvato to true
                    move 78-ID-gd-dest to store-id
                    move RigaVarDestino to riga
                    move 1              to colonna
                    |...ma poi sono tornato come NAZIONALE
                    if old-tpr-nazionale
                       inquire gd-dest, last-row in tot-righe
                       if tot-righe = 1
                          set SiSalvato to true
                       end-if
                    end-if
                 else
                    set NoSalvato to true
                    move 1111 to store-id
                 end-if
              end-if
           end-if.

           if SiSalvato and mod = 1
              if rpr-articolo not = old-rpr-articolo
                 set NoSalvato to true
                 move 78-ID-gd1 to store-id
                 move 1 to colonna
              end-if

              if rpr-prz-acq not = old-rpr-prz-acq and SiSalvato
                 set NoSalvato to true
                 move 78-ID-gd1 to store-id
                 move 4 to colonna
              end-if

              if rpr-qta not = old-rpr-qta and SiSalvato
                 set NoSalvato to true
                 move 78-ID-gd1 to store-id
                 move 5 to colonna
              end-if

           end-if.

           if SiSalvato and mod = 1
              if RigaCambiata not = 0 or ColonnaCambiata not = 0
                 set NoSalvato  to true
                 move 78-ID-gd1 to store-id
                 move ColonnaCambiata to colonna
                 move RigaCambiata    to riga
              end-if
           end-if.    

           if SiSalvato and mod = 1
              inquire gd1, last-row in tot-righe
              subtract 1 from tot-righe
              if tot-righe not = RigheIniziali or inserito-extra
                 add 2 to RigheIniziali giving riga
                 set NoSalvato  to true
                 move 78-ID-gd1 to store-id
                 move 1 to colonna
              end-if
           end-if.

           |Specifico per il programma dei promo
           if SiSalvato and mod = 1
              perform X-Y
              |non lascio una testa di un volantino senza righe 
              if tot-righe = 1
                 perform RIEMPI-CHIAVE
                 delete tpromo record invalid continue end-delete
              end-if
           end-if.
           ||||
      
           if NoSalvato
              display message MSG-Salvare-le-modifiche
                        title titolo
                         type mb-yes-no-cancel 
                       giving scelta       
       
              evaluate scelta
              when mb-yes 
                   perform SALVA
              when mb-no  
                   continue
                   if nuovo
                      perform RIEMPI-CHIAVE
                      delete tpromo record invalid continue end-delete
                   end-if
              when other                
                   perform CANCELLA-COLORE
                   set errori to true
                   evaluate store-id
                   when 78-ID-gd1     perform PUNTA-CELLA
                   when 78-ID-gd-dest perform PUNTA-CELLA-DESTINI
                   when other
                      move store-id to control-id       
                      move 4        to accept-control   
                   end-evaluate
              end-evaluate
           else
              if nuovo
                 perform RIEMPI-CHIAVE
                 delete tpromo record invalid continue end-delete
              end-if
           end-if 
           .
      * <TOTEM:END>

       SCRIVI-DESTINI.
      * <TOTEM:PARA. SCRIVI-DESTINI>
           set tpr-nazionale of tpromo to true.
           |Prima cancello i destini.
           perform DELETE-DESTINI

           modify gd-dest, mass-update = 1.
           inquire gd-dest, last-row in tot-righe.
           if tot-righe > 1
              perform varying riga from 2 by 1 
                        until riga > tot-righe
                 inquire gd-dest(riga, 2) hidden-data in HiddenSel
                 if YesSel
                    set tpr-locale of tpromo to true
                    inquire gd-dest(riga, 1), hidden-data in HiddenDati
                    move tpr-codice   of tpromo to loc-codice
                    move tpr-gdo      of tpromo to loc-gdo
                    move hid-cliente            to loc-cliente 
                    move hid-destino            to loc-destino 
                    move tpr-ini-dpo  of tpromo to loc-ini-dpo 
                    move tpr-fine-dpo of tpromo to loc-fine-dpo
              
                    accept loc-data-creazione from century-date
                    accept loc-ora-creazione  from time
                    move user-codi to loc-utente-creazione

                    write loc-rec invalid continue end-write
                 else
                    modify gd-dest, record-to-delete = riga
                    subtract 1 from riga tot-righe
                 end-if
              end-perform
           end-if.
           modify gd-dest, mass-update = 0 
           .
      * <TOTEM:END>

       SCRIVI-RIGHE.
      * <TOTEM:PARA. SCRIVI-RIGHE>
           move 0 to tpr-num-righe of tpromo.
           perform varying riga from 2 by 1
                     until riga > tot-righe
              move tpr-codice of tpromo to rpr-codice
              perform VALORE-RIGA

              set trovato to false
              set idx-old to 1
              search el-riga
              when el-art(idx-old) = rpr-articolo
                   set trovato to true
              end-search
              if trovato
                 move el-data-creazione(idx-old)   to rpr-data-creazione
                 move el-ora-creazione(idx-old)    to rpr-ora-creazione
                 move el-utente-creazione(idx-old) to 
           rpr-utente-creazione
              else
                 accept rpr-data-creazione from century-date
                 accept rpr-ora-creazione  from time
                 move user-codi to rpr-utente-creazione
              end-if

              accept rpr-data-modifica from century-date
              accept rpr-ora-modifica  from time
              move user-codi    to rpr-utente-modifica

              add 1 to tpr-num-righe of tpromo
              write rpr-rec 
                    invalid 
                    rewrite rpr-rec end-rewrite
                not invalid
                    set rpr-prenotazioni-si to true
              end-write
              |In caso l'articolo non fosse presente a listino lo creo
              move rpr-articolo      to lst-articolo
              move tpr-gdo of tpromo to lst-gdo
              move low-value         to lst-data
              start listini key >= lst-k-articolo
                    invalid perform ACCODA-RIGA-SU-LISTINO
                not invalid
                    read listini next
                    if lst-articolo not = rpr-articolo
                       perform ACCODA-RIGA-SU-LISTINO
                    end-if
              end-start
           end-perform 
           .
      * <TOTEM:END>

       SELEZIONA.
      * <TOTEM:PARA. SELEZIONA>
           set tutto-ok to true.
           call   "lab-sel-promo" using link-codice link-articolo.
           cancel "lab-sel-promo".

           if link-codice not = 0

              if link-codice not = tpr-codice of tpromo
                 perform SALV-MOD
              end-if

              if tutto-ok
                 set  ReadSecca   to true
                 move link-codice to tpr-codice of tpromo 
                 move link-codice to ef-codice-buf
                 display ef-codice
                 perform CURRENT-RECORD
                 if link-articolo = 0
                    move 2 to riga
                 else
                    move store-riga to riga
                 end-if
                 move 1 to colonna
                 perform PUNTA-CELLA
                 perform CANCELLA-COLORE
                 if link-articolo = 0
                    move 78-ID-ef-codice to control-id
                    move 4               to accept-control
                 end-if
              end-if

           end-if 
           .
      * <TOTEM:END>

       SELEZIONE-RIGA.
      * <TOTEM:PARA. SELEZIONE-RIGA>
           inquire gd-dest(event-data-2, 2), hidden-data in HiddenSel.

           if YesSel
              set NoSel to true
              move 513 to colore
           else
              set YesSel to true
              move 176 to colore

              set local to true

           end-if.

           modify gd-dest, row-color = colore.
           modify gd-dest(event-data-2, 2), hidden-data HiddenSel.

           if not VariazioneDestini
              set VariazioneDestini to true
              move event-data-2     to RigaVarDestino
           end-if 
           .
      * <TOTEM:END>

       SPOSTAMENTO.
      * <TOTEM:PARA. SPOSTAMENTO>
           set tutto-ok to true.
           perform X-Y.
      
           if event-data-2 not = riga
      
              perform VALORE-RIGA

              if art-codice not = 0      or
                 col-art    not = spaces or
                 como-acq   not = 0      or
                 como-ven   not = 0      or
                 como-qta   not = 0
                 perform varying colonna from 1 by 1
                           until colonna > 5
                    perform CONTROLLO-RIGA
                    if errori exit perform end-if
                 end-perform
      *****           if tutto-ok
      *****              if vecchio
      *****                 write rpr-rec invalid rewrite rpr-rec end-write
      *****              end-if
      *****           end-if
              end-if
      
              if tutto-ok
                 evaluate true
                 when event-data-2 < 2 
                      move 2            to riga
                      move event-data-1 to colonna
      
                 when event-data-2 > tot-righe
                      add  1                to tot-righe giving riga
                      set event-action      to event-action-fail
                      move 1                to colonna
                      perform PUNTA-CELLA
                 when other
                      move event-data-2 to riga
                      move event-data-1 to colonna
                 end-evaluate
                 perform VALORE-RIGA
                 move rpr-rec to old-rpr-rec
              else
                 set event-action      to event-action-fail
                 perform PUNTA-CELLA
              end-if
           else
              if event-data-1 not = colonna
                 inquire gd1(riga, 1), cell-data in art-codice
                 if art-codice = 0
                    set event-action to event-action-fail
                    move 1 to colonna event-data-1
                    perform PUNTA-CELLA
                 end-if
              end-if
              move event-data-1 to colonna
           end-if.
      
           perform COLORE-RIGA.
           perform HELP-GRID 
           .
      * <TOTEM:END>

       SPOSTAMENTO-D.
      * <TOTEM:PARA. SPOSTAMENTO-D>
           set tutto-ok to true.
           inquire gd-dest, last-row in tot-righe, cursor-y in riga.

           if event-data-2 > tot-righe
              move tot-righe to event-data-2
           end-if.

           if event-data-2 < 2
              move 2 to event-data-2
           end-if.
           
           modify gd-dest(riga),         row-font Small-Font.
           modify gd-dest(event-data-2), row-font font-evidenzia-griglia
           .
      * <TOTEM:END>

       SPOSTAMENTO-S.
      * <TOTEM:PARA. SPOSTAMENTO-S>
           set tutto-ok to true.
           inquire gd-art, last-row in tot-righe, cursor-y in riga.

           if event-data-2 > tot-righe
              move tot-righe to event-data-2
           end-if.

           if event-data-2 < 2
              move 2 to event-data-2
           end-if.
           
           modify gd-art, start-x = 1,
                                x = 5,
                          start-y = event-data-2,
                                y = event-data-2,
                     region-color = 257,
                     cursor-color = 481 
           .
      * <TOTEM:END>

       STAMPA.
      * <TOTEM:PARA. STAMPA>
           set stampa       to true.
           set PromoUrgente to false.
           perform STAMPA-ANTEPRIMA 
           .
      * <TOTEM:END>

       STAMPA-ANTEPRIMA.
      * <TOTEM:PARA. STAMPA-ANTEPRIMA>
           if nuovo
              display message "Occorre salvare il volantino"
                              " per poterlo stampare"
                        title titolo
                         icon 2
           else
              inquire ef-codice, value in tpr-codice of tpromo
              read tpromo no lock
                   invalid
                   display message "Volantino NON valido"
                             title tit-err
                              icon 2
               not invalid
                   call "W$MOUSE" using set-mouse-shape, wait-pointer
                   initialize st-promo-linkage
                              replacing numeric data by zeroes
                                   alphanumeric data by spaces
                   if PromoUrgente
                      set link-si-firma   to true
                      evaluate true
                      when ru-SO-XP
                           accept link-nome-stampante 
                                  from environment "STAMPANTE_PROMO_XP"
                      when ru-SO-VISTA
                           accept link-nome-stampante 
                                  from environment "STAMPANTE_PROMO_V"
                      when ru-SO-7
                           accept link-nome-stampante 
                                  from environment "STAMPANTE_PROMO_7"
                      end-evaluate
                   else
                      set link-no-firma   to true
                   end-if
                   if anteprima
                      accept link-nome-stampante
                             from environment "STAMPANTE_ANTEPRIMA"
                   end-if
                   move tpr-codice of tpromo  to link-volantino
                   move form1-handle          to link-handle
                   call   "lab-st-promo-p" using st-promo-linkage
                   cancel "lab-st-promo-p"
                   call "W$MOUSE" using set-mouse-shape, arrow-pointer
              end-read
           end-if 
           .
      * <TOTEM:END>

       SUCCESSIVO.
      * <TOTEM:PARA. SUCCESSIVO>
           perform SALV-MOD.           
           if tutto-ok     
              perform CHECK-INSERIMENTO
              unlock tpromo all records 
      
              perform RIEMPI-CHIAVE
      
              start tpromo key > tpr-chiave of tpromo
                    invalid  set errori to true
                not invalid 
                    read tpromo next no lock
                         at end   set errori to true 
                    end-read
              end-start
      
              if tutto-ok
                 if nuovo
                    perform CANCELLA-COLORE
                    move 78-ID-ef-codice to control-id
                    move 4               to accept-control
                 end-if
                 move tpr-codice of tpromo to ef-codice-buf
                 display ef-codice
                 set ReadSecca             to false
                 perform CURRENT-RECORD
              else
                 display message "File [TPROMO]"
                          x"0d0a""Raggiunta fine file"
                           title titolo
              end-if
      
           end-if 
           .
      * <TOTEM:END>

       TORNA-IN-VISUA.
      * <TOTEM:PARA. TORNA-IN-VISUA>
           move 0 to mod.
           move 1 to mod-k.
           move 78-ID-ef-codice to CONTROL-ID.
           set NoMessage to true.
           perform ABILITAZIONI.
           set StatusVisua to true.
           perform STATUS-BAR-MSG.
           unlock tpromo all records.
                        
           modify tool-modifica,  value mod.
           perform CANCELLA-COLORE.
           move 4 to ACCEPT-CONTROL 
           .
      * <TOTEM:END>

       ULTIMO.
      * <TOTEM:PARA. ULTIMO>
           perform SALV-MOD.           
           if tutto-ok                 
              perform CHECK-INSERIMENTO
              unlock tpromo all records 
      
              move high-value to tpr-chiave of tpromo
              start tpromo key < tpr-chiave of tpromo
                    invalid  set errori to true
                not invalid 
                    read tpromo previous no lock
                         at end   set errori to true 
                    end-read
              end-start
      
              if tutto-ok
                 if nuovo
                    perform CANCELLA-COLORE
                    move 78-ID-ef-codice to control-id
                    move 4               to accept-control
                 end-if
                 move tpr-codice of tpromo to ef-codice-buf
                 display ef-codice
                 set  ReadSecca            to false
                 perform CURRENT-RECORD
              else
                 perform CLEAR-SCREEN
                 display message "File [TPROMO]"
                          x"0d0a""Archivio vuoto"
                           title titolo
                 perform CANCELLA-COLORE
                 move 78-ID-ef-codice to control-id
                 move 4               to accept-control
              end-if
      
           end-if 
           .
      * <TOTEM:END>

       VALORE-RIGA.
      * <TOTEM:PARA. VALORE-RIGA>
           inquire gd1(riga, 1), cell-data in col-art.
           inquire gd1(riga, 2), cell-data in col-des.
           inquire gd1(riga, 3), cell-data in col-ven.
           inquire gd1(riga, 4), cell-data in col-acq.
           inquire gd1(riga, 5), cell-data in col-qta.
           
           move col-art to rpr-articolo art-codice.
           move col-ven to rpr-prz-ven.
           move col-acq to rpr-prz-acq.
           move col-qta to rpr-qta.

           move col-acq to como-acq.
           move col-ven to como-ven.
           move col-qta to como-qta 
           .
      * <TOTEM:END>

       VALORIZZA-OLD.
      * <TOTEM:PARA. VALORIZZA-OLD>
           move tpr-rec of tpromo to old-tpr-rec.
           set vecchio to true.

           move 0 to StatusHelp
           perform STATUS-HELP.

           set inserito-extra to false.
           inquire gd1, last-row in tot-righe.
           subtract 1 from tot-righe giving RigheIniziali.
           move 0 to RigaCambiata ColonnaCambiata.

           set VariazioneDestini to false.
           move 0                to RigaVarDestino.

           move tpr-gdo  of tpromo to save-gdo.
           move tpr-tipo of tpromo to tipo-volantino.

           modify chk-mail visible false.
           modify lab-mail visible false 
           .
      * <TOTEM:END>

       VALORIZZA-NUOVO.
      * <TOTEM:PARA. VALORIZZA-NUOVO>
           move start-fittizia to tpr-codice of tpromo.

           start tpromo key < tpr-codice     of tpromo
                 invalid move 1 to tpr-codice of tpromo
             not invalid
                 read tpromo previous with no lock
                      at end move 1 to tpr-codice of tpromo
                  not at end add  1 to tpr-codice of tpromo
                 end-read
           end-start.

           move "00"    to status-tpromo.

           initialize tpr-dati of tpromo
                      replacing numeric data by zeroes
                           alphanumeric data by spaces.

           initialize rpr-rec replacing numeric data by zeroes
                                   alphanumeric data by spaces.

           write tpr-rec of tpromo
                 invalid rewrite tpr-rec of tpromo
           end-write.
           read tpromo lock invalid continue end-read.

           perform FORM1-IUD-DISPLAY.

           perform RESETTA-GRID.
           perform RESETTA-GRID-DESTINI.

           set tpr-nazionale of tpromo to true.

           move 0 to RigheIniziali.
           set inserito-extra to false.
           move 0 to RigaCambiata ColonnaCambiata.

           set  VariazioneDestini to false.
           move 0                 to RigaVarDestino.

           move spaces to lab-tipo-buf.
           display lab-tipo-volantino.

           move spaces to save-gdo.
           set nazionale to true 
           .
      * <TOTEM:END>

       VALORIZZA-DATI-COMUNI.
      * <TOTEM:PARA. VALORIZZA-DATI-COMUNI>
      * SE NON HO VALORIZZATO I CAMPI DI CREAZIONE LI VALORIZZO
           if tpr-data-creazione   of tpromo = 0
              accept tpr-data-creazione of tpromo from century-date
           end-if.
           if tpr-ora-creazione    of tpromo = 0
              accept tpr-ora-creazione of tpromo from time
           end-if.
           if tpr-utente-creazione of tpromo = space
              move user-codi to tpr-utente-creazione of tpromo
           end-if.

           accept tpr-data-modifica of tpromo from century-date.
           accept tpr-ora-modifica  of tpromo from time.
           move user-codi    to tpr-utente-modifica of tpromo 
           .
      * <TOTEM:END>

       X-Y.
      * <TOTEM:PARA. X-Y>
           inquire gd1, cursor-y in riga,
                        cursor-x in colonna,
                        last-row in tot-righe 
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       NUOVO-LinkTo.
      * <TOTEM:PARA. NUOVO-LinkTo>
           INQUIRE TOOL-NUOVO, ENABLED IN E-NUOVO.

           IF E-NUOVO = 1
              PERFORM NUOVO
           END-IF                    
           .
      * <TOTEM:END>
       CANCELLA-LinkTo.
      * <TOTEM:PARA. CANCELLA-LinkTo>
           INQUIRE TOOL-MODIFICA, VALUE IN MOD.
                              
           INQUIRE TOOL-CANCELLA, ENABLED IN E-CANCELLA
           IF E-CANCELLA = 1
              PERFORM CANCELLA
           END-IF                                                
           .
      * <TOTEM:END>
       TOOL-SALVA-LinkTo.
      * <TOTEM:PARA. TOOL-SALVA-LinkTo>
           INQUIRE TOOL-MODIFICA, VALUE IN MOD           

           INQUIRE TOOL-SALVA, ENABLED IN E-SALVA
           IF E-SALVA = 1
              PERFORM SALVA
           END-IF           
           .
      * <TOTEM:END>
       ANTEPRIMA-LinkTo.
      * <TOTEM:PARA. ANTEPRIMA-LinkTo>
           INQUIRE TOOL-ANTEPRIMA, ENABLED IN E-ANTEPRIMA.
           IF E-ANTEPRIMA = 1
                PERFORM ANTEPRIMA
           END-IF 
           .
      * <TOTEM:END>
       TOOL-MODIFICA-BeforeProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       TOOL-MODIFICA-AfterProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       TOOL-MODIFICA-LinkTo.
      * <TOTEM:PARA. TOOL-MODIFICA-LinkTo>
           INQUIRE TOOL-MODIFICA, ENABLED IN E-MODIFICA.
           
           IF E-MODIFICA = 1
              PERFORM MODIFICA
           END-IF 
           .
      * <TOTEM:END>
       STAMPA-LinkTo.
      * <TOTEM:PARA. STAMPA-LinkTo>
           INQUIRE TOOL-STAMPA, ENABLED IN E-STAMPA
           IF E-STAMPA = 1
                PERFORM STAMPA
           END-IF 
           .
      * <TOTEM:END>
       TOOL-CERCA-LinkTo.
      * <TOTEM:PARA. TOOL-CERCA-LinkTo>
           inquire tool-cerca, enabled in e-cerca
           if e-cerca = 1
              perform CERCA
           end-if 
           .
      * <TOTEM:END>
       TOOL-SELEZIONA-LinkTo.
      * <TOTEM:PARA. TOOL-SELEZIONA-LinkTo>
           inquire tool-seleziona, enabled in e-seleziona
           if e-seleziona = 1
              perform SELEZIONA
           end-if 
           .
      * <TOTEM:END>
       TOOL-PRIMO.
      * <TOTEM:PARA. TOOL-PRIMO>
           PERFORM PRIMO 
           .
      * <TOTEM:END>
       TOOL-PRECEDENTE.
      * <TOTEM:PARA. TOOL-PRECEDENTE>
           if nuovo             
              perform PRIMO
           else
              perform PRECEDENTE
           end-if 
           .
      * <TOTEM:END>
       TOOL-SUCCESSIVO.
      * <TOTEM:PARA. TOOL-SUCCESSIVO>
           if nuovo             
              perform ULTIMO
           else
              perform SUCCESSIVO
           end-if 
           .
      * <TOTEM:END>
       TOOL-ULTIMO.
      * <TOTEM:PARA. TOOL-ULTIMO>
           PERFORM ULTIMO 
           .
      * <TOTEM:END>
       ginqui-Ev-Before-Program.
      * <TOTEM:PARA. ginqui-Ev-Before-Program>
      * MS Sans Sertif 8BI
           accept ru-user from environment "USER_CODI".
           call   "readutente" using ru-linkage.
           cancel "readutente".

           initialize wfont-data font-evidenzia-griglia.
           move 8 to wfont-size
           move "MS Sans Serif"    to wfont-name
           set wfcharset-dont-care to true.
           set wfont-bold          to true.
           set wfont-italic        to false.
           set wfont-underline     to false.
           set wfont-strikeout     to false.
           set wfont-fixed-pitch   to false.
           move 0 to wfont-char-set.
           call "W$FONT" using wfont-get-font,
                               font-evidenzia-griglia,
                               wfont-data.
           move LK-BL-PROG-ID    TO COMO-PROG-ID 
           .
      * <TOTEM:END>
       ginqui-Ev-After-Program.
      * <TOTEM:PARA. ginqui-Ev-After-Program>
           set environment "KEYSTROKE" to "DATA=44 44".
           set environment "KEYSTROKE" to "DATA=46 46".
           destroy font-evidenzia-griglia.
           SET LK-BL-CANCELLAZIONE TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           if HoSalvato
              call   "tprev-elab" using user-codi
              cancel "tprev-elab"
           end-if 
           .
      * <TOTEM:END>
       Screen1-DaEf-1-BeforeProcedure.
      * <TOTEM:PARA. Screen1-DaEf-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           move ZERO to StatusHelp.
           perform STATUS-HELP 
           .
      * <TOTEM:END>
       Screen1-DaEf-1-AfterProcedure.
      * <TOTEM:PARA. Screen1-DaEf-1-AfterProcedure>
              INQUIRE ef-codice, VALUE IN tpr-codice of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-codice-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-gdo-BeforeProcedure.
      * <TOTEM:PARA. ef-gdo-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-ini-dpo-BeforeProcedure.
      * <TOTEM:PARA. ef-ini-dpo-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-fine-dpo-BeforeProcedure.
      * <TOTEM:PARA. ef-fine-dpo-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-nome-BeforeProcedure.
      * <TOTEM:PARA. ef-nome-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-ini-vol-BeforeProcedure.
      * <TOTEM:PARA. ef-ini-vol-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-fine-vol-BeforeProcedure.
      * <TOTEM:PARA. ef-fine-vol-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-sett-BeforeProcedure.
      * <TOTEM:PARA. ef-sett-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-gdo-AfterProcedure.
      * <TOTEM:PARA. ef-gdo-AfterProcedure>
              INQUIRE ef-gdo, VALUE IN tpr-gdo of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-gdo-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-ini-dpo-AfterProcedure.
      * <TOTEM:PARA. ef-ini-dpo-AfterProcedure>
              INQUIRE ef-ini-dpo, VALUE IN tpr-ini-dpo of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-ini-dpo-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-fine-dpo-AfterProcedure.
      * <TOTEM:PARA. ef-fine-dpo-AfterProcedure>
              INQUIRE ef-fine-dpo, VALUE IN tpr-fine-dpo of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-fine-dpo-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-nome-AfterProcedure.
      * <TOTEM:PARA. ef-nome-AfterProcedure>
              INQUIRE ef-nome, VALUE IN tpr-descrizione of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-nome-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
              INQUIRE ef-nomea, VALUE IN tpr-note of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-nomea-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-ini-vol-AfterProcedure.
      * <TOTEM:PARA. ef-ini-vol-AfterProcedure>
              INQUIRE ef-ini-vol, VALUE IN tpr-ini-volantino of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-ini-vol-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-fine-vol-AfterProcedure.
      * <TOTEM:PARA. ef-fine-vol-AfterProcedure>
              INQUIRE ef-fine-vol, VALUE IN tpr-fine-volantino of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-fine-vol-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       ef-sett-AfterProcedure.
      * <TOTEM:PARA. ef-sett-AfterProcedure>
              INQUIRE ef-sett, VALUE IN tpr-sett-uscita of tpromo
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-sett-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       gd1-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. gd1-Ev-Msg-Begin-Drag>

           set event-action to event-action-fail.
      *     perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-End-Drag.
      * <TOTEM:PARA. gd1-Ev-Msg-End-Drag>

           set event-action to event-action-fail.
      *     perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. gd1-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. gd1-Ev-Msg-Goto-Cell-Drag>

           set event-action to event-action-fail.
      *     perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. gd1-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. gd1-Ev-Msg-Begin-Entry>
           if mod = 0
              set event-action to event-action-fail
           else
              perform X-Y
              evaluate colonna
              when 2 set event-action to event-action-fail 
              when 3
              when 4 inquire gd1(riga, 4), cell-data in old-col-acq
                     set environment "KEYSTROKE" to "DATA=44 46"        
            
              when 5 inquire gd1(riga, 5), cell-data in old-col-qta
              end-evaluate
           end-if 
           .
      * <TOTEM:END>
       gd1-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. gd1-Ev-Msg-Finish-Entry>
           set tutto-ok to true.
           perform X-Y.
           perform VALORE-RIGA.

           evaluate colonna
           when 1
                if rpr-articolo = 0
                   if col-des  not = spaces or
                      como-acq not = 0      or
                      como-ven not = 0      or
                      como-qta not = 0
                      display message "Cancellare la riga?"
                                title titolo
                                 type mb-yes-no
                              default mb-no
                            giving scelta
                      if scelta = mb-no
                         set errori to true
                      else
                         move ef-codice-buf    to rpr-codice
                         move old-rpr-articolo to rpr-articolo
                         delete rpromo record invalid continue 
           end-delete

                         move riga to store-riga
                         add 1 to riga
                         perform VALORE-RIGA
                         move rpr-rec to old-rpr-rec
                         move store-riga to riga

                         modify gd1, record-to-delete = riga
                         modify gd1, insert-rows = 1
                      end-if
                   end-if
                else
                   perform CONTROLLA-ARTICOLO-GIA-INSERITO
                   if not trovato              
                      perform CONTROLLO-RIGA
                   end-if
                end-if
                if tutto-ok
                   if rpr-articolo not = old-rpr-articolo
                      move riga to RigaCambiata
                      move 1    to ColonnaCambiata
                   end-if
                end-if
           when 3
                if col-ven not = old-col-ven
                   move riga to RigaCambiata
                   move 3    to ColonnaCambiata
                end-if
                perform CONTROLLO-RIGA
                modify gd1(riga, 3), cell-data col-ven
           when 4
                if col-acq not = old-col-acq
                   move riga to RigaCambiata
                   move 4    to ColonnaCambiata
                end-if
                perform CONTROLLO-RIGA
                modify gd1(riga, 4), cell-data col-acq
           when 5
                if col-acq not = old-col-acq
                   move riga to RigaCambiata
                   move 5    to ColonnaCambiata
                end-if
                perform CONTROLLO-RIGA
           end-evaluate.

           if errori
              move 78-ID-gd1 to store-id
              set event-action to event-action-fail
           else
              set environment "KEYSTROKE" to "DATA=44 44"
              set environment "KEYSTROKE" to "DATA=46 46"
           end-if 
           .
      * <TOTEM:END>
       pb-ok-s-BeforeProcedure.
      * <TOTEM:PARA. pb-ok-s-BeforeProcedure>
           modify pb-ok-s, bitmap-number = 2 
           .
      * <TOTEM:END>
       pb-ok-s-AfterProcedure.
      * <TOTEM:PARA. pb-ok-s-AfterProcedure>
           modify pb-ok-s, bitmap-number = 1 
           .
      * <TOTEM:END>
       pb-annulla-s-BeforeProcedure.
      * <TOTEM:PARA. pb-annulla-s-BeforeProcedure>
           modify pb-annulla-s, bitmap-number = 2 
           .
      * <TOTEM:END>
       pb-annulla-s-AfterProcedure.
      * <TOTEM:PARA. pb-annulla-s-AfterProcedure>
           modify pb-annulla-s, bitmap-number = 1 
           .
      * <TOTEM:END>
       pb-extra-LinkTo.
      * <TOTEM:PARA. pb-extra-LinkTo>
           perform varying control-id from 78-ID-ef-codice by 1
                     until control-id > 78-ID-ef-sett
              perform CONTROLLO
              if errori
                 exit perform
              end-if
           end-perform.
           if nuovo
              perform RIEMPI-CHIAVE
              read tpromo lock invalid continue end-read
           end-if.
      
           if tutto-ok
              perform CONTROLLA-DESTINO
              if errori
                 perform CANCELLA-COLORE
                 move 78-ID-pb-dest to store-id
              end-if
           end-if.
           
           if tutto-ok
              perform SCREEN1-OPEN-ROUTINE
              perform X-Y
              perform VALORE-RIGA
           end-if 
           .
      * <TOTEM:END>
       ef-des-BeforeProcedure.
      * <TOTEM:PARA. ef-des-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-sconto-BeforeProcedure.
      * <TOTEM:PARA. ef-sconto-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-des-AfterProcedure.
      * <TOTEM:PARA. ef-des-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           perform CONTROLLO-S 
           .
      * <TOTEM:END>
       ef-sconto-AfterProcedure.
      * <TOTEM:PARA. ef-sconto-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           perform CONTROLLO-S 
           .
      * <TOTEM:END>
       pb-ok-s-LinkTo.
      * <TOTEM:PARA. pb-ok-s-LinkTo>
           inquire gd-art, last-row in tot-righe.
           if tot-righe > 2
              display message 
                      "Solo le righe con prezzo valorizzato"
               x"0d0a""verranno riportate in promozione."
               x"0d0a""Procedere?"
                        title tit-err
                         icon 2
                         type mb-yes-no
                      default mb-no
                       giving scelta
              if scelta = mb-yes
                 modify lab2, visible true
                 move 2 to riga
                 set inserito-extra to true
                 inquire gd-art, last-row in tot-righe
                 inquire gd1,    last-row in store-riga
                 add 1 to store-riga
                 modify gd1, mass-update = 1
                 perform varying riga from 2 by 1 
                           until riga > tot-righe
                    inquire gd-art(riga, 3), cell-data in como-acq
                    inquire gd-art(riga, 4), cell-data in como-qta
                    if como-acq not = 0
                       inquire gd-art(riga, 1), cell-data in col-art
                       inquire gd-art(riga, 2), cell-data in col-des
                       inquire gd-art(riga, 3), cell-data in col-acq
                       inquire gd-art(riga, 4), cell-data in col-qta

                       modify gd1(store-riga, 1), cell-data = col-art
                       modify gd1(store-riga, 2), cell-data = col-des
                       modify gd1(store-riga, 4), cell-data = col-acq
                       modify gd1(store-riga, 5), cell-data = col-qta

                       add 1 to store-riga
                    end-if
                 end-perform
                 modify gd1, mass-update = 0
                 move 27 to key-status
                 modify lab2, visible false
              end-if
           end-if 
           .
      * <TOTEM:END>
       pb-genera-BeforeProcedure.
      * <TOTEM:PARA. pb-genera-BeforeProcedure>
           modify pb-genera, bitmap-number = 2 
           .
      * <TOTEM:END>
       pb-genera-AfterProcedure.
      * <TOTEM:PARA. pb-genera-AfterProcedure>
           modify pb-genera, bitmap-number = 1 
           .
      * <TOTEM:END>
       pb-genera-LinkTo.
      * <TOTEM:PARA. pb-genera-LinkTo>
           perform varying control-id from 78-ID-ef-des by 1
                     until control-id > 78-ID-ef-sconto
              perform CONTROLLO-S
              if errori
                 exit perform
              end-if
           end-perform.

           move mb-no to scelta.

           if tutto-ok
              display message "Procedere?"
                        title titolo
                         type mb-yes-no
                      default mb-no
                       giving scelta
           end-if.

           if scelta = mb-yes
                            
              accept imp-data from century-date
              start timposte key <= imp-chiave
                    invalid continue
                not invalid
                    read timposte previous
              end-start
            
              move 0 to num-articoli
              
              move ef-ini-dpo-buf to como-data
              perform DATE-TO-FILE

              modify lab, visible true
              modify gd-art, mass-update = 1

              modify gd-art, reset-grid = 1
              perform GD-ART-CONTENT
              move 0 to NumChars
              if ef-des-buf not = "*"
                 inspect ef-des-buf  replacing trailing 
                                     spaces by low-value
                 inspect ef-des-buf  tallying NumChars for 
                                     characters before low-value
              end-if
              move low-value to art-descrizione
              start articoli key >= art-k1
                    invalid set errori to true
              end-start
              move 2 to riga

              perform until 1 = 2
                 move 0 to CountChar
                 read articoli next at end exit perform end-read
                 if ef-des-buf not = "*"
                    inspect  art-descrizione replacing trailing 
                                             spaces by low-value
                    inspect  art-descrizione 
                    tallying CountChar for all ef-des-buf (1:NumChars)
                    before low-value
                 else
                    move 1 to CountChar
                 end-if
                 if CountChar not = 0
                    perform CHECK-ESISTENZA-VALIDITA-LISTINO
                    if trovato
                       perform CHECK-ESISTENZA-ARTICOLO-IN-PROMO
                       if not trovato
                          inspect art-descrizione replacing trailing 
                                                  low-value by spaces
                          add 1 to num-articoli
                          |Da Walter: fisso NO
                          set  TrattamentoPiombo    to false
                          |Per cui non leggo nemmeno la marca
                          set  TrattamentoGDO       to true
                          move art-peso-utf         to prg-peso-utf
                          move art-peso-non-utf     to prg-peso-non-utf
                          perform CALCOLA-IMPOSTE
                          compute tot-imposte = imposta-consumo +
                                                imposta-cou     +
                                                imposta-cobat
                          compute prezzo-netto =
                              lst-prezzo - tot-imposte
                          compute sconto =
                               (( prezzo-netto ) *
                                  ef-sconto-buf ) / 100
                          compute rpr-prz-acq  =
                                  prezzo-netto - sconto + tot-imposte
                          move art-codice      to c-art
                          move art-descrizione to c-des
                          move rpr-prz-acq     to c-prz
                          move 0               to c-qta
                          modify gd-art, record-to-add = gd-art-rec
                          add 1 to riga
                       end-if
                    end-if
                 end-if
              end-perform

              if num-articoli = 0
                 display message "Nessun Articolo trovato"
                           title titolo
                            icon 2

                 move 78-ID-ef-des to control-id
                 move 4            to accept-control
              else
                 move 78-ID-gd-art to control-id
                 move 4            to accept-control
                 move 2 to event-data-2
                 move 1 to event-data-1
                 perform SPOSTAMENTO-S
              end-if
              modify gd-art, mass-update = 0
              modify lab, visible false

              modify pb-genera, bitmap-number = 1
           else
              move 1000 to control-id
              move 4    to accept-control
           end-if.

      ***---
       CHECK-ESISTENZA-VALIDITA-LISTINO.
           set trovato to false.
           move ef-gdo-buf    to lst-gdo.
           move art-codice    to lst-articolo.
           move como-data     to lst-data.
           start listini key <= lst-k-articolo
                 invalid continue
             not invalid
                 read listini previous
                 if lst-articolo = art-codice  and
                    lst-gdo      = ef-gdo-buf  and
                    lst-data    <= como-data   and
                    lst-prezzo  >  0 
                    set trovato to true
                 end-if
           end-start.

      ***---
       CHECK-ESISTENZA-ARTICOLO-IN-PROMO.
           set trovato to false.
           initialize rpr-rec replacing numeric data by zeroes
                                   alphanumeric data by spaces.
           move ef-codice-buf to rpr-codice.
           move art-codice to rpr-articolo.
           read rpromo no lock 
                invalid continue 
            not invalid
                set trovato to true
                display message "Articolo " rpr-articolo, 
                                " già presente sul volantino!"
                          title titolo
                           icon 2
           end-read 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. gd-art-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO-S 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-End-Drag.
      * <TOTEM:PARA. gd-art-Ev-Msg-End-Drag>
           perform SPOSTAMENTO-S 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. gd-art-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO-S 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. gd-art-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO-S 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. gd-art-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO-S 
           .
      * <TOTEM:END>
       gd-art-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. gd-art-Ev-Msg-Begin-Entry>
           evaluate event-data-1
           when 1
           when 2 set event-action to event-action-fail
           end-evaluate 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. gd-dest-Ev-Msg-Begin-Entry>
           set event-action to event-action-fail.
           if mod = 1
              inquire gd-dest, entry-reason in como-entry
              evaluate como-entry
              when x"20"
              when x"0D" perform SELEZIONE-RIGA
              end-evaluate
           end-if 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. gd-dest-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO-D.
           if mod = 1
              perform SELEZIONE-RIGA
           end-if 
           .
      * <TOTEM:END>
       pb-dest-LinkTo.
      * <TOTEM:PARA. pb-dest-LinkTo>
           if vecchio
              move 78-ID-ef-gdo to control-id
              perform CONTROLLO
              if tutto-ok
                 perform RIEMPI-GRID-DESTINI
              end-if
           else
              inquire ef-gdo, value in ef-gdo-buf
              perform RIEMPI-GRID-DESTINI
           end-if 
           .
      * <TOTEM:END>
       pb-nazio-LinkTo.
      * <TOTEM:PARA. pb-nazio-LinkTo>
           move "NAZIONALE" to lab-tipo-buf.
           display lab-tipo-volantino.

           perform RESETTA-GRID-DESTINI.

           if old-tpr-locale
              set VariazioneDestini to true
           end-if.

           set nazionale to true 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. gd-dest-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO-D 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-End-Drag.
      * <TOTEM:PARA. gd-dest-Ev-Msg-End-Drag>
           perform SPOSTAMENTO-D 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. gd-dest-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO-D 
           .
      * <TOTEM:END>
       gd-dest-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. gd-dest-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO-D 
           .
      * <TOTEM:END>
       pb-blister-LinkTo.
      * <TOTEM:PARA. pb-blister-LinkTo>
           perform X-Y.
           if colonna = 1
              inquire gd1(riga, 1), cell-data in bli-codice
              move "blister"      to Como-File
              call   "zoom-gt" using como-file, bli-rec
                              giving stato-zoom
              cancel "zoom-gt"
              if stato-zoom = 0
                 move bli-codice      to art-codice
                 move bli-descrizione to art-descrizione
                 perform CONTROLLA-ARTICOLO-GIA-INSERITO
                 if not trovato
                    perform CONTROLLA-SCORTA-BLISTER
                    if tutto-ok
                       move art-codice          to col-art
                       perform DESCRIZIONE-IMBALLO
                       modify gd1(riga, 1), cell-data = col-art
                       modify gd1(riga, 2), cell-data = col-des
                       move 78-ID-gd1 to control-id
                       move 4         to accept-control
                       modify gd1, cursor-y riga, cursor-x 1
                       perform COLORE-RIGA
                    end-if
                 end-if
              end-if
           end-if           
           .
      * <TOTEM:END>
       Screen1-Cb-1-BeforeProcedure.
      * <TOTEM:PARA. Screen1-Cb-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       Screen1-Cb-1-AfterProcedure.
      * <TOTEM:PARA. Screen1-Cb-1-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       pb-copia-BeforeProcedure.
      * <TOTEM:PARA. pb-copia-BeforeProcedure>
           modify pb-copia, bitmap-number = 2 
           .
      * <TOTEM:END>
       pb-copia-AfterProcedure.
      * <TOTEM:PARA. pb-copia-AfterProcedure>
           modify pb-copia, bitmap-number = 1 
           .
      * <TOTEM:END>
       pb-copia-LinkTo.
      * <TOTEM:PARA. pb-copia-LinkTo>
           perform SALV-MOD.
           if tutto-ok        
              display message 
              "S'intende generare una nuova promo identica a questa?"
                        title titolo
                         icon 2
                         type mb-yes-no
                       giving scelta
                       default mb-no
              if scelta = mb-yes
                 inquire ef-codice, value in link-tpr-codice
                 call   "lab-copiapromo" using link-tpr-codice user-codi
                 cancel "lab-copiapromo"
                 display message "Creata promo n. " link-tpr-codice
                           title titolo
                            icon 2
              end-if
           end-if 
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

