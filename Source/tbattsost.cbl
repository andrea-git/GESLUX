      *{TOTEM}PRG-COMMENT
      * tbattsost.Cbl
      * tbattsost.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          tbattsost.
       AUTHOR.              andre.
       DATE-WRITTEN.        giovedì 25 giugno 2020 09:17:46.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:tbattsost, INIT:tbattsost, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "articoli.sl".
           COPY "battsost.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "articoli.fd".
           COPY "battsost.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "fonts.def".
               COPY "crtvars.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Enter-Pushed VALUE 13.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
          88 Screen-Time-Out VALUE 99.
      * Properties & User defined Working Stoarge
       78 titolo VALUE IS "Geslux - Gestione Catene Articoli". 
       78 titolo-2 VALUE IS "Geslux - Gestione Catene Articoli - Dettagl
      -    "io". 
       77 save-riga        PIC  9(9).
       77 FILLER           PIC  9.
           88 CallManutenzione VALUE IS 1    WHEN SET TO FALSE  0. 
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 form1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 0.
       77 Verdana10B-Occidentale
                  USAGE IS HANDLE OF FONT DEFAULT-FONT.
       77 E-ESCI           PIC  9
                  VALUE IS 1.
       77 E-NUOVO          PIC  9
                  VALUE IS 1.
       77 E-CANCELLA       PIC  9
                  VALUE IS 1.
       77 E-SALVA          PIC  9
                  VALUE IS 1.
       77 E-ANTEPRIMA      PIC  9
                  VALUE IS 0.
       77 E-MODIFICA       PIC  9
                  VALUE IS 1.
       77 E-STAMPA         PIC  9
                  VALUE IS 0.
       77 E-CERCA          PIC  9
                  VALUE IS 1.
       77 como-x           PIC  x.
       77 Form3-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 Verdana12BI-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 font-evidenzia-griglia
                  USAGE IS HANDLE OF FONT.
       77 como-riga
                  USAGE IS UNSIGNED-INT.
       77 como-colonna
                  USAGE IS UNSIGNED-INT.
       77 bottone-ok-bmp   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 Verdana12-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 save-idx         PIC  9999.
       01 save-tabella.
           05 save-catena
                      OCCURS 1000 TIMES.
               10 save-articolo    PIC  9(6).
       01 FILLER           PIC  XX.
           88 ricarica VALUE IS "SI"    WHEN SET TO FALSE  "NO". 
       77 STATUS-articoli  PIC  X(2).
           88 Valid-STATUS-articoli VALUE IS "00" THRU "09". 
       77 status-battsost  PIC  X(2).
           88 Valid-status-battsost VALUE IS "00" THRU "09". 
       01 rec-grid.
           05 Col-art-princ    PIC  z(6).
           05 col-desc-art-princ           PIC  x(40).
           05 collegati.
               10 col-collegato-1  PIC  z(06).
               10 col-des-1        PIC  x(40).
               10 col-collegato-2  PIC  z(06).
               10 col-des-2        PIC  x(40).
               10 col-collegato-3  PIC  z(06).
               10 col-des-3        PIC  x(40).
               10 col-collegato-4  PIC  z(06).
               10 col-des-4        PIC  x(40).
               10 col-collegato-5  PIC  z(06).
               10 col-des-5        PIC  x(40).
           05 FILLER REDEFINES collegati.
               10 col-collegato    PIC  z(6)
                          OCCURS 5 TIMES.
               10 col-des          PIC  x(40)
                          OCCURS 5 TIMES.
       77 bottone-exit-bmp PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 form2-Handle
                  USAGE IS HANDLE OF WINDOW.
       01 rec-grid-dett.
           05 col-nulla-d      PIC  X.
           05 Col-articolo     PIC  z(6).
           05 col-desc-art     PIC  x(40).
       77 riga-det         PIC  9(4).
       77 tot-righe-det    PIC  9(4).
       77 lbl-art-buf      PIC  X(50).
       77 lbl-descr-art-buf            PIC  X(50).
       77 CERCA-BMP        PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 ef-art-buf       PIC  9(5).
       77 Form1-Tb-1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 toolbar-bmp      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-Form1-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Form1-battsost-RESTOREBUF  PIC X(6622).
       77 TMP-Form1-KEYIS  PIC 9(3) VALUE 1.
       77 Form1-MULKEY-TMPBUF   PIC X(6622).
       77 TMP-DataSet1-articoli-BUF     PIC X(3669).
       77 TMP-DataSet1-battsost-BUF     PIC X(6622).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-articoli-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-articoli-LOCK  VALUE "Y".
       77 DataSet1-articoli-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-articoli-KEY-Asc  VALUE "A".
          88 DataSet1-articoli-KEY-Desc VALUE "D".
       77 DataSet1-battsost-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-battsost-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-battsost-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-battsost-KEY1-Asc  VALUE "A".
          88 DataSet1-battsost-KEY1-Desc VALUE "D".

       77 articoli-art-k1-SPLITBUF  PIC X(51).
       77 articoli-art-k-frn-SPLITBUF  PIC X(16).
       77 battsost-bts-art-princ-SPLITBUF  PIC X(13).

       77  cod-ed   pic z(6).

       01 old-bts-rec.
           05 old-bts-chiave.
               10 old-bts-codice       PIC  9(6).
               10 old-bts-princ        PIC  9(6).
           05 old-bts-dati.
               10 old-bts-catena
                          OCCURS 1000 TIMES.
                   15 old-bts-collegato    PIC  9(6).
               10 old-bts-num-el-catena            PIC  9(4).
               10 old-bts-dati-comuni.
                   15 old-bts-data-creazione           PIC  9(8).
                   15 old-bts-ora-creazione            PIC  9(8).
                   15 old-bts-utente-creazione         PIC  X(10).
                   15 old-bts-data-ultima-modifica     PIC  9(8).
                   15 old-bts-ora-ultima-modifica      PIC  9(8).
                   15 old-bts-utente-ultima-modifica   PIC  X(10).
               10 old-bts-vuoti.
                   15 old-bts-num-vuoto-1  PIC  9(18).
                   15 old-bts-num-vuoto-2  PIC  9(18).
                   15 old-bts-num-vuoto-3  PIC  9(18).
                   15 old-bts-alfa-vuoto   PIC  X(500).
      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE
           COPY  "COMMON-LINKAGE.DEF".

      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           .

      * GRID
       05
           gd-catena, 
           Grid, 
           COL 2,67, 
           LINE 2,00,
           LINES 40,54 ,
           SIZE 243,17 ,
           BOXED,
           DATA-COLUMNS (1, 7, 47, 53, 93, 99, 139, 145, 185, 191, 231, 
           237),
           ALIGNMENT ("C", "L", "C", "U", "C", "U", "C", "U", "C", "U", 
           "C", "U"),
           SEPARATION (5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5),
           DATA-TYPES ("9(6)", "X", "9(6)", "X", "9(6)", "X", "9(6)", "X
      -    "", "9(6)", "X", "9(6)", "X"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-COLOR 480
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           HEADING-FONT IS Verdana10B-Occidentale,
           HSCROLL,
           ID IS 1,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 240,
           VPADDING 50,
           VSCROLL,
           EVENT PROCEDURE Screen1-Gd-1-Event-Proc,
           .

      * LABEL
       05
           Screen1-blockpgm-1, 
           Label, 
           COL 138,00, 
           LINE 1,38,
           LINES 0,23 ,
           SIZE 14,83 ,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "BlockPgm",
           VISIBLE v-custom,
           .

      * LABEL
       05
           Screen1-Custom1-1, 
           Label, 
           COL 155,50, 
           LINE 1,38,
           LINES 0,23 ,
           SIZE 7,67 ,
           ID IS 7,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * TOOLBAR
       01
           Form1-Tb-1,
           .    

      * PUSH BUTTON
       05
           TOOL-ESCI, 
           Push-Button, 
           COL 1,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           ENABLED E-ESCI,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 2,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "&Esci",
           .

      * PUSH BUTTON
       05
           TOOL-NUOVO, 
           Push-Button, 
           COL 6,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 2,
           UNFRAMED,
           SQUARE,
           ENABLED E-NUOVO,
           EXCEPTION-VALUE 2,
           FLAT,
           ID IS 6,
           SELF-ACT,
           TITLE "Nuovo (F2)",
           .

      * PUSH BUTTON
       05
           TOOL-CANCELLA, 
           Push-Button, 
           COL 16,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           UNFRAMED,
           SQUARE,
           ENABLED E-CANCELLA,
           EXCEPTION-VALUE 4,
           FLAT,
           ID IS 5,
           SELF-ACT,
           TITLE "Cancella (F4)",
           BITMAP-NUMBER BitmapNumDelete
           .

      * PUSH BUTTON
       05
           TOOL-SALVA, 
           Push-Button, 
           COL 11,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           UNFRAMED,
           SQUARE,
           ENABLED E-SALVA,
           EXCEPTION-VALUE 3,
           FLAT,
           ID IS 8,
           SELF-ACT,
           TITLE "Salva (F3)",
           BITMAP-NUMBER BitmapNumSave
           .

      * PUSH BUTTON
       05
           TOOL-ANTEPRIMA, 
           Push-Button, 
           COL 26,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-ANTEPRIMA,
           EXCEPTION-VALUE 6,
           FLAT,
           ID IS 9,
           SELF-ACT,
           TITLE "Anteprima (F6)",
           BITMAP-NUMBER BitmapNumPreview
           .

      * CHECK BOX
       05
           TOOL-MODIFICA, 
           Check-Box, 
           COL 21,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 5,
           UNFRAMED,
           SQUARE,
           ENABLED E-MODIFICA,
           EXCEPTION-VALUE 1005
           FLAT,
           ID IS 10,
           SELF-ACT,
           TITLE "Modifica (F5)",
           VALUE MOD,
           AFTER PROCEDURE TOOL-MODIFICA-AfterProcedure,
           BEFORE PROCEDURE TOOL-MODIFICA-BeforeProcedure, 
           .
      * PUSH BUTTON
       05
           TOOL-STAMPA, 
           Push-Button, 
           COL 31,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-STAMPA,
           EXCEPTION-VALUE 7,
           FLAT,
           ID IS 11,
           SELF-ACT,
           TITLE "Stampa (F7)",
           BITMAP-NUMBER BitmapNumPrint
           .

      * PUSH BUTTON
       05
           TOOL-CERCA, 
           Push-Button, 
           COL 36,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-CERCA,
           EXCEPTION-VALUE 8,
           FLAT,
           ID IS 12,
           SELF-ACT,
           TITLE "Cerca (F8)",
           BITMAP-NUMBER BitmapNumZoom
           .

      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE  DIVISION USING LK-BLOCKPGM, USER-CODI, LIVELLO-ABIL.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:tbattsost, INIT:tbattsost, BeforeDeclarative>
      ***---
       BATTSOST-ERR SECTION.
           use after error procedure on battsost.
           set tutto-ok  to true.
           evaluate status-battsost
           when "35"
                display message "File [BATTSOST] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [BATTSOST] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[BATTSOST] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.
 
      ***---
       ARTICOLI-ERR SECTION.
           use after error procedure on ARTICOLI.
           set tutto-ok  to true.
           evaluate status-ARTICOLI
           when "35"
                display message "File [ARTICOLI] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [ARTICOLI] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[ARTICOLI] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM ginqui-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:tbattsost, INIT:tbattsost, BeforeDestroyResource>
      * <TOTEM:END>
           DESTROY Verdana10B-Occidentale
           CALL "w$bitmap" USING WBITMAP-DESTROY, toolbar-bmp
           CALL "w$bitmap" USING WBITMAP-DESTROY, TOOLBAR-BMP
      *    After-Program
           PERFORM ginqui-Ev-After-Program
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
      *    After Init
           .
    
       INIT-FONT.
      * Verdana10B-Occidentale
           INITIALIZE WFONT-DATA Verdana10B-Occidentale
           MOVE 10 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO TRUE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana10B-Occidentale, WFONT-DATA
           .

       INIT-BMP.
      * TOOL-ESCI
           COPY RESOURCE "toolbar.bmp".
           CALL "w$bitmap" USING WBITMAP-LOAD "toolbar.bmp", 
                   GIVING toolbar-bmp.
      * TOOL-ANTEPRIMA
           COPY RESOURCE "TOOLBAR.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "TOOLBAR.BMP", 
                   GIVING TOOLBAR-BMP.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-articoli
           PERFORM OPEN-battsost
      *    After Open
           .

       OPEN-articoli.
      * <TOTEM:EPT. INIT:tbattsost, FD:articoli, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT articoli
           IF NOT Valid-STATUS-articoli
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tbattsost, FD:articoli, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-battsost.
      * <TOTEM:EPT. INIT:tbattsost, FD:battsost, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O battsost
           IF status-battsost = "35"
              OPEN OUTPUT battsost
                IF Valid-status-battsost
                   CLOSE battsost
                   OPEN I-O battsost
                END-IF
           END-IF
           IF NOT Valid-status-battsost
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tbattsost, FD:battsost, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-articoli
           PERFORM CLOSE-battsost
      *    After Close
           .

       CLOSE-articoli.
      * <TOTEM:EPT. INIT:tbattsost, FD:articoli, BeforeClose>
      * <TOTEM:END>
           CLOSE articoli
           .

       CLOSE-battsost.
      * <TOTEM:EPT. INIT:tbattsost, FD:battsost, BeforeClose>
      * <TOTEM:END>
           CLOSE battsost
           .

       articoli-art-k1-MERGE-SPLITBUF.
           INITIALIZE articoli-art-k1-SPLITBUF
           MOVE art-descrizione OF articoli(1:50) TO 
           articoli-art-k1-SPLITBUF(1:50)
           .

       articoli-art-k-frn-MERGE-SPLITBUF.
           INITIALIZE articoli-art-k-frn-SPLITBUF
           MOVE art-cod-art-frn OF articoli(1:15) TO 
           articoli-art-k-frn-SPLITBUF(1:15)
           .

       DataSet1-articoli-INITSTART.
           IF DataSet1-articoli-KEY-Asc
              MOVE Low-Value TO art-chiave OF articoli
           ELSE
              MOVE High-Value TO art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-INITEND.
           IF DataSet1-articoli-KEY-Asc
              MOVE High-Value TO art-chiave OF articoli
           ELSE
              MOVE Low-Value TO art-chiave OF articoli
           END-IF
           .

      * articoli
       DataSet1-articoli-START.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY >= art-chiave OF articoli
           ELSE
              START articoli KEY <= art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-NOTGREATER.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY <= art-chiave OF articoli
           ELSE
              START articoli KEY >= art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-GREATER.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY > art-chiave OF articoli
           ELSE
              START articoli KEY < art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-START-LESS.
           IF DataSet1-articoli-KEY-Asc
              START articoli KEY < art-chiave OF articoli
           ELSE
              START articoli KEY > art-chiave OF articoli
           END-IF
           .

       DataSet1-articoli-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-articoli-LOCK
              READ articoli WITH LOCK 
              KEY art-chiave OF articoli
           ELSE
              READ articoli WITH NO LOCK 
              KEY art-chiave OF articoli
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT 
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-articoli-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-articoli-KEY-Asc
              IF DataSet1-articoli-LOCK
                 READ articoli NEXT WITH LOCK
              ELSE
                 READ articoli NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-articoli-LOCK
                 READ articoli PREVIOUS WITH LOCK
              ELSE
                 READ articoli PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-articoli-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-articoli-KEY-Asc
              IF DataSet1-articoli-LOCK
                 READ articoli PREVIOUS WITH LOCK
              ELSE
                 READ articoli PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-articoli-LOCK
                 READ articoli NEXT WITH LOCK
              ELSE
                 READ articoli NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM articoli-art-k1-MERGE-SPLITBUF
           PERFORM articoli-art-k-frn-MERGE-SPLITBUF
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-articoli-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-articoli TO TOTEM-ERR-STAT
           MOVE "articoli" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:articoli, AfterDelete>
      * <TOTEM:END>
           .

       battsost-bts-art-princ-MERGE-SPLITBUF.
           INITIALIZE battsost-bts-art-princ-SPLITBUF
           MOVE bts-princ OF battsost(1:6) TO 
           battsost-bts-art-princ-SPLITBUF(1:6)
           MOVE bts-codice OF battsost(1:6) TO 
           battsost-bts-art-princ-SPLITBUF(7:6)
           .

       DataSet1-battsost-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 MOVE Low-Value TO bts-chiave OF battsost
              ELSE
                 MOVE High-Value TO bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-battsost-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 MOVE High-Value TO bts-chiave OF battsost
              ELSE
                 MOVE Low-Value TO bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-battsost-KEY1-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-battsost-KEY1-ORDER
           END-EVALUATE
           .

      * battsost
       DataSet1-battsost-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 START battsost KEY >= bts-chiave OF battsost
              ELSE
                 START battsost KEY <= bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-battsost-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 START battsost KEY <= bts-chiave OF battsost
              ELSE
                 START battsost KEY >= bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-battsost-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 START battsost KEY > bts-chiave OF battsost
              ELSE
                 START battsost KEY < bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-battsost-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 START battsost KEY < bts-chiave OF battsost
              ELSE
                 START battsost KEY > bts-chiave OF battsost
              END-IF
           END-EVALUATE
           .

       DataSet1-battsost-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-LOCK
                 READ battsost WITH LOCK 
                 KEY bts-chiave OF battsost
              ELSE
                 READ battsost WITH NO LOCK 
                 KEY bts-chiave OF battsost
              END-IF
           END-EVALUATE
           PERFORM battsost-bts-art-princ-MERGE-SPLITBUF
           MOVE status-battsost TO TOTEM-ERR-STAT 
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-battsost-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 IF DataSet1-battsost-LOCK
                    READ battsost NEXT WITH LOCK
                 ELSE
                    READ battsost NEXT WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-battsost-LOCK
                    READ battsost PREVIOUS WITH LOCK
                 ELSE
                    READ battsost PREVIOUS WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           PERFORM battsost-bts-art-princ-MERGE-SPLITBUF
           MOVE status-battsost TO TOTEM-ERR-STAT
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-battsost-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-battsost-KEY1-Asc
                 IF DataSet1-battsost-LOCK
                    READ battsost PREVIOUS WITH LOCK
                 ELSE
                    READ battsost PREVIOUS WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-battsost-LOCK
                    READ battsost NEXT WITH LOCK
                 ELSE
                    READ battsost NEXT WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           PERFORM battsost-bts-art-princ-MERGE-SPLITBUF
           MOVE status-battsost TO TOTEM-ERR-STAT
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-battsost-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeWrite>
      * <TOTEM:END>
           WRITE bts-rec OF battsost.
           MOVE status-battsost TO TOTEM-ERR-STAT
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-battsost-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeRewrite>
      * <TOTEM:END>
           REWRITE bts-rec OF battsost.
           MOVE status-battsost TO TOTEM-ERR-STAT
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-battsost-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, BeforeDelete>
      * <TOTEM:END>
           DELETE battsost.
           MOVE status-battsost TO TOTEM-ERR-STAT
           MOVE "battsost" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:battsost, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-INIT-RECORD.
           INITIALIZE art-rec OF articoli
           INITIALIZE bts-rec OF battsost
           .


      * GRID
       gd-catena-Content.
      * CELLS' SETTING
              MODIFY gd-catena, X = 1, Y = 1,
                CELL-DATA = "Articolo",
      * CELLS' SETTING
              MODIFY gd-catena, X = 3, Y = 1,
                CELL-DATA = "Coll. 1",
      * CELLS' SETTING
              MODIFY gd-catena, X = 5, Y = 1,
                CELL-DATA = "Coll. 2",
      * CELLS' SETTING
              MODIFY gd-catena, X = 7, Y = 1,
                CELL-DATA = "Coll. 3",
      * CELLS' SETTING
              MODIFY gd-catena, X = 9, Y = 1,
                CELL-DATA = "Coll. 4",
      * CELLS' SETTING
              MODIFY gd-catena, X = 11, Y = 1,
                CELL-DATA = "Coll. 5",
           .

      * FD's Initialize Paragraph
       DataSet1-articoli-INITREC.
           INITIALIZE art-rec OF articoli
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-battsost-INITREC.
           INITIALIZE bts-rec OF battsost
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 1 ALSO 0
                  PERFORM Form1-Buf-To-Fld
           END-EVALUATE
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           DISPLAY Form1-Tb-1
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 42,62,
              SIZE 246,67,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Small-Font,
              LABEL-OFFSET 23,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              WITH SYSTEM MENU,
              USER-GRAY,
           VISIBLE 1,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS form1-Handle,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
           DISPLAY TOOL-BAR 
              LINES 2,69,   
              HANDLE IN Form1-Tb-1-Handle
           DISPLAY Form1-Tb-1 UPON Form1-Tb-1-Handle

      * Status-bar
           DISPLAY Form1 UPON form1-Handle
      * DISPLAY-COLUMNS settings
              MODIFY gd-catena, DISPLAY-COLUMNS (1, 11, 41, 51, 81, 91, 
           121, 131, 161, 171, 201, 211)
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
           perform ABILITA-TOOLBAR.
           perform ABILITAZIONI.
           set CallManutenzione to false.
           perform RIEMPI-GRID

           move 2 to riga, EVENT-DATA-2
           modify gd-catena, CURSOR-Y = 2

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY form1-Handle
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
      *    per il bottone modifica
           if key-status = 5
              inquire tool-modifica, enabled in e-modifica
              if e-modifica = 1
                 if mod = zero
                    move 1    to mod
                 else 
                    move zero to mod
                 end-if
                 modify tool-modifica, value = mod
                 perform MODIFICA
              end-if
           end-if.

           .
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = 27
                 PERFORM TOOL-ESCI-LinkTo
              WHEN Key-Status = 2
                 PERFORM NUOVO-LinkTo
              WHEN Key-Status = 4
                 PERFORM CANCELLA-LinkTo
              WHEN Key-Status = 3
                 PERFORM TOOL-SALVA-LinkTo
              WHEN Key-Status = 6
                 PERFORM ANTEPRIMA-LinkTo
              WHEN Key-Status = 1005
                 PERFORM TOOL-MODIFICA-LinkTo
              WHEN Key-Status = 7
                 PERFORM STAMPA-LinkTo
              WHEN Key-Status = 8
                 PERFORM TOOL-CERCA-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1-Tb-1
           DISPLAY Form1 UPON form1-Handle
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
           perform SALV-MOD.
           if errori
              move 28 to key-status
              exit paragraph
           end-if.

           .
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM gd-catena-Content
           .

       Form1-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-battsost-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-battsost-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Update-Key.
           MOVE bts-rec OF battsost TO
                     Form1-MULKEY-TMPBUF
           PERFORM Form1-CLEAR
           PERFORM Form1-INIT-DATA
           MOVE Form1-MULKEY-TMPBUF TO
                     bts-rec OF battsost
           PERFORM DataSet1-battsost-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
           .

       Form1-DUPLICATE-MOVEKEY.
           .

       Form1-First.
           PERFORM Form1-DUMMY-FIRST
           PERFORM DataSet1-battsost-INITSTART
           PERFORM DataSet1-battsost-START
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-battsost-Read-Next
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFirst>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Previous.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-battsost-START-LESS
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-battsost-Read-Prev
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterPrevious>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-PREVIOUS
           PERFORM Form1-IUD-Display
           .

       Form1-Next.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-battsost-START-GREATER
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-battsost-Read-Next
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterNext>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-NEXT
           PERFORM Form1-IUD-Display
           .
      
       Form1-Last.
           PERFORM Form1-DUMMY-LAST
           PERFORM DataSet1-battsost-INITEND
           PERFORM DataSet1-battsost-START-NOTGREATER
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-battsost-Read-Prev
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterLast>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Curr.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-battsost-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCurrent>
      * <TOTEM:END>
           .

       Form1-IUD-Display.
           IF Valid-status-battsost
              PERFORM Form1-ALLGRID-RESET
              PERFORM Form1-Fld-To-Buf
              PERFORM Form1-NAVI-FOR-MASTERGRID
              PERFORM Form1-DISPLAY
           ELSE
              IF Form1-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Form1-Extended-File-Status
              END-IF
           END-IF
           .

       Form1-Add.
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-ADD
           PERFORM DataSet1-battsost-INITREC
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-battsost-Rec-Write
           IF Valid-status-battsost
              PERFORM Form1-RESUMMARY-INS
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAdd>
      * <TOTEM:END>
           .
     
       Form1-Update.
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-battsost-START              
           IF NOT Valid-status-battsost
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-battsost-Read
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-UPDATE
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-battsost-Rec-Rewrite
           IF Valid-status-battsost
              PERFORM Form1-RESUMMARY-DEL
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterUpdate>
      * <TOTEM:END>
           .

       Form1-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDelete>
      * <TOTEM:END>
           PERFORM Form1-DUMMY-DELETE
      * delete
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-battsost-Rec-Delete
           IF Valid-status-battsost
              PERFORM Form1-CLEAR
              PERFORM Form1-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to status-battsost
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDelete>
      * <TOTEM:END>
           PERFORM Form1-ERR-CHECKING
           .

       Form1-NAVI-FOR-MASTERGRID.
           .

       Form1-ERR-CHECKING.
           IF Valid-status-battsost
              PERFORM Form1-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Form1-Extended-File-Status
           END-IF
           .

       Form1-RESUMMARY-INS.
           .

       Form1-RESUMMARY-DEL.
           .


       Form1-DUMMY-FIRST.
           .

       Form1-DUMMY-PREVIOUS.
           .

       Form1-DUMMY-NEXT.
           .

       Form1-DUMMY-LAST.
           .

       Form1-DUMMY-CURR.
           .

       Form1-DUMMY-ADD.
           .

       Form1-DUMMY-UPDATE.
           .

       Form1-DUMMY-UPDATE-INIT.
           .

       Form1-DUMMY-DELETE.
           .

       Form1-DUMMY-DELETE-INIT.
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
      * FORM : Form1
           PERFORM DataSet1-INIT-RECORD
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
           set SiSalvato to true.

           .
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.
           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           MOVE DataSet1-battsost-KEY1-ORDER TO TMP-Form1-KEY1-ORDER
           MOVE DataSet1-KEYIS TO TMP-Form1-KEYIS
           MOVE bts-rec OF battsost TO 
              TMP-Form1-battsost-RESTOREBUF
           .             

       Form1-Restore-Status.
           MOVE TMP-Form1-KEY1-ORDER TO DataSet1-battsost-KEY1-ORDER
           MOVE TMP-Form1-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Form1-battsost-RESTOREBUF TO
              bts-rec OF battsost
           PERFORM DataSet1-battsost-START
           IF Valid-status-battsost
              PERFORM DataSet1-battsost-Read-Next
           ELSE
              PERFORM DataSet1-battsost-INITREC
           END-IF
           PERFORM UNTIL NOT Valid-status-battsost OR
              (Valid-status-battsost AND
                 bts-rec OF battsost = 
                   TMP-Form1-battsost-RESTOREBUF)
              PERFORM DataSet1-battsost-Read-Next
           END-PERFORM
           .



       Screen1-Event-Proc.
           .

       Screen1-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-catena-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 1 ALSO
                    form1-Handle 
              PERFORM gd-ordini-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

      * USER DEFINE PARAGRAPH
       ABILITAZIONI.
      * <TOTEM:PARA. ABILITAZIONI>
           if mod = 1
              move BitmapDeleteEnabled to BitmapNumDelete
              move BitmapSaveEnabled   to BitmapNumSave
              move 1 to e-salva e-cancella
           else
              |SE SONO IN VISUA           
              move BitmapDeleteDisabled to BitmapNumDelete
              move BitmapSaveDisabled   to BitmapNumSave
              move ZERO to e-salva e-cancella
           end-if.     

      * ISACCO (CORREZIONE SU LIVELLO ABILITAZIONE 2) - 10/11/2003
      * (CANCELLAZIONE NON PERMESSA)
           if livello-abil = 2 
              move ZERO to e-cancella
              move BitmapDeleteDisabled to BitmapNumDelete
           end-if.
      * FINE

           modify tool-cancella, enabled = e-cancella.
           modify tool-salva,    enabled = e-salva.
       
      * ISACCO (SERVE SEMPRE PER LA MODIFICA PRCEDENTE E PER RIPRISTINARE
      * LE BITMAP DISABILITATE. - 10/11/2003
      *     perform FORM1-DISPLAY.
           display tool-nuovo, tool-salva, tool-cancella, tool-modifica.
      * FINE.

           perform GRID-HELP 
           .
      * <TOTEM:END>

       CANCELLA.
      * <TOTEM:PARA. CANCELLA>
           if mod = 0 exit paragraph end-if.

           display message box MSG-cancellare-il-record-corrente
                   title = titolo
                   type mb-yes-no
                   default mb-no
                   giving scelta.

           if scelta = mb-yes

              inquire gd-catena, cursor-y  in riga
              perform VALORE-RIGA

              perform CANCELLA-BATTSOST

              modify  gd-catena, record-to-delete = riga 
              inquire gd-catena, last-row in tot-righe
              if riga > tot-righe move tot-righe to riga end-if
              modify gd-catena, cursor-y = riga, cursor-x = 1
              move riga to event-data-2
              perform COLORE-RIGA
              display message MSG-cancellazione-avvenuta-con-successo
                      title = titolo
           end-if 

           .
      * <TOTEM:END>

       CANCELLA-BATTSOST.
      * <TOTEM:PARA. CANCELLA-BATTSOST>
           move bts-codice to art-codice
           move low-value  to bts-princ
           start battsost key >= bts-chiave
                 invalid continue
             not invalid
                 perform until 1 = 2
                    read battsost next at end exit perform end-read
                    if bts-codice not = art-codice
                       exit perform
                    end-if
                    delete battsost record
                 end-perform
           end-start.

           move art-codice to bts-princ
           move low-value  to bts-codice
           start battsost key >= bts-art-princ
                 invalid continue
             not invalid
                 perform until 1 = 2
                    read battsost next at end exit perform end-read
                    if bts-princ not = art-codice
                       exit perform
                    end-if
                    delete battsost record
                 end-perform
           end-start 
           .
      * <TOTEM:END>

       CARICA-CATENE.
      * <TOTEM:PARA. CARICA-CATENE>
           move low-value to bts-codice
                             bts-princ

           start battsost key >= bts-art-princ 
                 invalid  continue
             not invalid  perform SCORRI-CATENE
           end-start 
           .
      * <TOTEM:END>

       CERCA.
      * <TOTEM:PARA. CERCA>
           evaluate colonna
           when 1
                perform VALORE-RIGA
                move bts-codice to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-art-princ
                   move art-descrizione to col-desc-art-princ
                   modify gd-catena(riga, 1), cell-data = col-art-princ
                   modify gd-catena(riga, 2), cell-data = 
           col-desc-art-princ
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           when 3
                perform VALORE-RIGA
                move bts-collegato(1) to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-collegato(1)
                   move art-descrizione to col-des(1)
                   modify gd-catena(riga, 3), cell-data = 
           col-collegato(1)
                   modify gd-catena(riga, 4), cell-data = col-des(1)
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           when 5
                perform VALORE-RIGA
                move bts-collegato(2) to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-collegato(2)
                   move art-descrizione to col-des(2)
                   modify gd-catena(riga, 5), cell-data = 
           col-collegato(2)
                   modify gd-catena(riga, 6), cell-data = col-des(2)
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           when 7
                perform VALORE-RIGA
                move bts-collegato(3) to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-collegato(3)
                   move art-descrizione to col-des(3)
                   modify gd-catena(riga, 7), cell-data = 
           col-collegato(3)
                   modify gd-catena(riga, 8), cell-data = col-des(3)
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           when 9
                perform VALORE-RIGA
                move bts-collegato(4) to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-collegato(4)
                   move art-descrizione to col-des(4)
                   modify gd-catena(riga, 9),  cell-data = 
           col-collegato(4)
                   modify gd-catena(riga, 10), cell-data = col-des(4)
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           when 11
                perform VALORE-RIGA
                move bts-collegato(5) to art-codice
                move "articoli"     to  como-file
                call   "zoom-gt" using  como-file, art-rec
                                 giving stato-zoom
           
                if stato-zoom = 0  
                   move art-codice      to col-collegato(5)
                   move art-descrizione to col-des(5)
                   modify gd-catena(riga, 11), cell-data = 
           col-collegato(5)
                   modify gd-catena(riga, 12), cell-data = col-des(5)
                   if bts-rec not = old-bts-rec
                      set NoSalvato to true                            
                   else 
                      set SiSalvato to true
                   end-if
                end-if
           end-evaluate  
           .
      * <TOTEM:END>

       CERCA-TESTO.
      * <TOTEM:PARA. CERCA-TESTO>
           .
      * <TOTEM:END>

       CHIAMA-MANUTENZIONE.
      * <TOTEM:PARA. CHIAMA-MANUTENZIONE>
           read articoli no lock 
                invalid continue
            not invalid
                modify form2-Handle, visible = 0
                call   "varticoli" using art-codice
                cancel "varticoli"
                modify form2-Handle, visible = 1
           end-read 
           .
      * <TOTEM:END>

       COLORE-RIGA.
      * <TOTEM:PARA. COLORE-RIGA>
           if riga < 2 
              move 2 to riga
           end-if.

           modify gd-catena, start-x = 1, x = 12,
                             start-y = riga,
                                   y = riga,
                             region-color 257,
                             cursor-color 481 
           .
      * <TOTEM:END>

       CONTROLLO.
      * <TOTEM:PARA. CONTROLLO>
           set tutto-ok to true.

           inquire gd-catena, cursor-y in riga.

           perform VALORE-RIGA.

           evaluate colonna
           when 1
                if nuovo
                   if bts-codice = zero or spaces 
                      set errori to true
                      move 1     to colonna
                      display message box MSG-Codice-obbligatorio
                              title = tit-err
                              icon mb-warning-icon
                   else 
                      move bts-codice to art-codice
                      perform CONTROLLO-ARTICOLO
                      if status-articoli = "00"
                         move 0 to bts-princ
                         read battsost
                              not invalid
                                  set errori to true
                                  display message 
           MGS-codice-gia-inserito|"Codice già inserito!"
                                          title = tit-err
                                          icon mb-warning-icon
                         end-read
                      end-if
                   end-if
                end-if
           when 3
                move bts-collegato(1) to art-codice
                perform CONTROLLO-ARTICOLO
           when 5                         
                move bts-collegato(2) to art-codice
                perform CONTROLLO-ARTICOLO
           when 7                    
                move bts-collegato(3) to art-codice
                perform CONTROLLO-ARTICOLO
           when 9                   
                move bts-collegato(4) to art-codice
                perform CONTROLLO-ARTICOLO
           when 11                  
                move bts-collegato(5) to art-codice
                perform CONTROLLO-ARTICOLO
           end-evaluate.

      ***---
       CONTROLLO-ARTICOLO.
           if art-codice = 0
              move spaces to art-descrizione
           else
              read articoli no lock
                   invalid
                   set errori to true
                   display message "Articolo non valido"
                             title tit-err
                              icon 2
                   move spaces to art-descrizione
              end-read
           end-if.
           modify gd-catena(riga, colonna + 1), cell-data 
           art-descrizione 
           
           .
      * <TOTEM:END>

       GRID-HELP.
      * <TOTEM:PARA. GRID-HELP>
      *    se non sono in modifica disabilito sempre lo zoom
           if mod = zero
              move BitmapZoomDisabled to BitmapNumZoom
              move 0 to e-cerca
              modify tool-cerca, bitmap-number = BitmapNumZoom,
                                 enabled       = e-cerca
           else
              evaluate colonna|event-data-1
              when 1
                   if nuovo
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   else                
                      move BitmapZoomDisabled to BitmapNumZoom
                      move 0 to e-cerca
                   end-if
              when 3
              when 5
              when 7
              when 9
              when 11
                   move BitmapZoomEnabled to BitmapNumZoom
                   move 1 to e-cerca
              when other
                   move BitmapZoomDisabled to BitmapNumZoom
                   move 0 to e-cerca
              end-evaluate
           
              modify tool-cerca, bitmap-number = BitmapNumZoom,
                                 enabled       = e-cerca
           end-if 
           .
      * <TOTEM:END>

       INIT.
      * <TOTEM:PARA. INIT>
           set vecchio  to true.
           set tutto-ok to true 
           .
      * <TOTEM:END>

       METTI-IN-GRIGLIA.
      * <TOTEM:PARA. METTI-IN-GRIGLIA>
           initialize rec-grid
           move bts-codice         to Col-art-princ    
                                      art-codice
           read articoli no lock
                invalid initialize art-descrizione
           end-read
           move art-descrizione    to col-desc-art-princ

           perform varying idx from 1 by 1 
                     until idx > bts-num-el-catena
              if idx > 5 exit perform end-if
              move bts-collegato(idx) to col-collegato(idx) art-codice
              read articoli no lock
                   invalid move spaces to art-descrizione
              end-read
              move art-descrizione to col-des(idx)
           end-perform

           modify gd-catena(riga, 1),  cell-data col-art-princ
           modify gd-catena(riga, 2),  cell-data col-desc-art-princ
           modify gd-catena(riga, 3),  cell-data col-collegato(1)
           modify gd-catena(riga, 4),  cell-data col-des(1)
           modify gd-catena(riga, 5),  cell-data col-collegato(2)
           modify gd-catena(riga, 6),  cell-data col-des(2)
           modify gd-catena(riga, 7),  cell-data col-collegato(3)
           modify gd-catena(riga, 8),  cell-data col-des(3)
           modify gd-catena(riga, 9),  cell-data col-collegato(4)
           modify gd-catena(riga, 10), cell-data col-des(4)
           modify gd-catena(riga, 11), cell-data col-collegato(5)
           modify gd-catena(riga, 12), cell-data col-des(5)

           inquire gd-catena, LAST-ROW = riga 
           .
      * <TOTEM:END>

       MODIFICA.
      * <TOTEM:PARA. MODIFICA>
           inquire tool-modifica, value in mod.

           if nuovo 
              move 1 to mod 
           else
              |specifico per i pgm. con grid-control
              if mod = 1
                 close battsost
                 open i-o battsost allowing readers
              else
                 set tutto-ok to true
                 if NoSalvato
                    move 1 to mod
                    perform SALV-MOD
                 end-if   
                 if tutto-ok
                    move 0 to mod
                    close battsost
                    open input battsost

      *             | specifico x le tabelle.
                    | fa in modo che resto sulla cella in cui ero
                    if ricarica
                       set ricarica to false
                       modify gd-catena, reset-grid = 1
                       perform RIEMPI-GRID
                    end-if

                 else
                    move 1 to mod
                 end-if
              end-if
           end-if.

           perform ABILITAZIONI.

           modify tool-modifica, value mod 
           .
      * <TOTEM:END>

       NUOVO.
      * <TOTEM:PARA. NUOVO>
           set tutto-ok to true.

           if nuovo
              perform VALORE-RIGA
              if bts-codice not = 0
                 perform SALVA
              else
                 set errori to true
              end-if
           end-if.

           if tutto-ok
              set nuovo to true
              inquire gd-catena,  last-row in tot-righe
              modify  gd-catena,  insert-rows = 1
              modify  gd-catena,  cursor-x    = 1 
                                  cursor-y    = tot-righe + 1
              move 1 to mod
              modify  tool-modifica,   value = mod

              add 1 to tot-righe giving riga

              perform ABILITAZIONI

              initialize old-bts-rec replacing numeric data by zeroes
                                          alphanumeric data by spaces
              add 1 to tot-righe giving event-data-2
              perform COLORE-RIGA
           end-if 
           .
      * <TOTEM:END>

       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "utydata.cpy".
           copy "color-custom.cpy".           
           copy "abilita-toolbar.cpy" 
           .
      * <TOTEM:END>

       RIEMPI-GRID.
      * <TOTEM:PARA. RIEMPI-GRID>
           modify gd-catena, mass-update = 1.
           modify gd-catena, reset-grid = 1.
           perform GD-CATENA-CONTENT.
           perform CARICA-CATENE.
           modify gd-catena, mass-update = 0.
           set vecchio to true 
           .
      * <TOTEM:END>

       SALV-MOD.
      * <TOTEM:PARA. SALV-MOD>
           if nuovo
              perform VALORE-RIGA
              if bts-rec not = old-bts-rec
                 set NoSalvato to true
              else
                 set SiSalvato to true
              end-if
           end-if.

           set tutto-ok to true.
           if NoSalvato
              display message box MSG-Salvare-le-modifiche, 
                             title = titolo
                             type = mb-yes-no-cancel
                             giving scelta

              evaluate scelta
              when mb-yes    perform SALVA
              when mb-cancel set errori    to true
              when mb-no     set tutto-ok  to true
                             set SiSalvato to true
                             set ricarica  to true
              end-evaluate

           end-if 
           .
      * <TOTEM:END>

       SALVA.
      * <TOTEM:PARA. SALVA>
           if sisalvato or mod = 0 exit paragraph end-if.

           inquire gd-catena, cursor-x in colonna, 
                              cursor-y in riga.

           perform varying colonna from 1 by 1 
                     until colonna > 13
              perform CONTROLLO
              if errori exit perform end-if
           end-perform.

           if tutto-ok     
              perform CANCELLA-BATTSOST
                                       
              move 0 to bts-princ
              perform VALORE-RIGA
              perform VALORIZZA-DATI-COMUNI
              move 0 to bts-num-el-catena
              perform varying idx from 1 by 1 
                        until idx > 5
                 if bts-collegato(idx)= 0
                    exit perform
                 end-if
                 move idx to bts-num-el-catena save-idx
              end-perform              
              write bts-rec
                                                 
              move bts-tabella to save-tabella

              perform varying idx from 1 by 1 
                        until idx > save-idx
                 initialize bts-rec replacing numeric data by zeroes
                                         alphanumeric data by spaces
                 move art-codice         to bts-princ
                 move save-articolo(idx) to bts-codice
                 perform VALORIZZA-DATI-COMUNI
                 write bts-rec 
              end-perform

              set sisalvato to true
              set vecchio   to true
           else                   
              perform ABILITAZIONI
           end-if                  
           .
      * <TOTEM:END>

       SCORRI-CATENE.
      * <TOTEM:PARA. SCORRI-CATENE>
           set trovato to false.

           modify gd-catena, mass-update 1.
           move 1 to riga.

           perform until 1 = 2
              read battsost next 
                 at end exit perform 
              end-read

              if bts-princ not = 0
                 exit perform 
              end-if

              add 1 to riga
              perform METTI-IN-GRIGLIA 
           end-perform.

           modify gd-catena, mass-update 0 
           .
      * <TOTEM:END>

       SPOSTAMENTO.
      * <TOTEM:PARA. SPOSTAMENTO>
           inquire gd-catena, cursor-x = colonna, cursor-y = riga.

           if event-data-2 not = riga
              perform VALORE-RIGA
              if bts-codice = 0
                 modify gd-catena, record-to-delete riga
                 set vecchio to true
              else  
                 perform SALVA
                 if errori
                    move riga    to event-data-2
                    move colonna to event-data-1 | (isacco)
                    set event-action to event-action-fail
                 end-if                                 
                 set vecchio to true
              end-if
           else
              if colonna not = event-data-1
                 perform CONTROLLO
                 if errori
                    set event-action to event-action-fail
                 end-if
              end-if
           end-if.

      * VALORIZZO L'OLD DELLA RIGA SU CUI SONO ANDATO
           move event-data-2 to riga.
           move event-data-1 to colonna.
           perform VALORE-OLD-RIGA.

      * COLORAZIONE RIGA IN GRID
           perform COLORE-RIGA.

           perform GRID-HELP 
           .
      * <TOTEM:END>

       VALORE-RIGA.
      * <TOTEM:PARA. VALORE-RIGA>
           inquire gd-catena(riga,  1), cell-data bts-codice.
           inquire gd-catena(riga,  3), cell-data bts-collegato(1) 
           inquire gd-catena(riga,  5), cell-data bts-collegato(2)
           inquire gd-catena(riga,  7), cell-data bts-collegato(3)
           inquire gd-catena(riga,  9), cell-data bts-collegato(4)
           inquire gd-catena(riga, 11), cell-data bts-collegato(5)
           .
      * <TOTEM:END>

       VALORE-OLD-RIGA.
      * <TOTEM:PARA. VALORE-OLD-RIGA>
           if vecchio
              inquire gd-catena(riga, 1) cell-data old-bts-codice
              move old-bts-chiave         to bts-chiave
              read battsost               no lock
              move bts-rec                to old-bts-rec
           else
              initialize old-bts-rec replacing numeric data by zeroes
                                          alphanumeric data by spaces
           end-if 
           .
      * <TOTEM:END>

       VALORIZZA-DATI-COMUNI.
      * <TOTEM:PARA. VALORIZZA-DATI-COMUNI>
      *    se non ho valorizzato i campi di creazione li valorizzo
           if bts-data-creazione = zero
              accept bts-data-creazione from century-date
           end-if.
           if bts-ora-creazione = zero
              accept bts-ora-creazione from time
           end-if.
           if bts-utente-creazione = space
              move user-codi to bts-utente-creazione
           end-if.

           accept bts-data-ultima-modifica from century-date.
           accept bts-ora-ultima-modifica from time.
           move user-codi to bts-utente-ultima-modifica 
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       ginqui-Ev-Before-Program.
      * <TOTEM:PARA. ginqui-Ev-Before-Program>
           move LK-BL-PROG-ID    TO COMO-PROG-ID 
           .
      * <TOTEM:END>
       ginqui-Ev-After-Program.
      * <TOTEM:PARA. ginqui-Ev-After-Program>
           SET LK-BL-CANCELLAZIONE TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-Begin-Entry>
           if mod = 0
              set event-action to event-action-fail
           else
              perform VALORE-RIGA
              evaluate event-data-1
              when 1
                   if vecchio       
                      set event-action to event-action-fail
                   end-if
              when 3   
                   if bts-codice = 0
                      set event-action to event-action-fail
                   end-if
              when 5
                   if bts-collegato(1) = 0
                      set event-action to event-action-fail
                   end-if     
              when 7                  
                   if bts-collegato(2) = 0
                      set event-action to event-action-fail
                   end-if                   
              when 9
                   if bts-collegato(3) = 0
                      set event-action to event-action-fail
                   end-if                   
              when 11
                   if bts-collegato(4) = 0
                      set event-action to event-action-fail
                   end-if          
              when 2     
              when 4     
              when 6     
              when 8     
              when 10    
              when 12
                   set event-action to event-action-fail
              end-evaluate
           end-if 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-End-Drag.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-End-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       gd-ordini-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. gd-ordini-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       NUOVO-LinkTo.
      * <TOTEM:PARA. NUOVO-LinkTo>
           inquire tool-nuovo, enabled in e-nuovo.
           if e-nuovo = 1
              perform NUOVO
           end-if 

           .
      * <TOTEM:END>
       CANCELLA-LinkTo.
      * <TOTEM:PARA. CANCELLA-LinkTo>
           inquire tool-cancella, enabled in e-cancella.
           if e-cancella = 1
              perform CANCELLA
           end-if 
           .
      * <TOTEM:END>
       TOOL-SALVA-LinkTo.
      * <TOTEM:PARA. TOOL-SALVA-LinkTo>
           inquire tool-salva, enabled in e-salva.
           if e-salva = 1
              perform salva
           end-if 
           .
      * <TOTEM:END>
       ANTEPRIMA-LinkTo.
      * <TOTEM:PARA. ANTEPRIMA-LinkTo>
           .
      * <TOTEM:END>
       TOOL-MODIFICA-BeforeProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       TOOL-MODIFICA-AfterProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       TOOL-MODIFICA-LinkTo.
      * <TOTEM:PARA. TOOL-MODIFICA-LinkTo>
           inquire tool-modifica, enabled in e-modifica
           if e-modifica = 1
              perform MODIFICA
           end-if 
           .
      * <TOTEM:END>
       STAMPA-LinkTo.
      * <TOTEM:PARA. STAMPA-LinkTo>
           .
      * <TOTEM:END>
       TOOL-CERCA-LinkTo.
      * <TOTEM:PARA. TOOL-CERCA-LinkTo>
           inquire tool-cerca, enabled in e-cerca.
           if e-cerca = 1
              perform CERCA
           end-if 
           .
      * <TOTEM:END>
       TOOL-ESCI-LinkTo.
      * <TOTEM:PARA. TOOL-ESCI-LinkTo>
           move 27 to key-status 
           .
      * <TOTEM:END>
       gd-catena-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. gd-catena-Ev-Msg-Finish-Entry>
           inquire gd-catena, cursor-y in riga, cursor-x in colonna.
           perform VALORE-RIGA.

           perform  CONTROLLO.

           if errori 
              set event-action to event-action-fail 
              perform VALORE-RIGA   
           else
              set environment "KEYSTROKE" to "DATA=44 44"
              set environment "KEYSTROKE" to "DATA=46 46"
           end-if.

           if bts-rec not = old-bts-rec
              set NoSalvato to true                            
           else 
              set SiSalvato to true
           end-if 
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

