      *{TOTEM}PRG-COMMENT
      * tcodpag.Cbl
      * tcodpag.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          tcodpag.
       AUTHOR.              andre.
       DATE-WRITTEN.        lunedì 19 luglio 2021 15:19:10.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:tcodpag, INIT:tcodpag, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "tcodpag.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "tcodpag.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "fonts.def".
               COPY "crtvars.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Enter-Pushed VALUE 13.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
          88 Screen-Time-Out VALUE 99.
      * Properties & User defined Working Stoarge
       78 titolo VALUE IS "Geslux - Tabella Codici di Pagamento". 
       77 FlagTutteP       PIC  9.
           88 TutteP VALUE IS 1    WHEN SET TO FALSE  0. 
       77 FlagTutteC       PIC  9.
           88 TutteC VALUE IS 1    WHEN SET TO FALSE  0. 
       77 FlagTrovataC     PIC  9.
           88 TrovataC VALUE IS 1    WHEN SET TO FALSE  0. 
       77 Form1-Tb-1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 CountChar        PIC  9(3).
       77 como-id          PIC  9(5).
       77 data-oggi        PIC  9(8).
       77 toolbar-bmp      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 E-ESCI           PIC  9
                  VALUE IS 1.
       77 E-NUOVO          PIC  9
                  VALUE IS 1.
       77 E-CANCELLA       PIC  9
                  VALUE IS 1.
       77 E-SALVA          PIC  9
                  VALUE IS 1.
       77 E-ANTEPRIMA      PIC  9
                  VALUE IS 0.
       77 E-MODIFICA       PIC  9
                  VALUE IS 1.
       77 E-STAMPA         PIC  9
                  VALUE IS 0.
       77 E-CERCA          PIC  9
                  VALUE IS 0.
       77 E-SELEZIONA      PIC  9
                  VALUE IS 1.
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 Default-Font
                  USAGE IS HANDLE OF FONT DEFAULT-FONT.
       77 Screen1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 Form1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 form1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 NumRate          PIC  99.
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 0,00.
       77 tot-perce        PIC  9(3)v9(3).
       77 como-perce       PIC  9(3)v9(3).
       77 como-x           PIC  x.
       01 save-key.
           10 save-codice1     PIC  X(02).
           10 save-codice2     PIC  X(20).
       77 Verdana12-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 status-tcodpag   PIC  X(2).
           88 Valid-status-tcodpag VALUE IS "00" THRU "09". 
      *$XFD  WHEN TBLPA-CODICE1="PA" TABLENAME=TBLPA
       01 OLD-RECORD-TBLPA.
           05 OLD-TBLPA-CODICE.
               10 OLD-TBLPA-CODICE1            PIC  X(02).
               10 OLD-TBLPA-CODICE2            PIC  X(20).
           05 OLD-RESTO-RECORD-TBLPA.
               10 OLD-TBLPA-DESCRIZIONE1       PIC  X(30).
               10 OLD-TBLPA-DESCRIZIONE2       PIC  X(30).
               10 OLD-TBLPA-CODICE-SC          PIC  X(03).
               10 OLD-TBLPA-CODICE-SC-MAS      PIC  X(08).
               10 OLD-TBLPA-PAGAMENTO-IMMEDIATO.
                   15 OLD-TBLPA-IMMEDIATO          PIC  X(01).
                       88 OLD-TBLPA-IMMEDIATO-88 VALUE IS "S" " ". 
                   15 OLD-TBLPA-CODICE-MAS         PIC  X(08).
                   15 OLD-TBLPA-CODICE-CO          PIC  X(03).
               10 OLD-TBLPA-NUMERO-SCADENZE    PIC  9(02).
                   88 OLD-TBLPA-NUMERO-SCADENZE-88 VALUE IS 1 THRU 36. 
               10 OLD-TBLPA-MESI-ESCLUSI.
                   15 OLD-TBLPA-MESE1  PIC  9(02).
                       88 OLD-TBLPA-MESE1-88 VALUE IS 0 THRU 12. 
                   15 OLD-TBLPA-GIORNO1            PIC  9(02).
                   15 OLD-TBLPA-MESE2  PIC  9(02).
                       88 OLD-TBLPA-MESE2-88 VALUE IS 0 THRU 12. 
                   15 OLD-TBLPA-GIORNO2            PIC  9(02).
               10 OLD-TBLPA-IVA    PIC  X(01).
                   88 OLD-TBLPA-IVA-88 VALUE IS "A" " ". 
                   88 OLD-TBLPA-IVA-88-o VALUE IS " ". 
                   88 OLD-TBLPA-IVA-88-a VALUE IS "A". 
                   88 OLD-TBLPA-iva-88-g VALUE IS "A" " ". 
      *
      *Anticipato - Posticipato - prima rata solo di IVA
      *
               10 OLD-TBLPA-TABELLA-X.
                   15 OLD-TBLPA-TABELLA
                              OCCURS 36 TIMES.
                       20 OLD-TBLPA-CODICE-TR          PIC  X(01).
                       20 OLD-TBLPA-INIZIO-CONTEGGIO   PIC  9(02).
                       20 OLD-TBLPA-TIPO-IMPORTI       PIC  X(01).
                           88 OLD-TBLPA-TIPO-IMPORTI-88 VALUE IS "P" "A"
            "C". 
                           88 OLD-TBLPA-TIPO-IMPORTI-88-P VALUE IS "P". 
                           88 OLD-TBLPA-TIPO-IMPORTI-88-A VALUE IS "A". 
                           88 OLD-TBLPA-TIPO-IMPORTI-88-C VALUE IS "C". 
                       20 OLD-TBLPA-TIPO-SCADENZE      PIC  X(01).
                           88 OLD-TBLPA-TIPO-SCADENZE-88-i VALUE IS "I"
           . 
                           88 OLD-TBLPA-TIPO-SCADENZE-88-d VALUE IS "D"
           . 
                           88 OLD-TBLPA-TIPO-SCADENZE-88 VALUE IS "I" "D
      -    "". 
                       20 OLD-TBLPA-IMPORTO            PIC  S9(15)V9(03)
                                  SIGN IS TRAILING SEPARATE CHARACTER.
                       20 OLD-TBLPA-SCADENZA           PIC  9(08).
               10 OLD-TBLPA-CODICE-ART         PIC  X(15).
               10 OLD-TBLPA-SLITTAMENTO        PIC  X(01).
                   88 OLD-TBLPA-SLITTAMENTO-88 VALUE IS " " "S". 
               10 OLD-TBLPA-CONTRASSEGNO-79    PIC  X(01).
                   88 OLD-TBLPA-CONTRASSEGNO-79-88 VALUE IS " " "S". 
               10 OLD-TBLPA-DETRAZIONE-X.
                   15 OLD-TBLPA-detrazione
                              OCCURS 36 TIMES.
                       20 OLD-TBLPA-DETRAZIONE-det     PIC  X(01).
                           88 OLD-TBLPA-DETRAZIONE-det-88 VALUE IS "S" 
           " ". 
                           88 OLD-TBLPA-DETRAZIONE-det-yes VALUE IS "S"
           . 
                           88 OLD-TBLPA-DETRAZIONE-det-no VALUE IS " ". 
      *(( XFD NAME = TBLPA-ESCL-GG1 ))
               10 OLD-TBLPA-ESCLUSO-DAL-GIORNO1            PIC  9(02).
      *(( XFD NAME = TBLPA-ESCL-GG2 ))
               10 OLD-TBLPA-ESCLUSO-DAL-GIORNO2            PIC  9(02).
               10 OLD-TBLPA-FILLER PIC  X(15).
               10 OLD-TBLPA-FILLER-RIS         PIC  X(40).
       01 rec-grid.
           05 col-rata         PIC  99.
           05 col-tipo-pag     PIC  x.
           05 col-inizio       PIC  9(2)
                      BLANK WHEN ZERO.
           05 col-tipo         PIC  x.
           05 col-importo      PIC  s9(15)v9(3).
           05 col-tipo-scad    PIC  x.
           05 col-scad         PIC  x(10).
           05 col-det          PIC  x.
       77 col-importo-edit PIC  ----.---.---.---.--9,999.

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
      * DATA CONTROL BUFFER
       01 Form1-BUF.
      * Data.Entry-Field
              05 ef-codice-BUF PIC X(20).
              05 ef-codice-VALUEBUF PIC X(20).
      * Data.Entry-Field
              05 ef-descrizione1-BUF PIC X(30).
              05 ef-descrizione1-VALUEBUF PIC X(30).
      * Data.Entry-Field
              05 ef-descrizione2-BUF PIC X(30).

       77 TMP-Form1-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Form1-KEY2-ORDER  PIC X VALUE "A".
       77 TMP-Form1-tcodpag-RESTOREBUF  PIC X(1380).
       77 TMP-Form1-KEYIS  PIC 9(3) VALUE 1.
       77 Form1-MULKEY-TMPBUF   PIC X(1380).
       77 Form1-KEYISTMP2   PIC X(52).
      * Form1 : PKEY & AKEY'S TEMP BUFFER
       77 Form1-PKEYTMP   PIC X(22).
       77 TMP-DataSet1-tcodpag-BUF     PIC X(1380).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-tcodpag-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tcodpag-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-tcodpag-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-tcodpag-KEY1-Asc  VALUE "A".
          88 DataSet1-tcodpag-KEY1-Desc VALUE "D".
       77 DataSet1-tcodpag-KEY2-ORDER  PIC X VALUE "A".
          88 DataSet1-tcodpag-KEY2-Asc  VALUE "A".
          88 DataSet1-tcodpag-KEY2-Desc VALUE "D".

       77 tcodpag-TBL-CODICE-01-SPLITBUF  PIC X(53).
      * FOR SPLIT KEY BUFFER
       77 DataSet1-tcodpag-SPLIT-BUF2   PIC X(53).


      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
       78  78-ID-ef-codice VALUE 5001.
       78  78-ID-ef-descrizione1 VALUE 5002.
       78  78-ID-ef-descrizione2 VALUE 5003.
       78  78-ID-form1-Gd-1 VALUE 5004.
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE
           COPY  "COMMON-LINKAGE.DEF".

      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           AFTER PROCEDURE Form1-AfterProcedure,
           BEFORE PROCEDURE Form1-BeforeProcedure,
           .

      * ENTRY FIELD
       05
           ef-codice, 
           Entry-Field, 
           COL 17,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 7,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED mod-k,
           ID IS 78-ID-ef-codice,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 3,
           VALUE ef-codice-BUF,
           .

      * ENTRY FIELD
       05
           ef-descrizione1, 
           Entry-Field, 
           COL 17,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 73,00 ,
           AUTO,
           BOXED,
           COLOR IS 513,
           ENABLED MOD,
           ID IS 78-ID-ef-descrizione1,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 30,
           VALUE ef-descrizione1-BUF,
           .

      * ENTRY FIELD
       05
           ef-descrizione2, 
           Entry-Field, 
           COL 17,00, 
           LINE 7,00,
           LINES 1,33 ,
           SIZE 73,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED MOD,
           ID IS 78-ID-ef-descrizione2,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 30,
           VALUE ef-descrizione2-BUF,
           .

      * LABEL
       05
           Screen1-La-1, 
           Label, 
           COL 3,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,00 ,
           ID IS 100,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Codice",
           .

      * LABEL
       05
           Screen1-Custom1-1, 
           Label, 
           COL 64,90, 
           LINE 1,33,
           LINES 0,67 ,
           SIZE 4,00 ,
           ID IS 18,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * LABEL
       05
           Screen1-blockpgm-2, 
           Label, 
           COL 66,50, 
           LINE 2,56,
           LINES 1,00 ,
           SIZE 2,40 ,
           ID IS 21,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "BlockPgm",
           VISIBLE v-custom,
           .

      * BAR
       05
           Screen1-Br-1, 
           Bar,
           COL 1,00, 
           LINE 4,00,
           SIZE 90,30 ,
           ID IS 22,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           COLORS (8, 8),
           SHADING (-1, 1),
           WIDTH 2,
           .

      * LABEL
       05
           Screen1-La-2, 
           Label, 
           COL 3,00, 
           LINE 5,00,
           LINES 1,31 ,
           SIZE 12,00 ,
           ID IS 33,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Descrizione I",
           .

      * LABEL
       05
           Screen1-La-2a, 
           Label, 
           COL 3,00, 
           LINE 7,00,
           LINES 1,33 ,
           SIZE 12,00 ,
           ID IS 4,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Descrizione II",
           .

      * GRID
       05
           form1-Gd-1, 
           Grid, 
           COL 2,10, 
           LINE 9,00,
           LINES 23,56 ,
           SIZE 88,10 ,
           3-D,
           CENTERED-HEADINGS,
           DATA-COLUMNS (1, 3, 4, 6, 7, 31, 32, 42),
           ALIGNMENT ("C", "C", "C", "C", "R", "C", "C", "C"),
           SEPARATION (5, 5, 5, 5, 5, 5, 5, 5),
           DATA-TYPES ("X", "U(1)", "99", "U(1)", "9(20)", "U(1)", "D(10
      -    ")", "U(1)"),
           NUM-COL-HEADINGS 2,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 144,
           HEADING-DIVIDER-COLOR 1,
           ID IS 78-ID-form1-Gd-1,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           NUM-ROWS 38,
           ROW-HEADINGS,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 86,
           VPADDING 50,
           VSCROLL,
           EVENT PROCEDURE Screen1-Gd-1-Event-Proc,
           .

      * TOOLBAR
       01
           Form1-Tb-1,
           .    

      * PUSH BUTTON
       05
           TOOL-ESCI, 
           Push-Button, 
           COL 1,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           ENABLED E-ESCI,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 72,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "Esci (Esc)",
           .

      * PUSH BUTTON
       05
           TOOL-NUOVO, 
           Push-Button, 
           COL 6,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-NUOVO,
           EXCEPTION-VALUE 2,
           FLAT,
           ID IS 73,
           SELF-ACT,
           TITLE "Nuovo (F2)",
           BITMAP-NUMBER BitmapNumNew
           .

      * PUSH BUTTON
       05
           TOOL-CANCELLA, 
           Push-Button, 
           COL 16,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-CANCELLA,
           EXCEPTION-VALUE 4,
           FLAT,
           ID IS 74,
           SELF-ACT,
           TITLE "Cancella (F4)",
           BITMAP-NUMBER BitmapNumDelete
           .

      * PUSH BUTTON
       05
           TOOL-SALVA, 
           Push-Button, 
           COL 11,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-SALVA,
           EXCEPTION-VALUE 3,
           FLAT,
           ID IS 75,
           SELF-ACT,
           TITLE "Salva (F3)",
           BITMAP-NUMBER BitmapNumSave
           .

      * PUSH BUTTON
       05
           TOOL-ANTEPRIMA, 
           Push-Button, 
           COL 26,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-ANTEPRIMA,
           EXCEPTION-VALUE 6,
           FLAT,
           ID IS 76,
           SELF-ACT,
           TITLE "Anteprima (F6)",
           BITMAP-NUMBER BitmapNumPreview
           .

      * CHECK BOX
       05
           TOOL-MODIFICA, 
           Check-Box, 
           COL 21,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 5,
           FRAMED,
           SQUARE,
           ENABLED E-MODIFICA,
           EXCEPTION-VALUE 150
           FLAT,
           ID IS 77,
           SELF-ACT,
           TITLE "Modifica (F5)",
           VALUE MOD,
           BITMAP-NUMBER BitmapNumEdit
           AFTER PROCEDURE TOOL-MODIFICA-AfterProcedure,
           BEFORE PROCEDURE TOOL-MODIFICA-BeforeProcedure, 
           .
      * PUSH BUTTON
       05
           TOOL-STAMPA, 
           Push-Button, 
           COL 31,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-STAMPA,
           EXCEPTION-VALUE 7,
           FLAT,
           ID IS 110,
           SELF-ACT,
           TITLE "Stampa (F7)",
           BITMAP-NUMBER BitmapNumPrint
           .

      * PUSH BUTTON
       05
           TOOL-CERCA, 
           Push-Button, 
           COL 36,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           FRAMED,
           SQUARE,
           ENABLED E-CERCA,
           EXCEPTION-VALUE 8,
           FLAT,
           ID IS 111,
           SELF-ACT,
           TITLE "Cerca (F8)",
           BITMAP-NUMBER BitmapNumZoom
           .

      * PUSH BUTTON
       05
           TOOL-SELEZIONA, 
           Push-Button, 
           COL 41,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 9,
           FRAMED,
           SQUARE,
           ENABLED E-SELEZIONA,
           EXCEPTION-VALUE 9,
           FLAT,
           ID IS 112,
           SELF-ACT,
           TITLE "Seleziona (F9)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1a, 
           Push-Button, 
           COL 46,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 10,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 1002,
           FLAT,
           ID IS 113,
           SELF-ACT,
           TITLE "&Primo",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1b, 
           Push-Button, 
           COL 51,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 11,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 67,
           FLAT,
           ID IS 114,
           SELF-ACT,
           TITLE "Precedente (PgDn)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1c, 
           Push-Button, 
           COL 56,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 12,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 68,
           FLAT,
           ID IS 115,
           SELF-ACT,
           TITLE "Successivo (PgUp)",
           .

      * PUSH BUTTON
       05
           Form1-Pb-1d, 
           Push-Button, 
           COL 61,00, 
           LINE 1,15,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 13,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 1006,
           FLAT,
           ID IS 116,
           SELF-ACT,
           TITLE "&Ultimo",
           .

      * CHECK BOX
       05
           TOOL-ORD, 
           Check-Box, 
           COL 66,00, 
           LINE 1,23,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 14,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1001
           FLAT,
           ID IS 122,
           SELF-ACT,
           TITLE "Ordinamento Alfabetico (F10)",
           VALUE OrderBy,
           AFTER PROCEDURE TOOL-ORD-AfterProcedure,
           BEFORE PROCEDURE TOOL-ORD-BeforeProcedure, 
           .
      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE  DIVISION USING LK-BLOCKPGM, USER-CODI, LIVELLO-ABIL.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:tcodpag, INIT:tcodpag, BeforeDeclarative>
       TCODPAG-ERR SECTION.
           use after error procedure on tcodpag.
           set RecLocked to false.
           evaluate status-tcodpag
           when "35"
                display message "File [TCODPAG] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [TCODPAG] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[TCODPAG] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           when "99"
           when "93"
                set RecLocked to true
                set errori    to true
                move 0 to mod
                modify tool-modifica, value = mod
                display form1
                set StatusVisua to true
                perform STATUS-BAR-MSG
                move "00" to status-tcodpag
                if ReadSecca
                   read tcodpag       no lock 
                        invalid      continue
                        not invalid  perform FORM1-IUD-DISPLAY
                   end-read
                end-if
                display message box MSG-Record-gia-in-uso
                        title = tit-err
                        icon is mb-error-icon
           when "23"
                move 1 to mod-k
                move 0 to mod
                modify tool-modifica, value = mod
                set StatusVisua to true
                perform STATUS-BAR-MSG 
                if nuovo              
                   initialize resto-record-tblpa
                                       replacing numeric data by zeroes
                                            alphanumeric data by spaces
                   perform FORM1-FLD-TO-BUF
                   display form1-tb-1
                   set vecchio to true
                end-if   
                perform ABILITAZIONI
                display form1
                |RISETTO IL VALORE A "23" PERCHE DENTRO AL PAR. CLEAR-SCREEN
                |CON L'OPERAZIONE UNLOCK VIENE RISETTATO A ZERO COSICCHÈ 
                |QUANDO TORNA DENTRO AI PAR. DI SCORRIMENTO DI TOTEM SI 
                |TROVA IN UNA SITUAZIONE CORRETTA E PROSEGUE CON LA READ
                |USCENDO CON UN MESSAGGIO DI ERRORE DI TIPO "46"
                move "23" to status-tcodpag
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM ginqui-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:tcodpag, INIT:tcodpag, BeforeDestroyResource>
      * <TOTEM:END>
           DESTROY Verdana12-Occidentale
           CALL "w$bitmap" USING WBITMAP-DESTROY, toolbar-bmp
      *    After-Program
           PERFORM ginqui-Ev-After-Program
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
      *    After Init
           .
    
       INIT-FONT.
      * Verdana12-Occidentale
           INITIALIZE WFONT-DATA Verdana12-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12-Occidentale, WFONT-DATA
           .

       INIT-BMP.
      * TOOL-ESCI
           COPY RESOURCE "toolbar.bmp".
           CALL "w$bitmap" USING WBITMAP-LOAD "toolbar.bmp", 
                   GIVING toolbar-bmp.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-tcodpag
      *    After Open
           .

       OPEN-tcodpag.
      * <TOTEM:EPT. INIT:tcodpag, FD:tcodpag, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O tcodpag
           IF status-tcodpag = "35"
              OPEN OUTPUT tcodpag
                IF Valid-status-tcodpag
                   CLOSE tcodpag
                   OPEN I-O tcodpag
                END-IF
           END-IF
           IF NOT Valid-status-tcodpag
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tcodpag, FD:tcodpag, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-tcodpag
      *    After Close
           .

       CLOSE-tcodpag.
      * <TOTEM:EPT. INIT:tcodpag, FD:tcodpag, BeforeClose>
      * <TOTEM:END>
           CLOSE tcodpag
           .

       tcodpag-TBL-CODICE-01-MERGE-SPLITBUF.
           INITIALIZE tcodpag-TBL-CODICE-01-SPLITBUF
           MOVE TBLPA-CODICE1(1:2) TO 
           tcodpag-TBL-CODICE-01-SPLITBUF(1:2)
           MOVE TBLPA-DESCRIZIONE1(1:30) TO 
           tcodpag-TBL-CODICE-01-SPLITBUF(3:30)
           MOVE TBLPA-CODICE2(1:20) TO 
           tcodpag-TBL-CODICE-01-SPLITBUF(33:20)
           .

       DataSet1-tcodpag-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 MOVE Low-Value TO TBLPA-CODICE
              ELSE
                 MOVE High-Value TO TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE Low-Value TO TBLPA-CODICE1
              ELSE
                 MOVE High-Value TO TBLPA-CODICE1
              END-IF
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE Low-Value TO TBLPA-DESCRIZIONE1
              ELSE
                 MOVE High-Value TO TBLPA-DESCRIZIONE1
              END-IF
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE Low-Value TO TBLPA-CODICE2
              ELSE
                 MOVE High-Value TO TBLPA-CODICE2
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 MOVE High-Value TO TBLPA-CODICE
              ELSE
                 MOVE Low-Value TO TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE High-Value to TBLPA-CODICE1
              ELSE          
                 MOVE Low-Value to TBLPA-CODICE1
              END-IF
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE High-Value to TBLPA-DESCRIZIONE1
              ELSE          
                 MOVE Low-Value to TBLPA-DESCRIZIONE1
              END-IF
              IF DataSet1-tcodpag-KEY2-Asc
                 MOVE High-Value to TBLPA-CODICE2
              ELSE          
                 MOVE Low-Value to TBLPA-CODICE2
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-TMPBUF-TO-FLD.
           EVALUATE DataSet1-KEYIS
           WHEN 2
              MOVE DataSet1-tcodpag-SPLIT-BUF2(1:2) TO
                   TBLPA-CODICE1(1:2)
              MOVE DataSet1-tcodpag-SPLIT-BUF2(3:30) TO
                   TBLPA-DESCRIZIONE1(1:30)
              MOVE DataSet1-tcodpag-SPLIT-BUF2(33:20) TO
                   TBLPA-CODICE2(1:20)
           END-EVALUATE
           .

       DataSet1-tcodpag-FLD-TO-TMPBUF.
           EVALUATE DataSet1-KEYIS
           WHEN 2
              MOVE TBLPA-CODICE1(1:2) TO
                   DataSet1-tcodpag-SPLIT-BUF2(1:2)
              MOVE TBLPA-DESCRIZIONE1(1:30) TO
                   DataSet1-tcodpag-SPLIT-BUF2(3:30)
              MOVE TBLPA-CODICE2(1:20) TO
                   DataSet1-tcodpag-SPLIT-BUF2(33:20)
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-CHANGETO-KEY2.
           MOVE 2 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tcodpag-KEY1-ORDER
           WHEN 2
              MOVE "A" TO DataSet1-tcodpag-KEY2-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tcodpag-KEY1-ORDER
           WHEN 2
              MOVE "D" TO DataSet1-tcodpag-KEY2-ORDER
           END-EVALUATE
           .

      * tcodpag
       DataSet1-tcodpag-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 START tcodpag KEY >= TBLPA-CODICE
              ELSE
                 START tcodpag KEY <= TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 START tcodpag KEY >= TBL-CODICE-01
              ELSE
                 START tcodpag KEY <= TBL-CODICE-01
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 START tcodpag KEY <= TBLPA-CODICE
              ELSE
                 START tcodpag KEY >= TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 START tcodpag KEY <= TBL-CODICE-01
              ELSE
                 START tcodpag KEY >= TBL-CODICE-01
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 START tcodpag KEY > TBLPA-CODICE
              ELSE
                 START tcodpag KEY < TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 START tcodpag KEY > TBL-CODICE-01
              ELSE
                 START tcodpag KEY < TBL-CODICE-01
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 START tcodpag KEY < TBLPA-CODICE
              ELSE
                 START tcodpag KEY > TBLPA-CODICE
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 START tcodpag KEY < TBL-CODICE-01
              ELSE
                 START tcodpag KEY > TBL-CODICE-01
              END-IF
           END-EVALUATE
           .

       DataSet1-tcodpag-START-EQUAL.
           EVALUATE DataSet1-KEYIS
           WHEN 2
              START tcodpag KEY = TBL-CODICE-01
           END-EVALUATE
           .

       DataSet1-tcodpag-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-LOCK
                 READ tcodpag WITH LOCK 
                 KEY TBLPA-CODICE
              ELSE
                 READ tcodpag WITH NO LOCK 
                 KEY TBLPA-CODICE
              END-IF
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              IF status-tcodpag(1:1) = "0" AND 
                        NOT (TBLPA-CODICE1 = "PA")
                   MOVE 23 TO status-tcodpag
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-LOCK
                 READ tcodpag WITH LOCK 
                 KEY TBL-CODICE-01
              ELSE
                 READ tcodpag WITH NO LOCK 
                 KEY TBL-CODICE-01
              END-IF
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              IF status-tcodpag(1:1) = "0" AND 
                        NOT (TBLPA-CODICE1 = "PA")
                   MOVE 23 TO status-tcodpag
              END-IF
           END-EVALUATE
           PERFORM tcodpag-TBL-CODICE-01-MERGE-SPLITBUF
           MOVE status-tcodpag TO TOTEM-ERR-STAT 
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag NEXT WITH LOCK
                 ELSE
                    READ tcodpag NEXT WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-NEXT
              ELSE
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag PREVIOUS WITH LOCK
                 ELSE
                    READ tcodpag PREVIOUS WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-PREV
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag NEXT WITH LOCK
                 ELSE
                    READ tcodpag NEXT WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-NEXT
              ELSE
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag PREVIOUS WITH LOCK
                 ELSE
                    READ tcodpag PREVIOUS WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-PREV
              END-IF
           END-EVALUATE
           PERFORM tcodpag-TBL-CODICE-01-MERGE-SPLITBUF
           MOVE status-tcodpag TO TOTEM-ERR-STAT
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tcodpag-KEY1-Asc
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag PREVIOUS WITH LOCK
                 ELSE
                    READ tcodpag PREVIOUS WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-PREV
              ELSE
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag NEXT WITH LOCK
                 ELSE
                    READ tcodpag NEXT WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-NEXT
              END-IF
           WHEN 2
              IF DataSet1-tcodpag-KEY2-Asc
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag PREVIOUS WITH LOCK
                 ELSE
                    READ tcodpag PREVIOUS WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-PREV
              ELSE
                 IF DataSet1-tcodpag-LOCK
                    READ tcodpag NEXT WITH LOCK
                 ELSE
                    READ tcodpag NEXT WITH NO LOCK
                 END-IF
                 PERFORM DataSet1-tcodpag-CHECK-VALUES-NEXT
              END-IF
           END-EVALUATE
           PERFORM tcodpag-TBL-CODICE-01-MERGE-SPLITBUF
           MOVE status-tcodpag TO TOTEM-ERR-STAT
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeWrite>
      * <TOTEM:END>
           WRITE record-tblpa OF tcodpag.
           MOVE status-tcodpag TO TOTEM-ERR-STAT
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeRewrite>
      * <TOTEM:END>
           REWRITE record-tblpa OF tcodpag.
           MOVE status-tcodpag TO TOTEM-ERR-STAT
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeDelete>
      * <TOTEM:END>
           DELETE tcodpag.
           MOVE status-tcodpag TO TOTEM-ERR-STAT
           MOVE "tcodpag" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tcodpag-CHECK-VALUES-NEXT.
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              PERFORM UNTIL status-tcodpag(1:1) NOT = "0" OR
                      (status-tcodpag(1:1) = "0" AND (TBLPA-CODICE1 = "P
      -    "A"))
                 IF DataSet1-tcodpag-KEY1-Asc
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag NEXT WITH LOCK
                    ELSE
                       READ tcodpag NEXT WITH NO LOCK
                    END-IF
                 ELSE
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag PREVIOUS WITH LOCK
                    ELSE
                       READ tcodpag PREVIOUS WITH NO LOCK
                    END-IF
                 END-IF
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              END-PERFORM
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              PERFORM UNTIL status-tcodpag(1:1) NOT = "0" OR
                      (status-tcodpag(1:1) = "0" AND (TBLPA-CODICE1 = "P
      -    "A"))
                 IF DataSet1-tcodpag-KEY2-Asc
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag NEXT WITH LOCK
                    ELSE
                       READ tcodpag NEXT WITH NO LOCK
                    END-IF
                 ELSE
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag PREVIOUS WITH LOCK
                    ELSE
                       READ tcodpag PREVIOUS WITH NO LOCK
                    END-IF
                 END-IF
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              END-PERFORM
           .
           
       DataSet1-tcodpag-CHECK-VALUES-PREV.
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              PERFORM UNTIL status-tcodpag(1:1) NOT = "0" OR
                      (status-tcodpag(1:1) = "0" AND (TBLPA-CODICE1 = "P
      -    "A"))
                 IF DataSet1-tcodpag-KEY1-Asc
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag PREVIOUS WITH LOCK
                    ELSE
                       READ tcodpag PREVIOUS WITH NO LOCK
                    END-IF
                 ELSE
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag NEXT WITH LOCK
                    ELSE
                       READ tcodpag NEXT WITH NO LOCK
                    END-IF
                 END-IF
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              END-PERFORM
      * Check Condition
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              PERFORM UNTIL status-tcodpag(1:1) NOT = "0" OR
                      (status-tcodpag(1:1) = "0" AND (TBLPA-CODICE1 = "P
      -    "A"))
                 IF DataSet1-tcodpag-KEY2-Asc
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag PREVIOUS WITH LOCK
                    ELSE
                       READ tcodpag PREVIOUS WITH NO LOCK
                    END-IF
                 ELSE
                    IF DataSet1-tcodpag-LOCK
                       READ tcodpag NEXT WITH LOCK
                    ELSE
                       READ tcodpag NEXT WITH NO LOCK
                    END-IF
                 END-IF
      * <TOTEM:EPT. FD:DataSet1, FD:tcodpag, BeforeCheckCondition>
      * <TOTEM:END>
              END-PERFORM
           .
           
       DataSet1-INIT-RECORD.
           INITIALIZE record-tblpa OF tcodpag
           .


      * GRID
       form1-Gd-1-Content.
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 1,
                CELL-DATA = "Rata",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 2, Y = 1,
                CELL-DATA = "Tipo",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 3, Y = 1,
                CELL-DATA = "Inizio",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 4, Y = 1,
                CELL-DATA = "Tipo",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 5, Y = 1,
                CELL-DATA = "Importo / Percentuale",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 6, Y = 1,
                CELL-DATA = "Tipo",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 7, Y = 1,
                CELL-DATA = "Scadenza",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 8, Y = 1,
                CELL-DATA = "Detrazione",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 2, Y = 2,
                CELL-DATA = "Pagamento",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 3, Y = 2,
                CELL-DATA = "Conteggio",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 5, Y = 2,
                CELL-DATA = "Scadenza",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 6, Y = 2,
                CELL-DATA = "Scadenza",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 3,
                CELL-DATA = "1",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 4,
                CELL-DATA = "2",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 5,
                CELL-DATA = "3",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 6,
                CELL-DATA = "4",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 7,
                CELL-DATA = "5",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 8,
                CELL-DATA = "6",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 9,
                CELL-DATA = "7",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 10,
                CELL-DATA = "8",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 11,
                CELL-DATA = "9",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 12,
                CELL-DATA = "10",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 13,
                CELL-DATA = "11",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 14,
                CELL-DATA = "12",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 15,
                CELL-DATA = "13",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 16,
                CELL-DATA = "14",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 17,
                CELL-DATA = "15",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 18,
                CELL-DATA = "16",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 19,
                CELL-DATA = "17",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 20,
                CELL-DATA = "18",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 21,
                CELL-DATA = "19",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 22,
                CELL-DATA = "20",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 23,
                CELL-DATA = "21",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 24,
                CELL-DATA = "22",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 25,
                CELL-DATA = "23",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 26,
                CELL-DATA = "24",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 27,
                CELL-DATA = "25",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 28,
                CELL-DATA = "26",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 29,
                CELL-DATA = "27",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 30,
                CELL-DATA = "28",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 31,
                CELL-DATA = "29",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 32,
                CELL-DATA = "30",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 33,
                CELL-DATA = "31",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 34,
                CELL-DATA = "32",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 35,
                CELL-DATA = "33",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 36,
                CELL-DATA = "34",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 37,
                CELL-DATA = "35",
      * CELLS' SETTING
              MODIFY form1-Gd-1, X = 1, Y = 38,
                CELL-DATA = "36",
           .

      * FD's Initialize Paragraph
       DataSet1-tcodpag-INITREC.
           INITIALIZE record-tblpa OF tcodpag
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 1 ALSO 0
                  PERFORM Form1-Buf-To-Fld
           END-EVALUATE
           .

       Form1-DISPLAY-STATUS-MSG.
            MODIFY Form1-St-1-Handle PANEL-INDEX = 1
                PANEL-TEXT = TOTEM-HINT-TEXT
           .

       Form1-CLEAR-STATUS-MSG.
           MOVE SPACES TO TOTEM-MSG-1, TOTEM-MSG-2, TOTEM-MSG-3, 
           TOTEM-MSG-TEXT
           PERFORM Form1-DISPLAY-STATUS-MSG
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           DISPLAY Form1-Tb-1
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 33,17,
              SIZE 90,30,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              CONTROL FONT Verdana12-Occidentale,
              LABEL-OFFSET 23,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              AUTO-MINIMIZE,
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS form1-Handle,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
           DISPLAY TOOL-BAR 
              LINES 2,67,   
              HANDLE IN Form1-Tb-1-Handle
           DISPLAY Form1-Tb-1 UPON Form1-Tb-1-Handle

      * Status-bar
           DISPLAY STATUS-BAR
              FONT IS Small-Font,
              GRIP,
              PANEL-WIDTHS (55, 20, 999),
              PANEL-STYLE  (1, 1, 1),
              PANEL-TEXT   (SPACE, SPACE, SPACE),
              HANDLE IS Form1-St-1-Handle
           DISPLAY Form1 UPON form1-Handle
      * DISPLAY-COLUMNS settings
              MODIFY form1-Gd-1, DISPLAY-COLUMNS (1, 6, 16, 26, 36, 56, 
           66, 77)
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
           perform INIT.
           perform ABILITA-TOOLBAR.
           perform ABILITAZIONI.
           perform STATUS-BAR-MSG.           
      *     perform PRIMO.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY form1-Handle
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
           evaluate key-status
           when 5 |MODIFICA
                inquire tool-modifica, enabled in e-modifica
                if e-modifica = 1
                   if mod = zero 
                      move 1    to mod
                   else          
                      move zero to mod
                   end-if
                   modify tool-modifica, value = mod
                   perform MODIFICA
                end-if
           when 10 |ORDINAMENTO ALFABETICO 
                if OrderBy = zero 
                   move 1       to OrderBy
                else              
                   move zero    to OrderBy
                end-if
                modify TOOL-ORD, value OrderBy
                perform ORDINAMENTO
           end-evaluate.

           .
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = 2
                 PERFORM NUOVO-LinkTo
              WHEN Key-Status = 4
                 PERFORM CANCELLA-LinkTo
              WHEN Key-Status = 3
                 PERFORM TOOL-SALVA-LinkTo
              WHEN Key-Status = 6
                 PERFORM ANTEPRIMA-LinkTo
              WHEN Key-Status = 150
                 PERFORM TOOL-MODIFICA-LinkTo
              WHEN Key-Status = 7
                 PERFORM STAMPA-LinkTo
              WHEN Key-Status = 8
                 PERFORM TOOL-CERCA-LinkTo
              WHEN Key-Status = 9
                 PERFORM TOOL-SELEZIONA-LinkTo
              WHEN Key-Status = 1002
                 PERFORM TOOL-PRIMO
              WHEN Key-Status = 67
                 PERFORM TOOL-PRECEDENTE
              WHEN Key-Status = 68
                 PERFORM TOOL-SUCCESSIVO
              WHEN Key-Status = 1006
                 PERFORM TOOL-ULTIMO
              WHEN Key-Status = 1001
                 PERFORM TOOL-ORD-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1-Tb-1
           DISPLAY Form1 UPON form1-Handle
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
           perform SALV-MOD.

           if errori
              move 26 to key-status
              exit paragraph
           end-if.

           .
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM form1-Gd-1-Content
           .

       Form1-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-CHANGETO-KEY2.
           MOVE 2 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tcodpag-KEY1-ORDER
           WHEN 2
              MOVE "A" TO DataSet1-tcodpag-KEY2-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tcodpag-KEY1-ORDER
           WHEN 2
              MOVE "D" TO DataSet1-tcodpag-KEY2-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Update-Key.
           MOVE record-tblpa OF tcodpag TO
                     Form1-MULKEY-TMPBUF
           PERFORM Form1-CLEAR
           PERFORM Form1-INIT-DATA
           MOVE Form1-MULKEY-TMPBUF TO
                     record-tblpa OF tcodpag
           PERFORM DataSet1-tcodpag-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
           .

       Form1-DUPLICATE-PREV.
           EVALUATE DataSet1-KEYIS
           WHEN 2
              PERFORM tcodpag-TBL-CODICE-01-MERGE-SPLITBUF
              IF tcodpag-TBL-CODICE-01-SPLITBUF = Form1-KEYISTMP2
                 MOVE DataSet1-tcodpag-KEY2-ORDER TO 
           TMP-Form1-KEY2-ORDER
                 MOVE "A" TO DataSet1-tcodpag-KEY2-ORDER
                 PERFORM DataSet1-tcodpag-START-EQUAL
                 IF Valid-status-tcodpag
                    PERFORM DataSet1-tcodpag-Read-Next
                    PERFORM UNTIL NOT Valid-status-tcodpag OR 
                         TBLPA-CODICE = Form1-PKEYTMP OR
                         tcodpag-TBL-CODICE-01-SPLITBUF NOT = 
           Form1-KEYISTMP2
                       PERFORM DataSet1-tcodpag-Read-Next
                    END-PERFORM
                 END-IF
                 MOVE TMP-Form1-KEY2-ORDER TO 
           DataSet1-tcodpag-KEY2-ORDER
              ELSE
                 PERFORM DataSet1-tcodpag-START-LESS
              END-IF
           WHEN OTHER
              PERFORM DataSet1-tcodpag-START-LESS
           END-EVALUATE
           .

       Form1-DUPLICATE-NEXT.
           EVALUATE DataSet1-KEYIS
           WHEN 2
              PERFORM tcodpag-TBL-CODICE-01-MERGE-SPLITBUF
              IF tcodpag-TBL-CODICE-01-SPLITBUF = Form1-KEYISTMP2
                 MOVE DataSet1-tcodpag-KEY2-ORDER TO 
           TMP-Form1-KEY2-ORDER
                 MOVE "A" TO DataSet1-tcodpag-KEY2-ORDER
                 PERFORM DataSet1-tcodpag-START
                 IF Valid-status-tcodpag
                    PERFORM DataSet1-tcodpag-Read-Next
                    PERFORM UNTIL NOT Valid-status-tcodpag OR 
                         TBLPA-CODICE = Form1-PKEYTMP OR
                         tcodpag-TBL-CODICE-01-SPLITBUF NOT = 
           Form1-KEYISTMP2
                       PERFORM DataSet1-tcodpag-Read-Next
                    END-PERFORM
                 END-IF
                 MOVE TMP-Form1-KEY2-ORDER TO 
           DataSet1-tcodpag-KEY2-ORDER
              ELSE
                 PERFORM DataSet1-tcodpag-START-GREATER
              END-IF
           WHEN OTHER
              PERFORM DataSet1-tcodpag-START-GREATER
           END-EVALUATE
           .

       Form1-DUPLICATE-MOVEKEY.
           MOVE TBLPA-CODICE TO Form1-PKEYTMP
           EVALUATE DataSet1-KEYIS
           WHEN 2
              MOVE tcodpag-TBL-CODICE-01-SPLITBUF TO
                   Form1-KEYISTMP2
           END-EVALUATE
           .

       Form1-First.
           PERFORM Form1-DUMMY-FIRST
           PERFORM DataSet1-tcodpag-INITSTART
           PERFORM DataSet1-tcodpag-START
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-tcodpag-Read-Next
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFirst>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Previous.
              PERFORM Form1-Buf-To-Fld
              PERFORM Form1-DUPLICATE-PREV
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-tcodpag-Read-Prev
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterPrevious>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-PREVIOUS
           PERFORM Form1-IUD-Display
           .

       Form1-Next.
              PERFORM Form1-Buf-To-Fld
              PERFORM Form1-DUPLICATE-NEXT
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-tcodpag-Read-Next
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterNext>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-NEXT
           PERFORM Form1-IUD-Display
           .
      
       Form1-Last.
           PERFORM Form1-DUMMY-LAST
           PERFORM DataSet1-tcodpag-INITEND
           PERFORM DataSet1-tcodpag-START-NOTGREATER
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-tcodpag-Read-Prev
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterLast>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Curr.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tcodpag-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCurrent>
      * <TOTEM:END>
           .

       Form1-IUD-Display.
           IF Valid-status-tcodpag
              PERFORM Form1-ALLGRID-RESET
              PERFORM Form1-Fld-To-Buf
              PERFORM Form1-NAVI-FOR-MASTERGRID
              PERFORM Form1-DISPLAY
           ELSE
              IF Form1-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Form1-Extended-File-Status
              END-IF
           END-IF
           .

       Form1-Add.
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-ADD
           PERFORM DataSet1-tcodpag-INITREC
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tcodpag-Rec-Write
           IF Valid-status-tcodpag
              PERFORM Form1-RESUMMARY-INS
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAdd>
      * <TOTEM:END>
           .
     
       Form1-Update.
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tcodpag-START              
           IF NOT Valid-status-tcodpag
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-tcodpag-Read
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-UPDATE
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tcodpag-Rec-Rewrite
           IF Valid-status-tcodpag
              PERFORM Form1-RESUMMARY-DEL
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterUpdate>
      * <TOTEM:END>
           .

       Form1-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDelete>
      * <TOTEM:END>
           PERFORM Form1-DUMMY-DELETE
      * delete
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tcodpag-Rec-Delete
           IF Valid-status-tcodpag
              PERFORM Form1-CLEAR
              PERFORM Form1-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to status-tcodpag
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDelete>
      * <TOTEM:END>
           PERFORM Form1-ERR-CHECKING
           .

       Form1-NAVI-FOR-MASTERGRID.
           .

       Form1-ERR-CHECKING.
           IF Valid-status-tcodpag
              PERFORM Form1-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Form1-Extended-File-Status
           END-IF
           .

       Form1-RESUMMARY-INS.
           .

       Form1-RESUMMARY-DEL.
           .


       Form1-DUMMY-FIRST.
           .

       Form1-DUMMY-PREVIOUS.
           .

       Form1-DUMMY-NEXT.
           .

       Form1-DUMMY-LAST.
           .

       Form1-DUMMY-CURR.
           .

       Form1-DUMMY-ADD.
           .

       Form1-DUMMY-UPDATE.
           .

       Form1-DUMMY-UPDATE-INIT.
           .

       Form1-DUMMY-DELETE.
           .

       Form1-DUMMY-DELETE-INIT.
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
           INITIALIZE Form1-BUF
      * FORM : Form1
           PERFORM DataSet1-INIT-RECORD
           MOVE ALL X'9' TO Form1-KEYISTMP2
           MOVE ALL X'9' TO Form1-PKEYTMP
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
      * ef-codice's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-codice-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5001 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-descrizione1's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-descrizione1-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5002 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-descrizione2's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-descrizione2-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5003 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
           .

       ef-codice-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-codice, BeforeValidation>
      * <TOTEM:END>
           .

       ef-codice-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-codice, AfterValidation>
      * <TOTEM:END>
           .

      * ef-codice's Validation
       ef-codice-VALIDATION.
           PERFORM ef-codice-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-codice-AFTER-VALIDATION
           .

       ef-descrizione1-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-descrizione1, BeforeValidation>
      * <TOTEM:END>
           .

       ef-descrizione1-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-descrizione1, AfterValidation>
      * <TOTEM:END>
           .

      * ef-descrizione1's Validation
       ef-descrizione1-VALIDATION.
           PERFORM ef-descrizione1-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-descrizione1-AFTER-VALIDATION
           .

       ef-descrizione2-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-descrizione2, BeforeValidation>
      * <TOTEM:END>
           .

       ef-descrizione2-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-descrizione2, AfterValidation>
      * <TOTEM:END>
           .

      * ef-descrizione2's Validation
       ef-descrizione2-VALIDATION.
           PERFORM ef-descrizione2-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-descrizione2-AFTER-VALIDATION
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * DB_Entry-Field : ef-codice
           MOVE ef-codice-BUF TO tblpa-codice2
      * DB_Entry-Field : ef-descrizione1
           MOVE ef-descrizione1-BUF TO tblpa-DESCRIZIONE1
      * DB_Entry-Field : ef-descrizione2
           MOVE ef-descrizione2-BUF TO TBLpa-DESCRIZIONE2
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
           move 2 to riga.
           move 0 to idx.
           perform 36 times
              add 1 to idx
              add 1 to riga
              perform VALORE-RIGA
              perform GRID-TO-FLD
           end-perform.

           .
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
      * <TOTEM:END>
      * DB_Entry-Field : ef-codice
           MOVE tblpa-codice2 TO ef-codice-BUF
      * DB_Entry-Field : ef-descrizione1
           MOVE tblpa-DESCRIZIONE1 TO ef-descrizione1-BUF
      * DB_Entry-Field : ef-descrizione2
           MOVE TBLpa-DESCRIZIONE2 TO ef-descrizione2-BUF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
           perform ABILITAZIONI.

           perform VALORIZZA-OLD.

           perform CARICA-GRID.

           .
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.
           if tblpa-codice2 not = old-tblpa-codice2
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-codice è l'ID del campo ef-codice
              move 78-ID-ef-codice to store-id 
           end-if

           if tblpa-DESCRIZIONE1 not = old-tblpa-DESCRIZIONE1
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-descrizione1 è l'ID del campo ef-descrizione1
              move 78-ID-ef-descrizione1 to store-id 
           end-if

           if TBLpa-DESCRIZIONE2 not = old-TBLpa-DESCRIZIONE2
              and SiSalvato
              set NoSalvato to true
              |78-ID-ef-descrizione2 è l'ID del campo ef-descrizione2
              move 78-ID-ef-descrizione2 to store-id 
           end-if

           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           MOVE DataSet1-tcodpag-KEY1-ORDER TO TMP-Form1-KEY1-ORDER
           MOVE DataSet1-tcodpag-KEY2-ORDER TO TMP-Form1-KEY2-ORDER
           MOVE DataSet1-KEYIS TO TMP-Form1-KEYIS
           MOVE record-tblpa OF tcodpag TO 
              TMP-Form1-tcodpag-RESTOREBUF
           .             

       Form1-Restore-Status.
           MOVE TMP-Form1-KEY1-ORDER TO DataSet1-tcodpag-KEY1-ORDER
           MOVE TMP-Form1-KEY2-ORDER TO DataSet1-tcodpag-KEY2-ORDER
           MOVE TMP-Form1-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Form1-tcodpag-RESTOREBUF TO
              record-tblpa OF tcodpag
           PERFORM DataSet1-tcodpag-START
           IF Valid-status-tcodpag
              PERFORM DataSet1-tcodpag-Read-Next
           ELSE
              PERFORM DataSet1-tcodpag-INITREC
           END-IF
           PERFORM UNTIL NOT Valid-status-tcodpag OR
              (Valid-status-tcodpag AND
                 record-tblpa OF tcodpag = 
                   TMP-Form1-tcodpag-RESTOREBUF)
              PERFORM DataSet1-tcodpag-Read-Next
           END-PERFORM
           .


      * Paragrafo per la struttura del codice in AFTER sulla screen Form1
      ***---
       Form1-AFTER-SCREEN.

      * Generazione risettaggio keyboard "." ---> "."

      * Generazione stringa perform CONTROLLO
           evaluate control-id
           |78-ID-ef-codice è l'ID del campo ef-codice
           when 78-ID-ef-codice
                perform CONTROLLO
           |78-ID-ef-descrizione1 è l'ID del campo ef-descrizione1
           when 78-ID-ef-descrizione1
                perform CONTROLLO
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER CONTROLLO della screen
           when 99999 continue
           when other continue
           end-evaluate.



       Form1-BeforeProcedure.
           EVALUATE Control-Id
           WHEN 5001 MOVE "Digitare il Codice" to TOTEM-HINT-TEXT
           WHEN 5002 MOVE "Digitare la Descrizione" to TOTEM-HINT-TEXT
           WHEN 5003 MOVE "Digitare la Descrizione" to TOTEM-HINT-TEXT
           WHEN 5004 MOVE totem-hint-text to TOTEM-HINT-TEXT
           WHEN OTHER MOVE SPACES TO TOTEM-HINT-TEXT
           END-EVALUATE
           EVALUATE Control-Id
           When 5001 PERFORM Screen1-DaEf-1-BeforeProcedure
           When 5002 PERFORM Screen1-DaEf-2-BeforeProcedure
           When 5003 PERFORM Screen1-DaEf-2-BeforeProcedure
           END-EVALUATE
           PERFORM Form1-DISPLAY-STATUS-MSG
           .

       Form1-AfterProcedure.
           EVALUATE Control-Id
           When 5001 PERFORM Screen1-DaEf-1-AfterProcedure
           When 5002 PERFORM Screen1-DaEf-2-AfterProcedure
           When 5003 PERFORM Screen1-DaEf-2-AfterProcedure
           END-EVALUATE
           perform Form1-AFTER-SCREEN
           .

       Screen1-Event-Proc.
           .

       Screen1-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5004 ALSO
                    form1-Handle 
              PERFORM form1-Gd-1-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

      * USER DEFINE PARAGRAPH
       ABILITAZIONI.
      * <TOTEM:PARA. ABILITAZIONI>
           if mod = 1              
              move BitmapDeleteEnabled to BitmapNumDelete
              move BitmapSaveEnabled   to BitmapNumSave
              move 1 to e-salva e-cancella
           else           
              move BitmapDeleteDisabled to BitmapNumDelete
              move BitmapSaveDisabled   to BitmapNumSave
              move ZERO to e-salva e-cancella
           end-if.      

      * ISACCO (CORREZIONE SU LIVELLO ABILITAZIONE 2) - 10/11/2003
      * (CANCELLAZIONE NON PERMESSA)
           if livello-abil = 2 
              move ZERO to e-cancella
              move BitmapDeleteDisabled to BitmapNumDelete
           end-if.
      * FINE

           modify tool-cancella, enabled = e-cancella.
           modify tool-salva,    enabled = e-salva.
       
      * ISACCO (SERVE SEMPRE PER LA MODIFICA PRCEDENTE E PER RIPRISTINARE
      * LE BITMAP DISABILITATE. - 10/11/2003
      *     perform FORM1-DISPLAY.
           display tool-nuovo, tool-salva, tool-cancella, tool-modifica.
      * FINE 
           .
      * <TOTEM:END>

       ANTEPRIMA.
      * <TOTEM:PARA. ANTEPRIMA>
           continue 
           .
      * <TOTEM:END>

       AUTO-COMPLETAMENTO-C.
      * <TOTEM:PARA. AUTO-COMPLETAMENTO-C>
           move 2 to riga.
           perform 36 times
              add 1 to riga
              inquire form1-gd-1(riga, 2), cell-data in col-tipo-pag
              if col-tipo-pag = spaces exit perform end-if
              move "C"    to col-tipo
              move spaces to col-importo
              modify form1-gd-1(riga, 4), cell-data = col-tipo
              modify form1-gd-1(riga, 5), cell-data = col-importo
           end-perform 
           .
      * <TOTEM:END>

       CANCELLA.
      * <TOTEM:PARA. CANCELLA>
           if mod = 0 exit paragraph end-if.
      *
           display message box MSg-Cancellare-il-record-corrente
                   title   titolo
                   type    mb-yes-no 
                   default mb-no
                   giving  scelta

           if scelta = mb-yes
              perform RIEMPI-CHIAVE
              delete tcodpag record invalid continue end-delete     
              move 0 to mod
              move 1 to mod-k
              perform FORM1-CLEAR
              set vecchio to true
              perform CANCELLA-COLORE
              perform INIT-OLD-REC

              
              display message box 
           MSG-Cancellazione-avvenuta-con-successo
                      title titolo                         

              unlock tcodpag all records

              perform PRIMO 
              move 78-ID-ef-codice to  CONTROL-ID     
              move 4         to  ACCEPT-CONTROL 

              set Statusvisua to true
              perform STATUS-BAR-MSG
              modify TOOL-MODIFICA value = mod
           end-if 
           .
      * <TOTEM:END>

       CARICA-GRID.
      * <TOTEM:PARA. CARICA-GRID>
           inquire form1-gd-1, cursor-y in store-riga, 
                               cursor-x in store-colonna.

           perform RESETTA-GRID.

           move 1 to idx.
           move 2 to riga.

           modify form1-gd-1, mass-update = 1.
           perform varying idx from 1 by 1
                     until idx > 36
              add 1 to riga
              initialize rec-grid replacing numeric data by zeroes
                                       alphanumeric data by spaces      
             
              if tblpa-codice-tr(idx) = spaces exit perform end-if
              move idx                           to   col-rata
              move tblpa-codice-tr(idx)          to   col-tipo-pag 
              move tblpa-inizio-conteggio(idx)   to   col-inizio   
              move tblpa-tipo-importi(idx)       to   col-tipo
              move tblpa-tipo-scadenze(idx)      to   col-tipo-scad
              move tblpa-importo(idx)            to   col-importo  
              move col-importo                   to   col-importo-edit
              evaluate true
              when tblpa-tipo-scadenze-88-i(idx)
                   move tblpa-scadenza(idx)        to   col-scad
                   inspect col-scad replacing leading x"30" by x"20"
              when tblpa-tipo-scadenze-88-d(idx)
                   move tblpa-scadenza(idx)(1:2)   to   col-scad(1:2)
                   move "/"                        to   col-scad(3:1)
                   move tblpa-scadenza(idx)(3:2)   to   col-scad(4:2)
                   move "/"                        to   col-scad(6:1)
                   move tblpa-scadenza(idx)(5:4)   to   col-scad(7:4)
              end-evaluate
              move   tblpa-detrazione-det(idx)   to   col-det
              modify form1-gd-1(riga, 2), cell-data = col-tipo-pag
              modify form1-gd-1(riga, 3), cell-data = col-inizio
              modify form1-gd-1(riga, 4), cell-data = col-tipo
              modify form1-gd-1(riga, 5), cell-data = col-importo-edit
              modify form1-gd-1(riga, 6), cell-data = col-tipo-scad
              modify form1-gd-1(riga, 7), cell-data = col-scad
              modify form1-gd-1(riga, 8), cell-data = col-det
           end-perform.
           modify form1-gd-1, mass-update = 0.

           perform X-Y.
           if store-riga > tot-righe
              move tot-righe to store-riga
           end-if.

           if store-riga < 3
              move 3 to store-riga
           end-if.

           move store-riga to riga.
           perform COLORE-RIGA.
           modify form1-gd-1, cursor-y = riga, cursor-x = store-colonna 
           .
      * <TOTEM:END>

       CERCA.
      * <TOTEM:PARA. CERCA>
           continue 
           .
      * <TOTEM:END>

       CLEAR-SCREEN.
      * <TOTEM:PARA. CLEAR-SCREEN>
           move tblpa-codice to old-tblpa-codice.

           initialize resto-record-tblpa
                              replacing numeric data by zeroes
                                   alphanumeric data by spaces.
                         
           perform FORM1-FLD-TO-BUF. 

           perform INIT-OLD-REC.
                                          
           display form1. 
  
           unlock tcodpag all records 
           .
      * <TOTEM:END>

       CHECK-INSERIMENTO.
      * <TOTEM:PARA. CHECK-INSERIMENTO>
      * MODIFICA LA STATUS-BAR
      * CONTROLLO SE DA INSERIMENTO SCORRO. ALLORA DEVO SEGNALARE CHE
      * SONO TORNATO IN MODIFICA.
           inquire tool-modifica, value in mod.

           evaluate mod
           when 1
                set StatusModifica to true
           when ZERO
                set StatusVisua to true   
           end-evaluate.
      
           perform STATUS-BAR-MSG 
           .
      * <TOTEM:END>

       COLORE-RIGA.
      * <TOTEM:PARA. COLORE-RIGA>
           modify form1-gd-1, start-x = 2,
                                    x = 8,
                              start-y = riga,
                                    y = riga,
                         region-color = 257,
                         cursor-color = 481 
           .
      * <TOTEM:END>

       CONTROLLO.
      * <TOTEM:PARA. CONTROLLO>
           set tutto-ok to true.

           evaluate CONTROL-ID
           when 78-ID-ef-codice  
                perform RIEMPI-CHIAVE
                if tblpa-codice2 = spaces
                   set errori to true
                   display message box MSG-Codice-obbligatorio
                           title tit-err
                           icon  mb-warning-icon
                else          
                   read tcodpag no lock
                        invalid
                        if vecchio
                           display message box MSG-record-inesistente
                                   title = tit-err
                                   icon mb-warning-icon
                           perform CLEAR-SCREEN
                           set errori to true
                        end-if
                    not invalid      
                        if old-tblpa-codice2 not = tblpa-codice2
                           perform CURRENT-RECORD 
                           set errori to true
                        end-if
                   end-read
                end-if

           when 78-ID-ef-descrizione1
                inquire ef-descrizione1 value in tblpa-descrizione1
                if tblpa-descrizione1 = spaces
                   set errori to true
                   display message box "Descrizione obbligatoria"
                           title tit-err
                           icon  mb-warning-icon
                end-if     
           end-evaluate.
      
           if errori
              perform CANCELLA-COLORE
              move control-id to store-id
              move 4          to accept-control
           end-if 
           .
      * <TOTEM:END>

       CONTROLLO-PERCENTUALE-100.
      * <TOTEM:PARA. CONTROLLO-PERCENTUALE-100>
           move 0       to tot-perce como-perce store-riga.
           set trovato  to false.
           set tutto-ok to true.
           move 2 to riga
           perform 36 times
              add   1 to riga
              perform VALORE-RIGA
              if col-tipo-pag = spaces exit perform end-if
              if col-tipo = "P" and col-det not = "S"
                 set trovato to true
                 if store-riga = 0
                    move riga to store-riga
                 end-if
                 move col-importo to como-perce
                 add  como-perce  to tot-perce
                 if tot-perce > 100
                    set errori to true
                    exit perform
                 end-if
              end-if
           end-perform.

           if errori
              display message "Percentuale totale > 100"
                      title tit-err
                      icon  2
           else
              if tot-perce not = 100 and trovato
                 display message "Percentuale totale differente da 100."
                          x"0d0a""Confermi?"
                         title titolo
                          type mb-yes-no
                        giving scelta
                 if scelta = mb-no
                    set errori to true
                    display message "Salvataggio NON effettuato"
                            title tit-err
                             icon 2
                 end-if
              end-if
           end-if.

           if errori
              move 78-ID-form1-Gd-1 to control-id store-id
              move 5                to colonna
              move store-riga       to riga
           end-if 
           .
      * <TOTEM:END>

       CONTROLLO-RIGA.
      * <TOTEM:PARA. CONTROLLO-RIGA>
           set tutto-ok to true.
              
           evaluate colonna
           when 2
                evaluate col-tipo-pag
                when "B"
                when "D"
                when "T"           
                when "W" 
                when "Z" 
                when "E" continue
                when other
                     set errori to true
                     display message box
                             "Valori consentiti: "
                      x"0d0a""- B/Z : Bonifico bancario"
                      x"0d0a""- D : Rimessa  diretta"
                      x"0d0a""- T : Tratta"
                      x"0d0a""- W : R.I.B.A."
                      x"0d0a""- E : Bonfico per estero"
                            title tit-err
                            icon  2
                end-evaluate
           when 3 modify form1-gd-1(riga, colonna), 
                         cell-data = col-inizio
           when 4
                evaluate col-tipo
                when "P"
                when "A"
                when "C" continue
                when other
                     set errori to true
                     display message box
                             "Valori consentiti: "
                      x"0d0a""- P : Percentuale del Totale"
                      x"0d0a""- A : Valore Assoluto"
                      x"0d0a""- C : Totale Diviso Numero Rate"
                            title tit-err
                            icon  2
                end-evaluate
           when 5 
                if col-tipo = "P"
                   if col-importo > 100
                      set errori to true
                      display message "Percentuale superiore a 100"
                              title tit-err
                               icon 2
                   end-if
                end-if
           when 6         
                evaluate col-tipo-scad
                when "I"
                when "D" continue
                when other
                     set errori to true
                     display message box
                             "Valori consentiti: "
                      x"0d0a""- I : N. gg dalla data d'inizio conteggio"
                      x"0d0a""- D : Data Fissa (GGMMAAAA)"
                            title tit-err
                            icon  2
                end-evaluate
           when 7 
                if col-scad not = space
                   if col-tipo-scad = "D"
                        move col-scad to como-data convert
                        perform DATE-FORMAT
                        initialize col-scad
                        string como-data(1:2) delimited size
                               "/"            delimited size
                               como-data(3:2) delimited size
                               "/"            delimited size
                               como-data(5:4) delimited size
                               into col-scad
                        end-string
                        modify form1-gd-1(riga, colonna), 
                               cell-data = col-scad
                     end-if
                  end-if
           when 8 evaluate col-det 
                  when "S"
                  when space continue
                  when other
                       set errori to true
                       display message box
                               "Valori consentiti 'S'; BLANK"
                               title tit-err
                               icon  2
                end-evaluate 
           end-evaluate.

           if errori move 78-ID-form1-Gd-1 to store-id end-if 
           .
      * <TOTEM:END>

       CURRENT-RECORD.
      * <TOTEM:PARA. CURRENT-RECORD>
           perform RIEMPI-CHIAVE.
           set tutto-ok  to true.
           set ReadSecca to true.
           if mod = 1
              read tcodpag    lock invalid set errori to true end-read
           else
              read tcodpag no lock invalid set errori to true end-read
           end-if.

           set ReadSecca to false.

           if RecLocked
              set RecLocked to false
           else
              if tutto-ok    
                 if nuovo
                    move 0               to mod
                    move 1               to mod-k
                    move 78-ID-ef-codice to CONTROL-ID
                    move 4               to ACCEPT-CONTROL
                 end-if
                 perform FORM1-IUD-DISPLAY
                 set vecchio to true
                 if mod = 1  set StatusModifica to true
                 else        set StatusVisua    to true
                 end-if
                 perform STATUS-BAR-MSG
                 perform VALORIZZA-OLD
              else
                 move 0 to mod
                 move 1 to mod-k
                 if vecchio
                    perform CLEAR-SCREEN
                    if YesMessage
                       move 78-ID-ef-codice to CONTROL-ID
                       move 4               to ACCEPT-CONTROL
                       display message box MSG-Record-inesistente
                               title = tit-err
                               icon mb-warning-icon
                    end-if
                 end-if
              end-if
           end-if 
           .
      * <TOTEM:END>

       GRID-TO-FLD.
      * <TOTEM:PARA. GRID-TO-FLD>
           move col-tipo-pag   to tblpa-codice-tr(idx).
           move col-inizio     to tblpa-inizio-conteggio(idx).
           move col-tipo       to tblpa-tipo-importi(idx).
           move col-tipo-scad  to tblpa-tipo-scadenze(idx).
           move col-importo    to tblpa-importo(idx).
           evaluate col-tipo-scad
           when "I"
                call "C$JUSTIFY" using col-scad, "R"
                inspect col-scad replacing leading X"20" by X"30"
           when "D"
                move col-scad(5:1) to col-scad(6:1)
                move col-scad(4:1) to col-scad(5:1)
                move col-scad(1:2) to col-scad(3:2)
                move "00"          to col-scad(1:2)
           when other
                move all "0" to col-scad
           end-evaluate.
           move col-scad       to tblpa-scadenza(idx).
           move col-det        to tblpa-detrazione-det(idx) 
           .
      * <TOTEM:END>

       HELP-GRID.
      * <TOTEM:PARA. HELP-GRID>
           move event-data-1 to colonna.

           evaluate colonna
           when 2   move "B = Bonifico bancario; D = Rimessa  diretta; T
      -                  "= Tratta; W = R.I.B.A.; E = Bonifico per l'est
      -    "ero" 
                      to totem-hint-text
           when 3   move "0 = Data documento; 31 = Fine Mese; 99 = Vista
      -                  "; >31 = gg mese seg. ; Altri = Giorno Mese" 
                      to totem-hint-text
           when 4   move "P = Percentuale del Totale; A = Valore Assolut
      -                  "o; C = Totale Diviso Numero di Rate"
                      to totem-hint-text
           when 5   move "Importo della rata (0 su ultima rata = addebit
      -                  "o della rimanenza sulla rata)" 
                      to totem-hint-text
           when 6   move "I = Numero di Giorni dalla data di inizio cont
      -                  "eggio; D = Data Fissa(GGMMAAAA)" 
                      to totem-hint-text
           when 7   move "Scadenza della rata in termini di giorni da in
      -                  "izio conteggio o in termini di data fissa)" 
                      to totem-hint-text
           when 8   move "S = L'importo della rata va in detrazione del 
      -                  "totale sul calcolo della altre" 
                      to totem-hint-text
           end-evaluate.

           modify Form1-St-1-Handle, panel-index = 1,
                                     panel-text  = totem-hint-text 
           .
      * <TOTEM:END>

       INIT.
      * <TOTEM:PARA. INIT>
           move 0 to StatusHelp.
           move 1 to mod-k.
           set StatusVisua to true 
           .
      * <TOTEM:END>

       INIT-OLD-REC.
      * <TOTEM:PARA. INIT-OLD-REC>
           initialize old-record-tblpa replacing numeric data by zeroes
                                            alphanumeric data by spaces 
           .
      * <TOTEM:END>

       MODIFICA.
      * <TOTEM:PARA. MODIFICA>
           move 5 to key-status.
           inquire tool-modifica, value in mod.
           set tutto-ok to true.

           if nuovo
              move 1 to mod                  
              modify tool-modifica, value mod
           else
      *  SE L'UTENTE E' ABILITATO PUO' MODIFICARE UN RECORD
              if mod = 1
                 set YesMessage to true
                 perform CURRENT-RECORD
                 if tutto-ok
                    if CONTROL-ID < 78-ID-ef-descrizione1
                       move 78-ID-ef-descrizione1 to control-id
                    end-if
                    move 0 to mod-k
                    move 1 to mod
                    set StatusModifica to true
                    perform STATUS-BAR-MSG
                 end-if
              else
                 move 1 to mod
                 perform SALV-MOD            
                 move 0 to mod
                 move 1 to mod-k
                 if errori
                    move 1 to mod
                    move 0 to mod-k
                 else
                    move 78-ID-ef-codice to CONTROL-ID
                    set NoMessage to true
                    perform CURRENT-RECORD
                    set StatusVisua to true
                    perform STATUS-BAR-MSG 
                    unlock tcodpag all records
                 end-if
              end-if
                        
              display form1
              modify tool-modifica,  value mod
              perform CANCELLA-COLORE 

              move 4 to accept-control
           end-if 
           .
      * <TOTEM:END>

       NUOVO.
      * <TOTEM:PARA. NUOVO>
           perform SALV-MOD.

           if tutto-ok  
              move 78-ID-ef-codice to CONTROL-ID       
              move 4               to ACCEPT-CONTROL   
              move 1               to mod mod-k
              modify tool-modifica,  value = mod
              perform CANCELLA-COLORE                  
              perform VALORIZZA-NUOVO
              perform INIT-OLD-REC
              perform RESETTA-GRID
              set StatusIns to true
              perform STATUS-BAR-MSG  
              set nuovo to true       
              unlock tcodpag all records
           end-if 
           .
      * <TOTEM:END>

       ORDINAMENTO.
      * <TOTEM:PARA. ORDINAMENTO>
           inquire tool-ord, value in OrderBy.
      
           if OrderBy = zero
              perform DataSet1-CHANGETO-KEY1
           else
              perform DataSet1-CHANGETO-KEY2
           end-if.
      
           perform Form1-Curr 
           .
      * <TOTEM:END>

       RIEMPI-CHIAVE.
      * <TOTEM:PARA. RIEMPI-CHIAVE>
           move "PA" to tblpa-codice.
           inquire ef-codice, value in ef-codice-buf.
           move ef-codice-buf       to tblpa-codice2 
           .
      * <TOTEM:END>

       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "abilita-toolbar.cpy".
           copy "color-custom.cpy".
           copy "status.cpy".
           copy "utydata.cpy" 
           .
      * <TOTEM:END>

       PRECEDENTE.
      * <TOTEM:PARA. PRECEDENTE>
           perform SALV-MOD.           
           if tutto-ok

              perform CHECK-INSERIMENTO
              unlock tcodpag all records

              if mod = 1
                 move ZERO to mod-k
                 set dataset1-tcodpag-lock to true
              else              
                 move 1    to mod-k     
                 initialize dataset1-tcodpag-lock-flag
              end-if
                    
              perform CANCELLA-COLORE
              perform FORM1-PREVIOUS

              if RecLocked
                 set RecLocked to false             
                 initialize dataset1-tcodpag-lock-flag
                 move 1 to mod-k
                 perform FORM1-PREVIOUS
              end-if
           end-if 
           .
      * <TOTEM:END>

       PRIMO.
      * <TOTEM:PARA. PRIMO>
           perform SALV-MOD.           
           if tutto-ok    
 
              perform CHECK-INSERIMENTO
              unlock tcodpag all records

              if mod = 1
                 move 0 to mod-k
                 set dataset1-tcodpag-lock to true
              else              
                 move 1 to mod-k     
                 initialize dataset1-tcodpag-lock-flag
              end-if
                                  
              perform CANCELLA-COLORE
              perform FORM1-FIRST

              if RecLocked
                 set RecLocked to false             
                 initialize dataset1-tcodpag-lock-flag
                 move 1 to mod-k
                 perform FORM1-FIRST
              end-if
           end-if 
           .
      * <TOTEM:END>

       RESETTA-GRID.
      * <TOTEM:PARA. RESETTA-GRID>
           modify form1-gd-1, reset-grid = 1.
           perform INTESTAZIONE.

      ***---
       INTESTAZIONE.
           modify form1-gd-1, record-to-add = 38.
           perform FORM1-GD-1-CONTENT 
           .
      * <TOTEM:END>

       SALVA.
      * <TOTEM:PARA. SALVA>
           if mod = 0 exit paragraph end-if.

           set tutto-ok to true.

           perform varying CONTROL-ID from 78-ID-ef-codice by 1
                     until CONTROL-ID > 78-ID-ef-descrizione1
              perform CONTROLLO
              if errori 
                 exit perform 
              end-if
           end-perform.

           if tutto-ok   
              perform X-Y
              if tot-righe < 3
                 set errori to true
                 display message "Inserire almeno un pagamento"
                           title tit-err
                            icon 2
                 move 78-ID-form1-Gd-1 to control-id store-id
                 move 2                to colonna
                 move 3                to riga 
              end-if
           end-if.

           if tutto-ok
              move 2 to riga
              set TutteC   to true
              set TutteP   to true
              set TrovataC to false
              perform 36 times
                 add 1 to riga
                 perform VALORE-RIGA
                 if col-tipo-pag not = spaces
                    evaluate col-tipo
                    when "A" set  TutteC   to false
                             set  TutteP   to false
                    when "P" set  TutteC   to false
                    when "C" set  TrovataC to true
                             set  TutteP   to false
                             move riga     to store-riga
                    end-evaluate
                    perform varying colonna from 2 by 1
                              until colonna > 8
                       perform CONTROLLO-RIGA

                       if errori exit perform end-if
                    end-perform
                 end-if
                 if errori exit perform end-if
              end-perform

              if tutto-ok 
                 evaluate true 
                 when TutteP   perform CONTROLLO-PERCENTUALE-100
                 when TrovataC 
                      if not TutteC
                         display message 
                            "Tutte le rate devono avere un pagamento"
                     x"0d0a""di tipo 'C' e l'importo pari a zero."
                     x"0d0a""Procedere con il completamento automatico?"
                                 title titolo
                                  type mb-yes-no
                                  icon 2
                                giving scelta
                         if scelta = mb-no 
                            display message "Salvataggio NON effettuato"
                                    title tit-err
                                     icon 2
                            set errori            to true
                            move 78-ID-form1-Gd-1 to store-id control-id
                            move store-riga       to riga
                            move 4                to colonna
                         else
                            perform AUTO-COMPLETAMENTO-C
                         end-if
                      end-if
                 end-evaluate

              end-if

           end-if.

           if errori
              perform CANCELLA-COLORE
              perform ABILITAZIONI
              move store-id to control-id       
              move 4        to accept-control   
              if store-id = 78-ID-form1-Gd-1
                 modify form1-gd-1, cursor-y = riga, cursor-x = colonna
                 perform COLORE-RIGA
                 move colonna to event-data-1
                 perform HELP-GRID
              end-if
           else
              perform SCRIVI-RIGHE
              perform FORM1-BUF-TO-FLD
              perform CANCELLA-COLORE

              write record-tblpa invalid rewrite record-tblpa end-write
       
              set vecchio to true       
              perform TORNA-IN-VISUA            
           end-if.   
                 
           display form1 
           .
      * <TOTEM:END>

       SALV-MOD.
      * <TOTEM:PARA. SALV-MOD>
           set tutto-ok to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-CONTROLLO-OLD.

           if SiSalvato
              move 0 to idx
              perform 36 times
                 add 1 to idx
                 if tblpa-tabella(idx) not = old-tblpa-tabella(idx) 
                    set NoSalvato         to true
                    move 78-ID-form1-Gd-1 to control-id store-id
                    exit perform
                 end-if
                 if     tblpa-detrazione-det(idx) not = 
                    old-tblpa-detrazione-det(idx) and SiSalvato
                    set NoSalvato         to true
                    move 78-ID-form1-Gd-1 to control-id store-id
                    exit perform
                 end-if
              end-perform
           end-if.

           if NoSalvato
              display message box MSG-Salvare-le-modifiche
                            title titolo
                            type mb-yes-no-cancel 
                            giving scelta       
       
              evaluate scelta
              when mb-yes 
                   perform SALVA
              when mb-no  
                   continue
              when other                
                   perform CANCELLA-COLORE
                   set errori to true
                   move store-id to CONTROL-ID       
                   move 4        to ACCEPT-CONTROL   
              end-evaluate
           end-if 
           .
      * <TOTEM:END>

       SCRIVI-RIGHE.
      * <TOTEM:PARA. SCRIVI-RIGHE>
           move 0 to idx.
           move 2 to riga.
           perform 36 times
              add 1 to idx
              add 1 to riga
              perform VALORE-RIGA
              if col-tipo-pag = spaces exit perform end-if
              perform varying colonna from 2 by 1 until colonna > 8
                 perform CONTROLLO-RIGA
                 if errori 
                    move 78-ID-form1-Gd-1 to control-id
                    exit perform
                 end-if
              end-perform
              if tutto-ok perform GRID-TO-FLD end-if
              move idx to tblpa-numero-scadenze
           end-perform 
           .
      * <TOTEM:END>

       SELEZIONA.
      * <TOTEM:PARA. SELEZIONA>
           perform RIEMPI-CHIAVE.

           move "tcodpag" to    como-file.
           call "zoom-gt" using como-file, record-tblpa
                          giving stato-zoom.
           cancel "zoom-gt".
           if stato-zoom = 0
              if old-tblpa-codice not = tblpa-codice
                 move tblpa-codice to save-key
                 perform SALV-MOD
                 if tutto-ok
                    move save-key to tblpa-codice
                    set ReadSecca to true
                    modify ef-codice, value tblpa-codice2
                    perform CURRENT-RECORD
                    perform CANCELLA-COLORE
                    move 78-ID-ef-codice to CONTROL-ID       
                    move 4               to ACCEPT-CONTROL   
                 end-if                                  
              end-if
           end-if 
           .
      * <TOTEM:END>

       SELEZIONA-NUMERICO.
      * <TOTEM:PARA. SELEZIONA-NUMERICO>
           if tblpa-codice2 = spaces
              set errori to true
              display message box MSG-Codice-obbligatorio
                      title tit-err
                      type  mb-ok
                      icon  mb-warning-icon
           else          
              read tcodpag no lock
                   invalid
                   if vecchio
                      display message box MSG-record-inesistente
                              title = tit-err
                              icon mb-warning-icon
                      perform CLEAR-SCREEN
                      set errori to true
                   end-if
               not invalid      
                   if old-tblpa-codice2 not = tblpa-codice2
                      perform CURRENT-RECORD 
                      set errori to true
                   end-if
              end-read
           end-if 
           .
      * <TOTEM:END>

       SPOSTAMENTO.
      * <TOTEM:PARA. SPOSTAMENTO>
           set tutto-ok to true.
           perform X-Y.

           if event-data-2 not = riga

              perform VALORE-RIGA
              if col-tipo-pag not = spaces
                 perform varying colonna from 2 by 1
                           until colonna > 8
                    perform CONTROLLO-RIGA
                    if errori exit perform end-if
                 end-perform
              end-if

              if tutto-ok
                 evaluate true
                 when event-data-2 < 3 move 3 to event-data-2

                 when event-data-2 > tot-righe
                      add 1 to tot-righe giving event-data-2
                      set event-action   to event-action-fail
                      move 2 to event-data-1
                      modify form1-gd-1, cursor-y = event-data-2,
                                         cursor-x = event-data-1
                 end-evaluate
              else
                 move colonna       to event-data-1
                 move riga          to event-data-2
                 set event-action   to event-action-fail
                 modify form1-gd-1, cursor-y = event-data-2,
                                    cursor-x = colonna
              end-if
           end-if.

           move event-data-2 to riga.
           perform COLORE-RIGA.
           perform HELP-GRID 
           .
      * <TOTEM:END>

       STAMPA.
      * <TOTEM:PARA. STAMPA>
           continue 
           .
      * <TOTEM:END>

       SUCCESSIVO.
      * <TOTEM:PARA. SUCCESSIVO>
           perform SALV-MOD.
           if tutto-ok

              perform CHECK-INSERIMENTO
              unlock tcodpag all records

              if mod = 1
                 move ZERO to mod-k
                 set dataset1-tcodpag-lock to true
              else              
                 move 1    to mod-k     
                 initialize dataset1-tcodpag-lock-flag
              end-if
                                     
              perform CANCELLA-COLORE
              perform FORM1-NEXT
 
              if RecLocked
                 set RecLocked to false             
                 initialize dataset1-tcodpag-lock-flag
                 move 1 to mod-k
                 perform FORM1-NEXT
              end-if
           end-if 
           .
      * <TOTEM:END>

       ULTIMO.
      * <TOTEM:PARA. ULTIMO>
           perform SALV-MOD.
           if tutto-ok

              perform CHECK-INSERIMENTO
              unlock tcodpag all records 

              if mod = 1
                 move ZERO to mod-k
                 set dataset1-tcodpag-lock to true
              else              
                 move 1    to mod-k     
                 initialize dataset1-tcodpag-lock-flag
              end-if
                               
              perform CANCELLA-COLORE
              perform FORM1-LAST 
 
              if RecLocked
                 set RecLocked to false             
                 initialize dataset1-tcodpag-lock-flag
                 move 1 to mod-k
                 perform FORM1-LAST
              end-if
           end-if 
           .
      * <TOTEM:END>

       VALORIZZA-OLD.
      * <TOTEM:PARA. VALORIZZA-OLD>
           move record-tblpa to old-record-tblpa.
           set vecchio to true.

           move 0 to StatusHelp
           perform STATUS-HELP 
           .
      * <TOTEM:END>

       VALORIZZA-NUOVO.
      * <TOTEM:PARA. VALORIZZA-NUOVO>
           move "00"    to status-tcodpag.

           initialize record-tblpa replacing numeric data by zeroes
                                        alphanumeric data by spaces.
                                       
           perform FORM1-IUD-DISPLAY 
           .
      * <TOTEM:END>

       TORNA-IN-VISUA.
      * <TOTEM:PARA. TORNA-IN-VISUA>
           move 0 to mod.
           move 1 to mod-k.
           move 78-ID-ef-codice to CONTROL-ID.
           set NoMessage to true.
           perform ABILITAZIONI.
           set StatusVisua to true.
           perform STATUS-BAR-MSG.
           unlock tcodpag all records.
                        
           modify tool-modifica,  value mod.
           perform CANCELLA-COLORE.
           move 4 to ACCEPT-CONTROL 
           .
      * <TOTEM:END>

       VALORE-RIGA.
      * <TOTEM:PARA. VALORE-RIGA>
           inquire form1-gd-1(riga, 2), cell-data in col-tipo-pag.
           inquire form1-gd-1(riga, 3), cell-data in col-inizio.
           inquire form1-gd-1(riga, 4), cell-data in col-tipo.
           inquire form1-gd-1(riga, 5), cell-data in col-importo.
           inquire form1-gd-1(riga, 6), cell-data in col-tipo-scad.
           inquire form1-gd-1(riga, 7), cell-data in col-scad.
           inquire form1-gd-1(riga, 8), cell-data in col-det 
           .
      * <TOTEM:END>

       X-Y.
      * <TOTEM:PARA. X-Y>
           inquire form1-gd-1, cursor-y in riga, cursor-x in colonna,
                               last-row in tot-righe 
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       NUOVO-LinkTo.
      * <TOTEM:PARA. NUOVO-LinkTo>
           INQUIRE TOOL-NUOVO, ENABLED IN E-NUOVO.

           IF E-NUOVO = 1
              PERFORM NUOVO
           END-IF                    
           .
      * <TOTEM:END>
       CANCELLA-LinkTo.
      * <TOTEM:PARA. CANCELLA-LinkTo>
           INQUIRE TOOL-MODIFICA, VALUE IN MOD.
                              
           INQUIRE TOOL-CANCELLA, ENABLED IN E-CANCELLA
           IF E-CANCELLA = 1
              PERFORM CANCELLA
           END-IF                                                
           .
      * <TOTEM:END>
       TOOL-SALVA-LinkTo.
      * <TOTEM:PARA. TOOL-SALVA-LinkTo>
           INQUIRE TOOL-MODIFICA, VALUE IN MOD           

           INQUIRE TOOL-SALVA, ENABLED IN E-SALVA
           IF E-SALVA = 1
              PERFORM SALVA
           END-IF           
           .
      * <TOTEM:END>
       ANTEPRIMA-LinkTo.
      * <TOTEM:PARA. ANTEPRIMA-LinkTo>
           INQUIRE TOOL-ANTEPRIMA, ENABLED IN E-ANTEPRIMA.
           IF E-ANTEPRIMA = 1
                PERFORM ANTEPRIMA
           END-IF 
           .
      * <TOTEM:END>
       TOOL-MODIFICA-BeforeProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       TOOL-MODIFICA-AfterProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       TOOL-MODIFICA-LinkTo.
      * <TOTEM:PARA. TOOL-MODIFICA-LinkTo>
           INQUIRE TOOL-MODIFICA, ENABLED IN E-MODIFICA.

           IF E-MODIFICA = 1
              PERFORM MODIFICA
           END-IF 
           .
      * <TOTEM:END>
       STAMPA-LinkTo.
      * <TOTEM:PARA. STAMPA-LinkTo>
           INQUIRE TOOL-STAMPA, ENABLED IN E-STAMPA
           IF E-STAMPA = 1
                PERFORM STAMPA
           END-IF 
           .
      * <TOTEM:END>
       TOOL-CERCA-LinkTo.
      * <TOTEM:PARA. TOOL-CERCA-LinkTo>
           inquire tool-cerca, enabled in e-cerca
           if e-cerca = 1
              perform CERCA
           end-if 
           .
      * <TOTEM:END>
       TOOL-SELEZIONA-LinkTo.
      * <TOTEM:PARA. TOOL-SELEZIONA-LinkTo>
           inquire tool-seleziona, enabled in e-seleziona
           if e-seleziona = 1
              perform SELEZIONA
           end-if 
           .
      * <TOTEM:END>
       TOOL-PRIMO.
      * <TOTEM:PARA. TOOL-PRIMO>
           PERFORM PRIMO 
           .
      * <TOTEM:END>
       TOOL-PRECEDENTE.
      * <TOTEM:PARA. TOOL-PRECEDENTE>
           if nuovo             
              perform PRIMO
           else
              perform PRECEDENTE
           end-if 
           .
      * <TOTEM:END>
       TOOL-SUCCESSIVO.
      * <TOTEM:PARA. TOOL-SUCCESSIVO>
           if nuovo             
              perform ULTIMO
           else
              perform SUCCESSIVO
           end-if 
           .
      * <TOTEM:END>
       TOOL-ULTIMO.
      * <TOTEM:PARA. TOOL-ULTIMO>
           PERFORM ULTIMO 
           .
      * <TOTEM:END>
       ginqui-Ev-Before-Program.
      * <TOTEM:PARA. ginqui-Ev-Before-Program>
           move LK-BL-PROG-ID    TO COMO-PROG-ID 
           .
      * <TOTEM:END>
       ginqui-Ev-After-Program.
      * <TOTEM:PARA. ginqui-Ev-After-Program>
           SET LK-BL-CANCELLAZIONE TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM 
           .
      * <TOTEM:END>
       Screen1-DaEf-2-BeforeProcedure.
      * <TOTEM:PARA. Screen1-DaEf-2-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           move ZERO to StatusHelp.
           perform STATUS-HELP 
           .
      * <TOTEM:END>
       Screen1-DaEf-2-AfterProcedure.
      * <TOTEM:PARA. Screen1-DaEf-2-AfterProcedure>
              INQUIRE ef-descrizione1, VALUE IN tblpa-DESCRIZIONE1
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-descrizione1-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
              INQUIRE ef-descrizione2, VALUE IN TBLpa-DESCRIZIONE2
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-descrizione2-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       TOOL-ORD-LinkTo.
      * <TOTEM:PARA. TOOL-ORD-LinkTo>
           perform ORDINAMENTO 
           .
      * <TOTEM:END>
       TOOL-ORD-BeforeProcedure.
      * <TOTEM:PARA. TOOL-ORD-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       TOOL-ORD-AfterProcedure.
      * <TOTEM:PARA. TOOL-ORD-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       Screen1-DaEf-1-BeforeProcedure.
      * <TOTEM:PARA. Screen1-DaEf-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           move ZERO to StatusHelp.
           perform STATUS-HELP 
           .
      * <TOTEM:END>
       Screen1-DaEf-1-AfterProcedure.
      * <TOTEM:PARA. Screen1-DaEf-1-AfterProcedure>
              INQUIRE ef-codice, VALUE IN tblpa-codice2
              SET TOTEM-CHECK-OK TO FALSE
              PERFORM ef-codice-VALIDATION
              IF NOT TOTEM-CHECK-OK
                 MOVE 1 TO ACCEPT-CONTROL
              END-IF
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       form1-Gd-1-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Begin-Entry>
           if mod = 0 
              set event-action to event-action-fail 
           else
              perform X-Y
              perform VALORE-RIGA
              evaluate colonna
              when 2 continue         
              when 3 
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   end-if
              when 4 
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   end-if
              when 5
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   else
                      if col-tipo = spaces
                         set event-action to event-action-fail
                         modify form1-gd-1, 
                                cursor-y = riga, 
                                cursor-x = 4
                         perform COLORE-RIGA
                      end-if
                   end-if
              when 6 
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   end-if
              when 7 
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   else
                      if col-tipo-scad = spaces
                         set event-action to event-action-fail
                         modify form1-gd-1, 
                                cursor-y = riga, 
                                cursor-x = 6
                         perform COLORE-RIGA
                      end-if
                   end-if
              when 8
                   if col-tipo-pag = space
                      set event-action to event-action-fail
                      modify form1-gd-1, 
                             cursor-y = riga, 
                             cursor-x = 2
                      perform COLORE-RIGA
                   end-if
           end-if 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-End-Drag.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-End-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-Gd-1-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. form1-Gd-1-Ev-Msg-Finish-Entry>
           move mb-no to scelta.
           perform X-Y.
           perform VALORE-RIGA.
           evaluate colonna
           when 2
                if col-tipo-pag = spaces
                   display message box "Cancellare l'intera riga?"
                              type mb-yes-no
                             title titolo
                           default mb-no
                              icon 2
                            giving scelta
                   if scelta = mb-yes
                      modify form1-gd-1, record-to-delete = riga
                      perform FORM1-GD-1-CONTENT
                   end-if
                end-if
           when 5
                move col-importo to col-importo-edit
                modify form1-gd-1(riga, 5), cell-data = col-importo-edit
           end-evaluate.

           if scelta = mb-no
              perform CONTROLLO-RIGA
              if errori
                 set event-action to event-action-fail
              end-if
           end-if 
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

