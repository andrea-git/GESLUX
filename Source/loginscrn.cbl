      *{TOTEM}PRG-COMMENT
      * loginscrn.Cbl
      * loginscrn.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          loginscrn IS INITIAL PROGRAM.
       AUTHOR.              ANDREA EVENTI.
       DATE-WRITTEN.        lunedì 11 giugno 2018 15:26:12.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:loginscrn, INIT:loginscrn, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "USER.sl".
           COPY "tconvanno.sl".
           COPY "pass.sl".
           COPY "STO-tordini.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "USER.fd".
           COPY "tconvanno.fd".
           COPY "pass.fd".
           COPY "STO-tordini.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "fonts.def".
               COPY "crtvars.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "F:\lubex\geslux\Copylib\standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
      * Properties & User defined Working Stoarge
       77 Form1-SF-HANDLE
                  USAGE IS HANDLE OF WINDOW.
           COPY  "COMMON-LINKAGE.DEF".
           COPY  "HINTTEXT.DEF".
           COPY  "CALCOLA-CENTRO-WINDOW.DEF".
       77 messaggio        PIC  X.
           88 stop-splash VALUE IS "s". 
       77 path-archivi-sto PIC  x(256).
       77 path-archivi     PIC  x(256).
       77 path-archivi-completo        PIC  x(256).
       77 h-splash
                  USAGE IS HANDLE OF WINDOW.
       77 link-status      PIC  s9.
       77 trd-splash
                  USAGE IS HANDLE OF THREAD.
       77 como-anno        PIC  9(4).
       77 anno-x           PIC  x(4).
       77 anno-sto         PIC  9(4).
       01 FILLER           PIC  9.
           88 bisestile VALUE IS 1    WHEN SET TO FALSE  0. 
       01 data-validita.
           05 anno PIC  9999.
           05 mese PIC  99.
           05 giorno           PIC  99.
       77 data-oggi        PIC  9(8).
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 STATUS-USER      PIC  X(2).
           88 VALID-STATUS-USER VALUE IS "00" THRU "09". 
       77 Form1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 E-USER-CODICE    PIC  X(10).
       77 Comic-Sans-MS22I
                  USAGE IS HANDLE OF FONT.
       77 STATUS-user-pgm  PIC  X(2).
           88 Valid-STATUS-user-pgm VALUE IS "00" THRU "09". 
       77 Default-bmp      PIC  S9(6)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 Default-Font
                  USAGE IS HANDLE OF FONT DEFAULT-FONT.
       77 Form1-Bt-1-Handle            PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 lubex-bmp        PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 lubex-colori-bmp PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       78 titolo VALUE IS "Geslux - Login". 
       77 Verdana12-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 bottone-ok-bmp   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 bottone-cancel-bmp           PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 bottone-exit-bmp PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 esci-73x21-bmp   PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 11.
       77 como-riga        PIC  x(100).
       77 STATUS-destini   PIC  X(2).
           88 Valid-STATUS-destini VALUE IS "00" THRU "09". 
       77 ef-anno-buf      PIC  z(4).
       77 STATUS-tconvanno PIC  X(2).
           88 Valid-STATUS-tconvanno VALUE IS "00" THRU "09". 
       77 Verdana10-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 Verdana8-Occidentale
                  USAGE IS HANDLE OF FONT.
       77 path-txt         PIC  X(256).
       77 STATUS-pass      PIC  X(2).
           88 Valid-STATUS-pass VALUE IS "00" THRU "09". 
       77 chk-storico-buf  PIC  9
                  VALUE IS 0.
       77 PATH-STO-TORDINI PIC  X(256).
       77 STATUS-sto-tordini           PIC  X(2).
           88 Valid-STATUS-sto-tordini VALUE IS "00" THRU "09". 
       77 tit-storico      PIC  X(20)
                  VALUE IS "Storico fino al 2014".

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
      * DATA CONTROL BUFFER
       01 Form1-BUF.
      * Data.Entry-Field
              05 ef-user-BUF PIC X(10).
      * Data.Entry-Field
              05 ef-pass-BUF PIC X(20).

       77 TMP-Form1-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Form1-USER-RESTOREBUF  PIC X(351).
       77 TMP-Form1-KEYIS  PIC 9(3) VALUE 1.
       77 Form1-MULKEY-TMPBUF   PIC X(351).
       77 TMP-DataSet1-USER-BUF     PIC X(351).
       77 TMP-DataSet1-tconvanno-BUF     PIC X(163).
       77 TMP-DataSet1-pass-BUF     PIC X(1000).
       77 TMP-DataSet1-STO-tordini-BUF     PIC X(3898).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-USER-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-USER-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-USER-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-USER-KEY1-Asc  VALUE "A".
          88 DataSet1-USER-KEY1-Desc VALUE "D".
       77 DataSet1-tconvanno-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tconvanno-LOCK  VALUE "Y".
       77 DataSet1-tconvanno-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tconvanno-KEY-Asc  VALUE "A".
          88 DataSet1-tconvanno-KEY-Desc VALUE "D".
       77 DataSet1-pass-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-pass-LOCK  VALUE "Y".
       77 DataSet1-pass-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-pass-KEY-Asc  VALUE "A".
          88 DataSet1-pass-KEY-Desc VALUE "D".
       77 DataSet1-STO-tordini-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-STO-tordini-LOCK  VALUE "Y".
       77 DataSet1-STO-tordini-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-STO-tordini-KEY-Asc  VALUE "A".
          88 DataSet1-STO-tordini-KEY-Desc VALUE "D".

       77 STO-tordini-k-causale-SPLITBUF  PIC X(17).
       77 STO-tordini-k1-SPLITBUF  PIC X(23).
       77 STO-tordini-k2-SPLITBUF  PIC X(21).
       77 STO-tordini-k-bolla-SPLITBUF  PIC X(13).
       77 STO-tordini-k3-SPLITBUF  PIC X(22).
       77 STO-tordini-k-fattura-SPLITBUF  PIC X(13).
       77 STO-tordini-k4-SPLITBUF  PIC X(30).
       77 STO-tordini-k-contab-SPLITBUF  PIC X(14).
       77 STO-tordini-k-tipo-SPLITBUF  PIC X(14).
       77 STO-tordini-k-data-SPLITBUF  PIC X(17).
       77 STO-tordini-k-agfatt-SPLITBUF  PIC X(42).
       77 STO-tordini-k-stbolle-SPLITBUF  PIC X(34).
       77 STO-tordini-k-andamento-data-SPLITBUF  PIC X(10).
       77 STO-tordini-k-andamento-cliente-SPLITBUF  PIC X(15).
       77 STO-tordini-k-andamento-clides-SPLITBUF  PIC X(20).
       77 STO-tordini-k-promo-SPLITBUF  PIC X(29).
       77 STO-tordini-k-or-SPLITBUF  PIC X(21).
       77 STO-tordini-k-tor-inviare-SPLITBUF  PIC X(14).
       77 STO-tordini-k-tor-tipocli-SPLITBUF  PIC X(25).
       77 STO-tordini-k-tor-gdo-SPLITBUF  PIC X(28).

      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
       78  78-ID-ef-user VALUE 5001.
       78  78-ID-ef-pass VALUE 5002.
       78  78-ID-ef-anno VALUE 5003.
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE

      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           HELP-ID 1,
           AFTER PROCEDURE Form1-AfterProcedure,
           BEFORE PROCEDURE Form1-BeforeProcedure,
           .

      * ENTRY FIELD
       05
           ef-user, 
           Entry-Field, 
           COL 21,60, 
           LINE 5,00,
           LINES 1,33 ,
           SIZE 21,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-user,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 10,
           VALUE ef-user-BUF,
           .

      * ENTRY FIELD
       05
           ef-pass, 
           Entry-Field, 
           COL 21,60, 
           LINE 7,00,
           LINES 1,33 ,
           SIZE 21,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-pass,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 20,
           SECURE,
           VALUE ef-pass-BUF,
           .

      * ENTRY FIELD
       05
           ef-anno, 
           Entry-Field, 
           COL 21,60, 
           LINE 9,00,
           LINES 1,33 ,
           SIZE 5,00 ,
           BOXED,
           COLOR IS 513,
           ID IS 78-ID-ef-anno,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RIGHT,
           MAX-TEXT 4,
           VALUE ef-anno-buf,
           AFTER PROCEDURE Form1-Ef-1-AfterProcedure, 
           BEFORE PROCEDURE Form1-Ef-1-BeforeProcedure, 
           .

      * CHECK BOX
       05
           chk-storico, 
           Check-Box, 
           COL 21,80, 
           LINE 10,61,
           LINES 1,33 ,
           SIZE 19,00 ,
           FLAT,
           ID IS 14,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE tit-storico,
           VALUE chk-storico-buf,
           VISIBLE 0,
           AFTER PROCEDURE Form1-Cb-1-AfterProcedure,
           BEFORE PROCEDURE Form1-Cb-1-BeforeProcedure, 
           .
      * FRAME
       05
           Screen1-Fr-2, 
           Frame, 
           COL 1,00, 
           LINE 11,83,
           LINES 2,78 ,
           SIZE 43,10 ,
           LOWERED,
           ID IS 8,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           .

      * PUSH BUTTON
       05
           PB-OK, 
           Push-Button, 
           COL 28,00, 
           LINE 12,44,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-OK-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1000,
           FLAT,
           HELP-ID 2,
           ID IS 1,
           SELF-ACT,
           TITLE "Accedi all'interno del sistema Geslux",
           AFTER PROCEDURE PB-OK-AfterProcedure, 
           BEFORE PROCEDURE PB-OK-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           PB-CANCEL, 
           Push-Button, 
           COL 35,80, 
           LINE 12,44,
           LINES 30,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE BOTTONE-CANCEL-BMP,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 27,
           FLAT,
           HELP-ID 3,
           ID IS 2,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "Esci dall'applicativo",
           AFTER PROCEDURE PB-CANCEL-AfterProcedure, 
           BEFORE PROCEDURE PB-CANCEL-BeforeProcedure, 
           .

      * LABEL
       05
           Form1-La-4, 
           Label, 
           COL 1,40, 
           LINE 13,72,
           LINES 0,78 ,
           SIZE 21,40 ,
           COLOR IS 2,
           FONT IS Verdana8-Occidentale,
           ID IS 13,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Release 2.7.1 del 13/10/2011",
           .

      * LABEL
       05
           Form1-La-1, 
           Label, 
           COL 11,50, 
           LINE 5,00,
           LINES 1,33 ,
           SIZE 8,00 ,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LABEL-OFFSET 0,
           TRANSPARENT,
           TITLE "Utente",
           .

      * LABEL
       05
           Form1-La-2, 
           Label, 
           COL 11,50, 
           LINE 7,00,
           LINES 1,33 ,
           SIZE 9,00 ,
           ID IS 4,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LABEL-OFFSET 0,
           TRANSPARENT,
           TITLE "Password",
           .

      * LABEL
       05
           Form1-La-3, 
           Label, 
           COL 6,80, 
           LINE 1,38,
           LINES 0,88 ,
           SIZE 18,00 ,
           COLOR IS 1,
           FONT IS Comic-Sans-MS22I,
           ID IS 7,
           CENTER,
           TRANSPARENT,
           TITLE "Gestione Commerciale",
           .

      * BITMAP
       05
           Form1-Bt-1, 
           Bitmap, 
           COL 1,90, 
           LINE 6,06,
           LINES 2,72 ,
           SIZE 8,30 ,
           TRANSPARENT-COLOR 16711935,
           BITMAP-HANDLE LUBEX-COLORI-BMP,
           BITMAP-NUMBER 1,
           ID IS 10,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           .

      * LABEL
       05
           Form1-La-2a, 
           Label, 
           COL 11,50, 
           LINE 9,00,
           LINES 1,33 ,
           SIZE 9,00 ,
           ID IS 12,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LABEL-OFFSET 0,
           TRANSPARENT,
           TITLE "Esercizio",
           .

      * LABEL
       05
           Form1-Custom1-1, 
           Label, 
           COL 3,30, 
           LINE 2,28,
           LINES 0,94 ,
           SIZE 1,50 ,
           FONT IS Default-Font,
           ID IS 9,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE        DIVISION.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:loginscrn, INIT:loginscrn, BeforeDeclarative>
      ***---
       USER-ERR SECTION.
           use after error procedure on USER.
           set tutto-ok  to true.
           evaluate status-USER
           when "35"
                display message "File [USER] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [USER] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[USER] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           end-evaluate.

       PASS-ERR SECTION.
           use after error procedure on pass.
           set tutto-ok to true.
           evaluate status-pass
           when "35"
           when "39"
           when "98"
                set errori to true
           end-evaluate.

       STO-TORDINI-ERR SECTION.
           use after error procedure on sto-tordini.
           set tutto-ok to true.
           evaluate status-sto-tordini
           when "35"
           when "39"
           when "98"
                set errori to true
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM loginscrn-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:loginscrn, INIT:loginscrn, BeforeDestroyResource>
      * <TOTEM:END>
           DESTROY Verdana8-Occidentale
           DESTROY Comic-Sans-MS22I
           DESTROY Verdana12-Occidentale
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-OK-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, BOTTONE-CANCEL-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, LUBEX-COLORI-BMP
      *    After-Program
           PERFORM loginscrn-Ev-After-Program
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
      *    After Init
           .
    
       INIT-FONT.
      * Verdana8-Occidentale
           INITIALIZE WFONT-DATA Verdana8-Occidentale
           MOVE 8 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana8-Occidentale, WFONT-DATA
      * Comic-Sans-MS22I
           INITIALIZE WFONT-DATA Comic-Sans-MS22I
           MOVE 22 TO WFONT-SIZE
           MOVE "Comic Sans MS" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO TRUE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Comic-Sans-MS22I, WFONT-DATA
      * Verdana12-Occidentale
           INITIALIZE WFONT-DATA Verdana12-Occidentale
           MOVE 12 TO WFONT-SIZE
           MOVE "Verdana" TO WFONT-NAME
           SET WFCHARSET-DONT-CARE TO TRUE
           SET WFONT-BOLD TO FALSE
           SET WFONT-ITALIC TO FALSE
           SET WFONT-UNDERLINE TO FALSE
           SET WFONT-STRIKEOUT TO FALSE
           SET WFONT-FIXED-PITCH TO FALSE
           MOVE 0 TO WFONT-CHAR-SET
           CALL "W$FONT" USING WFONT-GET-FONT, 
                     Verdana12-Occidentale, WFONT-DATA
           .

       INIT-BMP.
      * PB-OK
           COPY RESOURCE "BOTTONE-OK.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-OK.BMP", 
                   GIVING BOTTONE-OK-BMP.
      * PB-CANCEL
           COPY RESOURCE "BOTTONE-CANCEL.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "BOTTONE-CANCEL.BMP", 
                   GIVING BOTTONE-CANCEL-BMP.
      * Form1-Bt-1
           COPY RESOURCE "LUBEX-COLORI.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "LUBEX-COLORI.BMP", 
                   GIVING LUBEX-COLORI-BMP.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-USER
           PERFORM OPEN-tconvanno
      *    pass OPEN MODE IS FALSE
      *    PERFORM OPEN-pass
      *    STO-tordini OPEN MODE IS FALSE
      *    PERFORM OPEN-STO-tordini
      *    After Open
           .

       OPEN-USER.
      * <TOTEM:EPT. INIT:loginscrn, FD:USER, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT USER
           IF NOT VALID-STATUS-USER
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:loginscrn, FD:USER, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tconvanno.
      * <TOTEM:EPT. INIT:loginscrn, FD:tconvanno, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tconvanno
           IF NOT Valid-STATUS-tconvanno
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:loginscrn, FD:tconvanno, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-pass.
      * <TOTEM:EPT. INIT:loginscrn, FD:pass, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT pass
           IF NOT Valid-STATUS-pass
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:loginscrn, FD:pass, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-STO-tordini.
      * <TOTEM:EPT. INIT:loginscrn, FD:STO-tordini, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O STO-tordini
           IF STATUS-STO-tordini = "35"
              OPEN OUTPUT STO-tordini
                IF Valid-STATUS-sto-tordini
                   CLOSE STO-tordini
                   OPEN I-O STO-tordini
                END-IF
           END-IF
           IF NOT Valid-STATUS-sto-tordini
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:loginscrn, FD:STO-tordini, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-USER
           PERFORM CLOSE-tconvanno
      *    pass CLOSE MODE IS FALSE
      *    PERFORM CLOSE-pass
      *    STO-tordini CLOSE MODE IS FALSE
      *    PERFORM CLOSE-STO-tordini
      *    After Close
           .

       CLOSE-USER.
      * <TOTEM:EPT. INIT:loginscrn, FD:USER, BeforeClose>
      * <TOTEM:END>
           CLOSE USER
           .

       CLOSE-tconvanno.
      * <TOTEM:EPT. INIT:loginscrn, FD:tconvanno, BeforeClose>
      * <TOTEM:END>
           CLOSE tconvanno
           .

       CLOSE-pass.
      * <TOTEM:EPT. INIT:loginscrn, FD:pass, BeforeClose>
      * <TOTEM:END>
           .

       CLOSE-STO-tordini.
      * <TOTEM:EPT. INIT:loginscrn, FD:STO-tordini, BeforeClose>
      * <TOTEM:END>
           .

       DataSet1-USER-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 MOVE Low-Value TO user-chiave
              ELSE
                 MOVE High-Value TO user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-USER-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 MOVE High-Value TO user-chiave
              ELSE
                 MOVE Low-Value TO user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-USER-KEY1-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-USER-KEY1-ORDER
           END-EVALUATE
           .

      * USER
       DataSet1-USER-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 START USER KEY >= user-chiave
              ELSE
                 START USER KEY <= user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-USER-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 START USER KEY <= user-chiave
              ELSE
                 START USER KEY >= user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-USER-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 START USER KEY > user-chiave
              ELSE
                 START USER KEY < user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-USER-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 START USER KEY < user-chiave
              ELSE
                 START USER KEY > user-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-USER-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-LOCK
                 READ USER WITH LOCK 
                 KEY user-chiave
              ELSE
                 READ USER WITH NO LOCK 
                 KEY user-chiave
              END-IF
           END-EVALUATE
           MOVE STATUS-USER TO TOTEM-ERR-STAT 
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-USER-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 IF DataSet1-USER-LOCK
                    READ USER NEXT WITH LOCK
                 ELSE
                    READ USER NEXT WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-USER-LOCK
                    READ USER PREVIOUS WITH LOCK
                 ELSE
                    READ USER PREVIOUS WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-USER TO TOTEM-ERR-STAT
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-USER-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-USER-KEY1-Asc
                 IF DataSet1-USER-LOCK
                    READ USER PREVIOUS WITH LOCK
                 ELSE
                    READ USER PREVIOUS WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-USER-LOCK
                    READ USER NEXT WITH LOCK
                 ELSE
                    READ USER NEXT WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-USER TO TOTEM-ERR-STAT
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-USER-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-USER TO TOTEM-ERR-STAT
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-USER-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-USER TO TOTEM-ERR-STAT
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-USER-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:USER, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-USER TO TOTEM-ERR-STAT
           MOVE "USER" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:USER, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-INITSTART.
           IF DataSet1-tconvanno-KEY-Asc
              MOVE Low-Value TO cnv-chiave
           ELSE
              MOVE High-Value TO cnv-chiave
           END-IF
           .

       DataSet1-tconvanno-INITEND.
           IF DataSet1-tconvanno-KEY-Asc
              MOVE High-Value TO cnv-chiave
           ELSE
              MOVE Low-Value TO cnv-chiave
           END-IF
           .

      * tconvanno
       DataSet1-tconvanno-START.
           IF DataSet1-tconvanno-KEY-Asc
              START tconvanno KEY >= cnv-chiave
           ELSE
              START tconvanno KEY <= cnv-chiave
           END-IF
           .

       DataSet1-tconvanno-START-NOTGREATER.
           IF DataSet1-tconvanno-KEY-Asc
              START tconvanno KEY <= cnv-chiave
           ELSE
              START tconvanno KEY >= cnv-chiave
           END-IF
           .

       DataSet1-tconvanno-START-GREATER.
           IF DataSet1-tconvanno-KEY-Asc
              START tconvanno KEY > cnv-chiave
           ELSE
              START tconvanno KEY < cnv-chiave
           END-IF
           .

       DataSet1-tconvanno-START-LESS.
           IF DataSet1-tconvanno-KEY-Asc
              START tconvanno KEY < cnv-chiave
           ELSE
              START tconvanno KEY > cnv-chiave
           END-IF
           .

       DataSet1-tconvanno-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tconvanno-LOCK
              READ tconvanno WITH LOCK 
              KEY cnv-chiave
           ELSE
              READ tconvanno WITH NO LOCK 
              KEY cnv-chiave
           END-IF
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT 
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tconvanno-KEY-Asc
              IF DataSet1-tconvanno-LOCK
                 READ tconvanno NEXT WITH LOCK
              ELSE
                 READ tconvanno NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tconvanno-LOCK
                 READ tconvanno PREVIOUS WITH LOCK
              ELSE
                 READ tconvanno PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tconvanno-KEY-Asc
              IF DataSet1-tconvanno-LOCK
                 READ tconvanno PREVIOUS WITH LOCK
              ELSE
                 READ tconvanno PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tconvanno-LOCK
                 READ tconvanno NEXT WITH LOCK
              ELSE
                 READ tconvanno NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tconvanno-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tconvanno TO TOTEM-ERR-STAT
           MOVE "tconvanno" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tconvanno, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-pass-INITSTART.
           .

       DataSet1-pass-INITEND.
           .

       DataSet1-pass-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-pass-LOCK
              READ pass WITH LOCK 
           ELSE
              READ pass WITH NO LOCK 
           END-IF
           MOVE STATUS-pass TO TOTEM-ERR-STAT 
           MOVE "pass" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-pass-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-pass-KEY-Asc
              IF DataSet1-pass-LOCK
                 READ pass NEXT WITH LOCK
              ELSE
                 READ pass NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-pass TO TOTEM-ERR-STAT
           MOVE "pass" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-pass-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeReadPrev>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-pass-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-pass TO TOTEM-ERR-STAT
           MOVE "pass" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-pass-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-pass TO TOTEM-ERR-STAT
           MOVE "pass" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-pass-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:pass, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-pass TO TOTEM-ERR-STAT
           MOVE "pass" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:pass, AfterDelete>
      * <TOTEM:END>
           .

       STO-tordini-k-causale-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-causale-SPLITBUF
           MOVE STO-tor-causale(1:4) TO 
           STO-tordini-k-causale-SPLITBUF(1:4)
           MOVE STO-tor-anno(1:4) TO STO-tordini-k-causale-SPLITBUF(5:4)
           MOVE STO-tor-numero(1:8) TO 
           STO-tordini-k-causale-SPLITBUF(9:8)
           .

       STO-tordini-k1-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k1-SPLITBUF
           MOVE STO-tor-cod-cli(1:5) TO STO-tordini-k1-SPLITBUF(1:5)
           MOVE STO-tor-prg-destino(1:5) TO STO-tordini-k1-SPLITBUF(6:5)
           MOVE STO-tor-anno(1:4) TO STO-tordini-k1-SPLITBUF(11:4)
           MOVE STO-tor-numero(1:8) TO STO-tordini-k1-SPLITBUF(15:8)
           .

       STO-tordini-k2-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k2-SPLITBUF
           MOVE STO-tor-data-passaggio-ordine(1:8) TO 
           STO-tordini-k2-SPLITBUF(1:8)
           MOVE STO-tor-anno(1:4) TO STO-tordini-k2-SPLITBUF(9:4)
           MOVE STO-tor-numero(1:8) TO STO-tordini-k2-SPLITBUF(13:8)
           .

       STO-tordini-k-bolla-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-bolla-SPLITBUF
           MOVE STO-tor-anno-bolla(1:4) TO 
           STO-tordini-k-bolla-SPLITBUF(1:4)
           MOVE STO-tor-num-bolla(1:8) TO 
           STO-tordini-k-bolla-SPLITBUF(5:8)
           .

       STO-tordini-k3-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k3-SPLITBUF
           MOVE STO-tor-anno-bolla(1:4) TO STO-tordini-k3-SPLITBUF(1:4)
           MOVE STO-tor-data-bolla(1:8) TO STO-tordini-k3-SPLITBUF(5:8)
           MOVE STO-tor-num-bolla(1:8) TO STO-tordini-k3-SPLITBUF(13:8)
           MOVE STO-tor-bolla-prenotata(1:1) TO 
           STO-tordini-k3-SPLITBUF(21:1)
           .

       STO-tordini-k-fattura-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-fattura-SPLITBUF
           MOVE STO-tor-anno-fattura(1:4) TO 
           STO-tordini-k-fattura-SPLITBUF(1:4)
           MOVE STO-tor-num-fattura(1:8) TO 
           STO-tordini-k-fattura-SPLITBUF(5:8)
           .

       STO-tordini-k4-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k4-SPLITBUF
           MOVE STO-tor-anno-fattura(1:4) TO 
           STO-tordini-k4-SPLITBUF(1:4)
           MOVE STO-tor-data-fattura(1:8) TO 
           STO-tordini-k4-SPLITBUF(5:8)
           MOVE STO-tor-num-fattura(1:8) TO 
           STO-tordini-k4-SPLITBUF(13:8)
           MOVE STO-tor-num-prenot(1:8) TO STO-tordini-k4-SPLITBUF(21:8)
           MOVE STO-tor-fatt-prenotata(1:1) TO 
           STO-tordini-k4-SPLITBUF(29:1)
           .

       STO-tordini-k-contab-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-contab-SPLITBUF
           MOVE STO-tor-agg-contab(1:1) TO 
           STO-tordini-k-contab-SPLITBUF(1:1)
           MOVE STO-tor-anno-fattura(1:4) TO 
           STO-tordini-k-contab-SPLITBUF(2:4)
           MOVE STO-tor-num-fattura(1:8) TO 
           STO-tordini-k-contab-SPLITBUF(6:8)
           .

       STO-tordini-k-tipo-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-tipo-SPLITBUF
           MOVE STO-tor-tipo(1:1) TO STO-tordini-k-tipo-SPLITBUF(1:1)
           MOVE STO-tor-chiave(1:12) TO 
           STO-tordini-k-tipo-SPLITBUF(2:12)
           .

       STO-tordini-k-data-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-data-SPLITBUF
           MOVE STO-tor-data-creazione(1:8) TO 
           STO-tordini-k-data-SPLITBUF(1:8)
           MOVE STO-tor-numero(1:8) TO STO-tordini-k-data-SPLITBUF(9:8)
           .

       STO-tordini-k-agfatt-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-agfatt-SPLITBUF
           MOVE STO-tor-anno-fattura(1:4) TO 
           STO-tordini-k-agfatt-SPLITBUF(1:4)
           MOVE STO-tor-data-fattura(1:8) TO 
           STO-tordini-k-agfatt-SPLITBUF(5:8)
           MOVE STO-tor-num-fattura(1:8) TO 
           STO-tordini-k-agfatt-SPLITBUF(13:8)
           MOVE STO-tor-num-prenot(1:8) TO 
           STO-tordini-k-agfatt-SPLITBUF(21:8)
           MOVE STO-tor-fatt-prenotata(1:1) TO 
           STO-tordini-k-agfatt-SPLITBUF(29:1)
           MOVE STO-tor-chiave(1:12) TO 
           STO-tordini-k-agfatt-SPLITBUF(30:12)
           .

       STO-tordini-k-stbolle-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-stbolle-SPLITBUF
           MOVE STO-tor-anno-bolla(1:4) TO 
           STO-tordini-k-stbolle-SPLITBUF(1:4)
           MOVE STO-tor-data-bolla(1:8) TO 
           STO-tordini-k-stbolle-SPLITBUF(5:8)
           MOVE STO-tor-num-bolla(1:8) TO 
           STO-tordini-k-stbolle-SPLITBUF(13:8)
           MOVE STO-tor-bolla-prenotata(1:1) TO 
           STO-tordini-k-stbolle-SPLITBUF(21:1)
           MOVE STO-tor-chiave(1:12) TO 
           STO-tordini-k-stbolle-SPLITBUF(22:12)
           .

       STO-tordini-k-andamento-data-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-andamento-data-SPLITBUF
           MOVE STO-tor-agg-contab(1:1) TO 
           STO-tordini-k-andamento-data-SPLITBUF(1:1)
           MOVE STO-tor-data-fattura(1:8) TO 
           STO-tordini-k-andamento-data-SPLITBUF(2:8)
           .

       STO-tordini-k-andamento-cliente-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-andamento-cliente-SPLITBUF
           MOVE STO-tor-cod-cli(1:5) TO 
           STO-tordini-k-andamento-cliente-SPLITBUF(1:5)
           MOVE STO-tor-agg-contab(1:1) TO 
           STO-tordini-k-andamento-cliente-SPLITBUF(6:1)
           MOVE STO-tor-data-fattura(1:8) TO 
           STO-tordini-k-andamento-cliente-SPLITBUF(7:8)
           .

       STO-tordini-k-andamento-clides-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-andamento-clides-SPLITBUF
           MOVE STO-tor-cod-cli(1:5) TO 
           STO-tordini-k-andamento-clides-SPLITBUF(1:5)
           MOVE STO-tor-prg-destino(1:5) TO 
           STO-tordini-k-andamento-clides-SPLITBUF(6:5)
           MOVE STO-tor-agg-contab(1:1) TO 
           STO-tordini-k-andamento-clides-SPLITBUF(11:1)
           MOVE STO-tor-data-fattura(1:8) TO 
           STO-tordini-k-andamento-clides-SPLITBUF(12:8)
           .

       STO-tordini-k-promo-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-promo-SPLITBUF
           MOVE STO-tor-stato(1:1) TO STO-tordini-k-promo-SPLITBUF(1:1)
           MOVE STO-tor-promo(1:1) TO STO-tordini-k-promo-SPLITBUF(2:1)
           MOVE STO-tor-data-ordine(1:8) TO 
           STO-tordini-k-promo-SPLITBUF(3:8)
           MOVE STO-tor-numero(1:8) TO 
           STO-tordini-k-promo-SPLITBUF(11:8)
           MOVE STO-tor-cod-cli(1:5) TO 
           STO-tordini-k-promo-SPLITBUF(19:5)
           MOVE STO-tor-prg-destino(1:5) TO 
           STO-tordini-k-promo-SPLITBUF(24:5)
           .

       STO-tordini-k-or-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-or-SPLITBUF
           MOVE STO-tor-cod-cli(1:5) TO STO-tordini-k-or-SPLITBUF(1:5)
           MOVE STO-tor-prg-destino(1:5) TO 
           STO-tordini-k-or-SPLITBUF(6:5)
           MOVE STO-tor-num-ord-cli(1:10) TO 
           STO-tordini-k-or-SPLITBUF(11:10)
           .

       STO-tordini-k-tor-inviare-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-tor-inviare-SPLITBUF
           MOVE STO-tor-da-inviare OF STO-tordini(1:1) TO 
           STO-tordini-k-tor-inviare-SPLITBUF(1:1)
           MOVE STO-tor-chiave OF STO-tordini(1:12) TO 
           STO-tordini-k-tor-inviare-SPLITBUF(2:12)
           .

       STO-tordini-k-tor-tipocli-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-tor-tipocli-SPLITBUF
           MOVE STO-tor-tipocli OF STO-tordini(1:2) TO 
           STO-tordini-k-tor-tipocli-SPLITBUF(1:2)
           MOVE STO-tor-cod-cli OF STO-tordini(1:5) TO 
           STO-tordini-k-tor-tipocli-SPLITBUF(3:5)
           MOVE STO-tor-prg-destino OF STO-tordini(1:5) TO 
           STO-tordini-k-tor-tipocli-SPLITBUF(8:5)
           MOVE STO-tor-chiave OF STO-tordini(1:12) TO 
           STO-tordini-k-tor-tipocli-SPLITBUF(13:12)
           .

       STO-tordini-k-tor-gdo-MERGE-SPLITBUF.
           INITIALIZE STO-tordini-k-tor-gdo-SPLITBUF
           MOVE STO-tor-gdo OF STO-tordini(1:5) TO 
           STO-tordini-k-tor-gdo-SPLITBUF(1:5)
           MOVE STO-tor-cod-cli OF STO-tordini(1:5) TO 
           STO-tordini-k-tor-gdo-SPLITBUF(6:5)
           MOVE STO-tor-prg-destino OF STO-tordini(1:5) TO 
           STO-tordini-k-tor-gdo-SPLITBUF(11:5)
           MOVE STO-tor-chiave OF STO-tordini(1:12) TO 
           STO-tordini-k-tor-gdo-SPLITBUF(16:12)
           .

       DataSet1-STO-tordini-INITSTART.
           IF DataSet1-STO-tordini-KEY-Asc
              MOVE Low-Value TO STO-tor-chiave
           ELSE
              MOVE High-Value TO STO-tor-chiave
           END-IF
           .

       DataSet1-STO-tordini-INITEND.
           IF DataSet1-STO-tordini-KEY-Asc
              MOVE High-Value TO STO-tor-chiave
           ELSE
              MOVE Low-Value TO STO-tor-chiave
           END-IF
           .

      * STO-tordini
       DataSet1-STO-tordini-START.
           IF DataSet1-STO-tordini-KEY-Asc
              START STO-tordini KEY >= STO-tor-chiave
           ELSE
              START STO-tordini KEY <= STO-tor-chiave
           END-IF
           .

       DataSet1-STO-tordini-START-NOTGREATER.
           IF DataSet1-STO-tordini-KEY-Asc
              START STO-tordini KEY <= STO-tor-chiave
           ELSE
              START STO-tordini KEY >= STO-tor-chiave
           END-IF
           .

       DataSet1-STO-tordini-START-GREATER.
           IF DataSet1-STO-tordini-KEY-Asc
              START STO-tordini KEY > STO-tor-chiave
           ELSE
              START STO-tordini KEY < STO-tor-chiave
           END-IF
           .

       DataSet1-STO-tordini-START-LESS.
           IF DataSet1-STO-tordini-KEY-Asc
              START STO-tordini KEY < STO-tor-chiave
           ELSE
              START STO-tordini KEY > STO-tor-chiave
           END-IF
           .

       DataSet1-STO-tordini-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-STO-tordini-LOCK
              READ STO-tordini WITH LOCK 
              KEY STO-tor-chiave
           ELSE
              READ STO-tordini WITH NO LOCK 
              KEY STO-tor-chiave
           END-IF
           PERFORM STO-tordini-k-causale-MERGE-SPLITBUF
           PERFORM STO-tordini-k1-MERGE-SPLITBUF
           PERFORM STO-tordini-k2-MERGE-SPLITBUF
           PERFORM STO-tordini-k-bolla-MERGE-SPLITBUF
           PERFORM STO-tordini-k3-MERGE-SPLITBUF
           PERFORM STO-tordini-k-fattura-MERGE-SPLITBUF
           PERFORM STO-tordini-k4-MERGE-SPLITBUF
           PERFORM STO-tordini-k-contab-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tipo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-agfatt-MERGE-SPLITBUF
           PERFORM STO-tordini-k-stbolle-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-cliente-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-clides-MERGE-SPLITBUF
           PERFORM STO-tordini-k-promo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-or-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-inviare-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-tipocli-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-gdo-MERGE-SPLITBUF
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT 
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-STO-tordini-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-STO-tordini-KEY-Asc
              IF DataSet1-STO-tordini-LOCK
                 READ STO-tordini NEXT WITH LOCK
              ELSE
                 READ STO-tordini NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-STO-tordini-LOCK
                 READ STO-tordini PREVIOUS WITH LOCK
              ELSE
                 READ STO-tordini PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM STO-tordini-k-causale-MERGE-SPLITBUF
           PERFORM STO-tordini-k1-MERGE-SPLITBUF
           PERFORM STO-tordini-k2-MERGE-SPLITBUF
           PERFORM STO-tordini-k-bolla-MERGE-SPLITBUF
           PERFORM STO-tordini-k3-MERGE-SPLITBUF
           PERFORM STO-tordini-k-fattura-MERGE-SPLITBUF
           PERFORM STO-tordini-k4-MERGE-SPLITBUF
           PERFORM STO-tordini-k-contab-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tipo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-agfatt-MERGE-SPLITBUF
           PERFORM STO-tordini-k-stbolle-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-cliente-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-clides-MERGE-SPLITBUF
           PERFORM STO-tordini-k-promo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-or-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-inviare-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-tipocli-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-gdo-MERGE-SPLITBUF
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-STO-tordini-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-STO-tordini-KEY-Asc
              IF DataSet1-STO-tordini-LOCK
                 READ STO-tordini PREVIOUS WITH LOCK
              ELSE
                 READ STO-tordini PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-STO-tordini-LOCK
                 READ STO-tordini NEXT WITH LOCK
              ELSE
                 READ STO-tordini NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM STO-tordini-k-causale-MERGE-SPLITBUF
           PERFORM STO-tordini-k1-MERGE-SPLITBUF
           PERFORM STO-tordini-k2-MERGE-SPLITBUF
           PERFORM STO-tordini-k-bolla-MERGE-SPLITBUF
           PERFORM STO-tordini-k3-MERGE-SPLITBUF
           PERFORM STO-tordini-k-fattura-MERGE-SPLITBUF
           PERFORM STO-tordini-k4-MERGE-SPLITBUF
           PERFORM STO-tordini-k-contab-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tipo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-agfatt-MERGE-SPLITBUF
           PERFORM STO-tordini-k-stbolle-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-data-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-cliente-MERGE-SPLITBUF
           PERFORM STO-tordini-k-andamento-clides-MERGE-SPLITBUF
           PERFORM STO-tordini-k-promo-MERGE-SPLITBUF
           PERFORM STO-tordini-k-or-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-inviare-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-tipocli-MERGE-SPLITBUF
           PERFORM STO-tordini-k-tor-gdo-MERGE-SPLITBUF
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-STO-tordini-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeWrite>
      * <TOTEM:END>
           WRITE STO-tor-rec OF STO-tordini.
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-STO-tordini-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeRewrite>
      * <TOTEM:END>
           REWRITE STO-tor-rec OF STO-tordini.
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-STO-tordini-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, BeforeDelete>
      * <TOTEM:END>
           DELETE STO-tordini.
           MOVE STATUS-STO-tordini TO TOTEM-ERR-STAT
           MOVE "STO-tordini" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:STO-tordini, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-INIT-RECORD.
           INITIALIZE user-rec OF USER
           INITIALIZE cnv-rec OF tconvanno
           INITIALIZE pass-rec OF pass
           INITIALIZE STO-tor-rec OF STO-tordini
           .


      * FD's Initialize Paragraph
       DataSet1-USER-INITREC.
           INITIALIZE user-rec OF USER
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tconvanno-INITREC.
           INITIALIZE cnv-rec OF tconvanno
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-pass-INITREC.
           INITIALIZE pass-rec OF pass
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-STO-tordini-INITREC.
           INITIALIZE STO-tor-rec OF STO-tordini
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 1 ALSO 0
                  PERFORM Form1-Buf-To-Fld
           END-EVALUATE
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Standard GRAPHICAL WINDOW
              LINES 13,61,
              SIZE 43,10,
              COLOR 131329,
              CONTROL FONT Verdana12-Occidentale,
              CONTROLS-UNCROPPED,
              LABEL-OFFSET 0,
              LINK TO THREAD,
              MODELESS,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              WITH SYSTEM MENU,
              USER-GRAY,
           VISIBLE 0,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Form1-Event,
              HANDLE IS Form1-SF-HANDLE,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY Form1 UPON Form1-SF-HANDLE
      * DISPLAY-COLUMNS settings
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
           accept path-archivi-sto from environment "PATH_ARCHIVI_STO".
           if path-archivi-sto not = spaces
              inspect path-archivi-sto replacing trailing spaces by 
           low-value
              initialize PATH-STO-TORDINI
              string path-archivi-sto delimited low-value
                     "tordini"        delimited size
                into PATH-STO-TORDINI
              end-string                   
              move 0 to anno-sto
              open input sto-tordini
              if status-sto-tordini = "00"
                 move high-value to sto-tor-chiave
                 start sto-tordini key <= sto-tor-chiave
                       invalid continue
                   not invalid read sto-tordini previous
                 end-start
                 move sto-tor-anno to anno-sto       
                 close      sto-tordini
              end-if
              if anno-sto > 0
                 string "Storico fino al " delimited size
                        anno-sto           delimited size
                   into tit-storico
                 end-string
                 modify chk-storico, visible true, title tit-storico
              end-if    
           end-if.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Form1-SF-HANDLE
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = 1000
                 PERFORM PB-OK-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1 UPON Form1-SF-HANDLE
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
      *    centro la screen
           move Form1-SF-HANDLE to textsize-window.

           inquire Form1-SF-HANDLE, LINES window-height
                                    size  window-size.
      
           perform CALCOLA-CENTRO-WINDOW.

           modify Form1-SF-HANDLE, SCREEN LINE window-line
                                   SCREEN COL window-col.

      *    richiamo della splash
      *     Call Thread "splash" handle in trd-splash  using h-splash.
      *     Call "C$SLEEP" using 1.
      *
      *     Set Stop-Splash to true.  
      *     send messaggio to trd-splash.
      *     Wait for     trd-splash.
      *     Move ZERO to trd-splash.

           Modify Form1-SF-Handle, visible 1.

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
           .

       Form1-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-USER-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-USER-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Update-Key.
           MOVE user-rec OF USER TO
                     Form1-MULKEY-TMPBUF
           PERFORM Form1-CLEAR
           PERFORM Form1-INIT-DATA
           MOVE Form1-MULKEY-TMPBUF TO
                     user-rec OF USER
           PERFORM DataSet1-USER-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
           .

       Form1-DUPLICATE-MOVEKEY.
           .

       Form1-First.
           PERFORM Form1-DUMMY-FIRST
           PERFORM DataSet1-USER-INITSTART
           PERFORM DataSet1-USER-START
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-USER-Read-Next
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFirst>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Previous.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-USER-START-LESS
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-USER-Read-Prev
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterPrevious>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-PREVIOUS
           PERFORM Form1-IUD-Display
           .

       Form1-Next.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-USER-START-GREATER
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-USER-Read-Next
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterNext>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-NEXT
           PERFORM Form1-IUD-Display
           .
      
       Form1-Last.
           PERFORM Form1-DUMMY-LAST
           PERFORM DataSet1-USER-INITEND
           PERFORM DataSet1-USER-START-NOTGREATER
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-USER-Read-Prev
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterLast>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Curr.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-USER-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCurrent>
      * <TOTEM:END>
           .

       Form1-IUD-Display.
           IF VALID-STATUS-USER
              PERFORM Form1-ALLGRID-RESET
              PERFORM Form1-Fld-To-Buf
              PERFORM Form1-NAVI-FOR-MASTERGRID
              PERFORM Form1-DISPLAY
           ELSE
              IF Form1-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Form1-Extended-File-Status
              END-IF
           END-IF
           .

       Form1-Add.
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-ADD
           PERFORM DataSet1-USER-INITREC
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-USER-Rec-Write
           IF VALID-STATUS-USER
              PERFORM Form1-RESUMMARY-INS
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAdd>
      * <TOTEM:END>
           .
     
       Form1-Update.
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-USER-START              
           IF NOT VALID-STATUS-USER
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-USER-Read
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-UPDATE
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-USER-Rec-Rewrite
           IF VALID-STATUS-USER
              PERFORM Form1-RESUMMARY-DEL
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterUpdate>
      * <TOTEM:END>
           .

       Form1-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDelete>
      * <TOTEM:END>
           PERFORM Form1-DUMMY-DELETE
      * delete
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-USER-Rec-Delete
           IF VALID-STATUS-USER
              PERFORM Form1-CLEAR
              PERFORM Form1-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to STATUS-USER
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDelete>
      * <TOTEM:END>
           PERFORM Form1-ERR-CHECKING
           .

       Form1-NAVI-FOR-MASTERGRID.
           .

       Form1-ERR-CHECKING.
           IF VALID-STATUS-USER
              PERFORM Form1-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Form1-Extended-File-Status
           END-IF
           .

       Form1-RESUMMARY-INS.
           .

       Form1-RESUMMARY-DEL.
           .


       Form1-DUMMY-FIRST.
           .

       Form1-DUMMY-PREVIOUS.
           .

       Form1-DUMMY-NEXT.
           .

       Form1-DUMMY-LAST.
           .

       Form1-DUMMY-CURR.
           .

       Form1-DUMMY-ADD.
           .

       Form1-DUMMY-UPDATE.
           .

       Form1-DUMMY-UPDATE-INIT.
           .

       Form1-DUMMY-DELETE.
           .

       Form1-DUMMY-DELETE-INIT.
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
           INITIALIZE Form1-BUF
      * FORM : Form1
           PERFORM DataSet1-INIT-RECORD
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
      * ef-user's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-user-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5001 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
      * ef-pass's Validation
           SET TOTEM-CHECK-OK TO FALSE
           PERFORM ef-pass-VALIDATION
           IF NOT TOTEM-CHECK-OK
               MOVE 4 TO ACCEPT-CONTROL
               MOVE 5002 TO CONTROL-ID
               EXIT PARAGRAPH
           END-IF
           .

       ef-user-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-user, BeforeValidation>
      * <TOTEM:END>
           .

       ef-user-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-user, AfterValidation>
      * <TOTEM:END>
           .

      * ef-user's Validation
       ef-user-VALIDATION.
           PERFORM ef-user-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-user-AFTER-VALIDATION
           .

       ef-pass-BEFORE-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-pass, BeforeValidation>
      * <TOTEM:END>
           .

       ef-pass-AFTER-VALIDATION.
      * <TOTEM:EPT. FORM:Form1, Data.Entry-Field:ef-pass, AfterValidation>
      * <TOTEM:END>
           .

      * ef-pass's Validation
       ef-pass-VALIDATION.
           PERFORM ef-pass-BEFORE-VALIDATION
           SET TOTEM-CHECK-OK TO TRUE
           PERFORM ef-pass-AFTER-VALIDATION
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * DB_Entry-Field : ef-user
           MOVE ef-user-BUF TO user-cod
      * DB_Entry-Field : ef-pass
           MOVE ef-pass-BUF TO user-pass
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
      * <TOTEM:END>
      * DB_Entry-Field : ef-user
           MOVE user-cod TO ef-user-BUF
      * DB_Entry-Field : ef-pass
           MOVE user-pass TO ef-pass-BUF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.
           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           MOVE DataSet1-USER-KEY1-ORDER TO TMP-Form1-KEY1-ORDER
           MOVE DataSet1-KEYIS TO TMP-Form1-KEYIS
           MOVE user-rec OF USER TO 
              TMP-Form1-USER-RESTOREBUF
           .             

       Form1-Restore-Status.
           MOVE TMP-Form1-KEY1-ORDER TO DataSet1-USER-KEY1-ORDER
           MOVE TMP-Form1-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Form1-USER-RESTOREBUF TO
              user-rec OF USER
           PERFORM DataSet1-USER-START
           IF VALID-STATUS-USER
              PERFORM DataSet1-USER-Read-Next
           ELSE
              PERFORM DataSet1-USER-INITREC
           END-IF
           PERFORM UNTIL NOT VALID-STATUS-USER OR
              (VALID-STATUS-USER AND
                 user-rec OF USER = 
                   TMP-Form1-USER-RESTOREBUF)
              PERFORM DataSet1-USER-Read-Next
           END-PERFORM
           .


      * Paragrafo per la struttura del codice in AFTER sulla screen Form1
      ***---
       Form1-AFTER-SCREEN.

      * Generazione risettaggio keyboard "." ---> "."

      * Generazione stringa perform CONTROLLO
           evaluate control-id
           |78-ID-ef-user è l'ID del campo ef-user
           when 78-ID-ef-user
                perform CONTROLLO
           |78-ID-ef-pass è l'ID del campo ef-pass
           when 78-ID-ef-pass
                perform CONTROLLO
           |99999 è un valore fittizio, che non sarà MAI usato,
           |ma mi serve per non riscontrare errori di compilazione
           |in caso non avessi generato nulla nella AFTER CONTROLLO della screen
           when 99999 continue
           when other continue
           end-evaluate.



       Form1-BeforeProcedure.
           EVALUATE Control-Id
           WHEN 5001 MOVE "." to TOTEM-HINT-TEXT
           WHEN 5002 MOVE "." to TOTEM-HINT-TEXT
           WHEN OTHER MOVE SPACES TO TOTEM-HINT-TEXT
           END-EVALUATE
           EVALUATE Control-Id
           When 5001 PERFORM ef-1-BeforeProcedure
           When 5002 PERFORM EF-2-BeforeProcedure
           END-EVALUATE
           .

       Form1-AfterProcedure.
           EVALUATE Control-Id
           When 5001 PERFORM ef-1-AfterProcedure
           When 5002 PERFORM EF-2-AfterProcedure
           END-EVALUATE
           perform Form1-AFTER-SCREEN
           .

       Form1-Event-Extra.
           EVALUATE Event-Type
           WHEN Msg-Close
              PERFORM Form1-MSG-CLOSE
           END-EVALUATE.

       Form1-MSG-CLOSE.
           ACCEPT TOTEM-QUIT-MODE-FLAG FROM ENVIRONMENT "QUIT_MODE"
           IF TOTEM-QUIT-MODE-FLAG = ZEROS OR SPACES
              PERFORM Form1-Exit
              IF NOT Exit-Pushed
                 MOVE Event-Action-Fail TO Event-Action
              ELSE
                 PERFORM EXIT-STOP-ROUTINE
              END-IF
           END-IF
           .

       Form1-Event.
           IF Event-Control-Id = 0 AND
                 Event-Window-Handle = Form1-SF-HANDLE
              PERFORM Form1-Event-Extra
           END-IF
           .

      * USER DEFINE PARAGRAPH
       AGGIUNGI-6-MESI.
      * <TOTEM:PARA. AGGIUNGI-6-MESI>
           move user-pass-data to como-data.
           move como-data(1:4) to anno.
           move como-data(5:2) to mese.
           move como-data(7:2) to giorno.
           add  6 to mese.

           if mese > 12
              subtract 12 from mese
              add 1 to anno
           end-if.

           if mese = 2
              divide        anno by 4 giving como-anno
              multiply como-anno by 4 giving como-anno
              if como-anno = anno
                 set bisestile to true
              else
                 set bisestile to false
              end-if
              evaluate true
              when giorno >= 29
                   if bisestile
                      move 29 to giorno
                   else
                      move 28 to giorno
                   end-if
              end-evaluate
           else
              if giorno = 31
                 evaluate mese
                 when  4
                 when  6
                 when  9
                 when 11  move 30 to giorno
                 end-evaluate
              end-if
           end-if 
           .
      * <TOTEM:END>

       CONTROLLO.
      * <TOTEM:PARA. CONTROLLO>
           set tutto-ok to true.

      * Paragrafo per la struttura dei controlli sulla screen Form1
           evaluate control-id
           |78-ID-ef-user è l'ID del control ef-user
           when 78-ID-ef-user
                inquire ef-user, value in ef-user-buf
                move ef-user-buf to user-cod
                read user no lock
                     invalid
                     set errori to true
                     display message "Utente NON valido"
                               title tit-err
                                icon 2
                end-read

           |78-ID-ef-pass è l'ID del control ef-pass
           when 78-ID-ef-pass
                accept data-oggi from century-date
                inquire ef-pass, value in ef-pass-buf
                if ef-pass-buf not = user-pass
                   set errori to true
                   display message "Password NON valida"
                             title tit-err
                              icon 2
                else
                   perform AGGIUNGI-6-MESI
                   if data-validita < data-oggi
                      set errori to true
                      display message "La Password è scaduta!"
                                title tit-err
                                 icon 2
                      move user-cod to user-codi
                      modify form1-sf-handle, visible false
                      call   "gest-pwd" using lk-blockpgm
                                              user-codi
                                              livello-abil
                      cancel "gest-pwd"
                      move spaces to ef-pass-buf
                      display ef-pass
                      read user no lock invalid continue end-read
                      modify form1-sf-handle, visible true
                   end-if
                end-if

           |78-ID-ef-anno è l'ID del control ef-anno
           when 78-ID-ef-anno
                inquire ef-anno, value in ef-anno-buf
                move ef-anno-buf to como-anno
                if como-anno < 999
                   set errori to true
                   display message "Anno non valido"
                             title tit-err
                              icon 2
                else
                   move como-anno to cnv-anno-geslux
                   read tconvanno no lock
                        invalid
                        set errori to true
                        display message "Anno non intabellato per conver
      -    "sione"
                                 x"0d0a""Utilizzare funzione apposita e 
      -    "riprovare"
                                  title tit-err
                                   icon 2
                    not invalid
                        if cnv-anno-g2 = spaces
                           set errori to true
                           display message "Anno non intabellato per con
      -    "versione"
                                    x"0d0a""Utilizzare funzione apposita
      -    " e riprovare"
                                     title tit-err
                                      icon 2
                        end-if
                   end-read
                end-if

           end-evaluate.

           if errori
              perform CANCELLA-COLORE
              move 4        to accept-control
           end-if 
           .
      * <TOTEM:END>

       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "calcola-centro-window.cpy".
           copy "color-custom.cpy" 
           .
      * <TOTEM:END>

       CONTROLLO-PWD-EVASIONE.
      * <TOTEM:PARA. CONTROLLO-PWD-EVASIONE>
           accept path-txt from environment "PATH_ISOLATA".

           if path-txt = spaces
              move "passevaiso" to path-txt
           end-if.

           set tutto-ok to true.
           open input pass.
           if errori
              initialize pass-rec
           end-if
           if tutto-ok
              initialize pass-rec
              read pass next
                 at end
                    continue
              end-read
           end-if
           if pass-rec = space
              display message box "Ricordarsi di attivare la password"
                                  x"0D0A"
                                  "per la cancellazione delle sessioni."
                      title "Geslux - Evasione Isalota"
                      icon 2

           end-if.

           close pass
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       EF-2-BeforeProcedure.
      * <TOTEM:PARA. EF-2-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       EF-2-AfterProcedure.
      * <TOTEM:PARA. EF-2-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>

       loginscrn-Ev-Before-Program.
      * <TOTEM:PARA. loginscrn-Ev-Before-Program>
           display spaces upon syserr.
           display "*** STARTING GESLUX... ***" upon syserr.
      ***     set environment "keystroke" to "data=44   46".
      ***     set environment "keystroke" to "data=46   44".

           call "getpid"
           cancel "getpid"

           call   "genfiles" using link-status.
           cancel "genfiles".    

           if link-status = -1
              perform LOGINSCRN-EV-AFTER-PROGRAM
              goback
           end-if.

           call   "colors".
           cancel "colors" 
           .
      * <TOTEM:END>
       PB-CANCEL-BeforeProcedure.
      * <TOTEM:PARA. PB-CANCEL-BeforeProcedure>
           modify pb-cancel, bitmap-number = 2 
           .
      * <TOTEM:END>
       PB-CANCEL-AfterProcedure.
      * <TOTEM:PARA. PB-CANCEL-AfterProcedure>
           modify pb-cancel, bitmap-number = 1 
           .
      * <TOTEM:END>
       PB-OK-BeforeProcedure.
      * <TOTEM:PARA. PB-OK-BeforeProcedure>
           modify pb-ok, bitmap-number = 2 
           .
      * <TOTEM:END>
       PB-OK-AfterProcedure.
      * <TOTEM:PARA. PB-OK-AfterProcedure>
           modify pb-ok, bitmap-number = 1 
           .
      * <TOTEM:END>
       PB-OK-LinkTo.
      * <TOTEM:PARA. PB-OK-LinkTo>
           perform varying control-id from 78-ID-ef-user by 1
                     until control-id > 78-ID-ef-anno
              perform CONTROLLO
              if errori exit perform end-if
           end-perform.

           if tutto-ok  
              set environment "STORICO" to spaces
              if chk-storico-buf = 1                  
                 accept path-archivi from environment "FILE_PREFIX"
                 initialize path-archivi-completo
                 string path-archivi-sto delimited low-value
                        ";"              delimited size
                        path-archivi     delimited size
                        into path-archivi-completo
                 end-string
                 set environment "FILE_PREFIX" to path-archivi-completo 
                 set environment "STORICO" to "S"
              end-if
              accept como-data from century-date
              accept como-ora  from time
              modify form1-sf-handle, visible = 0
              initialize como-riga
              display como-riga               upon syserr
              display "*** LOGIN GESLUX ***"  upon syserr
              string "*** DATA: "   delimited size
                     como-data(7:2) delimited size
                     "/"            delimited size
                     como-data(5:2) delimited size
                     "/"            delimited size
                     como-data(1:4) delimited size
                     " - "          delimited size
                     "ORA: "        delimited size
                     como-ora(1:2)  delimited size
                     ":"            delimited size
                     como-ora(3:2)  delimited size
                     " USER: "      delimited size
                     user-cod       delimited size
                     into como-riga
              end-string
              move como-anno                 to anno-x
              set environment "ESERCIZIO"    to anno-x
              set environment "ESERCIZIO_G2" to cnv-anno-g2

              display como-riga upon syserr

      *        if user-cod = "BOSS"
      *           perform CONTROLLO-PWD-EVASIONE
      *        end-if
              set environment "USER_CODI" to user-cod
              call   "menu"  using user-cod
              cancel "menu"
              perform FORM1-EXIT
           end-if 
           .
      * <TOTEM:END>
       ef-1-BeforeProcedure.
      * <TOTEM:PARA. ef-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-1-AfterProcedure.
      * <TOTEM:PARA. ef-1-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR

           .
      * <TOTEM:END>

       loginscrn-Ev-After-Program.
      * <TOTEM:PARA. loginscrn-Ev-After-Program>
           display "*** ENDING GESLUX... ***" upon syserr 
           .
      * <TOTEM:END>
       Form1-Ef-1-BeforeProcedure.
      * <TOTEM:PARA. Form1-Ef-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       Form1-Ef-1-AfterProcedure.
      * <TOTEM:PARA. Form1-Ef-1-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           perform CONTROLLO 
           .
      * <TOTEM:END>
       Form1-Cb-1-BeforeProcedure.
      * <TOTEM:PARA. Form1-Cb-1-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       Form1-Cb-1-AfterProcedure.
      * <TOTEM:PARA. Form1-Cb-1-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

