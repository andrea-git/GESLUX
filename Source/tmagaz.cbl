      *{TOTEM}PRG-COMMENT
      * tmagaz.Cbl
      * tmagaz.Cbl is generated by TOTEM
      * This is a generated file. DO NOT modify this file directly.
      *{TOTEM}END
       IDENTIFICATION       DIVISION.
      *{TOTEM}PRGID
       PROGRAM-ID.          tmagaz.
       AUTHOR.              andre.
       DATE-WRITTEN.        mercoledì 14 giugno 2023 16:26:36.
       REMARKS.
      *{TOTEM}END

       ENVIRONMENT          DIVISION.
       CONFIGURATION        SECTION.
       SPECIAL-NAMES.
      *{TOTEM}SPECIAL-NAME
      * <TOTEM:EPT. INIT:tmagaz, INIT:tmagaz, SpecialName>
      * <TOTEM:END>
      *{TOTEM}END
      *{TOTEM}ACTIVEX-DEF
      *{TOTEM}END
      *{TOTEM}DECIMAL-POINT
           DECIMAL-POINT IS COMMA.
      *{TOTEM}END

       INPUT-OUTPUT         SECTION.
       FILE-CONTROL.
      *{TOTEM}FILE-CONTROL
           COPY "tmagaz.sl".
           COPY "tcaumag.sl".
           COPY "tscorte.sl".
           COPY "tvettori.sl".
      *{TOTEM}END
       DATA                 DIVISION.
       FILE                 SECTION.
      *{TOTEM}FILE
           COPY "tmagaz.fd".
           COPY "tcaumag.fd".
           COPY "tscorte.fd".
           COPY "tvettori.fd".
      *{TOTEM}END

       WORKING-STORAGE      SECTION.
      *{TOTEM}ACU-DEF
               COPY "acugui.def".
               COPY "acucobol.def".
               COPY "crtvars.def".
               COPY "showmsg.def".
               COPY "totem.def".
               COPY "standard.def".
      *{TOTEM}END

      *{TOTEM}COPY-WORKING
      * Key Status
       77 Key-Status IS SPECIAL-NAMES CRT STATUS PIC 9(5) VALUE 0.
          88 Enter-Pushed VALUE 13.
          88 Exit-Pushed VALUE 27.
          88 Message-Received VALUE 95.
          88 Event-Occurred VALUE 96.
          88 Screen-No-Input-Field VALUE 97.
      * Properties & User defined Working Stoarge
       77 STATUS-tmagaz    PIC  X(2).
           88 Valid-STATUS-tmagaz VALUE IS "00" THRU "09". 
       77 Form1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 TIPO-DATA        PIC  9(8)
                  VALUE IS 0.
       77 Form1-Tb-1-Handle
                  USAGE IS HANDLE OF WINDOW.
       78 titolo VALUE IS "Geslux - Tabella Magazzini". 
       77 E-ESCI           PIC  9
                  VALUE IS 1.
       77 E-NUOVO          PIC  9
                  VALUE IS 1.
       77 E-CANCELLA       PIC  9
                  VALUE IS 1.
       77 E-SALVA          PIC  9
                  VALUE IS 1.
       77 E-ANTEPRIMA      PIC  9
                  VALUE IS 0.
       77 E-MODIFICA       PIC  9
                  VALUE IS 1.
       77 E-STAMPA         PIC  9
                  VALUE IS 0.
       77 E-CERCA          PIC  9
                  VALUE IS 1.
       77 MESSAGGIO        PIC  X(300)
                  VALUE IS SPACE.
       77 SAV-LIVELLO-ABIL PIC  9(2).
       77 STATUS-USER      PIC  X(2).
           88 Valid-STATUS-USER VALUE IS "00" THRU "09". 
       77 Small-Font
                  USAGE IS HANDLE OF FONT SMALL-FONT.
       77 toolbar-bmp      PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 msg-help         PIC  x(150).
       77 como-xx          PIC  xx.
       77 confronto-xx     PIC  xx.
       01 rec-grid.
           05 col-id           PIC  x(03).
           05 col-des          PIC  X(50).
           05 col-princ        PIC  X.
               88 si-principale VALUE IS "S". 
               88 no-principale VALUE IS "N". 
           05 col-scritt       PIC  X.
               88 si-scritt VALUE IS "S". 
               88 no-scritt VALUE IS "N". 
           05 col-utf          PIC  X.
               88 si-utf VALUE IS "S". 
               88 no-utf VALUE IS "N". 
           05 col-perce        PIC  zz9,999.
           05 col-promo        PIC  X.
               88 si-promo VALUE IS "S". 
               88 no-promo VALUE IS "N". 
           05 col-causale      PIC  x(4).
           05 col-causale-omag PIC  x(4).
           05 col-sostituzione PIC  X.
               88 si-sostituzione VALUE IS "S". 
               88 no-sostituzione VALUE IS "N". 
           05 col-blister      PIC  X.
               88 si-blister VALUE IS "S". 
               88 no-blister VALUE IS "N". 
           05 col-ritira       PIC  X.
               88 si-ritira VALUE IS "S". 
               88 no-ritira VALUE IS "N". 
           05 col-cau-s        PIC  x(4).
           05 col-cau-c        PIC  x(4).
           05 col-reso         PIC  x(4).
           05 col-diff         PIC  x(4).
           05 col-vett         PIC  z(5).
           05 col-priorita-mag PIC  z.
           05 col-da-inviare   PIC  X.
               88 si-da-inviare VALUE IS "S". 
               88 no-da-inviare VALUE IS "N", " ". 
           05 col-gen-auto     PIC  X.
               88 col-gen-auto-si VALUE IS "S". 
               88 col-gen-auto-no VALUE IS "N", " ". 
           05 col-blocco-24000 PIC  x.
           05 col-carico-rot   PIC  xxxx.
           05 col-scarico-rot  PIC  xxxx.
           05 col-scorta       PIC  X.
               88 col-scorta-si VALUE IS "S". 
               88 col-scorta-no VALUE IS "N", " ". 
       77 Screen1-Handle
                  USAGE IS HANDLE OF WINDOW.
       77 esegui-73x21-bmp PIC  S9(9)
                  USAGE IS COMP-4
                  VALUE IS 0.
       77 FILLER           PIC  XX.
           88 prima-volta VALUE IS "SI"    WHEN SET TO FALSE  "NO". 
       77 cod  PIC  x(3).
       77 des  PIC  x(50).
       77 e-cod            PIC  9
                  VALUE IS 1.
       77 e-des            PIC  9
                  VALUE IS 0.
       77 Default-Font
                  USAGE IS HANDLE OF FONT DEFAULT-FONT.
       77 lab-des2         PIC  x(50).
       01 FILLER           PIC  XX.
           88 ricarica VALUE IS "SI"    WHEN SET TO FALSE  "NO". 
       77 risultato        PIC  9
                  VALUE IS ZERO.
       01 old-mag-rec.
           05 old-mag-chiave.
               10 old-mag-codice   PIC  x(3).
           05 old-mag-dati.
               10 old-mag-descrizione          PIC  x(50).
               10 old-mag-principale           PIC  X(1).
                   88 old-si-mag-principale VALUE IS "S". 
                   88 old-no-mag-principale VALUE IS "N". 
      *(( XFD NAME = mag-principale_1 ))
               10 old-mag-scr-aux  PIC  X(1).
                   88 old-mag-tutte VALUE IS "T". 
                   88 old-mag-solo-no-utf VALUE IS "S". 
                   88 old-mag-nessuno VALUE IS "N". 
      *(( XFD NAME = mag-principale_1_1 ))
               10 old-mag-utf      PIC  X(1).
                   88 old-mag-si-utf VALUE IS "S". 
                   88 old-mag-no-utf VALUE IS "N". 
               10 old-mag-dati-comuni.
                   15 old-mag-data-creazione       PIC  9(8).
                   15 old-mag-ora-creazione        PIC  9(8).
                   15 old-mag-utente-creazione     PIC  x(10).
                   15 old-mag-data-ultima-modifica PIC  9(8).
                   15 old-mag-ora-ultima-modifica  PIC  9(8).
                   15 old-mag-utente-ultima-modifica           PIC  
           x(10).
               10 old-mag-vuoti.
                   15 old-mag-perce-riordino       PIC  9(3)v999.
                   15 old-mag-causali.
                       20 old-mag-cau-c    PIC  x(4).
                       20 old-mag-cau-s    PIC  x(4).
                   15 old-mag-causali-bozza-nc.
      *(( XFD NAME = mag-cau-c_1 ))
                       20 old-mag-cau-reso PIC  x(4).
      *(( XFD NAME = mag-cau-s_1 ))
                       20 old-mag-cau-diff PIC  x(4).
                   15 old-mag-vettore  PIC  9(5).
                   15 old-mag-num-vuoto-3          PIC  9(18).
                   15 old-mag-per-promo            PIC  x.
                       88 old-mag-per-promo-si VALUE IS "S". 
                       88 old-mag-per-promo-no VALUE IS "N". 
                   15 old-mag-causale-eva          PIC  x(4).
                   15 old-mag-causale-omag         PIC  x(4).
                   15 old-mag-sostituzione         PIC  x.
                       88 old-mag-sostituzione-si VALUE IS "S". 
                       88 old-mag-sostituzione-no VALUE IS "N". 
      *(( XFD NAME = mag-principale_1_2 ))
                   15 old-mag-blocco-24000         PIC  X(1).
                       88 old-mag-blocco-24000-si VALUE IS "S". 
                       88 old-mag-blocco-24000-no VALUE IS "N", " ". 
                   15 old-mag-blister  PIC  x.
                       88 old-mag-blister-si VALUE IS "S". 
                       88 old-mag-blister-no VALUE IS "N". 
                   15 old-mag-tab-scorte.
                       20 old-mag-sco-codice           PIC  xx
                                  OCCURS 20 TIMES.
                   15 old-mag-ritira-lbx           PIC  x.
                       88 old-mag-ritira-lbx-si VALUE IS "S". 
                       88 old-mag-ritira-lbx-no VALUE IS "N". 
                   15 old-mag-priorita-mag         PIC  99.
                   15 old-mag-da-inviare           PIC  x.
                       88 old-mag-da-inviare-si VALUE IS "S". 
                       88 old-mag-da-inviare-no VALUE IS "N", " ". 
                   15 old-mag-gen-auto PIC  x.
                       88 old-mag-gen-auto-si VALUE IS "S". 
                       88 old-mag-gen-auto-no VALUE IS "N", " ". 
                   15 old-mag-scorta   PIC  x.
       77 FILLER           PIC  XX.
           88 trovato-uno VALUE IS "SI"    WHEN SET TO FALSE  "NO". 
           88 trovato-nessuno VALUE IS "NO". 
       77 totale-righe     PIC  9(5)
                  VALUE IS ZERO.
       77 cont PIC  9(5)
                  VALUE IS ZERO.
       77 old-riga         PIC  9(5)
                  VALUE IS ZERO.
       77 Form1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 Screen1-St-1-Handle
                  USAGE IS HANDLE OF STATUS-BAR.
       77 STATUS-tcaumag   PIC  X(2).
           88 Valid-STATUS-tcaumag VALUE IS "00" THRU "09". 
       01 gd-scorte-rec.
           05 col-codice       PIC  xx.
           05 col-descrizione  PIC  x(50).
       77 Large-Font
                  USAGE IS HANDLE OF FONT LARGE-FONT.
       77 STATUS-tscorte   PIC  X(2).
           88 Valid-STATUS-tscorte VALUE IS "00" THRU "09". 
       77 AUTO-ID          PIC  9(6)
                  VALUE IS 4.
       77 STATUS-tvettori  PIC  X(2).
           88 Valid-STATUS-tvettori VALUE IS "00" THRU "09". 

      ***********************************************************
      *   Code Gen's Buffer                                     *
      ***********************************************************
       77 STATUS-Form1-FLAG-REFRESH PIC  9.
          88 Form1-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-Form1-KEY1-ORDER  PIC X VALUE "A".
       77 TMP-Form1-tmagaz-RESTOREBUF  PIC X(212).
       77 TMP-Form1-KEYIS  PIC 9(3) VALUE 1.
       77 Form1-MULKEY-TMPBUF   PIC X(212).
       77 STATUS-SCREEN-SEARCH-FLAG-REFRESH PIC  9.
          88 SCREEN-SEARCH-FLAG-REFRESH  VALUE 1 FALSE 0. 
       77 TMP-DataSet1-tmagaz-BUF     PIC X(212).
       77 TMP-DataSet1-tcaumag-BUF     PIC X(254).
       77 TMP-DataSet1-tscorte-BUF     PIC X(205).
       77 TMP-DataSet1-tvettori-BUF     PIC X(1847).
      * VARIABLES FOR RECORD LENGTH.
       77  TotemFdSlRecordClearOffset   PIC 9(5) COMP-4.
       77  TotemFdSlRecordLength        PIC 9(5) COMP-4.
      * FILE'S LOCK MODE FLAG
       77 DataSet1-tmagaz-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tmagaz-LOCK  VALUE "Y".
       77 DataSet1-KEYIS   PIC 9(3) VALUE 1.
       77 DataSet1-tmagaz-KEY1-ORDER  PIC X VALUE "A".
          88 DataSet1-tmagaz-KEY1-Asc  VALUE "A".
          88 DataSet1-tmagaz-KEY1-Desc VALUE "D".
       77 DataSet1-tcaumag-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tcaumag-LOCK  VALUE "Y".
       77 DataSet1-tcaumag-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tcaumag-KEY-Asc  VALUE "A".
          88 DataSet1-tcaumag-KEY-Desc VALUE "D".
       77 DataSet1-tscorte-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tscorte-LOCK  VALUE "Y".
       77 DataSet1-tscorte-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tscorte-KEY-Asc  VALUE "A".
          88 DataSet1-tscorte-KEY-Desc VALUE "D".
       77 DataSet1-tvettori-LOCK-FLAG   PIC X VALUE SPACE.
           88 DataSet1-tvettori-LOCK  VALUE "Y".
       77 DataSet1-tvettori-KEY-ORDER  PIC X VALUE "A".
          88 DataSet1-tvettori-KEY-Asc  VALUE "A".
          88 DataSet1-tvettori-KEY-Desc VALUE "D".

       77 tcaumag-k-mag-SPLITBUF  PIC X(5).
       77 tvettori-k-des-SPLITBUF  PIC X(41).

      *{TOTEM}END

      *{TOTEM}ID-LOGICI
      ***** Elenco ID Logici *****
       78  78-ID-form1-gd-1 VALUE 5001.
       78  78-ID-gd-scorte VALUE 5002.
      ***** Fine ID Logici *****
      *{TOTEM}END

       LINKAGE          SECTION.
      *{TOTEM}LINKAGE
           COPY  "COMMON-LINKAGE.DEF".

      *{TOTEM}END

       SCREEN           SECTION.
      *{TOTEM}COPY-SCREEN
      * FORM
       01 
           Form1, 
           .

      * LABEL
       05
           CST-BLOCKPGM, 
           Label, 
           COL 49,57, 
           LINE 1,00,
           LINES 0,46 ,
           SIZE 14,43 ,
           ID IS 12,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "BlockPgm",
           VISIBLE v-custom,
           .

      * GRID
       05
           form1-gd-1, 
           Grid, 
           COL 2,00, 
           LINE 1,62,
           LINES 29,00 ,
           SIZE 261,17 ,
           ADJUSTABLE-COLUMNS,
           BOXED,
           DATA-COLUMNS (1, 4, 54, 55, 56, 57, 64, 65, 69, 73, 74, 75, 
           76, 80, 84, 88, 92, 97, 99, 100, 101, 102, 106, 110),
           ALIGNMENT ("L", "U", "C", "C", "C", "C", "C", "C", "C", "C", 
           "C", "C", "C", "C", "C", "C", "R", "R", "C", "C", "C", "U", 
           "U", "C"),
           SEPARATION (5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
           5, 5, 5, 5, 5, 5, 5, 5),
           DATA-TYPES ("U(3)", "X(50)", "U(1)", "U(1)", "U(1)", "9(7)", 
           "U(1)", "U(4)", "U(4)", "U(1)", "U(1)", "U(1)", "U(4)", "U(4)
      -    "", "U(4)", "U(4)", "zzzz9", "X", "U(1)", "U(1)", "U(1)", "U(
      -    "4)", "U(4)", "U(1)"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           HSCROLL,
           ID IS 78-ID-form1-gd-1,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           RECORD-DATA rec-grid,
           TILED-HEADINGS,
           USE-TAB,
           VIRTUAL-WIDTH 258,
           VPADDING 30,
           VSCROLL,
           EVENT PROCEDURE Form1-Gd-1-Event-Proc,
           .

      * GRID
       05
           gd-scorte, 
           Grid, 
           COL 106,00, 
           LINE 33,00,
           LINES 11,92 ,
           SIZE 53,17 ,
           BOXED,
           DATA-COLUMNS (1, 3),
           SEPARATION (5, 5),
           DATA-TYPES ("x(2)", "X"),
           NUM-COL-HEADINGS 1,
           COLUMN-HEADINGS,
           CURSOR-FRAME-WIDTH 2,
           DIVIDER-COLOR 1,
           HEADING-COLOR 257,
           HEADING-DIVIDER-COLOR 1,
           ID IS 78-ID-gd-scorte,                
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           NUM-ROWS -1,
           TILED-HEADINGS,
           VIRTUAL-WIDTH 50,
           VPADDING 30,
           VSCROLL,
           EVENT PROCEDURE Form1-Gd-2-Event-Proc,
           .

      * LABEL
       05
           Form1-La-1, 
           Label, 
           COL 106,00, 
           LINE 31,31,
           LINES 1,31 ,
           SIZE 53,17 ,
           FONT IS Large-Font,
           ID IS 13,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           CENTER,
           TRANSPARENT,
           TITLE "SCORTE",
           .

      * TOOLBAR
       01
           Form1-Tb-1,
           .    

      * PUSH BUTTON
       05
           TOOL-ESCI, 
           Push-Button, 
           COL 1,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 1,
           UNFRAMED,
           SQUARE,
           ENABLED E-ESCI,
           EXCEPTION-VALUE 27,
           FLAT,
           ID IS 2,
           SELF-ACT,
           ESCAPE-BUTTON,
           TITLE "&Esci",
           .

      * PUSH BUTTON
       05
           TOOL-NUOVO, 
           Push-Button, 
           COL 6,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 2,
           UNFRAMED,
           SQUARE,
           ENABLED E-NUOVO,
           EXCEPTION-VALUE 2,
           FLAT,
           ID IS 6,
           SELF-ACT,
           TITLE "Nuovo (F2)",
           .

      * PUSH BUTTON
       05
           TOOL-CANCELLA, 
           Push-Button, 
           COL 16,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           UNFRAMED,
           SQUARE,
           ENABLED E-CANCELLA,
           EXCEPTION-VALUE 4,
           FLAT,
           ID IS 5,
           SELF-ACT,
           TITLE "Cancella (F4)",
           BITMAP-NUMBER BitmapNumDelete
           .

      * PUSH BUTTON
       05
           TOOL-SALVA, 
           Push-Button, 
           COL 11,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           UNFRAMED,
           SQUARE,
           ENABLED E-SALVA,
           EXCEPTION-VALUE 3,
           FLAT,
           ID IS 8,
           SELF-ACT,
           TITLE "Salva (F3)",
           BITMAP-NUMBER BitmapNumSave
           .

      * PUSH BUTTON
       05
           TOOL-ANTEPRIMA, 
           Push-Button, 
           COL 26,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-ANTEPRIMA,
           EXCEPTION-VALUE 6,
           FLAT,
           ID IS 9,
           SELF-ACT,
           TITLE "Anteprima (F6)",
           BITMAP-NUMBER BitmapNumPreview
           .

      * CHECK BOX
       05
           TOOL-MODIFICA, 
           Check-Box, 
           COL 21,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE toolbar-bmp,
           BITMAP-NUMBER 5,
           UNFRAMED,
           SQUARE,
           ENABLED E-MODIFICA,
           EXCEPTION-VALUE 1005
           FLAT,
           ID IS 7,
           SELF-ACT,
           TITLE "Modifica (F5)",
           VALUE MOD,
           AFTER PROCEDURE TOOL-MODIFICA-AfterProcedure,
           BEFORE PROCEDURE TOOL-MODIFICA-BeforeProcedure, 
           .
      * PUSH BUTTON
       05
           TOOL-STAMPA, 
           Push-Button, 
           COL 31,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-STAMPA,
           EXCEPTION-VALUE 7,
           FLAT,
           ID IS 10,
           SELF-ACT,
           TITLE "Stampa (F7)",
           BITMAP-NUMBER BitmapNumPrint
           .

      * PUSH BUTTON
       05
           TOOL-CERCA, 
           Push-Button, 
           COL 36,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           UNFRAMED,
           SQUARE,
           ENABLED E-CERCA,
           EXCEPTION-VALUE 8,
           FLAT,
           ID IS 11,
           SELF-ACT,
           TITLE "Cerca (F8)",
           BITMAP-NUMBER BitmapNumZoom
           .

      * PUSH BUTTON
       05
           tool-CercaTesto, 
           Push-Button, 
           COL 41,00, 
           LINE 1,08,
           LINES 23,00 ,
           SIZE 24,00 ,
           BITMAP-HANDLE TOOLBAR-BMP,
           BITMAP-NUMBER 20,
           UNFRAMED,
           SQUARE,
           EXCEPTION-VALUE 1234,
           FLAT,
           FONT IS Small-Font,
           ID IS 3,
           SELF-ACT,
           TITLE "&Ricerca testo (Ctrl + F)",
           .

      * FORM
       01 
           SCREEN-SEARCH, 
           .

      * ENTRY FIELD
       05
           ef-cod, 
           Entry-Field, 
           COL 12,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 8,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED e-cod,
           FONT IS Small-Font,
           ID IS 1,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LEFT,
           MAX-TEXT 3,
           VALUE Cod,
           AFTER PROCEDURE ef-cod-AfterProcedure, 
           BEFORE PROCEDURE ef-cod-BeforeProcedure, 
           .

      * RADIO BUTTON
       05
           rb-cod, 
           Radio-Button, 
           COL 47,00, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 2,14 ,
           EXCEPTION-VALUE 1000
           FLAT,
           FONT IS Small-Font,
           GROUP 1,
           GROUP-VALUE 1,
           ID IS 5,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Radio Button",
           VALUE tipo-ricerca,
           AFTER PROCEDURE rb-cod-AfterProcedure, 
           BEFORE PROCEDURE rb-cod-BeforeProcedure, 
           .
      * RADIO BUTTON
       05
           rb-des, 
           Radio-Button, 
           COL 47,00, 
           LINE 4,00,
           LINES 1,31 ,
           SIZE 2,14 ,
           EXCEPTION-VALUE 1001
           FLAT,
           FONT IS Small-Font,
           GROUP 1,
           GROUP-VALUE 2,
           ID IS 6,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TITLE "Radio Button",
           VALUE tipo-ricerca,
           AFTER PROCEDURE rb-des-AfterProcedure, 
           BEFORE PROCEDURE rb-des-BeforeProcedure, 
           .
      * ENTRY FIELD
       05
           ef-des, 
           Entry-Field, 
           COL 12,00, 
           LINE 4,00,
           LINES 1,31 ,
           SIZE 34,00 ,
           BOXED,
           COLOR IS 513,
           ENABLED e-des,
           FONT IS Small-Font,
           ID IS 2,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           MAX-TEXT 50,
           VALUE des,
           AFTER PROCEDURE ef-des-AfterProcedure, 
           BEFORE PROCEDURE ef-des-BeforeProcedure, 
           .

      * PUSH BUTTON
       05
           pb-esegui, 
           Push-Button, 
           COL 34,43, 
           LINE 5,92,
           LINES 21,00 ,
           SIZE 73,00 ,
           BITMAP-HANDLE ESEGUI_73X21-BMP,
           BITMAP-NUMBER 1,
           FRAMED,
           SQUARE,
           EXCEPTION-VALUE 13,
           FLAT,
           FONT IS Small-Font,
           ID IS 8,
           OK-BUTTON,
           TITLE "E&segue la ricerca del testo imputato",
           .

      * LABEL
       05
           Form2-La-1, 
           Label, 
           COL 1,86, 
           LINE 2,00,
           LINES 1,31 ,
           SIZE 6,14 ,
           FONT IS Small-Font,
           ID IS 3,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Codice",
           .

      * LABEL
       05
           Form2-La-2, 
           Label, 
           COL 1,86, 
           LINE 4,00,
           LINES 1,31 ,
           SIZE 8,43 ,
           FONT IS Small-Font,
           ID IS 4,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "Descrizione",
           .

      * LABEL
       05
           Form2-Custom1-1, 
           Label, 
           COL 44,00, 
           LINE 1,15,
           LINES 0,69 ,
           SIZE 5,57 ,
           FONT IS Default-Font,
           ID IS 101,
           TRANSPARENT,
           TITLE "CUSTOM CONTROL",
           VISIBLE v-custom,
           .

      * CHECK BOX
       05
           cb-match, 
           Check-Box, 
           COL 11,71, 
           LINE 5,85,
           LINES 1,31 ,
           SIZE 2,14 ,
           FLAT,
           FONT IS Small-Font,
           ID IS 7,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           LEFT-TEXT,
           TITLE "   &M   ",
           VALUE MatchCase,
           AFTER PROCEDURE cb-match-AfterProcedure,
           BEFORE PROCEDURE cb-match-BeforeProcedure, 
           .
      * LABEL
       05
           Form2-La-3, 
           Label, 
           COL 1,86, 
           LINE 5,92,
           LINES 1,08 ,
           SIZE 9,00 ,
           FONT IS Small-Font,
           ID IS 78,
           HEIGHT-IN-CELLS,
           WIDTH-IN-CELLS,
           TRANSPARENT,
           TITLE "&Match case",
           .

      *{TOTEM}END

      *{TOTEM}LINKPARA
       PROCEDURE  DIVISION USING LK-BLOCKPGM, USER-CODI, LIVELLO-ABIL.
      *{TOTEM}END

      *{TOTEM}DECLARATIVE
       DECLARATIVES.
      * <TOTEM:EPT. INIT:tmagaz, INIT:tmagaz, BeforeDeclarative>
       TMAGAZ-ERR SECTION.
           use after error procedure on tmagaz.
           evaluate status-tmagaz 
           when "35"
                display message "File [TMAGAZ] not found!"
                           title titolo
                            icon 3
                set errori to true
           when "39"
                display message "File [TMAGAZ] Mismatch size!"
                           title titolo
                            icon 3
                set errori to true
           when "98"
                display message "[TMAGAZ] Indexed file corrupt!"
                           title titolo
                            icon 3
                set errori to true
           when "93"             
                move 0 to mod
                modify tool-modifica, value = mod  
                set StatusVisua to true
                open input tmagaz
                display message box MSG-Gia-in-uso-su-altro-terminale
                            x"0d0a" MSG-SOLA-VISUA
                        title = tit-err
                        icon is mb-error-icon      
           end-evaluate.

      * <TOTEM:END>
       INPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON INPUT.
       0100-DECL.
           EXIT.
       I-O-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON I-O.
       0200-DECL.
           EXIT.
       OUTPUT-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON OUTPUT.
       0300-DECL.
           EXIT.
       TRANSACTION-ERROR SECTION.
           USE AFTER STANDARD ERROR PROCEDURE ON TRANSACTION.
       0400-DECL.
           EXIT.
       END DECLARATIVES.
      *{TOTEM}END

       MAIN-LOGIC.
      *{TOTEM}ENTRY-BEFPRG
      *    Before-Program
           PERFORM PAS004P-Ev-Before-Program
      *{TOTEM}END
           PERFORM INITIALIZE-ROUTINE.
      * run main screen
      *{TOTEM}RUN-MAINSCR
           PERFORM Form1-OPEN-ROUTINE.
      *{TOTEM}END

      *{TOTEM}COPY-PROCEDURE
       EXIT-STOP-ROUTINE.
           PERFORM CLOSE-FILE-RTN
      * <TOTEM:EPT. INIT:tmagaz, INIT:tmagaz, BeforeDestroyResource>
      * <TOTEM:END>
           CALL "w$bitmap" USING WBITMAP-DESTROY, toolbar-bmp
           CALL "w$bitmap" USING WBITMAP-DESTROY, TOOLBAR-BMP
           CALL "w$bitmap" USING WBITMAP-DESTROY, ESEGUI_73X21-BMP
      *    After-Program
           PERFORM I-O-BLOCCO
           EXIT PROGRAM TOTEM-PgmStatus
           STOP RUN.

       INITIALIZE-ROUTINE.
      *    Before Init
      * initialize program status variable
           Initialize TOTEM-PgmStatus.
      * get system information
           ACCEPT SYSTEM-INFORMATION FROM SYSTEM-INFO.
      * get terminal information
           ACCEPT TERMINAL-ABILITIES FROM TERMINAL-INFO.
      * set font
           PERFORM INIT-FONT.
      * load bitmap
           PERFORM INIT-BMP.
      * load resource
           PERFORM INIT-RES.
      * create pop-up menu
           PERFORM INIT-POPUP.
      * open files
           PERFORM OPEN-FILE-RTN.
      *    After Init
           .
    
       INIT-FONT.
           .

       INIT-BMP.
      * TOOL-ESCI
           COPY RESOURCE "toolbar.bmp".
           CALL "w$bitmap" USING WBITMAP-LOAD "toolbar.bmp", 
                   GIVING toolbar-bmp.
      * TOOL-ANTEPRIMA
           COPY RESOURCE "TOOLBAR.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "TOOLBAR.BMP", 
                   GIVING TOOLBAR-BMP.
      * pb-esegui
           COPY RESOURCE "ESEGUI_73X21.BMP".
           CALL "w$bitmap" USING WBITMAP-LOAD "ESEGUI_73X21.BMP", 
                   GIVING ESEGUI_73X21-BMP.
           .

       INIT-RES.
           .

       INIT-POPUP.
           .

       OPEN-FILE-RTN.
      *    Before Open
           PERFORM OPEN-tmagaz
           PERFORM OPEN-tcaumag
           PERFORM OPEN-tscorte
           PERFORM OPEN-tvettori
      *    After Open
           .

       OPEN-tmagaz.
      * <TOTEM:EPT. INIT:tmagaz, FD:tmagaz, BeforeOpen>
      * <TOTEM:END>
           OPEN  I-O tmagaz
           IF STATUS-tmagaz = "35"
              OPEN OUTPUT tmagaz
                IF Valid-STATUS-tmagaz
                   CLOSE tmagaz
                   OPEN I-O tmagaz
                END-IF
           END-IF
           IF NOT Valid-STATUS-tmagaz
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tmagaz, FD:tmagaz, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tcaumag.
      * <TOTEM:EPT. INIT:tmagaz, FD:tcaumag, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tcaumag
           IF NOT Valid-STATUS-tcaumag
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tmagaz, FD:tcaumag, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tscorte.
      * <TOTEM:EPT. INIT:tmagaz, FD:tscorte, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tscorte
           IF NOT Valid-STATUS-tscorte
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tmagaz, FD:tscorte, AfterOpen>
      * <TOTEM:END>
           .

       OPEN-tvettori.
      * <TOTEM:EPT. INIT:tmagaz, FD:tvettori, BeforeOpen>
      * <TOTEM:END>
           OPEN  INPUT tvettori
           IF NOT Valid-STATUS-tvettori
              PERFORM  Form1-EXTENDED-FILE-STATUS
              GO TO EXIT-STOP-ROUTINE
           END-IF
      * <TOTEM:EPT. INIT:tmagaz, FD:tvettori, AfterOpen>
      * <TOTEM:END>
           .

       CLOSE-FILE-RTN.
      *    Before Close
           PERFORM CLOSE-tmagaz
           PERFORM CLOSE-tcaumag
           PERFORM CLOSE-tscorte
           PERFORM CLOSE-tvettori
      *    After Close
           .

       CLOSE-tmagaz.
      * <TOTEM:EPT. INIT:tmagaz, FD:tmagaz, BeforeClose>
      * <TOTEM:END>
           CLOSE tmagaz
           .

       CLOSE-tcaumag.
      * <TOTEM:EPT. INIT:tmagaz, FD:tcaumag, BeforeClose>
      * <TOTEM:END>
           CLOSE tcaumag
           .

       CLOSE-tscorte.
      * <TOTEM:EPT. INIT:tmagaz, FD:tscorte, BeforeClose>
      * <TOTEM:END>
           CLOSE tscorte
           .

       CLOSE-tvettori.
      * <TOTEM:EPT. INIT:tmagaz, FD:tvettori, BeforeClose>
      * <TOTEM:END>
           CLOSE tvettori
           .

       DataSet1-tmagaz-INITSTART.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 MOVE Low-Value TO mag-chiave
              ELSE
                 MOVE High-Value TO mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tmagaz-INITEND.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 MOVE High-Value TO mag-chiave
              ELSE
                 MOVE Low-Value TO mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           .   

       DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tmagaz-KEY1-ORDER
           END-EVALUATE
           .

       DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tmagaz-KEY1-ORDER
           END-EVALUATE
           .

      * tmagaz
       DataSet1-tmagaz-START.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 START tmagaz KEY >= mag-chiave
              ELSE
                 START tmagaz KEY <= mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tmagaz-START-NOTGREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 START tmagaz KEY <= mag-chiave
              ELSE
                 START tmagaz KEY >= mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tmagaz-START-GREATER.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 START tmagaz KEY > mag-chiave
              ELSE
                 START tmagaz KEY < mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tmagaz-START-LESS.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 START tmagaz KEY < mag-chiave
              ELSE
                 START tmagaz KEY > mag-chiave
              END-IF
           END-EVALUATE
           .

       DataSet1-tmagaz-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeReadRecord>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-LOCK
                 READ tmagaz WITH LOCK 
                 KEY mag-chiave
              ELSE
                 READ tmagaz WITH NO LOCK 
                 KEY mag-chiave
              END-IF
           END-EVALUATE
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT 
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tmagaz-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeReadNext>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 IF DataSet1-tmagaz-LOCK
                    READ tmagaz NEXT WITH LOCK
                 ELSE
                    READ tmagaz NEXT WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tmagaz-LOCK
                    READ tmagaz PREVIOUS WITH LOCK
                 ELSE
                    READ tmagaz PREVIOUS WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tmagaz-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeReadPrev>
      * <TOTEM:END>
           EVALUATE DataSet1-KEYIS
           WHEN 1
              IF DataSet1-tmagaz-KEY1-Asc
                 IF DataSet1-tmagaz-LOCK
                    READ tmagaz PREVIOUS WITH LOCK
                 ELSE
                    READ tmagaz PREVIOUS WITH NO LOCK
                 END-IF
              ELSE
                 IF DataSet1-tmagaz-LOCK
                    READ tmagaz NEXT WITH LOCK
                 ELSE
                    READ tmagaz NEXT WITH NO LOCK
                 END-IF
              END-IF
           END-EVALUATE
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tmagaz-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeWrite>
      * <TOTEM:END>
           WRITE mag-rec OF tmagaz.
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tmagaz-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeRewrite>
      * <TOTEM:END>
           REWRITE mag-rec OF tmagaz.
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tmagaz-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, BeforeDelete>
      * <TOTEM:END>
           DELETE tmagaz.
           MOVE STATUS-tmagaz TO TOTEM-ERR-STAT
           MOVE "tmagaz" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tmagaz, AfterDelete>
      * <TOTEM:END>
           .

       tcaumag-k-mag-MERGE-SPLITBUF.
           INITIALIZE tcaumag-k-mag-SPLITBUF
           MOVE tca-cod-magaz(1:3) TO tcaumag-k-mag-SPLITBUF(1:3)
           MOVE tca-ord-forn(1:1) TO tcaumag-k-mag-SPLITBUF(4:1)
           .

       DataSet1-tcaumag-INITSTART.
           IF DataSet1-tcaumag-KEY-Asc
              MOVE Low-Value TO tca-chiave
           ELSE
              MOVE High-Value TO tca-chiave
           END-IF
           .

       DataSet1-tcaumag-INITEND.
           IF DataSet1-tcaumag-KEY-Asc
              MOVE High-Value TO tca-chiave
           ELSE
              MOVE Low-Value TO tca-chiave
           END-IF
           .

      * tcaumag
       DataSet1-tcaumag-START.
           IF DataSet1-tcaumag-KEY-Asc
              START tcaumag KEY >= tca-chiave
           ELSE
              START tcaumag KEY <= tca-chiave
           END-IF
           .

       DataSet1-tcaumag-START-NOTGREATER.
           IF DataSet1-tcaumag-KEY-Asc
              START tcaumag KEY <= tca-chiave
           ELSE
              START tcaumag KEY >= tca-chiave
           END-IF
           .

       DataSet1-tcaumag-START-GREATER.
           IF DataSet1-tcaumag-KEY-Asc
              START tcaumag KEY > tca-chiave
           ELSE
              START tcaumag KEY < tca-chiave
           END-IF
           .

       DataSet1-tcaumag-START-LESS.
           IF DataSet1-tcaumag-KEY-Asc
              START tcaumag KEY < tca-chiave
           ELSE
              START tcaumag KEY > tca-chiave
           END-IF
           .

       DataSet1-tcaumag-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tcaumag-LOCK
              READ tcaumag WITH LOCK 
              KEY tca-chiave
           ELSE
              READ tcaumag WITH NO LOCK 
              KEY tca-chiave
           END-IF
           PERFORM tcaumag-k-mag-MERGE-SPLITBUF
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT 
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tcaumag-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tcaumag-KEY-Asc
              IF DataSet1-tcaumag-LOCK
                 READ tcaumag NEXT WITH LOCK
              ELSE
                 READ tcaumag NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tcaumag-LOCK
                 READ tcaumag PREVIOUS WITH LOCK
              ELSE
                 READ tcaumag PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM tcaumag-k-mag-MERGE-SPLITBUF
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tcaumag-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tcaumag-KEY-Asc
              IF DataSet1-tcaumag-LOCK
                 READ tcaumag PREVIOUS WITH LOCK
              ELSE
                 READ tcaumag PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tcaumag-LOCK
                 READ tcaumag NEXT WITH LOCK
              ELSE
                 READ tcaumag NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM tcaumag-k-mag-MERGE-SPLITBUF
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tcaumag-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tcaumag-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tcaumag-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tcaumag TO TOTEM-ERR-STAT
           MOVE "tcaumag" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tcaumag, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-tscorte-INITSTART.
           IF DataSet1-tscorte-KEY-Asc
              MOVE Low-Value TO sco-chiave
           ELSE
              MOVE High-Value TO sco-chiave
           END-IF
           .

       DataSet1-tscorte-INITEND.
           IF DataSet1-tscorte-KEY-Asc
              MOVE High-Value TO sco-chiave
           ELSE
              MOVE Low-Value TO sco-chiave
           END-IF
           .

      * tscorte
       DataSet1-tscorte-START.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY >= sco-chiave
           ELSE
              START tscorte KEY <= sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-NOTGREATER.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY <= sco-chiave
           ELSE
              START tscorte KEY >= sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-GREATER.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY > sco-chiave
           ELSE
              START tscorte KEY < sco-chiave
           END-IF
           .

       DataSet1-tscorte-START-LESS.
           IF DataSet1-tscorte-KEY-Asc
              START tscorte KEY < sco-chiave
           ELSE
              START tscorte KEY > sco-chiave
           END-IF
           .

       DataSet1-tscorte-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tscorte-LOCK
              READ tscorte WITH LOCK 
              KEY sco-chiave
           ELSE
              READ tscorte WITH NO LOCK 
              KEY sco-chiave
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT 
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tscorte-KEY-Asc
              IF DataSet1-tscorte-LOCK
                 READ tscorte NEXT WITH LOCK
              ELSE
                 READ tscorte NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tscorte-LOCK
                 READ tscorte PREVIOUS WITH LOCK
              ELSE
                 READ tscorte PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tscorte-KEY-Asc
              IF DataSet1-tscorte-LOCK
                 READ tscorte PREVIOUS WITH LOCK
              ELSE
                 READ tscorte PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tscorte-LOCK
                 READ tscorte NEXT WITH LOCK
              ELSE
                 READ tscorte NEXT WITH NO LOCK
              END-IF
           END-IF
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tscorte-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tscorte TO TOTEM-ERR-STAT
           MOVE "tscorte" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tscorte, AfterDelete>
      * <TOTEM:END>
           .

       tvettori-k-des-MERGE-SPLITBUF.
           INITIALIZE tvettori-k-des-SPLITBUF
           MOVE vet-descrizione(1:40) TO tvettori-k-des-SPLITBUF(1:40)
           .

       DataSet1-tvettori-INITSTART.
           IF DataSet1-tvettori-KEY-Asc
              MOVE Low-Value TO vet-chiave
           ELSE
              MOVE High-Value TO vet-chiave
           END-IF
           .

       DataSet1-tvettori-INITEND.
           IF DataSet1-tvettori-KEY-Asc
              MOVE High-Value TO vet-chiave
           ELSE
              MOVE Low-Value TO vet-chiave
           END-IF
           .

      * tvettori
       DataSet1-tvettori-START.
           IF DataSet1-tvettori-KEY-Asc
              START tvettori KEY >= vet-chiave
           ELSE
              START tvettori KEY <= vet-chiave
           END-IF
           .

       DataSet1-tvettori-START-NOTGREATER.
           IF DataSet1-tvettori-KEY-Asc
              START tvettori KEY <= vet-chiave
           ELSE
              START tvettori KEY >= vet-chiave
           END-IF
           .

       DataSet1-tvettori-START-GREATER.
           IF DataSet1-tvettori-KEY-Asc
              START tvettori KEY > vet-chiave
           ELSE
              START tvettori KEY < vet-chiave
           END-IF
           .

       DataSet1-tvettori-START-LESS.
           IF DataSet1-tvettori-KEY-Asc
              START tvettori KEY < vet-chiave
           ELSE
              START tvettori KEY > vet-chiave
           END-IF
           .

       DataSet1-tvettori-Read.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeReadRecord>
      * <TOTEM:END>
           IF DataSet1-tvettori-LOCK
              READ tvettori WITH LOCK 
              KEY vet-chiave
           ELSE
              READ tvettori WITH NO LOCK 
              KEY vet-chiave
           END-IF
           PERFORM tvettori-k-des-MERGE-SPLITBUF
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT 
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "READ" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterReadRecord>
      * <TOTEM:END>
           .

       DataSet1-tvettori-Read-Next.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeReadNext>
      * <TOTEM:END>
           IF DataSet1-tvettori-KEY-Asc
              IF DataSet1-tvettori-LOCK
                 READ tvettori NEXT WITH LOCK
              ELSE
                 READ tvettori NEXT WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tvettori-LOCK
                 READ tvettori PREVIOUS WITH LOCK
              ELSE
                 READ tvettori PREVIOUS WITH NO LOCK
              END-IF
           END-IF
           PERFORM tvettori-k-des-MERGE-SPLITBUF
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "READ NEXT" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterReadNext>
      * <TOTEM:END>
           .

       DataSet1-tvettori-Read-Prev.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeReadPrev>
      * <TOTEM:END>
           IF DataSet1-tvettori-KEY-Asc
              IF DataSet1-tvettori-LOCK
                 READ tvettori PREVIOUS WITH LOCK
              ELSE
                 READ tvettori PREVIOUS WITH NO LOCK
              END-IF
           ELSE
              IF DataSet1-tvettori-LOCK
                 READ tvettori NEXT WITH LOCK
              ELSE
                 READ tvettori NEXT WITH NO LOCK
              END-IF
           END-IF
           PERFORM tvettori-k-des-MERGE-SPLITBUF
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "READ PREVIOUS" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterRead>
      * <TOTEM:END>
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterReadPrev>
      * <TOTEM:END>
           .

       DataSet1-tvettori-Rec-Write.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeWrite>
      * <TOTEM:END>
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "WRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterWrite>
      * <TOTEM:END>
           .

       DataSet1-tvettori-Rec-Rewrite.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeRewrite>
      * <TOTEM:END>
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "REWRITE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterRewrite>
      * <TOTEM:END>
           .

       DataSet1-tvettori-Rec-Delete.
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, BeforeDelete>
      * <TOTEM:END>
           MOVE STATUS-tvettori TO TOTEM-ERR-STAT
           MOVE "tvettori" TO TOTEM-ERR-FILE
           MOVE "DELETE" TO TOTEM-ERR-MODE
      * <TOTEM:EPT. FD:DataSet1, FD:tvettori, AfterDelete>
      * <TOTEM:END>
           .

       DataSet1-INIT-RECORD.
           INITIALIZE mag-rec OF tmagaz
           INITIALIZE tca-rec OF tcaumag
           INITIALIZE sco-rec OF tscorte
           INITIALIZE vet-rec OF tvettori
           .


      * GRID
       form1-gd-1-Content.
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 1, Y = 1,
                CELL-DATA = "Codice",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 2, Y = 1,
                CELL-DATA = "Descrizione",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 3, Y = 1,
                CELL-DATA = "Principale",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 4, Y = 1,
                CELL-DATA = "Scr.Aus.",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 5, Y = 1,
                CELL-DATA = "UTF",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 6, Y = 1,
                CELL-DATA = "% + riordino",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 7, Y = 1,
                CELL-DATA = "Pren Promo",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 8, Y = 1,
                CELL-DATA = "Vendita",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 9, Y = 1,
                CELL-DATA = "Omaggio",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 10, Y = 1,
                CELL-DATA = "SOST",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 11, Y = 1,
                CELL-DATA = "Blister",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 12, Y = 1,
                CELL-DATA = "Ritira LBX",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 13, Y = 1,
                CELL-DATA = "Scarico",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 14, Y = 1,
                CELL-DATA = "Carico",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 15, Y = 1,
                CELL-DATA = "Reso",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 16, Y = 1,
                CELL-DATA = "Diff. Pz.",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 17, Y = 1,
                CELL-DATA = "Vettore",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 18, Y = 1,
                CELL-DATA = "PM",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 19, Y = 1,
                CELL-DATA = "Da inviare",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 20, Y = 1,
                CELL-DATA = "Gen. auto",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 21, Y = 1,
                CELL-DATA = "Blocco 24000",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 22, Y = 1,
                CELL-DATA = "C ROT",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 23, Y = 1,
                CELL-DATA = "S ROT",
      * CELLS' SETTING
              MODIFY form1-gd-1, X = 24, Y = 1,
                CELL-DATA = "Scorta",
      * COLUMNS' SETTING
              MODIFY form1-gd-1, X = 1  
                COLUMN-FONT = Small-Font,
      * COLUMNS' SETTING
              MODIFY form1-gd-1, X = 2  
                COLUMN-FONT = Small-Font,
           .

      * GRID
       gd-scorte-Content.
      * CELLS' SETTING
              MODIFY gd-scorte, X = 1, Y = 1,
                CELL-DATA = "Cod.",
      * CELLS' SETTING
              MODIFY gd-scorte, X = 2, Y = 1,
                CELL-DATA = "Descrizione",
           .

      * FD's Initialize Paragraph
       DataSet1-tmagaz-INITREC.
           INITIALIZE mag-rec OF tmagaz
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tcaumag-INITREC.
           INITIALIZE tca-rec OF tcaumag
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tscorte-INITREC.
           INITIALIZE sco-rec OF tscorte
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      * FD's Initialize Paragraph
       DataSet1-tvettori-INITREC.
           INITIALIZE vet-rec OF tvettori
               REPLACING NUMERIC       DATA BY ZEROS
                         ALPHANUMERIC  DATA BY SPACES
                         ALPHABETIC    DATA BY SPACES
           .

      *
       DataSet1-DISPATCH-BUFTOFLD.
           EVALUATE TOTEM-Form-Index ALSO TOTEM-Frame-Index
              WHEN 1 ALSO 0
                  PERFORM Form1-Buf-To-Fld
           END-EVALUATE
           .

       Form1-DISPLAY-STATUS-MSG.
            MODIFY Screen1-St-1-Handle PANEL-INDEX = 1
                PANEL-TEXT = TOTEM-HINT-TEXT
           .

       Form1-CLEAR-STATUS-MSG.
           MOVE SPACES TO TOTEM-MSG-1, TOTEM-MSG-2, TOTEM-MSG-3, 
           TOTEM-MSG-TEXT
           PERFORM Form1-DISPLAY-STATUS-MSG
           .

       Form1-Open-Routine.
           PERFORM Form1-Scrn
           PERFORM Form1-Proc
           .

       Form1-Scrn.
           PERFORM Form1-Create-Win
           PERFORM Form1-Init-Value
           PERFORM Form1-Init-Data
      * Tab keystrok settings
      * Tool Bar
           DISPLAY Form1-Tb-1
           PERFORM Form1-DISPLAY
           .

       Form1-Create-Win.
           Display Independent GRAPHICAL WINDOW
              LINES 46,15,
              SIZE 263,17,
              COLOR 65793,
              CONTROL FONT Small-Font,
              LINK TO THREAD,
              NO SCROLL,
              TITLE-BAR,
              TITLE titolo,
              AUTO-MINIMIZE,
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Form1-Event-Proc,
              HANDLE IS Form1-Handle,
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
           DISPLAY TOOL-BAR 
              LINES 2,69,   
              HANDLE IN Form1-Tb-1-Handle
           DISPLAY Form1-Tb-1 UPON Form1-Tb-1-Handle

      * Status-bar
           DISPLAY STATUS-BAR
              FONT IS Small-Font,
              GRIP,
              PANEL-WIDTHS (145, 25, 999),
              PANEL-STYLE  (1, 1, 1),
              PANEL-TEXT   (SPACE, SPACE, SPACE),
              HANDLE IS Screen1-St-1-Handle
           DISPLAY Form1 UPON Form1-Handle
      * DISPLAY-COLUMNS settings
              MODIFY form1-gd-1, DISPLAY-COLUMNS (1, 9, 55, 65, 75, 85, 
           96, 106, 116, 126, 135, 143, 153, 163, 173, 181, 189, 197, 
           201, 211, 221, 235, 243, 251)
              MODIFY gd-scorte, DISPLAY-COLUMNS (1, 7)
           .

       Form1-PROC.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAccept>
           perform ABILITA-TOOLBAR.

           perform FORM1-GD-1-CONTENT.
           perform LOAD-RECORD.

           perform INIT.

           move 2  to event-data-2.
           perform SPOSTAMENTO.

           |specifico dei pgm. con grid-control
           perform ABILITAZIONI.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT Form1
                 ON EXCEPTION
                    PERFORM Form1-Evaluate-Func
                 MOVE 1 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Form1-Handle
           INITIALIZE Key-Status
           .

       Form1-Evaluate-Func.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAccept>
      *    per il bottone modifica
           if key-status = 5
              inquire tool-modifica, enabled in e-modifica
              if e-modifica = 1
                 if mod = zero
                    move 1    to mod
                 else 
                    move zero to mod
                 end-if
                 modify tool-modifica, value = mod
                 perform MODIFICA
              end-if
           end-if.

           .
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM Form1-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM Form1-Exit
                 END-IF
              WHEN Key-Status = 2
                 PERFORM NUOVO-LinkTo
              WHEN Key-Status = 4
                 PERFORM CANCELLA-LinkTo
              WHEN Key-Status = 3
                 PERFORM TOOL-SALVA-LinkTo
              WHEN Key-Status = 6
                 PERFORM ANTEPRIMA-LinkTo
              WHEN Key-Status = 1005
                 PERFORM TOOL-MODIFICA-LinkTo
              WHEN Key-Status = 7
                 PERFORM STAMPA-LinkTo
              WHEN Key-Status = 8
                 PERFORM TOOL-CERCA-LinkTo
              WHEN Key-Status = 1234
                 PERFORM tool-CercaTesto-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       Form1-CLEAR.
           PERFORM Form1-INIT-VALUE
           PERFORM Form1-DISPLAY
           .

       Form1-DISPLAY.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY Form1-Tb-1
           DISPLAY Form1 UPON Form1-Handle
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       Form1-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeExit>
           perform SALV-MOD.

           set trovato-nessuno to true
           perform CHECK-PRINCIPALE-ESISTENZA

           if trovato-nessuno
              set errori to true
              display message MSG-Principale-inesistente
                      title tit-err
                      icon MB-WARNING-ICON
              set NoSalvato to true
           end-if.

           if errori
              move 28 to key-status
              exit paragraph
           end-if.

           .
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       Form1-Init-Data.
           MOVE 1 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
      * GRID
           PERFORM form1-gd-1-Content
      * GRID
           PERFORM gd-scorte-Content
           .

       Form1-DataSet1-CHANGETO-KEY1.
           MOVE 1 TO DataSet1-KEYIS
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Asc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "A" TO DataSet1-tmagaz-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Change-CurrentKey-Desc.
           EVALUATE DataSet1-KEYIS
           WHEN 1
              MOVE "D" TO DataSet1-tmagaz-KEY1-ORDER
           END-EVALUATE
           PERFORM Form1-DataSet1-Update-Key
           .

       Form1-DataSet1-Update-Key.
           MOVE mag-rec OF tmagaz TO
                     Form1-MULKEY-TMPBUF
           PERFORM Form1-CLEAR
           PERFORM Form1-INIT-DATA
           MOVE Form1-MULKEY-TMPBUF TO
                     mag-rec OF tmagaz
           PERFORM DataSet1-tmagaz-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
           .

       Form1-DUPLICATE-MOVEKEY.
           .

       Form1-First.
           PERFORM Form1-DUMMY-FIRST
           PERFORM DataSet1-tmagaz-INITSTART
           PERFORM DataSet1-tmagaz-START
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFirst>
      * <TOTEM:END>
           PERFORM DataSet1-tmagaz-Read-Next
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFirst>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Previous.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-tmagaz-START-LESS
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforePrevious>
      * <TOTEM:END>
           PERFORM DataSet1-tmagaz-Read-Prev
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterPrevious>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-PREVIOUS
           PERFORM Form1-IUD-Display
           .

       Form1-Next.
              PERFORM Form1-Buf-To-Fld
              PERFORM DataSet1-tmagaz-START-GREATER
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeNext>
      * <TOTEM:END>
           PERFORM DataSet1-tmagaz-Read-Next
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterNext>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-NEXT
           PERFORM Form1-IUD-Display
           .
      
       Form1-Last.
           PERFORM Form1-DUMMY-LAST
           PERFORM DataSet1-tmagaz-INITEND
           PERFORM DataSet1-tmagaz-START-NOTGREATER
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeLast>
      * <TOTEM:END>
           PERFORM DataSet1-tmagaz-Read-Prev
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterLast>
      * <TOTEM:END>
           PERFORM Form1-DUPLICATE-MOVEKEY.
           PERFORM Form1-IUD-Display
           .

       Form1-Curr.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeCurrent>
      * <TOTEM:END>
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tmagaz-Read
           PERFORM Form1-DUPLICATE-MOVEKEY
           PERFORM Form1-DUMMY-CURR
           PERFORM Form1-IUD-Display
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterCurrent>
      * <TOTEM:END>
           .

       Form1-IUD-Display.
           IF Valid-STATUS-tmagaz
              PERFORM Form1-ALLGRID-RESET
              PERFORM Form1-Fld-To-Buf
              PERFORM Form1-NAVI-FOR-MASTERGRID
              PERFORM Form1-DISPLAY
           ELSE
              IF Form1-FLAG-REFRESH
                 CONTINUE
              ELSE
                 PERFORM Form1-Extended-File-Status
              END-IF
           END-IF
           .

       Form1-Add.
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-ADD
           PERFORM DataSet1-tmagaz-INITREC
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeAdd>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tmagaz-Rec-Write
           IF Valid-STATUS-tmagaz
              PERFORM Form1-RESUMMARY-INS
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "301" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterAdd>
      * <TOTEM:END>
           .
     
       Form1-Update.
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tmagaz-START              
           IF NOT Valid-STATUS-tmagaz
              PERFORM Form1-Extended-File-Status
              EXIT PARAGRAPH
           END-IF
           PERFORM DataSet1-tmagaz-Read
           PERFORM Form1-Buf-To-Fld
           PERFORM Form1-VALIDATION-ROUTINE
           IF NOT TOTEM-CHECK-OK
               EXIT PARAGRAPH
           END-IF
           PERFORM Form1-DUMMY-UPDATE
           PERFORM Form1-Buf-To-Fld
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeUpdate>
      * <TOTEM:END>
      * write
           PERFORM DataSet1-tmagaz-Rec-Rewrite
           IF Valid-STATUS-tmagaz
              PERFORM Form1-RESUMMARY-DEL
              PERFORM Form1-DUMMY-UPDATE-INIT
              MOVE "302" TO TOTEM-MSG-ID
              PERFORM Form1-IUD-Display
           END-IF
           PERFORM Form1-ERR-CHECKING
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterUpdate>
      * <TOTEM:END>
           .

       Form1-Delete.
           MOVE "203" TO TOTEM-MSG-ID
           PERFORM MESSAGE-BOX-DISPLAY
           IF TOTEM-MSG-RETURN-VALUE NOT = 1
              INITIALIZE TOTEM-MSG-TEXT
              EXIT PARAGRAPH 
           END-IF
           MOVE SPACES TO TOTEM-TRANSACTION-FLAG
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeDelete>
      * <TOTEM:END>
           PERFORM Form1-DUMMY-DELETE
      * delete
           PERFORM Form1-Buf-To-Fld
           PERFORM DataSet1-tmagaz-Rec-Delete
           IF Valid-STATUS-tmagaz
              PERFORM Form1-CLEAR
              PERFORM Form1-DUMMY-DELETE-INIT
              MOVE "303" TO TOTEM-MSG-ID
              MOVE "00" to STATUS-tmagaz
           END-IF
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterDelete>
      * <TOTEM:END>
           PERFORM Form1-ERR-CHECKING
           .

       Form1-NAVI-FOR-MASTERGRID.
           .

       Form1-ERR-CHECKING.
           IF Valid-STATUS-tmagaz
              PERFORM Form1-SHOW-MSG-ROUTINE
           ELSE
              PERFORM Form1-Extended-File-Status
           END-IF
           .

       Form1-RESUMMARY-INS.
           .

       Form1-RESUMMARY-DEL.
           .


       Form1-DUMMY-FIRST.
           .

       Form1-DUMMY-PREVIOUS.
           .

       Form1-DUMMY-NEXT.
           .

       Form1-DUMMY-LAST.
           .

       Form1-DUMMY-CURR.
           .

       Form1-DUMMY-ADD.
           .

       Form1-DUMMY-UPDATE.
           .

       Form1-DUMMY-UPDATE-INIT.
           .

       Form1-DUMMY-DELETE.
           .

       Form1-DUMMY-DELETE-INIT.
           .

       Form1-Init-Value.
           MOVE titolo TO TOTEM-MSG-TITLE
      * FORM : Form1
           PERFORM DataSet1-INIT-RECORD
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, SetDefault>
      * <TOTEM:END>
           PERFORM Form1-FLD-TO-BUF
           .


       Form1-ALLGRID-RESET.
           .

      * for Form's Validation
       Form1-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       Form1-Buf-To-Fld.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterBufToFld>
           initialize mag-tab-scorte.
           move 1 to idx.
           inquire gd-scorte, last-row in tot-righe.
           perform varying riga from 2 by 1 
                     until riga > tot-righe
              inquire gd-scorte(riga, 1), cell-data col-codice
              move col-codice to mag-sco-codice(idx)
              add 1 to idx
           end-perform.

           .
      * <TOTEM:END>
           .

       Form1-Fld-To-Buf.
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, BeforeFldToBuf>
           set SiSalvato to true.

           .
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:Form1, FORM:Form1, AfterFldToBuf>
           perform VALORIZZA-SCORTE.

           .
      * <TOTEM:END>
           .

       Form1-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform Form1-BUF-TO-FLD.
           move 0 to scelta.
           .
       Form1-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM Form1-SHOW-MSG-ROUTINE
           .

       Form1-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM Form1-DISPLAY-MESSAGE
           .

       Form1-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       Form1-Save-Status.
           MOVE DataSet1-tmagaz-KEY1-ORDER TO TMP-Form1-KEY1-ORDER
           MOVE DataSet1-KEYIS TO TMP-Form1-KEYIS
           MOVE mag-rec OF tmagaz TO 
              TMP-Form1-tmagaz-RESTOREBUF
           .             

       Form1-Restore-Status.
           MOVE TMP-Form1-KEY1-ORDER TO DataSet1-tmagaz-KEY1-ORDER
           MOVE TMP-Form1-KEYIS TO DataSet1-KEYIS
           MOVE TMP-Form1-tmagaz-RESTOREBUF TO
              mag-rec OF tmagaz
           PERFORM DataSet1-tmagaz-START
           IF Valid-STATUS-tmagaz
              PERFORM DataSet1-tmagaz-Read-Next
           ELSE
              PERFORM DataSet1-tmagaz-INITREC
           END-IF
           PERFORM UNTIL NOT Valid-STATUS-tmagaz OR
              (Valid-STATUS-tmagaz AND
                 mag-rec OF tmagaz = 
                   TMP-Form1-tmagaz-RESTOREBUF)
              PERFORM DataSet1-tmagaz-Read-Next
           END-PERFORM
           .

       SCREEN-SEARCH-Open-Routine.
           PERFORM SCREEN-SEARCH-Scrn
           PERFORM SCREEN-SEARCH-Proc
           .

       SCREEN-SEARCH-Scrn.
           PERFORM SCREEN-SEARCH-Create-Win
           PERFORM SCREEN-SEARCH-Init-Value
           PERFORM SCREEN-SEARCH-Init-Data
      * Tab keystrok settings
      * Tool Bar
           PERFORM SCREEN-SEARCH-DISPLAY
           .

       SCREEN-SEARCH-Create-Win.
           Display Floating GRAPHICAL WINDOW
              LINES 7,31,
              SIZE 50,00,
              HEIGHT-IN-CELLS,
              WIDTH-IN-CELLS,
              COLOR 65793,
              LINK TO THREAD,
              NO SCROLL,
              TITLE-BAR,
              TITLE "Ricerca del testo selezionato",
              WITH SYSTEM MENU,
              USER-GRAY,
              USER-WHITE,
              No WRAP,
              EVENT PROCEDURE Screen1-Event-Proc,
              HANDLE IS Screen1-Handle,
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterCreateWin>
      * <TOTEM:END>


      * Tool Bar    
      * Status-bar
           DISPLAY SCREEN-SEARCH UPON Screen1-Handle
      * DISPLAY-COLUMNS settings
           .

       SCREEN-SEARCH-PROC.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeAccept>
           set Ricerca to false. 
           move 1 to control-id.
           move 4 to accept-control.

           .
      * <TOTEM:END>
           PERFORM UNTIL Exit-Pushed
              ACCEPT SCREEN-SEARCH
                 ON EXCEPTION
                    PERFORM SCREEN-SEARCH-Evaluate-Func
                 MOVE 2 TO TOTEM-Form-Index
              END-ACCEPT
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterEndAccept>
      * <TOTEM:END>
           END-PERFORM
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeDestroyWindow>
      * <TOTEM:END>
           DESTROY Screen1-Handle
           INITIALIZE Key-Status
           .

       SCREEN-SEARCH-Evaluate-Func.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterAccept>
      * <TOTEM:END>
           EVALUATE TRUE
              WHEN Exit-Pushed
                 PERFORM SCREEN-SEARCH-Exit
              WHEN Event-Occurred
                 IF Event-Type = Cmd-Close
                    PERFORM SCREEN-SEARCH-Exit
                 END-IF
              WHEN Key-Status = 1000
                 PERFORM rb-cod-LinkTo
              WHEN Key-Status = 1001
                 PERFORM rb-des-LinkTo
              WHEN Key-Status = 13
                 PERFORM pb-esegui-LinkTo
           END-EVALUATE
      * avoid changing focus
           MOVE 4 TO Accept-Control
           .

       SCREEN-SEARCH-CLEAR.
           PERFORM SCREEN-SEARCH-INIT-VALUE
           PERFORM SCREEN-SEARCH-DISPLAY
           .

       SCREEN-SEARCH-DISPLAY.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeDisplay>
      * <TOTEM:END>
           DISPLAY SCREEN-SEARCH UPON Screen1-Handle
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterDisplay>
           SET LK-BL-SCRITTURA     TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           MOVE FORM1-HANDLE       TO LK-HND-WIN.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM.
           CANCEL "BLOCKPGM".

           .
      * <TOTEM:END>
           .

       SCREEN-SEARCH-Exit.
      * for main screen
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeExit>
      * <TOTEM:END>
           MOVE 27 TO Key-Status
           .

       SCREEN-SEARCH-Init-Data.
           MOVE 2 TO TOTEM-Form-Index
           MOVE 0 TO TOTEM-Frame-Index
           .

       SCREEN-SEARCH-Init-Value.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, SetDefault>
      * <TOTEM:END>
           PERFORM SCREEN-SEARCH-FLD-TO-BUF
           .


       SCREEN-SEARCH-ALLGRID-RESET.
           .

      * for Form's Validation
       SCREEN-SEARCH-VALIDATION-ROUTINE.
           SET TOTEM-CHECK-OK TO TRUE
           .


       SCREEN-SEARCH-Buf-To-Fld.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeBufToFld>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterBufToFld>
      * <TOTEM:END>
           .

       SCREEN-SEARCH-Fld-To-Buf.
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, BeforeFldToBuf>
      * <TOTEM:END>
      * <TOTEM:EPT. FORM:SCREEN-SEARCH, FORM:SCREEN-SEARCH, AfterFldToBuf>
      * <TOTEM:END>
           .

       SCREEN-SEARCH-CONTROLLO-OLD.
           set SiSalvato to true.
           if mod = 0 exit paragraph end-if.
           perform SCREEN-SEARCH-BUF-TO-FLD.
           move 0 to scelta.
           .
       SCREEN-SEARCH-EXTENDED-FILE-STATUS.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
           MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           PERFORM SCREEN-SEARCH-SHOW-MSG-ROUTINE
           .

       SCREEN-SEARCH-SHOW-MSG-ROUTINE.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM SCREEN-SEARCH-DISPLAY-MESSAGE
           .

       SCREEN-SEARCH-DISPLAY-MESSAGE.
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

       SCREEN-SEARCH-Save-Status.
           .             

       SCREEN-SEARCH-Restore-Status.
           .



       Form1-Event-Proc.
           .

       Form1-Gd-1-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5001 ALSO
                    Form1-Handle 
              PERFORM form1-gd-1-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

       Form1-Gd-2-Event-Proc.
           EVALUATE Event-Type ALSO Event-Control-Id ALSO
                                    Event-Window-Handle
           WHEN Msg-Begin-Drag ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Begin-Drag
           WHEN Msg-Begin-Entry ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Begin-Entry
           WHEN Msg-End-Drag ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-End-Drag
           WHEN Msg-Finish-Entry ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Finish-Entry
           WHEN Msg-Goto-Cell ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Goto-Cell
           WHEN Msg-Goto-Cell-Drag ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Goto-Cell-Drag
           WHEN Msg-Goto-Cell-Mouse ALSO 5002 ALSO
                    Form1-Handle 
              PERFORM gd-scorte-Ev-Msg-Goto-Cell-Mouse
           END-EVALUATE
           .

       Screen1-Event-Proc.
           .

      * USER DEFINE PARAGRAPH
       ABILITAZIONI.
      * <TOTEM:PARA. ABILITAZIONI>
           if mod = 1
              move BitmapDeleteEnabled to BitmapNumDelete
              move BitmapSaveEnabled   to BitmapNumSave
              move 1 to e-salva e-cancella
           else
              |SE SONO IN VISUA           
              move BitmapDeleteDisabled to BitmapNumDelete
              move BitmapSaveDisabled   to BitmapNumSave
              move 0 to e-salva e-cancella
           end-if.     

      * ISACCO (CORREZIONE SU LIVELLO ABILITAZIONE 2) - 10/11/2003
      * (CANCELLAZIONE NON PERMESSA)
           if livello-abil = 2 
              move ZERO to e-cancella
              move BitmapDeleteDisabled to BitmapNumDelete
           end-if.
      * FINE

           modify tool-cancella, enabled = e-cancella.
           modify tool-salva,    enabled = e-salva.
       
      * ISACCO (SERVE SEMPRE PER LA MODIFICA PRCEDENTE E PER RIPRISTINARE
      * LE BITMAP DISABILITATE. - 10/11/2003
      *     perform FORM1-DISPLAY.
           display tool-nuovo, tool-salva, tool-cancella, tool-modifica.
      * FINE.

           perform GRID-HELP 
           .
      * <TOTEM:END>

       ANTEPRIMA.
      * <TOTEM:PARA. ANTEPRIMA>
           set anteprima       to true.
      *     perform paragrafo-stampa 
           .
      * <TOTEM:END>

       CANCELLA.
      * <TOTEM:PARA. CANCELLA>
      *--->modifica (isacco)
           if mod = ZERO 
              exit paragraph 
           end-if.
      *--->fine.                 

           display message box MSG-cancellare-il-record-corrente
                   title = titolo
                   type mb-yes-no
                   default mb-no
                   giving scelta.

           if scelta = mb-yes

              inquire form1-gd-1, cursor-y  in riga
              perform valore-riga

              delete tmagaz record invalid continue end-delete

              modify  form1-gd-1, record-to-delete = riga 
              inquire form1-gd-1, last-row in tot-righe
              if riga > tot-righe move tot-righe to riga end-if
              modify form1-gd-1, cursor-y = riga, cursor-x = 1
              move riga to event-data-2
              perform COLORE-RIGA
              display message MSG-cancellazione-avvenuta-con-successo
                      title = titolo
           end-if 

           .
      * <TOTEM:END>

       CERCA.
      * <TOTEM:PARA. CERCA>
           evaluate CONTROL-ID
           when 78-ID-gd-scorte
                inquire gd-scorte(event-data-2, 1), cell-data in 
           col-codice
                move "tscorte"       to Como-File
                call   "zoom-gt"  using como-file, sco-rec
                                 giving stato-zoom
                cancel "zoom-gt"
                if stato-zoom = 0
                   move sco-codice to como-xx
                   inspect como-xx replacing leading x"30" by x"20"
                   call "C$JUSTIFY" using como-xx, "L"
                   set tutto-ok to true
                   inquire gd-scorte, last-row in tot-righe
                   perform varying riga from 2 by 1
                             until riga > tot-righe 
                      inquire gd-scorte(riga, 1), cell-data in 
           confronto-xx
                      if confronto-xx = como-xx and riga not = 
           event-data-2
                         set errori to true
                         subtract 1 from riga
                         display message "Scorta già presente a riga " 
           riga
                                   title tit-err
                                    icon 2
                         exit perform
                      end-if
                   end-perform

                   if tutto-ok
                      move como-xx         to col-codice
                      move sco-descrizione to col-descrizione
                      modify gd-scorte(riga, 1), cell-data col-codice
                      modify gd-scorte(riga, 2), cell-data 
           col-descrizione
                   end-if
                end-if

           when 78-ID-form1-gd-1
                inquire form1-gd-1, cursor-y in riga, cursor-x in 
           colonna
                if colonna = 8
                   set tca-imponibile-neg to true
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 8), cell-data tca-codice  
                   move "tcaumag-imp-neg-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-cau-s
                      modify form1-gd-1(riga, 8), cell-data col-causale
                   end-if
                end-if
                if colonna = 9
                   set tca-imponibile-neg to true
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 9), cell-data tca-codice  
                   move "tcaumag-imp-neg-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-cau-s
                      modify form1-gd-1(riga, 9), cell-data 
           col-causale-omag
                   end-if
                end-if

                if colonna = 13
                   set tca-imponibile-neg to true
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 13), cell-data tca-codice  
                   move "tcaumag-imp-neg-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-cau-s
                      modify form1-gd-1(riga, 13), cell-data col-cau-s
                   end-if
                end-if

                if colonna = 14
                   set tca-imponibile-pos to true
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 14), cell-data tca-codice  
                   move "tcaumag-imp-pos-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-cau-c
                      modify form1-gd-1(riga, 14), cell-data col-cau-c
                   end-if
                end-if

                if colonna = 15
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 15), cell-data tca-codice  
                   move "tcaumag-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-reso
                      modify form1-gd-1(riga, 15), cell-data col-reso
                   end-if
                end-if

                if colonna = 16
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 16), cell-data tca-codice  
                   move "tcaumag-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-diff
                      modify form1-gd-1(riga, 16), cell-data col-diff
                   end-if
                end-if

                if colonna = 17
                   inquire form1-gd-1(riga, 17), cell-data vet-codice  
                   move "tvettori"  to como-file
                   call "zoom-gt"   using como-file, vet-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move vet-codice      to col-vett
                      modify form1-gd-1(riga, 17), cell-data col-vett
                   end-if
                end-if     

                if colonna = 22
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 22), cell-data tca-codice  
                   move "tcaumag-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-carico-rot
                      modify form1-gd-1(riga, 22), cell-data 
           col-carico-rot
                   end-if
                end-if

                if colonna = 23
                   inquire form1-gd-1(riga, 1),  cell-data tca-cod-magaz
                   inquire form1-gd-1(riga, 23), cell-data tca-codice  
                   move "tcaumag-mag"  to como-file
                   call "zoom-gt"   using como-file, tca-rec
                                   giving stato-zoom
                   cancel "zoom-gt"
                   if stato-zoom = 0
                      move tca-codice      to col-scarico-rot
                      modify form1-gd-1(riga, 23), cell-data 
           col-scarico-rot
                   end-if
                end-if

           end-evaluate 
           .
      * <TOTEM:END>

       CHECK-PRINCIPALE-ESISTENZA.
      * <TOTEM:PARA. CHECK-PRINCIPALE-ESISTENZA>
      * CONTROLLO CHE ESISTA ALMENO UN PRINCIPALE IN GRID
           set tutto-ok        to true.
           set trovato-uno     to false.

           inquire form1-gd-1 search-options GRID-SEARCH-OPTIONS.

           set GRID-SEARCH-MATCH-ANY    to true.
           set GRID-SEARCH-MOVES-CURSOR to false.
           set GRID-SEARCH-WRAP         to true.
           move 3                       to GRID-SEARCH-COLUMN.

           modify form1-gd-1, search-options GRID-SEARCH-OPTIONS.

           modify form1-gd-1, search-text "S"
                                   giving risultato.

           if risultato = GRDSRCH-NOT-FOUND
              set trovato-nessuno to true
           else
              set trovato-uno     to true
           end-if 
           .
      * <TOTEM:END>

       COLORE-RIGA.
      * <TOTEM:PARA. COLORE-RIGA>
           if riga < 2 move 2 to riga end-if.

           modify form1-gd-1, start-x = 1, x = 24,
                                  start-y = riga,
                                        y = riga,
                                  region-color 257,
                                  cursor-color 481 
           .
      * <TOTEM:END>

       CONTROLLO.
      * <TOTEM:PARA. CONTROLLO>
           set tutto-ok to true.

           if mod = 0 exit paragraph end-if.

           inquire form1-gd-1, cursor-y in riga.

           perform VALORE-RIGA.

           evaluate colonna
           when 1
                if nuovo
                   if mag-codice = spaces 
                      set errori to true
                      move 1     to colonna
                      display message MSG-Codice-obbligatorio
                                title tit-err
                                 icon 2
                   else  
                      read tmagaz
                           not invalid
                               set errori to true
                               display message MGS-codice-gia-inserito|"Codice già inserito!"
                                         title tit-err
                                          icon 2
                      end-read
                   end-if
                end-if
           when 2
                if mag-descrizione = spaces
                   set errori to true
                   move 2 to colonna
                   display message box MSG-Descrizione-mancante|"Descrizione mancante"
                           title = tit-err
                           icon mb-warning-icon
                end-if
           when 3
                inquire form1-gd-1(riga, 3) cell-data col-princ

                if si-principale
      *            CONTROLLO SE NE ESISTE GIA UNO
      *            IN CASO AFFERMATIVO ERRORE!!!
                   perform SEARCH-PRINCIPALE

                   if trovato-uno
                      if riga not = cont
                         set errori to true
                         display message  MSG-Principale-gia-inserito
                              title = tit-err
                              icon mb-warning-icon                 
                      else
                         perform EVIDENZIA-RIGA
                      end-if
                   else
      *               COLORA LA RIGA SE INSERISCO "S" E TUTTO-OK
                      inquire form1-gd-1(riga, 3), cell-data col-princ
                      if si-principale
                         perform EVIDENZIA-RIGA
                      end-if
                   end-if   
                else        
                   if col-princ = SPACE or 
                      col-princ = "N"
      *               SE DIGITO SPACE PROPONGO "N"
      *               DECOLORO LA RIGA
                      set no-principale to true
                      perform DECOLORA-EVIDENZIAZIONE
                   else
      *               SE INSERISCO VALORI DIVERSI DA "N" O "S" ERRORE!
                      if not no-principale
                         set errori to true
                         move 3     to colonna
                         display message box MSG-Principale-Invalido|"Principale non valido"
                                 title = tit-err
                                 icon mb-warning-icon
                      end-if
                   end-if
                end-if  

           when 4
                inquire form1-gd-1(riga, 4) cell-data col-scritt
                evaluate col-scritt
                when "T"
                when "N"   
                when "S"   continue
                when other set errori to true
                           move 4     to colonna
                           display message "Valori ammessi:"
                                    x"0d0a""T = TUTTI"
                                    x"0d0a""S = SOLO NON UTF"
                                    x"0d0a""N = NESSUNO"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 5
                inquire form1-gd-1(riga, 5) cell-data col-utf
                evaluate col-utf
                when "S"
                when "N"   continue
                when other set errori to true
                           move 5     to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 7
                inquire form1-gd-1(riga, 7) cell-data col-promo
                evaluate col-promo
                when "S"
                when "N"   continue
                when other set errori to true
                           move 7     to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 8
                inquire form1-gd-1(riga, 1) cell-data col-id
                inquire form1-gd-1(riga, 8) cell-data col-causale
                move col-causale to tca-codice
                if tca-codice not = spaces
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 8     to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 8     to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        end-if
                   end-read
                end-if

           when 9
                inquire form1-gd-1(riga, 1) cell-data col-id
                inquire form1-gd-1(riga, 9) cell-data col-causale-omag
                move col-causale-omag to tca-codice
                if tca-codice not = spaces
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 9     to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 9     to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        else
                           if tca-no-zero
                              set errori to true
                              display message "Codice Causale non valida
      -    ""
                                            "NON valido!"
                                        title tit-err
                                         icon 2
                           end-if
                        end-if
                   end-read
                end-if

           when 10
                inquire form1-gd-1(riga, 10) cell-data col-sostituzione
                evaluate col-sostituzione
                when "S"
                when "N"   continue
                when other set errori to true
                           move 10    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 11
                inquire form1-gd-1(riga, 11) cell-data col-blister
                evaluate col-blister
                when "S"
                when "N"   continue
                when other set errori to true
                           move 11    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 12
                inquire form1-gd-1(riga, 12) cell-data col-ritira
                evaluate col-ritira
                when "S"
                when "N"   continue
                when other set errori to true
                           move 12    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate
                
           when 13
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 13) cell-data col-cau-s
                move col-cau-s to tca-codice
                if tca-codice not = spaces and not = "0000"
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 13    to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 13    to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        else
                           if tca-imponibile-pos
                              set errori to true
                              display message "Causale di scarico non va
      -    "lida"
                                       x"0d0a""Indicare una causale ad i
      -    "mponibile negativo"
                                        title tit-err
                                         icon 2
                           end-if
                        end-if
                   end-read
                end-if
                
           when 14
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 14) cell-data col-cau-c
                move col-cau-c to tca-codice
                if tca-codice not = spaces and not = "0000"
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 14    to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 14    to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        else
                           if tca-imponibile-neg
                              set errori to true
                              display message "Causale di carico non val
      -    "ida"
                                       x"0d0a""Indicare una causale ad i
      -    "mponibile positivo"
                                        title tit-err
                                         icon 2
                           end-if
                        end-if
                   end-read
                end-if
                
           when 15
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 15) cell-data col-reso
                move col-reso to tca-codice
                if tca-codice not = spaces and not = "0000"
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 15    to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 15    to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        end-if
                   end-read
                end-if
                
           when 16
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 16) cell-data col-diff
                move col-diff to tca-codice
                if tca-codice not = spaces and not = "0000"
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 16    to colonna
                        display message "Causale non valida"
                                  title tit-err
                                   icon 2
                    not invalid
                        if tca-cod-magaz not = col-id
                           set errori to true
                           move 16    to colonna
                           display message "Magazzino Causale non valido
      -    ""
                                     title tit-err
                                      icon 2
                        end-if
                   end-read
                end-if
                
           when 17
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 17) cell-data col-vett
                move col-vett to vet-codice
                if vet-codice not = 0
                   read tvettori no lock
                        invalid
                        set errori to true
                        move 17    to colonna
                        display message "Vettore non valido"
                                  title tit-err
                                   icon 2
                   end-read
                end-if   

           when 19
                inquire form1-gd-1(riga, 19) cell-data col-ritira
                evaluate col-ritira
                when "S"
                when "N"   continue
                when other set errori to true
                           move 19    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate 

           when 20
                inquire form1-gd-1(riga, 20) cell-data col-gen-auto
                evaluate col-gen-auto
                when "S"
                when "N"   continue
                when other set errori to true
                           move 19    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 21
                inquire form1-gd-1(riga, 21) cell-data col-blocco-24000
                evaluate col-blocco-24000
                when "S"
                when "N"   continue
                when other set errori to true
                           move 21    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           when 22                                   
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 22) cell-data col-carico-rot
                if col-carico-rot not = spaces and not = "0000"
                   move col-carico-rot to tca-codice
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 22    to colonna
                        display message "Causale carico ROT non valida"
                                  title tit-err
                                   icon 2
                   end-read
                end-if

           when 23                           
                inquire form1-gd-1(riga, 1)  cell-data col-id
                inquire form1-gd-1(riga, 23) cell-data col-scarico-rot
                if col-scarico-rot not = spaces and not = "0000"
                   move col-scarico-rot to tca-codice
                   read tcaumag no lock
                        invalid
                        set errori to true
                        move 23    to colonna
                        display message "Causale scarico ROT non valida"
                                  title tit-err
                                   icon 2
                   end-read
                end-if      

           when 24
                inquire form1-gd-1(riga, 24) cell-data col-scorta
                evaluate col-scorta
                when "S"
                when "N"   continue
                when other set errori to true
                           move 24    to colonna
                           display message "Valori ammessi: S o N"
                                    title tit-err
                                     icon 2
                end-evaluate

           end-evaluate.

           if errori
              modify form1-gd-1, cursor-y = riga, cursor-x = colonna
              move riga    to event-data-2
              move colonna to event-data-1
           end-if 
           .
      * <TOTEM:END>

       DECOLORA-EVIDENZIAZIONE.
      * <TOTEM:PARA. DECOLORA-EVIDENZIAZIONE>
           modify form1-gd-1(riga, 3), cell-data col-princ
           modify form1-gd-1(riga), start-x 1, x 3,
                                    y riga, start-y riga,
                                    row-color ZERO 
           .
      * <TOTEM:END>

       EVIDENZIA-RIGA.
      * <TOTEM:PARA. EVIDENZIA-RIGA>
           modify form1-gd-1(riga), start-x 1, x 3,
                                    y riga, start-y riga,
                                    row-color 80 
           .
      * <TOTEM:END>

       GRID-HELP.
      * <TOTEM:PARA. GRID-HELP>
           move BitmapZoomDisabled to BitmapNumZoom.
           move 0 to e-cerca.

           evaluate event-data-1
           when  1 move "Codice magazzino"      to msg-help
           when  2 move "Descrizione magazzino" to msg-help
           when  3 move "Valori ammessi: S(i) / N(o)" to msg-help
           when  4 move "Valori ammessi: S(olo non UTF) / T(utte) / N(es
      -    "suna)" to msg-help
           when  5 move "Valori ammessi: S(i) / N(o)" to msg-help
           when  7 move "Valori ammessi: S(i) / N(o)" to msg-help
           when  8 move "Causale standard di vendita da utilizzare in ev
      -    "asione" to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when  9 move "Causale standard di omaggio da utilizzare in ev
      -    "asione" to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when 10 move "Valori ammessi: S(i) / N(o)" to msg-help
           when 11 move "Valori ammessi: S(i) / N(o)" to msg-help
           when 12 move "Valori ammessi: S(i) / N(o)" to msg-help
           when 13 move "Causale da utilizzare come scarico nella proced
      -    "ura d'inventario" to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when 14 move "Causale da utilizzare come carico nella procedu
      -    "ra d'inventario"  to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when 15 move "Causale da utilizzare come reso nella creazione
      -    " di bozze NC"  to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when 16 move "Causale da utilizzare come diff. prezzo nella c
      -    "reazione di bozze NC"  to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if 
           when 17 move "Vettore da utilizzare in evasione"  to msg-help
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if
           when 18 move "Priorità magazzino: per mail-giacenze notturno.
      -    " Il magazzino principale dev'essere 1"  to msg-help
           when 22 move "Verrà usata per gnerare movimento di carico da 
      -    "bozza nota credito"  to msg-help  
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if 
           when 23 move "Verrà usata per generare movimento di scarico d
      -    "a bozza nota credito" to msg-help  
                   if mod = 1
                      move BitmapZoomEnabled to BitmapNumZoom
                      move 1 to e-cerca
                   end-if 
           when 24 move "Verrà usata per sommare le quantità del magazzi
      -    "no in fase di sostituzione scorta 0/2" to msg-help  
           end-evaluate.
           modify Screen1-St-1-Handle, panel-index = 1,
                                       panel-text  = msg-help.

           modify tool-cerca, bitmap-number = BitmapNumZoom,
                              enabled       = e-cerca 
           .
      * <TOTEM:END>

       INIT.
      * <TOTEM:PARA. INIT>
           set vecchio  to true.
           set tutto-ok to true 
           .
      * <TOTEM:END>

       LOAD-RECORD.
      * <TOTEM:PARA. LOAD-RECORD>
           modify form1-gd-1, mass-update = 1.

           move low-value to mag-codice.
           start tmagaz key is >= mag-chiave
                  invalid continue
              not invalid
                  perform varying riga from 2 by 1
                          until 1 = 2
                     read tmagaz next
                          at end exit perform
                      not at end
                          move mag-codice           to col-id
                          move mag-descrizione      to col-des
                          move mag-principale       to col-princ
                          move mag-scr-aux          to col-scritt
                          move mag-utf              to col-utf
                          move mag-perce-riordino   to col-perce
                          move mag-per-promo        to col-promo
                          move mag-causale-eva      to col-causale
                          move mag-causale-omag     to col-causale-omag
                          move mag-sostituzione     to col-sostituzione
                          move mag-blister          to col-blister
                          move mag-ritira-lbx       to col-ritira
                          move mag-scorta           to col-scorta
                          move mag-cau-s            to col-cau-s
                          move mag-cau-c            to col-cau-c
                          move mag-cau-reso         to col-reso
                          move mag-cau-diff         to col-diff
                          move mag-vettore          to col-vett
                          move mag-priorita-mag     to col-priorita-mag 
              
                          move mag-da-inviare       to col-da-inviare
                          move mag-gen-auto         to col-gen-auto
                          move mag-blocco-24000     to col-blocco-24000
                          move mag-cau-carico-rot   to col-carico-rot
                          move mag-cau-scarico-rot  to col-scarico-rot 
                          modify form1-gd-1(riga, 1),  cell-data col-id 
                          
                          modify form1-gd-1(riga, 2),  cell-data 
           col-des               
                          modify form1-gd-1(riga, 3),  cell-data 
           col-princ             
                          modify form1-gd-1(riga, 4),  cell-data 
           col-scritt            
                          modify form1-gd-1(riga, 5),  cell-data 
           col-utf               
                          modify form1-gd-1(riga, 6),  cell-data 
           col-perce             
                          modify form1-gd-1(riga, 7),  cell-data 
           col-promo             
                          modify form1-gd-1(riga, 8),  cell-data 
           col-causale           
                          modify form1-gd-1(riga, 9),  cell-data 
           col-causale-omag      
                          modify form1-gd-1(riga, 10), cell-data 
           col-sostituzione      
                          modify form1-gd-1(riga, 11), cell-data 
           col-blister           
                          modify form1-gd-1(riga, 12), cell-data 
           col-ritira            
                          modify form1-gd-1(riga, 13), cell-data 
           col-cau-s             
                          modify form1-gd-1(riga, 14), cell-data 
           col-cau-c             
                          modify form1-gd-1(riga, 15), cell-data 
           col-reso              
                          modify form1-gd-1(riga, 16), cell-data 
           col-diff              
                          modify form1-gd-1(riga, 17), cell-data 
           col-vett              
                          modify form1-gd-1(riga, 18), cell-data 
           col-priorita-mag      
                          modify form1-gd-1(riga, 19), cell-data 
           col-da-inviare        
                          modify form1-gd-1(riga, 20), cell-data 
           col-gen-auto       
                          modify form1-gd-1(riga, 21), cell-data 
           col-blocco-24000
                          modify form1-gd-1(riga, 22), cell-data 
           col-carico-rot   
                          modify form1-gd-1(riga, 23), cell-data 
           col-scarico-rot
                          modify form1-gd-1(riga, 24), cell-data 
           col-scorta

                          evaluate true
                          when si-principale
                               perform EVIDENZIA-RIGA
                          when other
                               perform DECOLORA-EVIDENZIAZIONE
                          end-evaluate
                     end-read                                           
                     if riga = 2
                        perform VALORIZZA-SCORTE
                     end-if
                  end-perform
           end-start.

           modify form1-gd-1, mass-update = ZERO 
           .
      * <TOTEM:END>

       MODIFICA.
      * <TOTEM:PARA. MODIFICA>
           inquire tool-modifica, value in mod.

      *--->modifica (isacco)
           if nuovo 
              move 1 to mod 
           else
              |specifico per i pgm. con grid-control
              if mod = 1
                 close tmagaz
                 open i-o tmagaz allowing readers
              else
                 set tutto-ok to true
                 if NoSalvato
                    move 1 to mod
                    perform SALV-MOD
                 end-if   
                 if tutto-ok
                    move ZERO to mod
                    close tmagaz
                    open input tmagaz

      *             | specifico x le tabelle.
                    | fa in modo che resto sulla cella in cui ero
                    if ricarica
                       set ricarica to false
                       modify form1-gd-1, reset-grid = 1
                       perform FORM1-GD-1-CONTENT
                       perform LOAD-RECORD
                    end-if

                 else
                    move 1 to mod
                 end-if
              end-if
           end-if.

           perform ABILITAZIONI.

           modify tool-modifica, value mod 
           .
      * <TOTEM:END>

       NUOVO.
      * <TOTEM:PARA. NUOVO>
           set tutto-ok to true.

           if nuovo
              perform VALORE-RIGA
              if mag-codice not = SPACES
                 perform SALVA
              else
                 set errori to true
              end-if
           end-if.

           if tutto-ok

      *    MODIFICA SOLO PER TMAGAZ. (VALORE TERZA COLONNA)
              perform SALVA
      *    FINE

              set nuovo to true
              inquire form1-gd-1,  last-row in tot-righe

              if tot-righe > 1
                 inquire form1-gd-1 (riga, 3), cell-data col-princ
                 if col-princ = spaces or no-principale
                    perform DECOLORA-EVIDENZIAZIONE
                 end-if
              end-if

              modify  form1-gd-1,  insert-rows = 1
              modify  form1-gd-1,  cursor-x    = 1 
                                   cursor-y    = tot-righe + 1
              move 1 to mod
              modify  tool-modifica,   value = mod

              add 1 to tot-righe giving riga

              perform ABILITAZIONI

              initialize old-mag-rec replacing numeric data by zeroes
                                          alphanumeric data by spaces
              add 1 to tot-righe giving event-data-2
              perform COLORE-RIGA
           end-if 
           .
      * <TOTEM:END>

       PARAGRAFO-COPY.
      * <TOTEM:PARA. PARAGRAFO-COPY>
           copy "abilita-toolbar.cpy".
           copy "color-custom.cpy".   
           copy "cerca-testo.cpy".
           copy "status.cpy" 
           .
      * <TOTEM:END>

       SALV-MOD.
      * <TOTEM:PARA. SALV-MOD>
           if nuovo
              perform VALORE-RIGA
              if mag-rec not = old-mag-rec
                 set NoSalvato to true
              else
                 set SiSalvato to true
              end-if
           end-if.

           set tutto-ok to true.
           if NoSalvato
              display message box MSG-Salvare-le-modifiche, 
                             title = titolo
                             type = mb-yes-no-cancel
                             giving scelta

              evaluate scelta
              when mb-yes    
                   perform SALVA
              when mb-cancel 
                   set errori    to true
              when mb-no     
                   set tutto-ok  to true
                   set SiSalvato to true
                   set ricarica  to true
              end-evaluate

           end-if 
           .
      * <TOTEM:END>

       SALVA.
      * <TOTEM:PARA. SALVA>
           if mod = 0 
              exit paragraph 
           end-if.

           inquire form1-gd-1, cursor-x in colonna, 
                               cursor-y in riga.

           set prima-volta to true.

      * RESTANTI CONTROLLI
           perform varying colonna from 1 by 1 
                     until colonna > 24
              perform CONTROLLO
              if errori exit perform end-if
           end-perform.

           if tutto-ok
              perform FORM1-BUF-TO-FLD
      *    luciano start
              perform VALORIZZA-DATI-COMUNI
      *    luciano end
              write mag-rec invalid rewrite mag-rec end-write
              set sisalvato to true
              set vecchio   to true
           else                   
              perform ABILITAZIONI
           end-if 
           .
      * <TOTEM:END>

       SEARCH-PRINCIPALE.
      * <TOTEM:PARA. SEARCH-PRINCIPALE>
      * EFFETTUA UN CONTROLLO SULLA GRIGLIA PER VEDERE SE E' GIA STATO 
      * INSERITO IL PRINCIPALE. SOLO UN RECORD PUò AVERLO "S".
           set tutto-ok        to true.
           set trovato-uno     to false.

           inquire form1-gd-1 last-row totale-righe.

      * USO CONT POICHE IN CASO DI ERRORI DEVO RIPOSIZIONARMI 
      * SULLA RIGA IN CUI ERO
           perform varying cont from 2 by 1 until cont > totale-righe
              inquire form1-gd-1(cont, 3), cell-data col-princ
              if mod = 1
                 if cont not = old-riga
                    if not prima-volta
                       evaluate true
                       when si-principale
                            set trovato-uno to true
                            set prima-volta to true
                            exit perform
                       end-evaluate
                    end-if
                 end-if

                 if prima-volta and si-principale
                    subtract 1 from cont
                    set prima-volta to false
                 end-if
              end-if

           end-perform 
           .
      * <TOTEM:END>

       SPOSTAMENTO.
      * <TOTEM:PARA. SPOSTAMENTO>
           inquire form1-gd-1, cursor-x = colonna, cursor-y = riga.

           if event-data-2 not = riga
              perform VALORE-RIGA
              if mag-codice = spaces or zero
                 modify form1-gd-1, record-to-delete riga
                 set vecchio to true
              else  
                 perform SALVA
                 if errori
                    move riga    to event-data-2
                    move colonna to event-data-1
                    set event-action to event-action-fail
                 end-if
              end-if
           else
              if colonna not = event-data-1
                 perform CONTROLLO
                 if errori
                    set event-action to event-action-fail
                 end-if
              end-if
           end-if.

      *    valorizzo l'old della riga su cui sono andato
           move event-data-2 to riga.
           move event-data-1 to colonna.
           perform VALORE-OLD-RIGA.

      * colorazione riga in grid
           perform COLORE-RIGA.

           perform GRID-HELP.

           perform FORM1-FLD-TO-BUF 
           .
      * <TOTEM:END>

       SPOSTAMENTO-SCORTE.
      * <TOTEM:PARA. SPOSTAMENTO-SCORTE>
           move event-data-2 to riga.

           if riga < 2 move 2 to riga end-if.

           modify gd-scorte, start-x = 1, x = 2,
                             start-y = riga,
                                   y = riga,
                                  region-color 257,
                                  cursor-color 481.

           if event-data-1 = 1 and mod = 1
              move 1 to StatusHelp
           else
              move 0 to StatusHelp
           end-if.
           perform STATUS-HELP
           .
      * <TOTEM:END>

       STAMPA.
      * <TOTEM:PARA. STAMPA>
           set stampa       to true.
      *     perform paragrafo-stampa 
           .
      * <TOTEM:END>

       VALORE-RIGA.
      * <TOTEM:PARA. VALORE-RIGA>
           inquire form1-gd-1(riga, 1),  cell-data mag-codice.
           inquire form1-gd-1(riga, 2),  cell-data mag-descrizione. 
           inquire form1-gd-1(riga, 3),  cell-data mag-principale.  
           inquire form1-gd-1(riga, 4),  cell-data mag-scr-aux.     
           inquire form1-gd-1(riga, 5),  cell-data mag-utf.
           inquire form1-gd-1(riga, 6),  cell-data mag-perce-riordino.
           inquire form1-gd-1(riga, 7),  cell-data mag-per-promo.
           inquire form1-gd-1(riga, 8),  cell-data mag-causale-eva.
           inquire form1-gd-1(riga, 9),  cell-data mag-causale-omag.
           inquire form1-gd-1(riga, 10), cell-data mag-sostituzione.
           inquire form1-gd-1(riga, 11), cell-data mag-blister.
           inquire form1-gd-1(riga, 12), cell-data mag-ritira-lbx.
           inquire form1-gd-1(riga, 13), cell-data mag-cau-s.
           inquire form1-gd-1(riga, 14), cell-data mag-cau-c.
           inquire form1-gd-1(riga, 15), cell-data mag-cau-reso.
           inquire form1-gd-1(riga, 16), cell-data mag-cau-diff.   
           inquire form1-gd-1(riga, 17), cell-data mag-vettore.  
           inquire form1-gd-1(riga, 18), cell-data mag-priorita-mag.
           inquire form1-gd-1(riga, 19), cell-data mag-da-inviare.
           inquire form1-gd-1(riga, 20), cell-data mag-gen-auto.
           inquire form1-gd-1(riga, 21), cell-data mag-blocco-24000.
           inquire form1-gd-1(riga, 22), cell-data mag-cau-carico-rot.  
           inquire form1-gd-1(riga, 23), cell-data mag-cau-scarico-rot.
           inquire form1-gd-1(riga, 24), cell-data mag-scorta.

           if mag-principale = spaces
              set no-mag-principale to true
              set no-principale     to true
           end-if
           .
      * <TOTEM:END>

       VALORE-OLD-RIGA.
      * <TOTEM:PARA. VALORE-OLD-RIGA>
           if vecchio
              inquire form1-gd-1(riga, 1) cell-data old-mag-codice
              move old-mag-codice         to mag-codice
              read tmagaz                 no lock
              move mag-rec                to old-mag-rec
           else
              initialize old-mag-rec replacing numeric data by zeroes
                                          alphanumeric data by spaces
           end-if 
           .
      * <TOTEM:END>

       VALORIZZA-DATI-COMUNI.
      * <TOTEM:PARA. VALORIZZA-DATI-COMUNI>
      *    se non ho valorizzato i campi di creazione li valorizzo
           if mag-data-creazione = zero
              accept mag-data-creazione from century-date
           end-if.
           if mag-ora-creazione = zero
              accept mag-ora-creazione from time
           end-if.
           if mag-utente-creazione = space
              move user-codi to mag-utente-creazione
           end-if.

           accept mag-data-ultima-modifica from century-date.
           accept mag-ora-ultima-modifica from time.
           move user-codi to mag-utente-ultima-modifica 
           .
      * <TOTEM:END>

       VALORIZZA-SCORTE.
      * <TOTEM:PARA. VALORIZZA-SCORTE>
           move 2 to store-riga.
           modify gd-scorte, reset-grid = 1.
           perform GD-SCORTE-CONTENT.
           perform varying idx from 1 by 1 
                     until idx > 20
              if mag-sco-codice(idx) = spaces
                 exit perform
              end-if
              move mag-sco-codice(idx) to col-codice
              call "C$JUSTIFY" using col-codice, "R"
              inspect col-codice replacing leading X"20" by x"30"
              move col-codice to sco-codice
              read tscorte no lock
              move sco-descrizione to col-descrizione
              modify gd-scorte(store-riga, 1), cell-data 
           mag-sco-codice(idx)
              modify gd-scorte(store-riga, 2), cell-data col-descrizione
              add 1 to store-riga
           end-perform 
           .
      * <TOTEM:END>

      * EVENT PARAGRAPH
       NUOVO-LinkTo.
      * <TOTEM:PARA. NUOVO-LinkTo>
           inquire tool-nuovo, enabled in e-nuovo.
           if e-nuovo = 1
              perform NUOVO
           end-if 

           .
      * <TOTEM:END>
       CANCELLA-LinkTo.
      * <TOTEM:PARA. CANCELLA-LinkTo>
           inquire tool-cancella, enabled in e-cancella.
           if e-cancella = 1
              perform CANCELLA
           end-if 
           .
      * <TOTEM:END>
       TOOL-SALVA-LinkTo.
      * <TOTEM:PARA. TOOL-SALVA-LinkTo>
           inquire tool-salva, enabled in e-salva.
           if e-salva = 1
              perform salva
           end-if 
           .
      * <TOTEM:END>
       ANTEPRIMA-LinkTo.
      * <TOTEM:PARA. ANTEPRIMA-LinkTo>
           inquire tool-anteprima, enabled in e-anteprima.
           if e-anteprima = 1
              perform ANTEPRIMA
           end-if 
           .
      * <TOTEM:END>
       TOOL-MODIFICA-LinkTo.
      * <TOTEM:PARA. TOOL-MODIFICA-LinkTo>
           inquire tool-modifica, enabled in e-modifica
           if e-modifica = 1
              perform MODIFICA
           end-if 
           .
      * <TOTEM:END>
       STAMPA-LinkTo.
      * <TOTEM:PARA. STAMPA-LinkTo>
           inquire tool-stampa, enabled in e-stampa
           if e-stampa = 1
              perform STAMPA
           end-if 
           .
      * <TOTEM:END>
       I-O-BLOCCO.
      * <TOTEM:PARA. I-O-BLOCCO>
           SET LK-BL-CANCELLAZIONE TO TRUE.
           MOVE COMO-PROG-ID       TO LK-BL-PROG-ID.
           CALL "BLOCKPGM"  USING LK-BLOCKPGM 
           .
      * <TOTEM:END>
       PAS004P-Ev-Before-Program.
      * <TOTEM:PARA. PAS004P-Ev-Before-Program>
           move LK-BL-PROG-ID    TO COMO-PROG-ID.
           set prima-volta to true 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Finish-Entry>
           inquire form1-gd-1, cursor-y in riga.
           perform VALORE-RIGA.

           perform  CONTROLLO.

           if errori 
              set event-action to event-action-fail 
              perform VALORE-RIGA
           else
              move mag-perce-riordino to col-perce
              modify form1-gd-1(riga, 6), cell-data col-perce
           end-if.

           if mag-rec not = old-mag-rec
              set NoSalvato to true                            
           else 
              set SiSalvato to true
           end-if 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Begin-Entry>
           if mod = 0
              set event-action to event-action-fail
           else
              inquire form1-gd-1, cursor-x = colonna,
                                  cursor-y = riga
              perform VALORE-RIGA

              evaluate colonna
              when 1
                   if mag-codice not = 0 and not = spaces
                      set event-action to event-action-fail
                   end-if
              when other
                   if mag-codice = 0 or spaces
                      set event-action to event-action-fail
                      modify form1-gd-1, cursor-y = riga, cursor-x = 1
                   end-if
              end-evaluate
           end-if.

           if colonna = 3
              inquire form1-gd-1, cursor-y old-riga
           end-if 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-End-Drag.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-End-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       form1-gd-1-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. form1-gd-1-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO 
           .
      * <TOTEM:END>
       TOOL-CERCA-LinkTo.
      * <TOTEM:PARA. TOOL-CERCA-LinkTo>
           inquire tool-cerca, enabled in e-cerca.
           if e-cerca = 1
              perform CERCA
           end-if 
           .
      * <TOTEM:END>
       ef-cod-BeforeProcedure.
      * <TOTEM:PARA. ef-cod-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-des-BeforeProcedure.
      * <TOTEM:PARA. ef-des-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       ef-cod-AfterProcedure.
      * <TOTEM:PARA. ef-cod-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       ef-des-AfterProcedure.
      * <TOTEM:PARA. ef-des-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       rb-cod-BeforeProcedure.
      * <TOTEM:PARA. rb-cod-BeforeProcedure>
           modify control-handle, color = colore-nu
           .
      * <TOTEM:END>
       rb-des-BeforeProcedure.
      * <TOTEM:PARA. rb-des-BeforeProcedure>
           modify control-handle, color = colore-nu
           .
      * <TOTEM:END>
       rb-cod-AfterProcedure.
      * <TOTEM:PARA. rb-cod-AfterProcedure>
           modify control-handle, color = colore-or
           .
      * <TOTEM:END>
       rb-des-AfterProcedure.
      * <TOTEM:PARA. rb-des-AfterProcedure>
           modify control-handle, color = colore-or
           .
      * <TOTEM:END>
       pb-esegui-LinkTo.
      * <TOTEM:PARA. pb-esegui-LinkTo>
           set tutto-ok to true.

           if tipo-ricerca = 1
              inquire ef-cod, value in cod
              if cod not > spaces 
                 set errori  to true 
              else
                 move cod    to TextToSearch
                 move spaces to des
                 display ef-des
              end-if 
           else                           
              inquire ef-des, value in des
              if des = spaces 
                 set errori to true 
              else
                 move des to TextToSearch   
                 move space to cod
                 display ef-cod
              end-if
           end-if.

           if tutto-ok 
              move 27 to key-status 
              set Ricerca to true
           end-if.

      * ISACCO - FISSATO BUG SE NON DIGITO NULLA IN SCREEN RICERCA
      * 10/11/20003
           Set tutto-ok to true.
      * FINE
           .
      * <TOTEM:END>
       tool-CercaTesto-LinkTo.
      * <TOTEM:PARA. tool-CercaTesto-LinkTo>
           perform CERCA-TESTO 
           .
      * <TOTEM:END>
       rb-cod-LinkTo.
      * <TOTEM:PARA. rb-cod-LinkTo>
           move 1 to tipo-ricerca.
           move 1 to e-cod.
           move 0 to e-des.
           display SCREEN-SEARCH.

           perform CANCELLA-COLORE.
           move 1 to control-id.
           move 4 to accept-control 
           .
      * <TOTEM:END>
       rb-des-LinkTo.
      * <TOTEM:PARA. rb-des-LinkTo>
           move 2 to tipo-ricerca.
           move 1 to e-des.
           move 0 to e-cod.
           display SCREEN-SEARCH.  

           perform CANCELLA-COLORE.
           move 2 to control-id.
           move 4 to accept-control 
           .
      * <TOTEM:END>
       TOOL-MODIFICA-BeforeProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       cb-match-BeforeProcedure.
      * <TOTEM:PARA. cb-match-BeforeProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-NU
           .
      * <TOTEM:END>
       TOOL-MODIFICA-AfterProcedure.
      * <TOTEM:PARA. TOOL-MODIFICA-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       cb-match-AfterProcedure.
      * <TOTEM:PARA. cb-match-AfterProcedure>
           MODIFY CONTROL-HANDLE COLOR = COLORE-OR
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Begin-Drag.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Begin-Drag>
           perform SPOSTAMENTO-SCORTE 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-End-Drag.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-End-Drag>
           perform SPOSTAMENTO-SCORTE 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Goto-Cell-Drag.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Goto-Cell-Drag>
           perform SPOSTAMENTO-SCORTE 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Goto-Cell-Mouse.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Goto-Cell-Mouse>
           perform SPOSTAMENTO-SCORTE 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Goto-Cell.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Goto-Cell>
           perform SPOSTAMENTO-SCORTE 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Begin-Entry.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Begin-Entry>
           inquire gd-scorte, cursor-x in colonna,
           if mod = 0 or colonna not = 1
              set event-action to event-action-fail
           end-if 
           .
      * <TOTEM:END>
       gd-scorte-Ev-Msg-Finish-Entry.
      * <TOTEM:PARA. gd-scorte-Ev-Msg-Finish-Entry>
           set tutto-ok to true.
           move event-data-2 to riga.
           inquire gd-scorte(event-data-2, 1), cell-data in col-codice.
           move col-codice to como-xx.
           if col-codice = spaces
              add 1 to riga
              inquire gd-scorte(riga, 1), cell-data in col-codice
              subtract 1 from riga
              modify gd-scorte, record-to-delete event-data-2
              modify gd-scorte(riga , 1), cell-data col-codice
              exit paragraph
           else
              call "C$JUSTIFY" using col-codice, "R"
              inspect col-codice replacing leading X"20" by x"30"
              if col-codice is numeric
                 move col-codice to sco-codice
                 read tscorte no lock 
                      invalid
                      set errori to true
                      display message "Scorta NON valida"
                                title tit-err
                                 icon 2
                      move spaces to sco-descrizione
                  end-read
               else 
                  set errori to true
                  display message "Scorta NON valida"
                            title tit-err
                             icon 2
                  move spaces to sco-descrizione
               end-if
           end-if.

           if tutto-ok
              inquire gd-scorte, last-row in tot-righe
              perform varying riga from 2 by 1 
                        until riga > tot-righe 
                 inquire gd-scorte(riga, 1), cell-data in confronto-xx
                 if confronto-xx = como-xx and riga not = event-data-2
                    set errori to true
                    subtract 1 from riga
                    display message "Scorta già presente a riga " riga
                              title tit-err
                               icon 2
                    exit perform
                 end-if
              end-perform
           end-if.

           if errori
              set event-action to event-action-fail
           end-if.
           modify gd-scorte(event-data-2, 2), cell-data sco-descrizione 
           .
      * <TOTEM:END>

      *{TOTEM}END

      *{TOTEM}SHOW-MSG
       MESSAGE-FOR-FILEERROR.
           CALL "C$RERRNAME" USING TOTEM-MSG-ERR-FILE
           CALL "C$RERR" USING EXTEND-STAT, TEXT-MESSAGE
              MOVE PRIMARY-ERROR TO TOTEM-MSG-ID
           .

       SHOW-TRANSACTION-ROUTINE.
           IF TOTEM-TRANSACTION-FLAG = SPACES
              IF TRANSACTION-STATUS NOT = 0
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-1
              END-IF
           ELSE
              PERFORM SHOW-MSG-ROUTINE
              IF TRANSACTION-STATUS = 0
                 MOVE "Transazione terminata con Rollback." TO 
           TOTEM-MSG-3
              ELSE
                 STRING "TRANSACTION ERROR ", TRANSACTION-STATUS
                    DELIMITED BY SIZE INTO TOTEM-MSG-3
              END-IF
           END-IF
           .

       SHOW-MSG-ROUTINE.
           MOVE SPACE TO TOTEM-MSG-1 TOTEM-MSG-2 TOTEM-MSG-3
           EVALUATE TOTEM-MSG-ID
               WHEN "10"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Nessun altro dato." TO TOTEM-MSG-2
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "22"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Chiave Duplicata." TO TOTEM-MSG-2
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "23"
                    STRING "File:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-1
                    MOVE "Raggiunta fine file." TO TOTEM-MSG-2
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "101"
                    MOVE "Terminare l'applicazione?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "201"
                    MOVE "Aggiungere un nuovo record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "202"
                    MOVE "Aggiornare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "203"
                    MOVE "Cancellare il Record?" TO TOTEM-MSG-1
                    MOVE 4 TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-YES-NO TO TOTEM-MSG-BUTTON-TYPE
               WHEN "204"
                    MOVE "Chiave duplicata." TO TOTEM-MSG-1
                    MOVE MB-WARNING-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "301"
                    MOVE "Inserimento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "302"
                    MOVE "Aggiornamento avvenuto con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "303"
                    MOVE "Cancellazione avvenuta con Successo." TO 
           TOTEM-MSG-1
                    MOVE MB-DEFAULT-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN "401"
                    MOVE "Shell non trovata." TO TOTEM-MSG-1
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
               WHEN OTHER
                    MOVE TEXT-MESSAGE TO TOTEM-MSG-1
                    STRING "FILE:" TOTEM-MSG-ERR-FILE DELIMITED BY SPACE
                       INTO TOTEM-MSG-3
                    MOVE 0 TO TOTEM-IDX1
                    INSPECT TOTEM-MSG-3 TALLYING TOTEM-IDX1
                       FOR TRAILING SPACE
                    STRING TOTEM-MSG-3(1:TOTEM-MSG-LENGTH - 
           TOTEM-IDX1), 
                       ", FILE STATUS ", PRIMARY-ERROR "," 
                       SECONDARY-ERROR
                    DELIMITED BY SIZE INTO TOTEM-MSG-2
                    MOVE SPACES TO TOTEM-MSG-3
                    MOVE MB-ERROR-ICON TO TOTEM-MSG-ICON-TYPE
                    MOVE MB-OK TO TOTEM-MSG-BUTTON-TYPE
           END-EVALUATE
           PERFORM MESSAGE-BOX-ROUTINE
           .

       MESSAGE-BOX-ROUTINE.
           MOVE 1 TO TOTEM-MSG-TEXT-POINTER
           IF TOTEM-MSG-1 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-1 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              STRING TOTEM-MSG-1( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                 DELIMITED BY SIZE
                 INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-2 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-2 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-2( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-3 NOT = SPACE
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-3 TALLYING TOTEM-MSG-SIZE FOR TRAILING 
           SPACE
              IF TOTEM-MSG-TEXT-POINTER > 1
                 STRING X"0A" DELIMITED BY SIZE
                     INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
              END-IF
              STRING TOTEM-MSG-3( 1 : TOTEM-MSG-LENGTH - TOTEM-MSG-SIZE 
           )
                  DELIMITED BY SIZE
                  INTO TOTEM-MSG-TEXT, POINTER TOTEM-MSG-TEXT-POINTER
           END-IF

           IF TOTEM-MSG-TEXT-POINTER = 1
              MOVE 0 TO TOTEM-MSG-SIZE
              INSPECT TOTEM-MSG-TEXT TALLYING TOTEM-MSG-SIZE FOR 
           TRAILING SPACE
                  COMPUTE TOTEM-MSG-TEXT-POINTER = 
           TOTEM-MSG-FULL-LENGTH - TOTEM-MSG-SIZE + 1
           END-IF
           MOVE LOW-VALUES TO TOTEM-MSG-TEXT(TOTEM-MSG-TEXT-POINTER : 1 
           )
           .

       MESSAGE-BOX-DISPLAY.
           PERFORM SHOW-MSG-ROUTINE
           PERFORM MESSAGE-BOX-ROUTINE
           DISPLAY MESSAGE BOX TOTEM-MSG-TEXT
               TITLE IS TOTEM-MSG-TITLE
               TYPE  IS TOTEM-MSG-BUTTON-TYPE
               ICON  IS TOTEM-MSG-DEFAULT-BUTTON
               RETURNING TOTEM-MSG-RETURN-VALUE
           .

      *{TOTEM}END

